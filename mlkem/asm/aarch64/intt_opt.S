///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

#include "config.h"
#if defined(MLKEM_USE_AARCH64_ASM)

// Needed to provide ASM_LOAD directive
#include "common.i"

.macro mulmodq dst, src, const, idx0, idx1
        sqrdmulh t2.8h,      \src\().8h, \const\().h[\idx1\()]
        mul      \dst\().8h, \src\().8h, \const\().h[\idx0\()]
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro mulmod dst, src, const, const_twisted
        sqrdmulh t2.8h,      \src\().8h, \const_twisted\().8h
        mul      \dst\().8h, \src\().8h, \const\().8h
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro gs_butterfly a, b, root, idx0, idx1
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmodq  \b, tmp, \root, \idx0, \idx1
.endm

.macro gs_butterfly_v a, b, root, root_twisted
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmod  \b, tmp, \root, \root_twisted
.endm

.macro mul_ninv dst0, dst1, dst2, dst3, src0, src1, src2, src3
        mulmod \dst0, \src0, ninv, ninv_tw
        mulmod \dst1, \src1, ninv, ninv_tw
        mulmod \dst2, \src2, ninv, ninv_tw
        mulmod \dst3, \src3, ninv, ninv_tw
.endm

.macro barrett_reduce a
        sqdmulh t0.8h,    \a\().8h, consts.h[1]
        srshr   t0.8h,    t0.8h,    #11
        mls     \a\().8h, t0.8h,    consts.h[0]
.endm

.macro load_roots_123
        ldr q_root0, [r_ptr0], #32
        ldr q_root1, [r_ptr0, #-16]
.endm

.macro load_next_roots_45
        ldr q_root0, [r_ptr0], #16
.endm

.macro load_next_roots_67
        ldr q_root0,    [r_ptr1], #(6*16)
        ldr q_root0_tw, [r_ptr1, #(-6*16 + 1*16)]
        ldr q_root1,    [r_ptr1, #(-6*16 + 2*16)]
        ldr q_root1_tw, [r_ptr1, #(-6*16 + 3*16)]
        ldr q_root2,    [r_ptr1, #(-6*16 + 4*16)]
        ldr q_root2_tw, [r_ptr1, #(-6*16 + 5*16)]
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0.4s, \data\()1.4s
        trn2 t1.4s, \data\()0.4s, \data\()1.4s
        trn1 t2.4s, \data\()2.4s, \data\()3.4s
        trn2 t3.4s, \data\()2.4s, \data\()3.4s

        trn2 \data\()2.2d, t0.2d, t2.2d
        trn2 \data\()3.2d, t1.2d, t3.2d
        trn1 \data\()0.2d, t0.2d, t2.2d
        trn1 \data\()1.2d, t1.2d, t3.2d
.endm

.macro transpose_single data_out, data_in
        trn1 \data_out\()0.4s, \data_in\()0.4s, \data_in\()1.4s
        trn2 \data_out\()1.4s, \data_in\()0.4s, \data_in\()1.4s
        trn1 \data_out\()2.4s, \data_in\()2.4s, \data_in\()3.4s
        trn2 \data_out\()3.4s, \data_in\()2.4s, \data_in\()3.4s
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

// For comparability reasons, the output range for the coefficients of this
// invNTT code is supposed to match the implementation from PQClean on commit
// ee71d2c823982bfcf54686f3cf1d666f396dc9aa. After the invNTT, the coefficients
// are NOT canonically reduced. The ordering of the coefficients is canonical,
// also matching PQClean.

.data
.p2align 4
roots:
#include "intt_123_45_67_twiddles.S"
.text

        .global intt_asm_opt
        .global _intt_asm_opt

.p2align 4
const_addr:       .short 3329
                  .short 20159
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
ninv_addr:        .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
ninv_tw_addr:     .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040

intt_asm_opt:
_intt_asm_opt:
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15

        q_data0  .req q8
        q_data1  .req q9
        q_data2  .req q10
        q_data3  .req q11
        q_data4  .req q12
        q_data5  .req q13
        q_data6  .req q14
        q_data7  .req q15

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6

        consts     .req v7
        q_consts   .req q7

        q_root0    .req q0
        q_root1    .req q1
        q_root2    .req q2
        q_root0_tw .req q4
        q_root1_tw .req q5
        q_root2_tw .req q6

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        ASM_LOAD(r_ptr0, roots_l34)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]

        mov inp, in
        mov count, #8

        .p2align 2
                                                // Instructions:    53
                                                // Expected cycles: 57
                                                // Expected IPC:    0.93
                                                //
                                                // Cycle bound:     57.0
                                                // IPC bound:       0.93
                                                //
                                                // Wall time:     2.34s
                                                // User time:     2.34s
                                                //
                                                // ------------------- cycle (expected) ------------------->
                                                // 0                        25                       50
                                                // |------------------------|------------------------|------
        ldr q3, [x1, #0]                        // *........................................................
        ldr q20, [x1, #16]                      // *........................................................
        ldr q21, [x1, #32]                      // .*.......................................................
        ldr q13, [x1, #48]                      // .*.......................................................
        ldr q24, [x4, #48]                      // ..*......................................................
        ldr q26, [x4, #80]                      // ..*......................................................
        ldr q25, [x4, #16]                      // ...*.....................................................
        ldr q9, [x3], #16                       // ...*.....................................................
        trn1 v14.4S, v3.4S, v20.4S              // ....*....................................................
        trn2 v18.4S, v3.4S, v20.4S              // ....*....................................................
        ldr q27, [x4], #(6*16)                  // ....*....................................................
        trn1 v31.4S, v21.4S, v13.4S             // .....*...................................................
        trn2 v15.4S, v21.4S, v13.4S             // .....*...................................................
        trn2 v8.2D, v18.2D, v15.2D              // ........*................................................
        trn2 v11.2D, v14.2D, v31.2D             // ........*................................................
        trn1 v0.2D, v14.2D, v31.2D              // .........*...............................................
        trn1 v2.2D, v18.2D, v15.2D              // .........*...............................................
        sub v23.8H, v11.8H, v8.8H               // ...........*.............................................
        ldr q22, [x4, #-32]                     // ............*............................................
        sub v1.8H, v0.8H, v2.8H                 // ............*............................................
        add v0.8H, v0.8H, v2.8H                 // ............*............................................
        sqrdmulh v6.8H, v23.8H, v26.8H          // ..............*..........................................
        ldr q18, [x4, #-64]                     // ................*........................................
        sqrdmulh v14.8H, v1.8H, v24.8H          // ................*........................................
        mul v16.8H, v23.8H, v22.8H              // ..................*......................................
        add v23.8H, v11.8H, v8.8H               // ..................*......................................
        mul v18.8H, v1.8H, v18.8H               // ....................*....................................
        mls v18.8H, v14.8H, v7.H[0]             // ......................*..................................
        sub v14.8H, v0.8H, v23.8H               // ......................*..................................
        mls v16.8H, v6.8H, v7.H[0]              // ........................*................................
        sqrdmulh v17.8H, v14.8H, v25.8H         // ..........................*..............................
        mul v11.8H, v14.8H, v27.8H              // ............................*............................
        add v31.8H, v18.8H, v16.8H              // .............................*...........................
        sub v10.8H, v18.8H, v16.8H              // ..............................*..........................
        mls v11.8H, v17.8H, v7.H[0]             // ...............................*.........................
        sqrdmulh v2.8H, v10.8H, v25.8H          // .................................*.......................
        add v13.8H, v0.8H, v23.8H               // .................................*.......................
        mul v16.8H, v10.8H, v27.8H              // ...................................*.....................
        trn2 v20.4S, v13.4S, v31.4S             // ....................................*....................
        trn1 v8.4S, v13.4S, v31.4S              // .....................................*...................
        mls v16.8H, v2.8H, v7.H[0]              // ......................................*..................
        trn1 v23.4S, v11.4S, v16.4S             // ...........................................*.............
        trn2 v10.4S, v11.4S, v16.4S             // ...........................................*.............
        trn1 v0.2D, v8.2D, v23.2D               // ..............................................*..........
        trn1 v14.2D, v20.2D, v10.2D             // ..............................................*..........
        trn2 v13.2D, v8.2D, v23.2D              // ................................................*........
        trn2 v23.2D, v20.2D, v10.2D             // ................................................*........
        sub v6.8H, v0.8H, v14.8H                // .................................................*.......
        add v24.8H, v13.8H, v23.8H              // ...................................................*.....
        sub v13.8H, v13.8H, v23.8H              // ...................................................*.....
        sqrdmulh v18.8H, v6.8H, v9.H[3]         // ....................................................*....
        sqrdmulh v22.8H, v13.8H, v9.H[5]        // ......................................................*..
        mul v27.8H, v13.8H, v9.H[4]             // ........................................................*

                                                 // ------------------- cycle (expected) ------------------->
                                                 // 0                        25                       50
                                                 // |------------------------|------------------------|------
        // ldr q28, [x1, #0]                     // *........................................................
        // ldr q11, [x1, #16]                    // *........................................................
        // ldr q12, [x1, #48]                    // .*.......................................................
        // ldr q1, [x1, #32]                     // .*.......................................................
        // ldr q22, [x4, #16]                    // ...*.....................................................
        // ldr q17, [x4], #(6*16)                // ....*....................................................
        // ldr q5, [x4, #-16]                    // ..*......................................................
        // ldr q4, [x4, #-32]                    // ............*............................................
        // trn1 v2.4S, v28.4S, v11.4S            // ....*....................................................
        // ldr q31, [x4, #-64]                   // ................*........................................
        // trn1 v23.4S, v1.4S, v12.4S            // .....*...................................................
        // trn2 v30.4S, v1.4S, v12.4S            // .....*...................................................
        // trn2 v15.4S, v28.4S, v11.4S           // ....*....................................................
        // trn1 v29.2D, v2.2D, v23.2D            // .........*...............................................
        // trn2 v26.2D, v2.2D, v23.2D            // ........*................................................
        // trn2 v18.2D, v15.2D, v30.2D           // ........*................................................
        // sub v20.8H, v26.8H, v18.8H            // ...........*.............................................
        // trn1 v11.2D, v15.2D, v30.2D           // .........*...............................................
        // add v25.8H, v26.8H, v18.8H            // ..................*......................................
        // sqrdmulh v21.8H, v20.8H, v5.8H        // ..............*..........................................
        // ldr q19, [x4, #-48]                   // ..*......................................................
        // sub v23.8H, v29.8H, v11.8H            // ............*............................................
        // add v30.8H, v29.8H, v11.8H            // ............*............................................
        // mul v5.8H, v20.8H, v4.8H              // ..................*......................................
        // sqrdmulh v20.8H, v23.8H, v19.8H       // ................*........................................
        // add v18.8H, v30.8H, v25.8H            // .................................*.......................
        // mls v5.8H, v21.8H, v7.H[0]            // ........................*................................
        // sub v8.8H, v30.8H, v25.8H             // ......................*..................................
        // mul v16.8H, v23.8H, v31.8H            // ....................*....................................
        // mls v16.8H, v20.8H, v7.H[0]           // ......................*..................................
        // sqrdmulh v15.8H, v8.8H, v22.8H        // ..........................*..............................
        // add v4.8H, v16.8H, v5.8H              // .............................*...........................
        // sub v28.8H, v16.8H, v5.8H             // ..............................*..........................
        // mul v24.8H, v8.8H, v17.8H             // ............................*............................
        // trn2 v25.4S, v18.4S, v4.4S            // ....................................*....................
        // mls v24.8H, v15.8H, v7.H[0]           // ...............................*.........................
        // trn1 v2.4S, v18.4S, v4.4S             // .....................................*...................
        // sqrdmulh v11.8H, v28.8H, v22.8H       // .................................*.......................
        // mul v21.8H, v28.8H, v17.8H            // ...................................*.....................
        // mls v21.8H, v11.8H, v7.H[0]           // ......................................*..................
        // trn1 v10.4S, v24.4S, v21.4S           // ...........................................*.............
        // trn2 v29.4S, v24.4S, v21.4S           // ...........................................*.............
        // trn2 v22.2D, v2.2D, v10.2D            // ................................................*........
        // trn2 v23.2D, v25.2D, v29.2D           // ................................................*........
        // ldr q9, [x3], #16                     // ...*.....................................................
        // trn1 v0.2D, v2.2D, v10.2D             // ..............................................*..........
        // sub v31.8H, v22.8H, v23.8H            // ...................................................*.....
        // trn1 v14.2D, v25.2D, v29.2D           // ..............................................*..........
        // add v24.8H, v22.8H, v23.8H            // ...................................................*.....
        // sqrdmulh v22.8H, v31.8H, v9.H[5]      // ......................................................*..
        // sub v6.8H, v0.8H, v14.8H              // .................................................*.......
        // mul v27.8H, v31.8H, v9.H[4]           // ........................................................*
        // sqrdmulh v18.8H, v6.8H, v9.H[3]       // ....................................................*....

        sub count, count, #1
layer4567_start:
                                                // Instructions:    83
                                                // Expected cycles: 65
                                                // Expected IPC:    1.28
                                                //
                                                // Cycle bound:     65.0
                                                // IPC bound:       1.28
                                                //
                                                // Wall time:     79.40s
                                                // User time:     79.40s
                                                //
                                                // ----------------------- cycle (expected) ----------------------->
                                                // 0                        25                       50
                                                // |------------------------|------------------------|--------------
        ldr q28, [x1, #64]                      // e................................................................
        add v16.8H, v0.8H, v14.8H               // *................................................................
        ldr q11, [x1, #80]                      // e................................................................
        ldr q12, [x1, #112]                     // .e...............................................................
        ldr q1, [x1, #96]                       // .e...............................................................
        mls v27.8H, v22.8H, v7.H[0]             // .*...............................................................
        ldr q22, [x4, #16]                      // ..e..............................................................
        ldr q17, [x4], #(6*16)                  // ..e..............................................................
        ldr q5, [x4, #-16]                      // ...e.............................................................
        ldr q4, [x4, #-32]                      // ...e.............................................................
        sqdmulh v13.8H, v24.8H, v7.H[1]         // ...*.............................................................
        trn1 v2.4S, v28.4S, v11.4S              // ....e............................................................
        ldr q31, [x4, #-64]                     // ....e............................................................
        sqdmulh v21.8H, v16.8H, v7.H[1]         // .....*...........................................................
        trn1 v23.4S, v1.4S, v12.4S              // .....e...........................................................
        trn2 v30.4S, v1.4S, v12.4S              // ......e..........................................................
        trn2 v15.4S, v28.4S, v11.4S             // .......e.........................................................
        sqdmulh v12.8H, v27.8H, v7.H[1]         // .......*.........................................................
        trn1 v29.2D, v2.2D, v23.2D              // ........e........................................................
        srshr v13.8H, v13.8H, #11               // .........*.......................................................
        mul v10.8H, v6.8H, v9.H[2]              // .........*.......................................................
        trn2 v26.2D, v2.2D, v23.2D              // ..........e......................................................
        mls v10.8H, v18.8H, v7.H[0]             // ...........*.....................................................
        trn2 v18.2D, v15.2D, v30.2D             // ...........e.....................................................
        srshr v21.8H, v21.8H, #11               // ............*....................................................
        srshr v6.8H, v12.8H, #11                // .............*...................................................
        mls v24.8H, v13.8H, v7.H[0]             // .............*...................................................
        sub v20.8H, v26.8H, v18.8H              // ..............e..................................................
        trn1 v11.2D, v15.2D, v30.2D             // ...............e.................................................
        mls v16.8H, v21.8H, v7.H[0]             // ...............*.................................................
        add v25.8H, v26.8H, v18.8H              // ................e................................................
        sqrdmulh v21.8H, v20.8H, v5.8H          // .................e...............................................
        ldr q19, [x4, #-48]                     // .................e...............................................
        sub v23.8H, v29.8H, v11.8H              // ..................e..............................................
        add v30.8H, v29.8H, v11.8H              // ...................e.............................................
        mul v5.8H, v20.8H, v4.8H                // ...................e.............................................
        sub v3.8H, v16.8H, v24.8H               // ....................*............................................
        sqrdmulh v20.8H, v23.8H, v19.8H         // .....................e...........................................
        add v13.8H, v16.8H, v24.8H              // .....................*...........................................
        add v18.8H, v30.8H, v25.8H              // ......................e..........................................
        mls v5.8H, v21.8H, v7.H[0]              // .......................e.........................................
        sub v8.8H, v30.8H, v25.8H               // .......................e.........................................
        str q13, [x1], #(64)                    // ........................*........................................
        mul v16.8H, v23.8H, v31.8H              // .........................e.......................................
        mls v16.8H, v20.8H, v7.H[0]             // ...........................e.....................................
        sqrdmulh v15.8H, v8.8H, v22.8H          // .............................e...................................
        sqdmulh v13.8H, v10.8H, v7.H[1]         // ...............................*.................................
        add v4.8H, v16.8H, v5.8H                // ................................e................................
        sub v28.8H, v16.8H, v5.8H               // .................................e...............................
        mul v24.8H, v8.8H, v17.8H               // .................................e...............................
        trn2 v25.4S, v18.4S, v4.4S              // ...................................e.............................
        mls v24.8H, v15.8H, v7.H[0]             // ...................................e.............................
        trn1 v2.4S, v18.4S, v4.4S               // ....................................e............................
        mls v27.8H, v6.8H, v7.H[0]              // .....................................*...........................
        srshr v13.8H, v13.8H, #11               // .....................................*...........................
        sqrdmulh v11.8H, v28.8H, v22.8H         // .......................................e.........................
        mul v21.8H, v28.8H, v17.8H              // .........................................e.......................
        mls v10.8H, v13.8H, v7.H[0]             // ...........................................*.....................
        mls v21.8H, v11.8H, v7.H[0]             // .............................................e...................
        sqrdmulh v6.8H, v3.8H, v9.H[1]          // ...............................................*.................
        add v13.8H, v10.8H, v27.8H              // ................................................*................
        mul v12.8H, v3.8H, v9.H[0]              // .................................................*...............
        sub v3.8H, v10.8H, v27.8H               // .................................................*...............
        trn1 v10.4S, v24.4S, v21.4S             // ..................................................e..............
        str q13, [x1, #-48]                     // ...................................................*.............
        trn2 v29.4S, v24.4S, v21.4S             // ...................................................e.............
        sqrdmulh v14.8H, v3.8H, v9.H[1]         // ....................................................*............
        trn2 v22.2D, v2.2D, v10.2D              // .....................................................e...........
        mul v17.8H, v3.8H, v9.H[0]              // ......................................................*..........
        trn2 v23.2D, v25.2D, v29.2D             // ......................................................e..........
        ldr q9, [x3], #16                       // ......................................................e..........
        trn1 v0.2D, v2.2D, v10.2D               // .......................................................e.........
        mls v12.8H, v6.8H, v7.H[0]              // ........................................................*........
        sub v31.8H, v22.8H, v23.8H              // .........................................................e.......
        mls v17.8H, v14.8H, v7.H[0]             // ..........................................................*......
        trn1 v14.2D, v25.2D, v29.2D             // ..........................................................e......
        add v24.8H, v22.8H, v23.8H              // ...........................................................e.....
        sqrdmulh v22.8H, v31.8H, v9.H[5]        // ............................................................e....
        str q12, [x1, #-32]                     // .............................................................*...
        sub v6.8H, v0.8H, v14.8H                // .............................................................e...
        mul v27.8H, v31.8H, v9.H[4]             // ..............................................................e..
        str q17, [x1, #-16]                     // ...............................................................*.
        sqrdmulh v18.8H, v6.8H, v9.H[3]         // ................................................................e

                                                      // ------------------------------------------------------- cycle (expected) ------------------------------------------------------->
                                                      // 0                        25                       50                       75                       100                      125
                                                      // |------------------------|------------------------|------------------------|------------------------|------------------------|---
        // ldr q8, [x1, #(16*0)]                      // e................................................................~...............................................................
        // ldr q9, [x1, #(16*1)]                      // e................................................................~...............................................................
        // ldr q10, [x1, #(16*2)]                     // .e...............................................................'~..............................................................
        // ldr q11, [x1, #(16*3)]                     // .e...............................................................'~..............................................................
        // trn1 v25.4s, v8.4s, v9.4s                  // ....e............................................................'...~...........................................................
        // trn2 v26.4s, v8.4s, v9.4s                  // .......e.........................................................'......~........................................................
        // trn1 v27.4s, v10.4s, v11.4s                // .....e...........................................................'....~..........................................................
        // trn2 v28.4s, v10.4s, v11.4s                // ......e..........................................................'.....~.........................................................
        // trn2 v10.2d, v25.2d, v27.2d                // ..........e......................................................'.........~.....................................................
        // trn2 v11.2d, v26.2d, v28.2d                // ...........e.....................................................'..........~....................................................
        // trn1 v8.2d, v25.2d, v27.2d                 // ........e........................................................'.......~.......................................................
        // trn1 v9.2d, v26.2d, v28.2d                 // ...............e.................................................'..............~................................................
        // ldr q0,    [x4], #(6*16)                   // ..e..............................................................'.~.............................................................
        // ldr q4, [x4, #(-6*16 + 1*16)]              // ..e..............................................................'.~.............................................................
        // ldr q1,    [x4, #(-6*16 + 2*16)]           // ....e............................................................'...~...........................................................
        // ldr q5, [x4, #(-6*16 + 3*16)]              // .................e...............................................'................~..............................................
        // ldr q2,    [x4, #(-6*16 + 4*16)]           // ...e.............................................................'..~............................................................
        // ldr q6, [x4, #(-6*16 + 5*16)]              // ...e.............................................................'..~............................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ..................e..............................................'.................~.............................................
        // add v8.8h, v8.8h, v9.8h                    // ...................e.............................................'..................~............................................
        // sqrdmulh v27.8h,      v24.8h, v5.8h        // .....................e...........................................'....................~..........................................
        // mul      v9.8h, v24.8h, v1.8h              // .........................e.......................................'........................~......................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ...........................e.....................................'..........................~....................................
        // sub v24.8h,   v10.8h, v11.8h               // ..............e..................................................'.............~.................................................
        // add v10.8h, v10.8h, v11.8h                 // ................e................................................'...............~...............................................
        // sqrdmulh v27.8h,      v24.8h, v6.8h        // .................e...............................................'................~..............................................
        // mul      v11.8h, v24.8h, v2.8h             // ...................e.............................................'..................~............................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // .......................e.........................................'......................~........................................
        // sub v24.8h,   v8.8h, v10.8h                // .......................e.........................................'......................~........................................
        // add v8.8h, v8.8h, v10.8h                   // ......................e..........................................'.....................~.........................................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // .............................e...................................'............................~..................................
        // mul      v10.8h, v24.8h, v0.8h             // .................................e...............................'................................~..............................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ...................................e.............................'..................................~............................
        // sub v24.8h,   v9.8h, v11.8h                // .................................e...............................'................................~..............................
        // add v9.8h, v9.8h, v11.8h                   // ................................e................................'...............................~...............................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // .......................................e.........................'......................................~........................
        // mul      v11.8h, v24.8h, v0.8h             // .........................................e.......................'........................................~......................
        // mls      v11.8h, v27.8h,      v7.h[0]      // .............................................e...................'............................................~..................
        // trn1 v25.4s, v8.4s, v9.4s                  // ....................................e............................'...................................~...........................
        // trn2 v26.4s, v8.4s, v9.4s                  // ...................................e.............................'..................................~............................
        // trn1 v27.4s, v10.4s, v11.4s                // ..................................................e..............'.................................................~.............
        // trn2 v28.4s, v10.4s, v11.4s                // ...................................................e.............'..................................................~............
        // trn2 v10.2d, v25.2d, v27.2d                // .....................................................e...........'....................................................~..........
        // trn2 v11.2d, v26.2d, v28.2d                // ......................................................e..........'.....................................................~.........
        // trn1 v8.2d, v25.2d, v27.2d                 // .......................................................e.........'......................................................~........
        // trn1 v9.2d, v26.2d, v28.2d                 // ..........................................................e......'.........................................................~.....
        // ldr q0, [x3], #16                          // ......................................................e..........'.....................................................~.........
        // sub v24.8h,   v8.8h, v9.8h                 // .............................................................e...'............................................................~..
        // add v8.8h, v8.8h, v9.8h                    // ~................................................................*...............................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ................................................................e'...............................................................
        // mul      v9.8h, v24.8h, v0.h[2]            // .........~.......................................................'........*......................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ...........~.....................................................'..........*....................................................
        // sub v24.8h,   v10.8h, v11.8h               // .........................................................e.......'........................................................~......
        // add v10.8h, v10.8h, v11.8h                 // ...........................................................e.....'..........................................................~....
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ............................................................e....'...........................................................~...
        // mul      v11.8h, v24.8h, v0.h[4]           // ..............................................................e..'.............................................................~.
        // mls      v11.8h, v27.8h,      v7.h[0]      // .~...............................................................'*..............................................................
        // sqdmulh v25.8h,    v8.8h, v7.h[1]          // .....~...........................................................'....*..........................................................
        // srshr   v25.8h,    v25.8h,    #11          // ............~....................................................'...........*...................................................
        // mls     v8.8h, v25.8h,    v7.h[0]          // ...............~.................................................'..............*................................................
        // sqdmulh v25.8h,    v10.8h, v7.h[1]         // ...~.............................................................'..*............................................................
        // srshr   v25.8h,    v25.8h,    #11          // .........~.......................................................'........*......................................................
        // mls     v10.8h, v25.8h,    v7.h[0]         // .............~...................................................'............*..................................................
        // sqdmulh v25.8h,    v9.8h, v7.h[1]          // ...............................~.................................'..............................*................................
        // srshr   v25.8h,    v25.8h,    #11          // .....................................~...........................'....................................*..........................
        // mls     v9.8h, v25.8h,    v7.h[0]          // ...........................................~.....................'..........................................*....................
        // sqdmulh v25.8h,    v11.8h, v7.h[1]         // .......~.........................................................'......*........................................................
        // srshr   v25.8h,    v25.8h,    #11          // .............~...................................................'............*..................................................
        // mls     v11.8h, v25.8h,    v7.h[0]         // .....................................~...........................'....................................*..........................
        // sub v24.8h,   v8.8h, v10.8h                // ....................~............................................'...................*...........................................
        // add v8.8h, v8.8h, v10.8h                   // .....................~...........................................'....................*..........................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...............................................~.................'..............................................*................
        // mul      v10.8h, v24.8h, v0.h[0]           // .................................................~...............'................................................*..............
        // mls      v10.8h, v27.8h,      v7.h[0]      // ........................................................~........'.......................................................*.......
        // sub v24.8h,   v9.8h, v11.8h                // .................................................~...............'................................................*..............
        // add v9.8h, v9.8h, v11.8h                   // ................................................~................'...............................................*...............
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ....................................................~............'...................................................*...........
        // mul      v11.8h, v24.8h, v0.h[0]           // ......................................................~..........'.....................................................*.........
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..........................................................~......'.........................................................*.....
        // str q8, [x1], #(64)                        // ........................~........................................'.......................*.......................................
        // str q9, [x1, #(-64 + 16*1)]                // ...................................................~.............'..................................................*............
        // str q10, [x1, #(-64 + 16*2)]               // .............................................................~...'............................................................*..
        // str q11, [x1, #(-64 + 16*3)]               // ...............................................................~.'..............................................................*

        sub count, count, #1
        cbnz count, layer4567_start
                                                // Instructions:    30
                                                // Expected cycles: 40
                                                // Expected IPC:    0.75
                                                //
                                                // Cycle bound:     40.0
                                                // IPC bound:       0.75
                                                //
                                                // Wall time:     0.18s
                                                // User time:     0.18s
                                                //
                                                // ---------- cycle (expected) ----------->
                                                // 0                        25
                                                // |------------------------|--------------
        add v13.8H, v0.8H, v14.8H               // *.......................................
        mls v27.8H, v22.8H, v7.H[0]             // *.......................................
        mul v10.8H, v6.8H, v9.H[2]              // ..*.....................................
        mls v10.8H, v18.8H, v7.H[0]             // ....*...................................
        sqdmulh v21.8H, v24.8H, v7.H[1]         // ......*.................................
        sqdmulh v3.8H, v13.8H, v7.H[1]          // ........*...............................
        sqdmulh v12.8H, v27.8H, v7.H[1]         // ..........*.............................
        srshr v21.8H, v21.8H, #11               // ...........*............................
        sqdmulh v6.8H, v10.8H, v7.H[1]          // ............*...........................
        srshr v3.8H, v3.8H, #11                 // .............*..........................
        mls v24.8H, v21.8H, v7.H[0]             // ..............*.........................
        srshr v21.8H, v12.8H, #11               // ...............*........................
        mls v13.8H, v3.8H, v7.H[0]              // ................*.......................
        srshr v3.8H, v6.8H, #11                 // .................*......................
        mls v27.8H, v21.8H, v7.H[0]             // ..................*.....................
        mls v10.8H, v3.8H, v7.H[0]              // ....................*...................
        sub v21.8H, v13.8H, v24.8H              // .....................*..................
        add v13.8H, v13.8H, v24.8H              // ......................*.................
        sqrdmulh v3.8H, v21.8H, v9.H[1]         // ........................*...............
        str q13, [x1], #(64)                    // .........................*..............
        sub v13.8H, v10.8H, v27.8H              // .........................*..............
        add v10.8H, v10.8H, v27.8H              // ..........................*.............
        mul v21.8H, v21.8H, v9.H[0]             // ..........................*.............
        sqrdmulh v12.8H, v13.8H, v9.H[1]        // ............................*...........
        str q10, [x1, #-48]                     // .............................*..........
        mul v13.8H, v13.8H, v9.H[0]             // ..............................*.........
        mls v21.8H, v3.8H, v7.H[0]              // ................................*.......
        mls v13.8H, v12.8H, v7.H[0]             // ..................................*.....
        str q21, [x1, #-32]                     // .....................................*..
        str q13, [x1, #-16]                     // .......................................*

                                                // ---------- cycle (expected) ----------->
                                                // 0                        25
                                                // |------------------------|--------------
        // add v16.8H, v0.8H, v14.8H            // *.......................................
        // mls v27.8H, v22.8H, v7.H[0]          // *.......................................
        // sqdmulh v13.8H, v24.8H, v7.H[1]      // ......*.................................
        // sqdmulh v21.8H, v16.8H, v7.H[1]      // ........*...............................
        // sqdmulh v12.8H, v27.8H, v7.H[1]      // ..........*.............................
        // srshr v13.8H, v13.8H, #11            // ...........*............................
        // mul v10.8H, v6.8H, v9.H[2]           // ..*.....................................
        // mls v10.8H, v18.8H, v7.H[0]          // ....*...................................
        // srshr v21.8H, v21.8H, #11            // .............*..........................
        // srshr v6.8H, v12.8H, #11             // ...............*........................
        // mls v24.8H, v13.8H, v7.H[0]          // ..............*.........................
        // mls v16.8H, v21.8H, v7.H[0]          // ................*.......................
        // sub v3.8H, v16.8H, v24.8H            // .....................*..................
        // add v13.8H, v16.8H, v24.8H           // ......................*.................
        // str q13, [x1], #(64)                 // .........................*..............
        // sqdmulh v13.8H, v10.8H, v7.H[1]      // ............*...........................
        // mls v27.8H, v6.8H, v7.H[0]           // ..................*.....................
        // srshr v13.8H, v13.8H, #11            // .................*......................
        // mls v10.8H, v13.8H, v7.H[0]          // ....................*...................
        // sqrdmulh v6.8H, v3.8H, v9.H[1]       // ........................*...............
        // add v13.8H, v10.8H, v27.8H           // ..........................*.............
        // mul v12.8H, v3.8H, v9.H[0]           // ..........................*.............
        // sub v3.8H, v10.8H, v27.8H            // .........................*..............
        // str q13, [x1, #-48]                  // .............................*..........
        // sqrdmulh v14.8H, v3.8H, v9.H[1]      // ............................*...........
        // mul v17.8H, v3.8H, v9.H[0]           // ..............................*.........
        // mls v12.8H, v6.8H, v7.H[0]           // ................................*.......
        // mls v17.8H, v14.8H, v7.H[0]          // ..................................*.....
        // str q12, [x1, #-32]                  // .....................................*..
        // str q17, [x1, #-16]                  // .......................................*


        // ---------------------------------------------------------------------

        ninv             .req v29
        ninv_tw          .req v30

        ASM_LOAD(xtmp, ninv_addr)
        ld1r {ninv.8h}, [xtmp]
        ASM_LOAD(xtmp, ninv_tw_addr)
        ld1r {ninv_tw.8h}, [xtmp]

        mov count, #4
        ASM_LOAD(r_ptr0, roots_l012)
        load_roots_123

        .p2align 2

                                                // Instructions:    12
                                                // Expected cycles: 10
                                                // Expected IPC:    1.20
                                                //
                                                // Cycle bound:     10.0
                                                // IPC bound:       1.20
                                                //
                                                // Wall time:     0.02s
                                                // User time:     0.02s
                                                //
                                                // ----- cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|----
        ldr q21, [x0, #448]                     // *.............................
        ldr q4, [x0, #384]                      // *.............................
        ldr q11, [x0, #0]                       // .*............................
        ldr q31, [x0, #128]                     // ..*...........................
        ldr q9, [x0, #192]                      // ...*..........................
        sub v17.8H, v4.8H, v21.8H               // ....*.........................
        ldr q19, [x0, #256]                     // ....*.........................
        add v24.8H, v4.8H, v21.8H               // .....*........................
        ldr q25, [x0, #64]                      // .....*........................
        sub v27.8H, v31.8H, v9.8H               // .......*......................
        sqrdmulh v15.8H, v17.8H, v1.H[5]        // .......*......................
        mul v21.8H, v17.8H, v1.H[4]             // .........*....................

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ldr q2, [x0, #384]                   // *..............................
        // ldr q11, [x0, #0]                    // .*.............................
        // ldr q25, [x0, #64]                   // .....*.........................
        // ldr q19, [x0, #256]                  // ....*..........................
        // ldr q31, [x0, #128]                  // ..*............................
        // ldr q5, [x0, #448]                   // *..............................
        // add v24.8H, v2.8H, v5.8H             // .....*.........................
        // sub v8.8H, v2.8H, v5.8H              // ....*..........................
        // ldr q9, [x0, #192]                   // ...*...........................
        // sub v27.8H, v31.8H, v9.8H            // .......*.......................
        // sqrdmulh v15.8H, v8.8H, v1.H[5]      // .......*.......................
        // mul v21.8H, v8.8H, v1.H[4]           // .........*.....................

        sub count, count, #1
layer123_start:
                                                // Instructions:    88
                                                // Expected cycles: 96
                                                // Expected IPC:    0.92
                                                //
                                                // Cycle bound:     96.0
                                                // IPC bound:       0.92
                                                //
                                                // Wall time:     23.46s
                                                // User time:     23.46s
                                                //
                                                // -------------------------------------- cycle (expected) --------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------------------
        mul v18.8H, v27.8H, v1.H[0]             // *...............................................................................................
        sub v16.8H, v11.8H, v25.8H              // *...............................................................................................
        ldr q12, [x0, #320]                     // *...............................................................................................
        add v26.8H, v31.8H, v9.8H               // .*..............................................................................................
        mls v21.8H, v15.8H, v7.H[0]             // ..*.............................................................................................
        ldr q2, [x0, #400]                      // ..e.............................................................................................
        add v3.8H, v19.8H, v12.8H               // ....*...........................................................................................
        sqrdmulh v23.8H, v16.8H, v0.H[7]        // ....*...........................................................................................
        add v20.8H, v11.8H, v25.8H              // .....*..........................................................................................
        sqrdmulh v9.8H, v27.8H, v1.H[1]         // ......*.........................................................................................
        ldr q11, [x0, #16]                      // ......e.........................................................................................
        add v8.8H, v3.8H, v24.8H                // .......*........................................................................................
        ldr q25, [x0, #80]                      // .......e........................................................................................
        sub v24.8H, v3.8H, v24.8H               // ........*.......................................................................................
        mul v10.8H, v16.8H, v0.H[6]             // ........*.......................................................................................
        sub v6.8H, v20.8H, v26.8H               // .........*......................................................................................
        mls v10.8H, v23.8H, v7.H[0]             // ..........*.....................................................................................
        sub v13.8H, v19.8H, v12.8H              // ..........*.....................................................................................
        mls v18.8H, v9.8H, v7.H[0]              // ............*...................................................................................
        add v9.8H, v20.8H, v26.8H               // ............*...................................................................................
        sqrdmulh v12.8H, v13.8H, v1.H[3]        // ..............*.................................................................................
        sqrdmulh v31.8H, v24.8H, v0.H[5]        // ................*...............................................................................
        sub v19.8H, v10.8H, v18.8H              // .................*..............................................................................
        mul v3.8H, v13.8H, v1.H[2]              // ..................*.............................................................................
        add v28.8H, v10.8H, v18.8H              // ..................*.............................................................................
        add v17.8H, v9.8H, v8.8H                // ...................*............................................................................
        mls v3.8H, v12.8H, v7.H[0]              // ....................*...........................................................................
        sub v13.8H, v9.8H, v8.8H                // ....................*...........................................................................
        sqrdmulh v27.8H, v19.8H, v0.H[3]        // ......................*.........................................................................
        sqrdmulh v14.8H, v6.8H, v0.H[3]         // ........................*.......................................................................
        sub v15.8H, v3.8H, v21.8H               // .........................*......................................................................
        add v23.8H, v3.8H, v21.8H               // ..........................*.....................................................................
        mul v8.8H, v24.8H, v0.H[4]              // ..........................*.....................................................................
        mls v8.8H, v31.8H, v7.H[0]              // ............................*...................................................................
        add v18.8H, v28.8H, v23.8H              // .............................*..................................................................
        mul v24.8H, v6.8H, v0.H[2]              // ..............................*.................................................................
        sub v16.8H, v28.8H, v23.8H              // ..............................*.................................................................
        mls v24.8H, v14.8H, v7.H[0]             // ................................*...............................................................
        sqrdmulh v22.8H, v17.8H, v30.8H         // ..................................*.............................................................
        mul v9.8H, v19.8H, v0.H[2]              // ....................................*...........................................................
        ldr q19, [x0, #272]                     // .....................................e..........................................................
        sub v10.8H, v24.8H, v8.8H               // .....................................*..........................................................
        ldr q31, [x0, #144]                     // ......................................e.........................................................
        sqrdmulh v26.8H, v15.8H, v0.H[5]        // ......................................*.........................................................
        add v21.8H, v24.8H, v8.8H               // .......................................*........................................................
        ldr q5, [x0, #464]                      // .......................................e........................................................
        mul v12.8H, v17.8H, v29.8H              // ........................................*.......................................................
        mul v6.8H, v15.8H, v0.H[4]              // ..........................................*.....................................................
        add v24.8H, v2.8H, v5.8H                // ...........................................e....................................................
        mls v9.8H, v27.8H, v7.H[0]              // ............................................*...................................................
        sqrdmulh v3.8H, v13.8H, v0.H[1]         // ..............................................*.................................................
        mul v4.8H, v13.8H, v0.H[0]              // ................................................*...............................................
        mul v20.8H, v18.8H, v29.8H              // ..................................................*.............................................
        mls v4.8H, v3.8H, v7.H[0]               // ....................................................*...........................................
        sqrdmulh v17.8H, v16.8H, v0.H[1]        // ......................................................*.........................................
        mls v6.8H, v26.8H, v7.H[0]              // ........................................................*.......................................
        str q4, [x0, #256]                      // .........................................................*......................................
        sqrdmulh v13.8H, v10.8H, v0.H[1]        // ..........................................................*.....................................
        mul v27.8H, v16.8H, v0.H[0]             // ............................................................*...................................
        sub v23.8H, v9.8H, v6.8H                // .............................................................*..................................
        add v9.8H, v9.8H, v6.8H                 // ..............................................................*.................................
        mls v27.8H, v17.8H, v7.H[0]             // ..............................................................*.................................
        sub v8.8H, v2.8H, v5.8H                 // ................................................................e...............................
        sqrdmulh v6.8H, v18.8H, v30.8H          // ................................................................*...............................
        sqrdmulh v16.8H, v9.8H, v30.8H          // ..................................................................*.............................
        str q27, [x0, #320]                     // ...................................................................*............................
        mul v3.8H, v10.8H, v0.H[0]              // ....................................................................*...........................
        mls v3.8H, v13.8H, v7.H[0]              // ......................................................................*.........................
        sqrdmulh v10.8H, v23.8H, v0.H[1]        // ........................................................................*.......................
        mul v5.8H, v23.8H, v0.H[0]              // ..........................................................................*.....................
        str q3, [x0, #384]                      // ...........................................................................*....................
        mls v12.8H, v22.8H, v7.H[0]             // ............................................................................*...................
        mls v5.8H, v10.8H, v7.H[0]              // ..............................................................................*.................
        mul v10.8H, v21.8H, v29.8H              // ................................................................................*...............
        str q12, [x0], #(16)                    // .................................................................................*..............
        mls v20.8H, v6.8H, v7.H[0]              // ..................................................................................*.............
        str q5, [x0, #432]                      // ...................................................................................*............
        sqrdmulh v12.8H, v21.8H, v30.8H         // ....................................................................................*...........
        mul v13.8H, v9.8H, v29.8H               // ......................................................................................*.........
        str q20, [x0, #48]                      // .......................................................................................*........
        ldr q9, [x0, #192]                      // .......................................................................................e........
        mls v13.8H, v16.8H, v7.H[0]             // ........................................................................................*.......
        mls v10.8H, v12.8H, v7.H[0]             // ..........................................................................................*.....
        sub v27.8H, v31.8H, v9.8H               // ...........................................................................................e....
        sqrdmulh v15.8H, v8.8H, v1.H[5]         // ............................................................................................e...
        str q13, [x0, #176]                     // .............................................................................................*..
        mul v21.8H, v8.8H, v1.H[4]              // ..............................................................................................e.
        str q10, [x0, #112]                     // ...............................................................................................*

                                                      // ------------------------------------------------------------------------------------- cycle (expected) -------------------------------------------------------------------------------------->
                                                      // 0                        25                       50                       75                       100                      125                      150                      175
                                                      // |------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|--------------
        // ldr q8, [x0, #0]                           // ....e.........................................................................................'.....~.........................................................................................
        // ldr q9, [x0, #(1*(512/8))]                 // .....e........................................................................................'......~........................................................................................
        // ldr q10, [x0, #(2*(512/8))]                // ....................................e.........................................................'.....................................~.........................................................
        // ldr q11, [x0, #(3*(512/8))]                // .....................................................................................e........'......................................................................................~........
        // ldr q12, [x0, #(4*(512/8))]                // ...................................e..........................................................'....................................~..........................................................
        // ldr q13, [x0, #(5*(512/8))]                // ..............................................................................................*...............................................................................................
        // ldr q14, [x0, #(6*(512/8))]                // e.............................................................................................'.~.............................................................................................
        // ldr q15, [x0, #(7*(512/8))]                // .....................................e........................................................'......................................~........................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ..............................................................................................*...............................................................................................
        // add v8.8h, v8.8h, v9.8h                    // ...~..........................................................................................'....*..........................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[7]      // ..~...........................................................................................'...*...........................................................................................
        // mul      v9.8h, v24.8h, v0.h[6]            // ......~.......................................................................................'.......*.......................................................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ........~.....................................................................................'.........*.....................................................................................
        // sub v24.8h,   v10.8h, v11.8h               // .........................................................................................e....'..........................................................................................~....
        // add v10.8h, v10.8h, v11.8h                 // ..............................................................................................'*..............................................................................................
        // sqrdmulh v27.8h,      v24.8h, v1.h[1]      // ....~.........................................................................................'.....*.........................................................................................
        // mul      v11.8h, v24.8h, v1.h[0]           // ..............................................................................................*...............................................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..........~...................................................................................'...........*...................................................................................
        // sub v24.8h,   v12.8h, v13.8h               // ........~.....................................................................................'.........*.....................................................................................
        // add v12.8h, v12.8h, v13.8h                 // ..~...........................................................................................'...*...........................................................................................
        // sqrdmulh v27.8h,      v24.8h, v1.h[3]      // ............~.................................................................................'.............*.................................................................................
        // mul      v13.8h, v24.8h, v1.h[2]           // ................~.............................................................................'.................*.............................................................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ..................~...........................................................................'...................*...........................................................................
        // sub v24.8h,   v14.8h, v15.8h               // ..............................................................e...............................'...............................................................~...............................
        // add v14.8h, v14.8h, v15.8h                 // .........................................e....................................................'..........................................~....................................................
        // sqrdmulh v27.8h,      v24.8h, v1.h[5]      // ..........................................................................................e...'...........................................................................................~...
        // mul      v15.8h, v24.8h, v1.h[4]           // ............................................................................................e.'.............................................................................................~.
        // mls      v15.8h, v27.8h,      v7.h[0]      // ~.............................................................................................'.*.............................................................................................
        // sub v24.8h,   v8.8h, v10.8h                // .......~......................................................................................'........*......................................................................................
        // add v8.8h, v8.8h, v10.8h                   // ..........~...................................................................................'...........*...................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ......................~.......................................................................'.......................*.......................................................................
        // mul      v10.8h, v24.8h, v0.h[2]           // ............................~.................................................................'.............................*.................................................................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ..............................~...............................................................'...............................*...............................................................
        // sub v24.8h,   v9.8h, v11.8h                // ...............~..............................................................................'................*..............................................................................
        // add v9.8h, v9.8h, v11.8h                   // ................~.............................................................................'.................*.............................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ....................~.........................................................................'.....................*.........................................................................
        // mul      v11.8h, v24.8h, v0.h[2]           // ..................................~...........................................................'...................................*...........................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..........................................~...................................................'...........................................*...................................................
        // sub v24.8h,   v12.8h, v14.8h               // ......~.......................................................................................'.......*.......................................................................................
        // add v12.8h, v12.8h, v14.8h                 // .....~........................................................................................'......*........................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ..............~...............................................................................'...............*...............................................................................
        // mul      v14.8h, v24.8h, v0.h[4]           // ........................~.....................................................................'.........................*.....................................................................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ..........................~...................................................................'...........................*...................................................................
        // sub v24.8h,   v13.8h, v15.8h               // .......................~......................................................................'........................*......................................................................
        // add v13.8h, v13.8h, v15.8h                 // ........................~.....................................................................'.........................*.....................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ....................................~.........................................................'.....................................*.........................................................
        // mul      v15.8h, v24.8h, v0.h[4]           // ........................................~.....................................................'.........................................*.....................................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ......................................................~.......................................'.......................................................*.......................................
        // sub v24.8h,   v8.8h, v12.8h                // ..................~...........................................................................'...................*...........................................................................
        // add v8.8h, v8.8h, v12.8h                   // .................~............................................................................'..................*............................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ............................................~.................................................'.............................................*.................................................
        // mul      v12.8h, v24.8h, v0.h[0]           // ..............................................~...............................................'...............................................*...............................................
        // mls      v12.8h, v27.8h,      v7.h[0]      // ..................................................~...........................................'...................................................*...........................................
        // sub v24.8h,   v9.8h, v13.8h                // ............................~.................................................................'.............................*.................................................................
        // add v9.8h, v9.8h, v13.8h                   // ...........................~..................................................................'............................*..................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ....................................................~.........................................'.....................................................*.........................................
        // mul      v13.8h, v24.8h, v0.h[0]           // ..........................................................~...................................'...........................................................*...................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ............................................................~.................................'.............................................................*.................................
        // sub v24.8h,   v10.8h, v14.8h               // ...................................~..........................................................'....................................*..........................................................
        // add v10.8h, v10.8h, v14.8h                 // .....................................~........................................................'......................................*........................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ........................................................~.....................................'.........................................................*.....................................
        // mul      v14.8h, v24.8h, v0.h[0]           // ..................................................................~...........................'...................................................................*...........................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ....................................................................~.........................'.....................................................................*.........................
        // sub v24.8h,   v11.8h, v15.8h               // ...........................................................~..................................'............................................................*..................................
        // add v11.8h, v11.8h, v15.8h                 // ............................................................~.................................'.............................................................*.................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ......................................................................~.......................'.......................................................................*.......................
        // mul      v15.8h, v24.8h, v0.h[0]           // ........................................................................~.....................'.........................................................................*.....................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ............................................................................~.................'.............................................................................*.................
        // str q12, [x0, #(4*(512/8))]                // .......................................................~......................................'........................................................*......................................
        // str q13, [x0, #(5*(512/8))]                // .................................................................~............................'..................................................................*............................
        // str q14, [x0, #(6*(512/8))]                // .........................................................................~....................'..........................................................................*....................
        // str q15, [x0, #(7*(512/8))]                // .................................................................................~............'..................................................................................*............
        // sqrdmulh v27.8h,      v8.8h, v30.8h        // ................................~.............................................................'.................................*.............................................................
        // mul      v8.8h, v8.8h, v29.8h              // ......................................~.......................................................'.......................................*.......................................................
        // mls      v8.8h, v27.8h,      v7.h[0]       // ..........................................................................~...................'...........................................................................*...................
        // sqrdmulh v27.8h,      v9.8h, v30.8h        // ..............................................................~...............................'...............................................................*...............................
        // mul      v9.8h, v9.8h, v29.8h              // ................................................~.............................................'.................................................*.............................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ................................................................................~.............'.................................................................................*.............
        // sqrdmulh v27.8h,      v10.8h, v30.8h       // ..................................................................................~...........'...................................................................................*...........
        // mul      v10.8h, v10.8h, v29.8h            // ..............................................................................~...............'...............................................................................*...............
        // mls      v10.8h, v27.8h,      v7.h[0]      // ........................................................................................~.....'.........................................................................................*.....
        // sqrdmulh v27.8h,      v11.8h, v30.8h       // ................................................................~.............................'.................................................................*.............................
        // mul      v11.8h, v11.8h, v29.8h            // ....................................................................................~.........'.....................................................................................*.........
        // mls      v11.8h, v27.8h,      v7.h[0]      // ......................................................................................~.......'.......................................................................................*.......
        // str q8, [x0], #(16)                        // ...............................................................................~..............'................................................................................*..............
        // str q9, [x0, #(-16 + 1*(512/8))]           // .....................................................................................~........'......................................................................................*........
        // str q10, [x0, #(-16 + 2*(512/8))]          // .............................................................................................~'..............................................................................................*
        // str q11, [x0, #(-16 + 3*(512/8))]          // ...........................................................................................~..'............................................................................................*..

        sub count, count, #1
        cbnz count, layer123_start
                                                // Instructions:    76
                                                // Expected cycles: 96
                                                // Expected IPC:    0.79
                                                //
                                                // Cycle bound:     96.0
                                                // IPC bound:       0.79
                                                //
                                                // Wall time:     3.69s
                                                // User time:     3.69s
                                                //
                                                // -------------------------------------- cycle (expected) --------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------------------
        add v13.8H, v31.8H, v9.8H               // *...............................................................................................
        mls v21.8H, v15.8H, v7.H[0]             // *...............................................................................................
        ldr q10, [x0, #320]                     // *...............................................................................................
        sub v3.8H, v11.8H, v25.8H               // .*..............................................................................................
        add v12.8H, v11.8H, v25.8H              // ..*.............................................................................................
        mul v6.8H, v27.8H, v1.H[0]              // ..*.............................................................................................
        sqrdmulh v31.8H, v27.8H, v1.H[1]        // ....*...........................................................................................
        add v5.8H, v19.8H, v10.8H               // ....*...........................................................................................
        sub v10.8H, v19.8H, v10.8H              // .....*..........................................................................................
        sqrdmulh v9.8H, v3.8H, v0.H[7]          // ......*.........................................................................................
        sub v15.8H, v12.8H, v13.8H              // ......*.........................................................................................
        add v25.8H, v5.8H, v24.8H               // .......*........................................................................................
        sub v5.8H, v5.8H, v24.8H                // ........*.......................................................................................
        sqrdmulh v20.8H, v10.8H, v1.H[3]        // ........*.......................................................................................
        add v13.8H, v12.8H, v13.8H              // .........*......................................................................................
        mul v3.8H, v3.8H, v0.H[6]               // ..........*.....................................................................................
        mul v10.8H, v10.8H, v1.H[2]             // ............*...................................................................................
        add v12.8H, v13.8H, v25.8H              // ............*...................................................................................
        sub v13.8H, v13.8H, v25.8H              // .............*..................................................................................
        mls v10.8H, v20.8H, v7.H[0]             // ..............*.................................................................................
        mls v6.8H, v31.8H, v7.H[0]              // ................*...............................................................................
        mls v3.8H, v9.8H, v7.H[0]               // ..................*.............................................................................
        sub v31.8H, v10.8H, v21.8H              // ...................*............................................................................
        add v10.8H, v10.8H, v21.8H              // ....................*...........................................................................
        sqrdmulh v21.8H, v15.8H, v0.H[3]        // ....................*...........................................................................
        mul v9.8H, v15.8H, v0.H[2]              // ......................*.........................................................................
        sub v15.8H, v3.8H, v6.8H                // .......................*........................................................................
        add v3.8H, v3.8H, v6.8H                 // ........................*.......................................................................
        sqrdmulh v6.8H, v5.8H, v0.H[5]          // ........................*.......................................................................
        mul v5.8H, v5.8H, v0.H[4]               // ..........................*.....................................................................
        add v25.8H, v3.8H, v10.8H               // ...........................*....................................................................
        sub v10.8H, v3.8H, v10.8H               // ............................*...................................................................
        sqrdmulh v3.8H, v15.8H, v0.H[3]         // ............................*...................................................................
        mls v5.8H, v6.8H, v7.H[0]               // ..............................*.................................................................
        mls v9.8H, v21.8H, v7.H[0]              // ................................*...............................................................
        sqrdmulh v21.8H, v12.8H, v30.8H         // ..................................*.............................................................
        mul v6.8H, v15.8H, v0.H[2]              // ....................................*...........................................................
        sub v15.8H, v9.8H, v5.8H                // .....................................*..........................................................
        mul v12.8H, v12.8H, v29.8H              // ......................................*.........................................................
        add v5.8H, v9.8H, v5.8H                 // ......................................*.........................................................
        sqrdmulh v9.8H, v13.8H, v0.H[1]         // ........................................*.......................................................
        mul v13.8H, v13.8H, v0.H[0]             // ..........................................*.....................................................
        sqrdmulh v20.8H, v31.8H, v0.H[5]        // ............................................*...................................................
        mul v31.8H, v31.8H, v0.H[4]             // ..............................................*.................................................
        mls v6.8H, v3.8H, v7.H[0]               // ................................................*...............................................
        mul v3.8H, v25.8H, v29.8H               // ..................................................*.............................................
        mls v13.8H, v9.8H, v7.H[0]              // ....................................................*...........................................
        sqrdmulh v9.8H, v10.8H, v0.H[1]         // ......................................................*.........................................
        mls v31.8H, v20.8H, v7.H[0]             // ........................................................*.......................................
        str q13, [x0, #256]                     // .........................................................*......................................
        sqrdmulh v13.8H, v15.8H, v0.H[1]        // ..........................................................*.....................................
        mul v10.8H, v10.8H, v0.H[0]             // ............................................................*...................................
        sub v20.8H, v6.8H, v31.8H               // .............................................................*..................................
        add v6.8H, v6.8H, v31.8H                // ..............................................................*.................................
        mls v10.8H, v9.8H, v7.H[0]              // ..............................................................*.................................
        sqrdmulh v31.8H, v25.8H, v30.8H         // ................................................................*...............................
        sqrdmulh v9.8H, v6.8H, v30.8H           // ..................................................................*.............................
        str q10, [x0, #320]                     // ...................................................................*............................
        mul v10.8H, v15.8H, v0.H[0]             // ....................................................................*...........................
        mls v10.8H, v13.8H, v7.H[0]             // ......................................................................*.........................
        sqrdmulh v13.8H, v20.8H, v0.H[1]        // ........................................................................*.......................
        mul v15.8H, v20.8H, v0.H[0]             // ..........................................................................*.....................
        str q10, [x0, #384]                     // ...........................................................................*....................
        mls v12.8H, v21.8H, v7.H[0]             // ............................................................................*...................
        mls v15.8H, v13.8H, v7.H[0]             // ..............................................................................*.................
        mul v13.8H, v5.8H, v29.8H               // ................................................................................*...............
        str q12, [x0], #(16)                    // .................................................................................*..............
        mls v3.8H, v31.8H, v7.H[0]              // ..................................................................................*.............
        str q15, [x0, #432]                     // ...................................................................................*............
        sqrdmulh v10.8H, v5.8H, v30.8H          // ....................................................................................*...........
        mul v21.8H, v6.8H, v29.8H               // ......................................................................................*.........
        str q3, [x0, #48]                       // .......................................................................................*........
        mls v21.8H, v9.8H, v7.H[0]              // ........................................................................................*.......
        mls v13.8H, v10.8H, v7.H[0]             // ..........................................................................................*.....
        str q21, [x0, #176]                     // .............................................................................................*..
        str q13, [x0, #112]                     // ...............................................................................................*

                                                 // -------------------------------------- cycle (expected) --------------------------------------->
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|--------------------
        // mul v18.8H, v27.8H, v1.H[0]           // ..*.............................................................................................
        // sub v16.8H, v11.8H, v25.8H            // .*..............................................................................................
        // ldr q12, [x0, #320]                   // *...............................................................................................
        // add v26.8H, v31.8H, v9.8H             // *...............................................................................................
        // mls v21.8H, v15.8H, v7.H[0]           // *...............................................................................................
        // add v3.8H, v19.8H, v12.8H             // ....*...........................................................................................
        // sqrdmulh v23.8H, v16.8H, v0.H[7]      // ......*.........................................................................................
        // add v20.8H, v11.8H, v25.8H            // ..*.............................................................................................
        // sqrdmulh v9.8H, v27.8H, v1.H[1]       // ....*...........................................................................................
        // add v8.8H, v3.8H, v24.8H              // .......*........................................................................................
        // sub v24.8H, v3.8H, v24.8H             // ........*.......................................................................................
        // mul v10.8H, v16.8H, v0.H[6]           // ..........*.....................................................................................
        // sub v6.8H, v20.8H, v26.8H             // ......*.........................................................................................
        // mls v10.8H, v23.8H, v7.H[0]           // ..................*.............................................................................
        // sub v13.8H, v19.8H, v12.8H            // .....*..........................................................................................
        // mls v18.8H, v9.8H, v7.H[0]            // ................*...............................................................................
        // add v9.8H, v20.8H, v26.8H             // .........*......................................................................................
        // sqrdmulh v12.8H, v13.8H, v1.H[3]      // ........*.......................................................................................
        // sqrdmulh v31.8H, v24.8H, v0.H[5]      // ........................*.......................................................................
        // sub v19.8H, v10.8H, v18.8H            // .......................*........................................................................
        // mul v3.8H, v13.8H, v1.H[2]            // ............*...................................................................................
        // add v28.8H, v10.8H, v18.8H            // ........................*.......................................................................
        // add v17.8H, v9.8H, v8.8H              // ............*...................................................................................
        // mls v3.8H, v12.8H, v7.H[0]            // ..............*.................................................................................
        // sub v13.8H, v9.8H, v8.8H              // .............*..................................................................................
        // sqrdmulh v27.8H, v19.8H, v0.H[3]      // ............................*...................................................................
        // sqrdmulh v14.8H, v6.8H, v0.H[3]       // ....................*...........................................................................
        // sub v15.8H, v3.8H, v21.8H             // ...................*............................................................................
        // add v23.8H, v3.8H, v21.8H             // ....................*...........................................................................
        // mul v8.8H, v24.8H, v0.H[4]            // ..........................*.....................................................................
        // mls v8.8H, v31.8H, v7.H[0]            // ..............................*.................................................................
        // add v18.8H, v28.8H, v23.8H            // ...........................*....................................................................
        // mul v24.8H, v6.8H, v0.H[2]            // ......................*.........................................................................
        // sub v16.8H, v28.8H, v23.8H            // ............................*...................................................................
        // mls v24.8H, v14.8H, v7.H[0]           // ................................*...............................................................
        // sqrdmulh v22.8H, v17.8H, v30.8H       // ..................................*.............................................................
        // mul v9.8H, v19.8H, v0.H[2]            // ....................................*...........................................................
        // sub v10.8H, v24.8H, v8.8H             // .....................................*..........................................................
        // sqrdmulh v26.8H, v15.8H, v0.H[5]      // ............................................*...................................................
        // add v21.8H, v24.8H, v8.8H             // ......................................*.........................................................
        // mul v12.8H, v17.8H, v29.8H            // ......................................*.........................................................
        // mul v6.8H, v15.8H, v0.H[4]            // ..............................................*.................................................
        // mls v9.8H, v27.8H, v7.H[0]            // ................................................*...............................................
        // sqrdmulh v3.8H, v13.8H, v0.H[1]       // ........................................*.......................................................
        // mul v4.8H, v13.8H, v0.H[0]            // ..........................................*.....................................................
        // mul v20.8H, v18.8H, v29.8H            // ..................................................*.............................................
        // mls v4.8H, v3.8H, v7.H[0]             // ....................................................*...........................................
        // sqrdmulh v17.8H, v16.8H, v0.H[1]      // ......................................................*.........................................
        // mls v6.8H, v26.8H, v7.H[0]            // ........................................................*.......................................
        // str q4, [x0, #256]                    // .........................................................*......................................
        // sqrdmulh v13.8H, v10.8H, v0.H[1]      // ..........................................................*.....................................
        // mul v27.8H, v16.8H, v0.H[0]           // ............................................................*...................................
        // sub v23.8H, v9.8H, v6.8H              // .............................................................*..................................
        // add v9.8H, v9.8H, v6.8H               // ..............................................................*.................................
        // mls v27.8H, v17.8H, v7.H[0]           // ..............................................................*.................................
        // sqrdmulh v6.8H, v18.8H, v30.8H        // ................................................................*...............................
        // sqrdmulh v16.8H, v9.8H, v30.8H        // ..................................................................*.............................
        // str q27, [x0, #320]                   // ...................................................................*............................
        // mul v3.8H, v10.8H, v0.H[0]            // ....................................................................*...........................
        // mls v3.8H, v13.8H, v7.H[0]            // ......................................................................*.........................
        // sqrdmulh v10.8H, v23.8H, v0.H[1]      // ........................................................................*.......................
        // mul v5.8H, v23.8H, v0.H[0]            // ..........................................................................*.....................
        // str q3, [x0, #384]                    // ...........................................................................*....................
        // mls v12.8H, v22.8H, v7.H[0]           // ............................................................................*...................
        // mls v5.8H, v10.8H, v7.H[0]            // ..............................................................................*.................
        // mul v10.8H, v21.8H, v29.8H            // ................................................................................*...............
        // str q12, [x0], #(16)                  // .................................................................................*..............
        // mls v20.8H, v6.8H, v7.H[0]            // ..................................................................................*.............
        // str q5, [x0, #432]                    // ...................................................................................*............
        // sqrdmulh v12.8H, v21.8H, v30.8H       // ....................................................................................*...........
        // mul v13.8H, v9.8H, v29.8H             // ......................................................................................*.........
        // str q20, [x0, #48]                    // .......................................................................................*........
        // mls v13.8H, v16.8H, v7.H[0]           // ........................................................................................*.......
        // mls v10.8H, v12.8H, v7.H[0]           // ..........................................................................................*.....
        // str q13, [x0, #176]                   // .............................................................................................*..
        // str q10, [x0, #112]                   // ...............................................................................................*


        pop_stack
        ret

#endif /* MLKEM_USE_AARCH64_ASM */
