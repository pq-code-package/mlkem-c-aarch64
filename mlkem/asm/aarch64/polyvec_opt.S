// SPDX-License-Identifier: Apache-2.0

// AArch64 re-implementation of the asymmetric base multiplication from:

// Neon NTT: Faster Dilithium, Kyber, and Saber on Cortex-A72 and Apple M1
// https:   // eprint.iacr.org/2021/986
// https:   // github.com/neon-ntt/neon-ntt

#include "config.h"
#if defined(MLKEM_USE_AARCH64_ASM)

#include "params.h"

// Needed to provide ASM_LOAD directive
#include "common.i"

.macro barrett_reduce a
        sqdmulh t0.8h, \a\().8h, consts.h[1]
        srshr   t0.8h, t0.8h, #11
        mls     \a\().8h, t0.8h, consts.h[0]
.endm

// Input:
// - Vectors al, ah of 32-bit entries
// Output:
// - Montgomery reductions of al || ah, stored in al
.macro montgomery_reduce_long x, a
        uzp1   t0.8h, \a\()l.8h, \a\()h.8h
        mul    t0.8h, t0.8h, consts.h[2]
        smlal  \a\()l.4s, t0.4h, constN.4h
        smlal2 \a\()h.4s, t0.8h, constN.8h
        uzp2   \x\().8h, \a\()l.8h, \a\()h.8h
.endm

// Computes products (a0*b0 + a0*b0t, a0*b1 + a1*b0) in 32-bit.
.macro pmull d, a, b
        smull  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smull2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smull  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smull2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro pmlal d, a, b
        smlal  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smlal2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smlal  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smlal2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro st2p d0, d1, src
        // This instruction is likely broken down into uOps
        // anyway, so we may achieve better scheduling by
        // breaking manually.
        st2 {\d0\().8h, \d1\().8h}, [\src], #32
        // zip1 tmp0.8h, \d0\().8h, \d1\().8h
        // zip2 tmp1.8h, \d0\().8h, \d1\().8h
        // str q_tmp0, [\src], #32
        // str q_tmp1, [\src, #-16]
.endm

.macro LD2 d0, d1, src
        // This instruction is likely broken down into uOps
        // anyway, so we may achieve better scheduling by
        // breaking manually.
        // ld2 {\d0\().8h, \d1\().8h}, [\src], #32
        ldr q_tmp0, [\src], #32
        ldr q_tmp1, [\src, #-16]
        uzp1 \d0\().8h, tmp0.8h, tmp1.8h
        uzp2 \d1\().8h, tmp0.8h, tmp1.8h
.endm

.macro load_polys a, b, a_ptr, b_ptr, b_cache_ptr
        LD2 \a\()0, \a\()1, \a_ptr
        LD2 \b\()0, \b\()1, \b_ptr
        ld1 {\b\()1t.8h}, [\b_cache_ptr], #16
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

        out          .req x0
        a0_ptr       .req x1
        b0_ptr       .req x2
        b0_cache_ptr .req x3
        a1_ptr       .req x4
        b1_ptr       .req x5
        b1_cache_ptr .req x6
        a2_ptr       .req x7
        b2_ptr       .req x8
        b2_cache_ptr .req x9
        a3_ptr       .req x10
        b3_ptr       .req x11
        b3_cache_ptr .req x12

        count        .req x13
        xtmp         .req x14
        modulus      .req w15

        constN    .req v0
        constX    .req v1
        consts    .req v2

        aa0      .req v3
        aa1      .req v4
        bb0      .req v5
        bb1      .req v6
        bb1t     .req v7

        res0l   .req v8
        res1l   .req v9
        res0h   .req v10
        res1h   .req v11

        tmp0   .req v12
        tmp1   .req v13
        q_tmp0 .req q12
        q_tmp1 .req q13

        out0 .req v26
        out1 .req v27

        t0   .req v28

.p2align 4
const_addr:
        .short 3329
        .short 20159
        .short 3327
        .short 0
        .short 0
        .short 0
        .short 0
        .short 0

#if KYBER_K == 2

.global polyvec_basemul_acc_montgomery_cached_asm_k2_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k2_opt

polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)

        mov count, #(KYBER_N / 16)
                                             // Instructions:    44
                                             // Expected cycles: 21
                                             // Expected IPC:    2.10

                                             // Cycle bound:     21.0
                                             // IPC bound:       2.10

                                             // Wall time:     0.34s
                                             // User time:     0.34s

                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        ldr q17, [x1], #32                   // *.............................
        ldr q7, [x1, #-16]                   // *.............................
        ldr q14, [x2, #16]                   // .*............................
        ldr q8, [x2], #32                    // .*............................
        ldr q26, [x5], #32                   // ...*..........................
        ldr q18, [x4], #32                   // ....*.........................
        uzp1 v25.8H, v17.8H, v7.8H           // ....*.........................
        uzp2 v20.8H, v8.8H, v14.8H           // .....*........................
        ldr q16, [x5, #-16]                  // .....*........................
        uzp2 v6.8H, v17.8H, v7.8H            // ......*.......................
        ldr q17, [x4, #-16]                  // ......*.......................
        uzp1 v14.8H, v8.8H, v14.8H           // .......*......................
        ldr q21, [x4, #16]                   // .......*......................
        smull v13.4S, v25.4H, v20.4H         // ........*.....................
        ldr q11, [x1], #32                   // ........*.....................
        smull2 v8.4S, v25.8H, v20.8H         // .........*....................
        uzp2 v3.8H, v26.8H, v16.8H           // .........*....................
        ld1 {v7.8H}, [x3], #16               // .........*....................
        smlal v13.4S, v6.4H, v14.4H          // ..........*...................
        ldr q20, [x2], #32                   // ..........*...................
        uzp1 v1.8H, v18.8H, v17.8H           // ..........*...................
        uzp2 v15.8H, v18.8H, v17.8H          // ...........*..................
        smlal2 v8.4S, v6.8H, v14.8H          // ...........*..................
        ldr q17, [x2, #-16]                  // ...........*..................
        uzp1 v24.8H, v26.8H, v16.8H          // ............*.................
        smull v16.4S, v25.4H, v14.4H         // ............*.................
        ldr q12, [x1, #-16]                  // ............*.................
        smlal v13.4S, v1.4H, v3.4H           // .............*................
        ldr q29, [x5], #32                   // .............*................
        smlal2 v8.4S, v1.8H, v3.8H           // ..............*...............
        ldr q31, [x4], #32                   // ..............*...............
        smlal v13.4S, v15.4H, v24.4H         // ...............*..............
        uzp2 v3.8H, v20.8H, v17.8H           // ...............*..............
        uzp1 v10.8H, v20.8H, v17.8H          // ................*.............
        smlal2 v8.4S, v15.8H, v24.8H         // ................*.............
        ldr q17, [x5, #-16]                  // ................*.............
        smull2 v23.4S, v25.8H, v14.8H        // .................*............
        uzp1 v14.8H, v13.8H, v8.8H           // .................*............
        smlal v16.4S, v6.4H, v7.4H           // ..................*...........
        uzp1 v22.8H, v11.8H, v12.8H          // ..................*...........
        smlal v16.4S, v1.4H, v24.4H          // ...................*..........
        mul v5.8H, v14.8H, v2.H[2]           // ....................*.........
        ld1 {v26.8H}, [x6], #16              // ....................*.........
        uzp2 v4.8H, v29.8H, v17.8H           // ....................*.........

                                              // ------ cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|-----
        // ldr q9, [x2, #16]                    // .*.............................
        // ldr q21, [x4, #16]                   // ......*........................
        // ldr q11, [x1], #32                   // *..............................
        // ldr q12, [x1, #-16]                  // *..............................
        // ldr q17, [x5, #16]                   // .....*.........................
        // ldr q31, [x2], #32                   // .*.............................
        // uzp2 v3.8H, v31.8H, v9.8H            // .....*.........................
        // ldr q29, [x5], #32                   // ...*...........................
        // uzp1 v22.8H, v11.8H, v12.8H          // ....*..........................
        // uzp1 v10.8H, v31.8H, v9.8H           // .......*.......................
        // ldr q31, [x4], #32                   // ....*..........................
        // uzp2 v4.8H, v29.8H, v17.8H           // .........*.....................
        // ldr q9, [x2, #16]                    // ...........*...................
        // uzp1 v1.8H, v31.8H, v21.8H           // ..........*....................
        // ld1 {v26.8H}, [x6], #16              // ....................*..........
        // uzp2 v15.8H, v31.8H, v21.8H          // ...........*...................
        // ldr q21, [x4, #16]                   // .......*.......................
        // smull v13.4S, v22.4H, v3.4H          // ........*......................
        // smull2 v8.4S, v22.8H, v3.8H          // .........*.....................
        // uzp2 v6.8H, v11.8H, v12.8H           // ......*........................
        // ldr q11, [x1], #32                   // ........*......................
        // uzp1 v24.8H, v29.8H, v17.8H          // ............*..................
        // ldr q12, [x1, #-16]                  // ............*..................
        // ld1 {v7.8H}, [x3], #16               // .........*.....................
        // smlal v13.4S, v6.4H, v10.4H          // ..........*....................
        // ldr q17, [x5, #16]                   // ................*..............
        // smlal v13.4S, v1.4H, v4.4H           // .............*.................
        // smlal v13.4S, v15.4H, v24.4H         // ...............*...............
        // ldr q31, [x2], #32                   // ..........*....................
        // smull v16.4S, v22.4H, v10.4H         // ............*..................
        // uzp2 v3.8H, v31.8H, v9.8H            // ...............*...............
        // smlal v16.4S, v6.4H, v7.4H           // ..................*............
        // smlal2 v8.4S, v6.8H, v10.8H          // ...........*...................
        // smlal2 v8.4S, v1.8H, v4.8H           // ..............*................
        // smlal2 v8.4S, v15.8H, v24.8H         // ................*..............
        // uzp1 v5.8H, v13.8H, v8.8H            // .................*.............
        // ldr q29, [x5], #32                   // .............*.................
        // smull2 v23.4S, v22.8H, v10.8H        // .................*.............
        // uzp1 v22.8H, v11.8H, v12.8H          // ..................*............
        // uzp1 v10.8H, v31.8H, v9.8H           // ................*..............
        // smlal v16.4S, v1.4H, v24.4H          // ...................*...........
        // ldr q31, [x4], #32                   // ..............*................
        // mul v5.8H, v5.8H, v2.H[2]            // ....................*..........
        // uzp2 v4.8H, v29.8H, v17.8H           // ....................*..........

        sub count, count, #2
k2_loop_start:
                                               // Instructions:    51
                                               // Expected cycles: 32
                                               // Expected IPC:    1.59

                                               // Cycle bound:     32.0
                                               // IPC bound:       1.59

                                               // Wall time:     28.89s
                                               // User time:     28.89s

                                               // ------ cycle (expected) ------->
                                               // 0                        25
                                               // |------------------------|------
        smlal2 v23.4S, v6.8H, v7.8H            // l...............................
        smlal v16.4S, v15.4H, v26.4H           // .l..............................
        smlal2 v23.4S, v1.8H, v24.8H           // ..l.............................
        ldr q9, [x2, #16]                      // ..e.............................
        smlal2 v23.4S, v15.8H, v26.8H          // ...l............................
        uzp1 v1.8H, v31.8H, v21.8H             // ...*............................
        ld1 {v26.8H}, [x6], #16                // ...*............................
        smlal v13.4S, v5.4H, v0.4H             // ....l...........................
        uzp2 v15.8H, v31.8H, v21.8H            // ....*...........................
        ldr q21, [x4, #16]                     // ....e...........................
        smlal2 v8.4S, v5.8H, v0.8H             // .....l..........................
        uzp1 v30.8H, v16.8H, v23.8H            // .....l..........................
        uzp2 v19.8H, v13.8H, v8.8H             // ......l.........................
        smull v13.4S, v22.4H, v3.4H            // ......*.........................
        smull2 v8.4S, v22.8H, v3.8H            // .......*........................
        uzp2 v6.8H, v11.8H, v12.8H             // .......*........................
        ldr q11, [x1], #32                     // .......e........................
        mul v5.8H, v30.8H, v2.H[2]             // ........l.......................
        uzp1 v24.8H, v29.8H, v17.8H            // ........*.......................
        ldr q12, [x1, #-16]                    // ........e.......................
        ld1 {v7.8H}, [x3], #16                 // .........*......................
        smlal v13.4S, v6.4H, v10.4H            // ..........*.....................
        ldr q17, [x5, #16]                     // ..........e.....................
        smlal v13.4S, v1.4H, v4.4H             // ...........*....................
        smlal v13.4S, v15.4H, v24.4H           // ............*...................
        ldr q31, [x2], #32                     // ............e...................
        smlal2 v23.4S, v5.8H, v0.8H            // .............l..................
        smlal v16.4S, v5.4H, v0.4H             // ..............l.................
        uzp2 v18.8H, v16.8H, v23.8H            // ...............l................
        smull v16.4S, v22.4H, v10.4H           // ...............*................
        sqdmulh v5.8H, v19.8H, v2.H[1]         // ................l...............
        sqdmulh v29.8H, v18.8H, v2.H[1]        // ..................l.............
        uzp2 v3.8H, v31.8H, v9.8H              // ..................e.............
        smlal v16.4S, v6.4H, v7.4H             // ....................*...........
        smlal2 v8.4S, v6.8H, v10.8H            // .....................*..........
        srshr v5.8H, v5.8H, #11                // .....................l..........
        smlal2 v8.4S, v1.8H, v4.8H             // ......................*.........
        smlal2 v8.4S, v15.8H, v24.8H           // .......................*........
        srshr v29.8H, v29.8H, #11              // .......................l........
        mls v19.8H, v5.8H, v2.H[0]             // ........................l.......
        uzp1 v5.8H, v13.8H, v8.8H              // ........................*.......
        mls v18.8H, v29.8H, v2.H[0]            // ..........................l.....
        ldr q29, [x5], #32                     // ..........................e.....
        smull2 v23.4S, v22.8H, v10.8H          // ............................*...
        uzp1 v22.8H, v11.8H, v12.8H            // ............................e...
        uzp1 v10.8H, v31.8H, v9.8H             // .............................e..
        smlal v16.4S, v1.4H, v24.4H            // .............................*..
        ldr q31, [x4], #32                     // .............................e..
        mul v5.8H, v5.8H, v2.H[2]              // ..............................*.
        uzp2 v4.8H, v29.8H, v17.8H             // ..............................e.
        st2 {v18.8H, v19.8H}, [x0], #32        // ...............................l

                                                // ------------------------------------- cycle (expected) -------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|------------------
        // ldr q12, [x1], #32                     // .....e........................'......~........................'......~........................
        // ldr q13, [x1, #-16]                    // ......e.......................'.......~.......................'.......~.......................
        // uzp1 v3.8h, v12.8h, v13.8h             // ..........................e...'...........................~...'...........................~...
        // uzp2 v4.8h, v12.8h, v13.8h             // .....~........................'......*........................'......~........................
        // ldr q12, [x2], #32                     // ..........e...................'...........~...................'...........~...................
        // ldr q13, [x2, #-16]                    // e.............................'.~.............................'.~.............................
        // uzp1 v5.8h, v12.8h, v13.8h             // ...........................e..'............................~..'............................~..
        // uzp2 v6.8h, v12.8h, v13.8h             // ................e.............'.................~.............'.................~.............
        // ld1 {v7.8h}, [x3], #16                 // .......~......................'........*......................'........~......................
        // smull  v8.4s, v3.4h, v5.4h             // .............~................'..............*................'..............~................
        // smull2 v10.4s, v3.8h, v5.8h            // ..........................~...'...........................*...'...........................~...
        // smlal  v8.4s, v4.4h, v7.4h             // ..................~...........'...................*...........'...................~...........
        // smlal2 v10.4s, v4.8h, v7.8h            // ..............................~...............................l...............................
        // smull  v9.4s, v3.4h, v6.4h             // ....~.........................'.....*.........................'.....~.........................
        // smull2 v11.4s, v3.8h, v6.8h            // .....~........................'......*........................'......~........................
        // smlal  v9.4s, v4.4h, v5.4h             // ........~.....................'.........*.....................'.........~.....................
        // smlal2 v11.4s, v4.8h, v5.8h            // ...................~..........'....................*..........'....................~..........
        // ldr q12, [x4], #32                     // ...........................e..'............................~..'............................~..
        // ldr q13, [x4, #-16]                    // ..e...........................'...~...........................'...~...........................
        // uzp1 v3.8h, v12.8h, v13.8h             // .~............................'..*............................'..~............................
        // uzp2 v4.8h, v12.8h, v13.8h             // ..~...........................'...*...........................'...~...........................
        // ldr q12, [x5], #32                     // ........................e.....'.........................~.....'.........................~.....
        // ldr q13, [x5, #-16]                    // ........e.....................'.........~.....................'.........~.....................
        // uzp1 v5.8h, v12.8h, v13.8h             // ......~.......................'.......*.......................'.......~.......................
        // uzp2 v6.8h, v12.8h, v13.8h             // ............................e.'.............................~.'.............................~.
        // ld1 {v7.8h}, [x6], #16                 // .~............................'..*............................'..~............................
        // smlal  v8.4s, v3.4h, v5.4h             // ...........................~..'............................*..'............................~..
        // smlal2 v10.4s, v3.8h, v5.8h            // ~.............................'.~.............................'.l.............................
        // smlal  v8.4s, v4.4h, v7.4h             // ..............................'~..............................'l..............................
        // smlal2 v10.4s, v4.8h, v7.8h            // .~............................'..~............................'..l............................
        // smlal  v9.4s, v3.4h, v6.4h             // .........~....................'..........*....................'..........~....................
        // smlal2 v11.4s, v3.8h, v6.8h            // ....................~.........'.....................*.........'.....................~.........
        // smlal  v9.4s, v4.4h, v5.4h             // ..........~...................'...........*...................'...........~...................
        // smlal2 v11.4s, v4.8h, v5.8h            // .....................~........'......................*........'......................~........
        // uzp1   v28.8h, v8.8h, v10.8h           // ...~..........................'....~..........................'....l..........................
        // mul    v28.8h, v28.8h, v2.h[2]         // ......~.......................'.......~.......................'.......l.......................
        // smlal  v8.4s, v28.4h, v0.4h            // ............~.................'.............~.................'.............l.................
        // smlal2 v10.4s, v28.8h, v0.8h           // ...........~..................'............~..................'............l..................
        // uzp2   v26.8h, v8.8h, v10.8h           // .............~................'..............~................'..............l................
        // uzp1   v28.8h, v9.8h, v11.8h           // ......................~.......'.......................*.......'.......................~.......
        // mul    v28.8h, v28.8h, v2.h[2]         // ............................~.'.............................*.'.............................~.
        // smlal  v9.4s, v28.4h, v0.4h            // ..~...........................'...~...........................'...l...........................
        // smlal2 v11.4s, v28.8h, v0.8h           // ...~..........................'....~..........................'....l..........................
        // uzp2   v27.8h, v9.8h, v11.8h           // ....~.........................'.....~.........................'.....l.........................
        // sqdmulh v28.8h, v26.8h, v2.h[1]        // ................~.............'.................~.............'.................l.............
        // srshr   v28.8h, v28.8h, #11            // .....................~........'......................~........'......................l........
        // mls     v26.8h, v28.8h, v2.h[0]        // ........................~.....'.........................~.....'.........................l.....
        // sqdmulh v28.8h, v27.8h, v2.h[1]        // ..............~...............'...............~...............'...............l...............
        // srshr   v28.8h, v28.8h, #11            // ...................~..........'....................~..........'....................l..........
        // mls     v27.8h, v28.8h, v2.h[0]        // ......................~.......'.......................~.......'.......................l.......
        // st2 {v26.8h, v27.8h}, [x0], #32        // .............................~'..............................~'..............................l

        sub count, count, #1
        cbnz count, k2_loop_start
                                               // Instructions:    58
                                               // Expected cycles: 54
                                               // Expected IPC:    1.07

                                               // Cycle bound:     54.0
                                               // IPC bound:       1.07

                                               // Wall time:     1.47s
                                               // User time:     1.47s

                                               // ----------------- cycle (expected) ------------------>
                                               // 0                        25                       50
                                               // |------------------------|------------------------|---
        smlal2 v23.4S, v6.8H, v7.8H            // *.....................................................
        uzp2 v12.8H, v11.8H, v12.8H            // *.....................................................
        ld1 {v20.8H}, [x6], #16                // *.....................................................
        smlal v16.4S, v15.4H, v26.4H           // .*....................................................
        uzp1 v14.8H, v29.8H, v17.8H            // .*....................................................
        ld1 {v29.8H}, [x3], #16                // .*....................................................
        smlal2 v23.4S, v1.8H, v24.8H           // ..*...................................................
        uzp1 v30.8H, v31.8H, v21.8H            // ..*...................................................
        smlal2 v23.4S, v15.8H, v26.8H          // ...*..................................................
        uzp2 v31.8H, v31.8H, v21.8H            // ...*..................................................
        smlal v13.4S, v5.4H, v0.4H             // ....*.................................................
        uzp1 v15.8H, v16.8H, v23.8H            // ....*.................................................
        smlal2 v8.4S, v5.8H, v0.8H             // .....*................................................
        uzp2 v7.8H, v13.8H, v8.8H              // ......*...............................................
        smull v9.4S, v22.4H, v3.4H             // ......*...............................................
        smull2 v8.4S, v22.8H, v3.8H            // .......*..............................................
        smull v25.4S, v22.4H, v10.4H           // ........*.............................................
        smull2 v28.4S, v22.8H, v10.8H          // .........*............................................
        smlal v9.4S, v12.4H, v10.4H            // ..........*...........................................
        smlal2 v8.4S, v12.8H, v10.8H           // ...........*..........................................
        smlal v9.4S, v30.4H, v4.4H             // ............*.........................................
        smlal2 v28.4S, v12.8H, v29.8H          // .............*........................................
        smlal v25.4S, v12.4H, v29.4H           // ..............*.......................................
        smlal2 v28.4S, v30.8H, v14.8H          // ...............*......................................
        smlal v25.4S, v30.4H, v14.4H           // ................*.....................................
        smlal2 v28.4S, v31.8H, v20.8H          // .................*....................................
        smlal v25.4S, v31.4H, v20.4H           // ..................*...................................
        mul v19.8H, v15.8H, v2.H[2]            // ...................*..................................
        uzp1 v29.8H, v25.8H, v28.8H            // ....................*.................................
        smlal2 v8.4S, v30.8H, v4.8H            // .....................*................................
        smlal v9.4S, v31.4H, v14.4H            // ......................*...............................
        smlal2 v8.4S, v31.8H, v14.8H           // .......................*..............................
        uzp1 v27.8H, v9.8H, v8.8H              // ........................*.............................
        smlal2 v23.4S, v19.8H, v0.8H           // ........................*.............................
        smlal v16.4S, v19.4H, v0.4H            // .........................*............................
        uzp2 v6.8H, v16.8H, v23.8H             // ..........................*...........................
        mul v30.8H, v29.8H, v2.H[2]            // ..........................*...........................
        mul v3.8H, v27.8H, v2.H[2]             // ............................*.........................
        sqdmulh v12.8H, v7.8H, v2.H[1]         // ..............................*.......................
        smlal v25.4S, v30.4H, v0.4H            // ................................*.....................
        smlal v9.4S, v3.4H, v0.4H              // .................................*....................
        smlal2 v8.4S, v3.8H, v0.8H             // ..................................*...................
        smlal2 v28.4S, v30.8H, v0.8H           // ...................................*..................
        uzp2 v22.8H, v9.8H, v8.8H              // ...................................*..................
        srshr v15.8H, v12.8H, #11              // ....................................*.................
        sqdmulh v8.8H, v6.8H, v2.H[1]          // ....................................*.................
        uzp2 v21.8H, v25.8H, v28.8H            // .....................................*................
        sqdmulh v4.8H, v22.8H, v2.H[1]         // ......................................*...............
        sqdmulh v26.8H, v21.8H, v2.H[1]        // ........................................*.............
        srshr v14.8H, v8.8H, #11               // .........................................*............
        mls v7.8H, v15.8H, v2.H[0]             // ..........................................*...........
        srshr v23.8H, v4.8H, #11               // ...........................................*..........
        mls v6.8H, v14.8H, v2.H[0]             // ............................................*.........
        srshr v10.8H, v26.8H, #11              // .............................................*........
        mls v22.8H, v23.8H, v2.H[0]            // ..............................................*.......
        mls v21.8H, v10.8H, v2.H[0]            // ................................................*.....
        st2 {v6.8H, v7.8H}, [x0], #32          // .................................................*....
        st2 {v21.8H, v22.8H}, [x0], #32        // .....................................................*

                                                // ----------------- cycle (expected) ------------------>
                                                // 0                        25                       50
                                                // |------------------------|------------------------|---
        // smlal2 v23.4S, v6.8H, v7.8H            // *.....................................................
        // smlal v16.4S, v15.4H, v26.4H           // .*....................................................
        // smlal2 v23.4S, v1.8H, v24.8H           // ..*...................................................
        // smlal2 v23.4S, v15.8H, v26.8H          // ...*..................................................
        // uzp1 v1.8H, v31.8H, v21.8H             // ..*...................................................
        // ld1 {v26.8H}, [x6], #16                // *.....................................................
        // smlal v13.4S, v5.4H, v0.4H             // ....*.................................................
        // uzp2 v15.8H, v31.8H, v21.8H            // ...*..................................................
        // smlal2 v8.4S, v5.8H, v0.8H             // .....*................................................
        // uzp1 v30.8H, v16.8H, v23.8H            // ....*.................................................
        // uzp2 v19.8H, v13.8H, v8.8H             // ......*...............................................
        // smull v13.4S, v22.4H, v3.4H            // ......*...............................................
        // smull2 v8.4S, v22.8H, v3.8H            // .......*..............................................
        // uzp2 v6.8H, v11.8H, v12.8H             // *.....................................................
        // mul v5.8H, v30.8H, v2.H[2]             // ...................*..................................
        // uzp1 v24.8H, v29.8H, v17.8H            // .*....................................................
        // ld1 {v7.8H}, [x3], #16                 // .*....................................................
        // smlal v13.4S, v6.4H, v10.4H            // ..........*...........................................
        // smlal v13.4S, v1.4H, v4.4H             // ............*.........................................
        // smlal v13.4S, v15.4H, v24.4H           // ......................*...............................
        // smlal2 v23.4S, v5.8H, v0.8H            // ........................*.............................
        // smlal v16.4S, v5.4H, v0.4H             // .........................*............................
        // uzp2 v18.8H, v16.8H, v23.8H            // ..........................*...........................
        // smull v16.4S, v22.4H, v10.4H           // ........*.............................................
        // sqdmulh v5.8H, v19.8H, v2.H[1]         // ..............................*.......................
        // sqdmulh v29.8H, v18.8H, v2.H[1]        // ....................................*.................
        // smlal v16.4S, v6.4H, v7.4H             // ..............*.......................................
        // smlal2 v8.4S, v6.8H, v10.8H            // ...........*..........................................
        // srshr v5.8H, v5.8H, #11                // ....................................*.................
        // smlal2 v8.4S, v1.8H, v4.8H             // .....................*................................
        // smlal2 v8.4S, v15.8H, v24.8H           // .......................*..............................
        // srshr v29.8H, v29.8H, #11              // .........................................*............
        // mls v19.8H, v5.8H, v2.H[0]             // ..........................................*...........
        // uzp1 v5.8H, v13.8H, v8.8H              // ........................*.............................
        // mls v18.8H, v29.8H, v2.H[0]            // ............................................*.........
        // smull2 v23.4S, v22.8H, v10.8H          // .........*............................................
        // smlal v16.4S, v1.4H, v24.4H            // ................*.....................................
        // mul v5.8H, v5.8H, v2.H[2]              // ............................*.........................
        // st2 {v18.8H, v19.8H}, [x0], #32        // .................................................*....
        // smlal2 v23.4S, v6.8H, v7.8H            // .............*........................................
        // smlal v16.4S, v15.4H, v26.4H           // ..................*...................................
        // smlal2 v23.4S, v1.8H, v24.8H           // ...............*......................................
        // smlal2 v23.4S, v15.8H, v26.8H          // .................*....................................
        // smlal v13.4S, v5.4H, v0.4H             // .................................*....................
        // smlal2 v8.4S, v5.8H, v0.8H             // ..................................*...................
        // uzp1 v30.8H, v16.8H, v23.8H            // ....................*.................................
        // uzp2 v19.8H, v13.8H, v8.8H             // ...................................*..................
        // mul v5.8H, v30.8H, v2.H[2]             // ..........................*...........................
        // smlal2 v23.4S, v5.8H, v0.8H            // ...................................*..................
        // smlal v16.4S, v5.4H, v0.4H             // ................................*.....................
        // uzp2 v18.8H, v16.8H, v23.8H            // .....................................*................
        // sqdmulh v5.8H, v19.8H, v2.H[1]         // ......................................*...............
        // sqdmulh v29.8H, v18.8H, v2.H[1]        // ........................................*.............
        // srshr v5.8H, v5.8H, #11                // ...........................................*..........
        // srshr v29.8H, v29.8H, #11              // .............................................*........
        // mls v19.8H, v5.8H, v2.H[0]             // ..............................................*.......
        // mls v18.8H, v29.8H, v2.H[0]            // ................................................*.....
        // st2 {v18.8H, v19.8H}, [x0], #32        // .....................................................*


        pop_stack
        ret
#endif /* KYBER_K == 2 */

#if KYBER_K == 3
.global polyvec_basemul_acc_montgomery_cached_asm_k3_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k3_opt

polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)

        mov count, #(KYBER_N / 16)
                                            // Instructions:    50
                                            // Expected cycles: 30
                                            // Expected IPC:    1.67

                                            // Cycle bound:     30.0
                                            // IPC bound:       1.67

                                            // Wall time:     0.35s
                                            // User time:     0.35s

                                            // ----- cycle (expected) ------>
                                            // 0                        25
                                            // |------------------------|----
        ldr q30, [x1, #16]                  // *.............................
        ldr q12, [x1], #32                  // *.............................
        ldr q9, [x2, #16]                   // .*............................
        ldr q17, [x2], #32                  // .*............................
        ldr q29, [x5, #16]                  // ..*...........................
        ldr q8, [x8, #16]                   // ..*...........................
        ldr q20, [x7, #16]                  // ...*..........................
        ldr q18, [x7], #32                  // ...*..........................
        uzp2 v14.8H, v12.8H, v30.8H         // ....*.........................
        uzp1 v28.8H, v12.8H, v30.8H         // ....*.........................
        ldr q16, [x5], #32                  // ....*.........................
        ldr q19, [x4], #32                  // .....*........................
        uzp2 v24.8H, v17.8H, v9.8H          // .....*........................
        ldr q27, [x4, #-16]                 // .....*........................
        uzp1 v5.8H, v17.8H, v9.8H           // ......*.......................
        ldr q11, [x1], #32                  // ......*.......................
        ldr q13, [x8, #48]                  // ......*.......................
        uzp1 v15.8H, v18.8H, v20.8H         // .......*......................
        ld1 {v10.8H}, [x3], #16             // .......*......................
        smull v23.4S, v28.4H, v24.4H        // ........*.....................
        ldr q12, [x4], #32                  // ........*.....................
        uzp2 v22.8H, v16.8H, v29.8H         // ........*.....................
        smlal v23.4S, v14.4H, v5.4H         // .........*....................
        ldr q17, [x8], #32                  // .........*....................
        uzp1 v9.8H, v19.8H, v27.8H          // .........*....................
        uzp1 v25.8H, v16.8H, v29.8H         // ..........*...................
        smull2 v3.4S, v28.8H, v24.8H        // ..........*...................
        ldr q30, [x1, #-16]                 // ..........*...................
        uzp2 v6.8H, v19.8H, v27.8H          // ...........*..................
        smlal2 v3.4S, v14.8H, v5.8H         // ...........*..................
        ld1 {v27.8H}, [x6], #16             // ...........*..................
        uzp2 v31.8H, v18.8H, v20.8H         // ............*.................
        smlal v23.4S, v9.4H, v22.4H         // ............*.................
        ld1 {v18.8H}, [x9], #16             // ............*.................
        smlal2 v3.4S, v9.8H, v22.8H         // .............*................
        uzp2 v16.8H, v17.8H, v8.8H          // .............*................
        smlal2 v3.4S, v6.8H, v25.8H         // ..............*...............
        uzp1 v20.8H, v17.8H, v8.8H          // ...............*..............
        smlal v23.4S, v6.4H, v25.4H         // ...............*..............
        smlal2 v3.4S, v15.8H, v16.8H        // ................*.............
        smlal v23.4S, v15.4H, v16.4H        // .................*............
        smlal2 v3.4S, v31.8H, v20.8H        // ..................*...........
        smlal v23.4S, v31.4H, v20.4H        // ...................*..........
        smull v4.4S, v28.4H, v5.4H          // ....................*.........
        uzp1 v17.8H, v23.8H, v3.8H          // ....................*.........
        smlal v4.4S, v14.4H, v10.4H         // .....................*........
        smlal v4.4S, v9.4H, v25.4H          // ......................*.......
        mul v17.8H, v17.8H, v2.H[2]         // .......................*......
        smlal2 v3.4S, v17.8H, v0.8H         // ............................*.
        smlal v23.4S, v17.4H, v0.4H         // .............................*

                                             // ------ cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|-----
        // ldr q13, [x8, #16]                 // ..*............................
        // ldr q12, [x4], #32                 // .....*.........................
        // ldr q30, [x1, #16]                 // *..............................
        // ldr q11, [x1], #32                 // *..............................
        // ldr q1, [x8], #32                  // .........*.....................
        // ldr q19, [x4, #-16]                // .....*.........................
        // ldr q21, [x2, #16]                 // .*.............................
        // ldr q22, [x7, #16]                 // ...*...........................
        // ldr q7, [x7], #32                  // ...*...........................
        // ldr q29, [x2], #32                 // .*.............................
        // uzp2 v14.8H, v11.8H, v30.8H        // ....*..........................
        // uzp2 v6.8H, v12.8H, v19.8H         // ...........*...................
        // ldr q24, [x5, #16]                 // ..*............................
        // ldr q27, [x5], #32                 // ....*..........................
        // uzp1 v28.8H, v11.8H, v30.8H        // ....*..........................
        // uzp1 v15.8H, v7.8H, v22.8H         // .......*.......................
        // uzp2 v26.8H, v29.8H, v21.8H        // .....*.........................
        // uzp1 v5.8H, v29.8H, v21.8H         // ......*........................
        // uzp1 v25.8H, v27.8H, v24.8H        // ..........*....................
        // uzp2 v18.8H, v27.8H, v24.8H        // ........*......................
        // smull v23.4S, v28.4H, v26.4H       // ........*......................
        // uzp1 v9.8H, v12.8H, v19.8H         // .........*.....................
        // smlal v23.4S, v14.4H, v5.4H        // .........*.....................
        // smull2 v3.4S, v28.8H, v26.8H       // ..........*....................
        // smlal2 v3.4S, v14.8H, v5.8H        // ...........*...................
        // uzp1 v20.8H, v1.8H, v13.8H         // ...............*...............
        // uzp2 v24.8H, v1.8H, v13.8H         // .............*.................
        // smlal v23.4S, v9.4H, v18.4H        // ............*..................
        // ldr q13, [x8, #16]                 // ......*........................
        // uzp2 v31.8H, v7.8H, v22.8H         // ............*..................
        // ld1 {v10.8H}, [x3], #16            // .......*.......................
        // smlal2 v3.4S, v9.8H, v18.8H        // .............*.................
        // smlal2 v3.4S, v6.8H, v25.8H        // ..............*................
        // smlal v23.4S, v6.4H, v25.4H        // ...............*...............
        // smlal2 v3.4S, v15.8H, v24.8H       // ................*..............
        // smlal2 v3.4S, v31.8H, v20.8H       // ..................*............
        // smlal v23.4S, v15.4H, v24.4H       // .................*.............
        // smlal v23.4S, v31.4H, v20.4H       // ...................*...........
        // smull v4.4S, v28.4H, v5.4H         // ....................*..........
        // uzp1 v22.8H, v23.8H, v3.8H         // ....................*..........
        // mul v1.8H, v22.8H, v2.H[2]         // .......................*.......
        // ldr q12, [x4], #32                 // ........*......................
        // ldr q30, [x1, #16]                 // ..........*....................
        // ldr q11, [x1], #32                 // ......*........................
        // ld1 {v18.8H}, [x9], #16            // ............*..................
        // smlal v4.4S, v14.4H, v10.4H        // .....................*.........
        // ld1 {v27.8H}, [x6], #16            // ...........*...................
        // smlal v4.4S, v9.4H, v25.4H         // ......................*........
        // smlal2 v3.4S, v1.8H, v0.8H         // ............................*..
        // smlal v23.4S, v1.4H, v0.4H         // .............................*.

        sub count, count, #2
k3_loop_start:
                                              // Instructions:    68
                                              // Expected cycles: 40
                                              // Expected IPC:    1.70

                                              // Cycle bound:     40.0
                                              // IPC bound:       1.70

                                              // Wall time:     30.37s
                                              // User time:     30.37s

                                              // ---------- cycle (expected) ----------->
                                              // 0                        25
                                              // |------------------------|--------------
        smlal v4.4S, v6.4H, v27.4H            // l.......................................
        ldr q1, [x8], #32                     // *.......................................
        smlal v4.4S, v15.4H, v20.4H           // .l......................................
        ldr q19, [x4, #-16]                   // .*......................................
        ldr q21, [x2, #16]                    // .*......................................
        ldr q22, [x7, #16]                    // ..*.....................................
        smull2 v16.4S, v28.8H, v5.8H          // ..l.....................................
        uzp2 v8.8H, v23.8H, v3.8H             // ...l....................................
        smlal2 v16.4S, v14.8H, v10.8H         // ...l....................................
        ldr q7, [x7], #32                     // ...*....................................
        ldr q29, [x2], #32                    // ....*...................................
        smlal2 v16.4S, v9.8H, v25.8H          // ....l...................................
        uzp2 v14.8H, v11.8H, v30.8H           // ....*...................................
        smlal2 v16.4S, v6.8H, v27.8H          // .....l..................................
        uzp2 v6.8H, v12.8H, v19.8H            // .....*..................................
        ldr q24, [x5, #16]                    // .....*..................................
        ldr q27, [x5], #32                    // ......*.................................
        smlal2 v16.4S, v15.8H, v20.8H         // ......l.................................
        uzp1 v28.8H, v11.8H, v30.8H           // ......*.................................
        sqdmulh v11.8H, v8.8H, v2.H[1]        // .......l................................
        uzp1 v15.8H, v7.8H, v22.8H            // .......*................................
        uzp2 v26.8H, v29.8H, v21.8H           // ........*...............................
        uzp1 v5.8H, v29.8H, v21.8H            // .........*..............................
        smlal2 v16.4S, v31.8H, v18.8H         // .........l..............................
        uzp1 v25.8H, v27.8H, v24.8H           // ..........*.............................
        smlal v4.4S, v31.4H, v18.4H           // ..........l.............................
        uzp2 v18.8H, v27.8H, v24.8H           // ...........*............................
        smull v23.4S, v28.4H, v26.4H          // ...........*............................
        uzp1 v9.8H, v12.8H, v19.8H            // ............*...........................
        smlal v23.4S, v14.4H, v5.4H           // ............*...........................
        smull2 v3.4S, v28.8H, v26.8H          // .............*..........................
        uzp1 v27.8H, v4.8H, v16.8H            // .............l..........................
        smlal2 v3.4S, v14.8H, v5.8H           // ..............*.........................
        uzp1 v20.8H, v1.8H, v13.8H            // ..............*.........................
        uzp2 v24.8H, v1.8H, v13.8H            // ...............*........................
        smlal v23.4S, v9.4H, v18.4H           // ...............*........................
        ldr q13, [x8, #16]                    // ...............e........................
        uzp2 v31.8H, v7.8H, v22.8H            // ................*.......................
        ld1 {v10.8H}, [x3], #16               // ................*.......................
        mul v21.8H, v27.8H, v2.H[2]           // ................l.......................
        smlal2 v3.4S, v9.8H, v18.8H           // ..................*.....................
        smlal2 v3.4S, v6.8H, v25.8H           // ...................*....................
        smlal v23.4S, v6.4H, v25.4H           // ....................*...................
        smlal v4.4S, v21.4H, v0.4H            // .....................l..................
        smlal2 v16.4S, v21.8H, v0.8H          // ......................l.................
        uzp2 v7.8H, v4.8H, v16.8H             // .......................l................
        smlal2 v3.4S, v15.8H, v24.8H          // .......................*................
        smlal2 v3.4S, v31.8H, v20.8H          // ........................*...............
        srshr v11.8H, v11.8H, #11             // ........................l...............
        smlal v23.4S, v15.4H, v24.4H          // .........................*..............
        sqdmulh v21.8H, v7.8H, v2.H[1]        // ..........................l.............
        smlal v23.4S, v31.4H, v20.4H          // ............................*...........
        smull v4.4S, v28.4H, v5.4H            // .............................*..........
        uzp1 v22.8H, v23.8H, v3.8H            // .............................*..........
        mls v8.8H, v11.8H, v2.H[0]            // ..............................l.........
        srshr v11.8H, v21.8H, #11             // ...............................l........
        mul v1.8H, v22.8H, v2.H[2]            // ................................*.......
        ldr q12, [x4], #32                    // ................................e.......
        ldr q30, [x1, #16]                    // .................................e......
        mls v7.8H, v11.8H, v2.H[0]            // ..................................l.....
        ldr q11, [x1], #32                    // ..................................e.....
        ld1 {v18.8H}, [x9], #16               // ...................................*....
        smlal v4.4S, v14.4H, v10.4H           // ....................................*...
        ld1 {v27.8H}, [x6], #16               // ....................................*...
        smlal v4.4S, v9.4H, v25.4H            // .....................................*..
        smlal2 v3.4S, v1.8H, v0.8H            // ......................................*.
        smlal v23.4S, v1.4H, v0.4H            // .......................................*
        st2 {v7.8H, v8.8H}, [x0], #32         // .......................................l

                                                // ------------------------------------------- cycle (expected) ------------------------------------------->
                                                // 0                        25                       50                       75                       100
                                                // |------------------------|------------------------|------------------------|------------------------|----
        // ldr q12, [x1], #32                    // ...................e.....'.................................~.....'.................................~.....
        // ldr q13, [x1, #-16]                   // ..................e......'................................~......'................................~......
        // uzp1 v3.8h, v12.8h, v13.8h            // .........................'.....*.................................'.....~.................................
        // uzp2 v4.8h, v12.8h, v13.8h            // .........................'...*...................................'...~...................................
        // ldr q12, [x2], #32                    // .........................'...*...................................'...~...................................
        // ldr q13, [x2, #-16]                   // .........................'*......................................'~......................................
        // uzp1 v5.8h, v12.8h, v13.8h            // .........................'........*..............................'........~..............................
        // uzp2 v6.8h, v12.8h, v13.8h            // .........................'.......*...............................'.......~...............................
        // ld1 {v7.8h}, [x3], #16                // .~.......................'...............*.......................'...............~.......................
        // smull  v8.4s, v3.4h, v5.4h            // ..............~..........'............................*..........'............................~..........
        // smull2 v10.4s, v3.8h, v5.8h           // .........................'.~.....................................'.l.....................................
        // smlal  v8.4s, v4.4h, v7.4h            // .....................~...'...................................*...'...................................~...
        // smlal2 v10.4s, v4.8h, v7.8h           // .........................'..~....................................'..l....................................
        // smull  v9.4s, v3.4h, v6.4h            // .........................'..........*............................'..........~............................
        // smull2 v11.4s, v3.8h, v6.8h           // .........................'............*..........................'............~..........................
        // smlal  v9.4s, v4.4h, v5.4h            // .........................'...........*...........................'...........~...........................
        // smlal2 v11.4s, v4.8h, v5.8h           // .........................'.............*.........................'.............~.........................
        // ldr q12, [x4], #32                    // .................e.......'...............................~.......'...............................~.......
        // ldr q13, [x4, #-16]                   // .........................'*......................................'~......................................
        // uzp1 v3.8h, v12.8h, v13.8h            // .........................'...........*...........................'...........~...........................
        // uzp2 v4.8h, v12.8h, v13.8h            // .........................'....*..................................'....~..................................
        // ldr q12, [x5], #32                    // .........................'.....*.................................'.....~.................................
        // ldr q13, [x5, #-16]                   // .........................'....*..................................'....~..................................
        // uzp1 v5.8h, v12.8h, v13.8h            // .........................'.........*.............................'.........~.............................
        // uzp2 v6.8h, v12.8h, v13.8h            // .........................'..........*............................'..........~............................
        // ld1 {v7.8h}, [x6], #16                // .....................~...'...................................*...'...................................~...
        // smlal  v8.4s, v3.4h, v5.4h            // ......................~..'....................................*..'....................................~..
        // smlal2 v10.4s, v3.8h, v5.8h           // .........................'...~...................................'...l...................................
        // smlal  v8.4s, v4.4h, v7.4h            // .........................~.......................................l.......................................
        // smlal2 v10.4s, v4.8h, v7.8h           // .........................'....~..................................'....l..................................
        // smlal  v9.4s, v3.4h, v6.4h            // ~........................'..............*........................'..............~........................
        // smlal2 v11.4s, v3.8h, v6.8h           // ...~.....................'.................*.....................'.................~.....................
        // smlal  v9.4s, v4.4h, v5.4h            // .....~...................'...................*...................'...................~...................
        // smlal2 v11.4s, v4.8h, v5.8h           // ....~....................'..................*....................'..................~....................
        // ldr q12, [x7], #32                    // .........................'..*....................................'..~....................................
        // ldr q13, [x7, #-16]                   // .........................'.*.....................................'.~.....................................
        // uzp1 v3.8h, v12.8h, v13.8h            // .........................'......*................................'......~................................
        // uzp2 v4.8h, v12.8h, v13.8h            // .~.......................'...............*.......................'...............~.......................
        // ldr q12, [x8], #32                    // .........................*.......................................~.......................................
        // ldr q13, [x8, #-16]                   // e........................'..............~........................'..............~........................
        // uzp1 v5.8h, v12.8h, v13.8h            // .........................'.............*.........................'.............~.........................
        // uzp2 v6.8h, v12.8h, v13.8h            // ~........................'..............*........................'..............~........................
        // ld1 {v7.8h}, [x9], #16                // ....................~....'..................................*....'..................................~....
        // smlal  v8.4s, v3.4h, v5.4h            // .........................'~......................................'l......................................
        // smlal2 v10.4s, v3.8h, v5.8h           // .........................'.....~.................................'.....l.................................
        // smlal  v8.4s, v4.4h, v7.4h            // .........................'.........~.............................'.........l.............................
        // smlal2 v10.4s, v4.8h, v7.8h           // .........................'........~..............................'........l..............................
        // smlal  v9.4s, v3.4h, v6.4h            // ..........~..............'........................*..............'........................~..............
        // smlal2 v11.4s, v3.8h, v6.8h           // ........~................'......................*................'......................~................
        // smlal  v9.4s, v4.4h, v5.4h            // .............~...........'...........................*...........'...........................~...........
        // smlal2 v11.4s, v4.8h, v5.8h           // .........~...............'.......................*...............'.......................~...............
        // uzp1   v28.8h, v8.8h, v10.8h          // .........................'............~..........................'............l..........................
        // mul    v28.8h, v28.8h, v2.h[2]        // .~.......................'...............~.......................'...............l.......................
        // smlal  v8.4s, v28.4h, v0.4h           // ......~..................'....................~..................'....................l..................
        // smlal2 v10.4s, v28.8h, v0.8h          // .......~.................'.....................~.................'.....................l.................
        // uzp2   v26.8h, v8.8h, v10.8h          // ........~................'......................~................'......................l................
        // uzp1   v28.8h, v9.8h, v11.8h          // ..............~..........'............................*..........'............................~..........
        // mul    v28.8h, v28.8h, v2.h[2]        // .................~.......'...............................*.......'...............................~.......
        // smlal  v9.4s, v28.4h, v0.4h           // ........................~'......................................*'.......................................
        // smlal2 v11.4s, v28.8h, v0.8h          // .......................~.'.....................................*.'.....................................~.
        // uzp2   v27.8h, v9.8h, v11.8h          // .........................'..~....................................'..l....................................
        // sqdmulh v28.8h, v26.8h, v2.h[1]       // ...........~.............'.........................~.............'.........................l.............
        // srshr   v28.8h, v28.8h, #11           // ................~........'..............................~........'..............................l........
        // mls     v26.8h, v28.8h, v2.h[0]       // ...................~.....'.................................~.....'.................................l.....
        // sqdmulh v28.8h, v27.8h, v2.h[1]       // .........................'......~................................'......l................................
        // srshr   v28.8h, v28.8h, #11           // .........~...............'.......................~...............'.......................l...............
        // mls     v27.8h, v28.8h, v2.h[0]       // ...............~.........'.............................~.........'.............................l.........
        // st2 {v26.8h, v27.8h}, [x0], #32       // ........................~'......................................~'......................................l

        sub count, count, #1
        cbnz count, k3_loop_start
                                               // Instructions:    86
                                               // Expected cycles: 65
                                               // Expected IPC:    1.32

                                               // Cycle bound:     65.0
                                               // IPC bound:       1.32

                                               // Wall time:     3.20s
                                               // User time:     3.20s

                                               // ----------------------- cycle (expected) ----------------------->
                                               // 0                        25                       50
                                               // |------------------------|------------------------|--------------
        smlal v4.4S, v6.4H, v27.4H             // *................................................................
        uzp2 v17.8H, v23.8H, v3.8H             // *................................................................
        ldr q29, [x4, #-16]                    // *................................................................
        smull2 v28.4S, v28.8H, v5.8H           // .*...............................................................
        ldr q21, [x8], #32                     // .*...............................................................
        uzp2 v16.8H, v11.8H, v30.8H            // .*...............................................................
        smlal2 v28.4S, v14.8H, v10.8H          // ..*..............................................................
        uzp1 v14.8H, v11.8H, v30.8H            // ..*..............................................................
        ldr q23, [x2, #16]                     // ..*..............................................................
        smlal2 v28.4S, v9.8H, v25.8H           // ...*.............................................................
        ldr q9, [x7, #16]                      // ...*.............................................................
        ldr q25, [x7], #32                     // ...*.............................................................
        smlal2 v28.4S, v6.8H, v27.8H           // ....*............................................................
        ldr q3, [x2], #32                      // ....*............................................................
        uzp2 v7.8H, v12.8H, v29.8H             // ....*............................................................
        uzp1 v29.8H, v12.8H, v29.8H            // .....*...........................................................
        smlal v4.4S, v15.4H, v20.4H            // .....*...........................................................
        ldr q22, [x5, #16]                     // .....*...........................................................
        smlal2 v28.4S, v15.8H, v20.8H          // ......*..........................................................
        uzp1 v12.8H, v21.8H, v13.8H            // ......*..........................................................
        ldr q20, [x5], #32                     // ......*..........................................................
        uzp2 v21.8H, v21.8H, v13.8H            // .......*.........................................................
        smlal2 v28.4S, v31.8H, v18.8H          // .......*.........................................................
        ld1 {v13.8H}, [x3], #16                // .......*.........................................................
        smlal v4.4S, v31.4H, v18.4H            // ........*........................................................
        uzp1 v24.8H, v3.8H, v23.8H             // ........*........................................................
        ld1 {v11.8H}, [x9], #16                // ........*........................................................
        uzp2 v18.8H, v3.8H, v23.8H             // .........*.......................................................
        ld1 {v30.8H}, [x6], #16                // .........*.......................................................
        sqdmulh v19.8H, v17.8H, v2.H[1]        // .........*.......................................................
        uzp1 v3.8H, v20.8H, v22.8H             // ..........*......................................................
        uzp2 v20.8H, v20.8H, v22.8H            // ...........*.....................................................
        smull v22.4S, v14.4H, v24.4H           // ...........*.....................................................
        smlal v22.4S, v16.4H, v13.4H           // ............*....................................................
        uzp1 v10.8H, v25.8H, v9.8H             // ............*....................................................
        uzp2 v9.8H, v25.8H, v9.8H              // .............*...................................................
        smlal v22.4S, v29.4H, v3.4H            // .............*...................................................
        uzp1 v23.8H, v4.8H, v28.8H             // ..............*..................................................
        smlal v22.4S, v7.4H, v30.4H            // ..............*..................................................
        smlal v22.4S, v10.4H, v12.4H           // ...............*.................................................
        smlal v22.4S, v9.4H, v11.4H            // ................*................................................
        smull v25.4S, v14.4H, v18.4H           // .................*...............................................
        smull2 v18.4S, v14.8H, v18.8H          // ..................*..............................................
        smull2 v14.4S, v14.8H, v24.8H          // ...................*.............................................
        smlal2 v14.4S, v16.8H, v13.8H          // ....................*............................................
        smlal2 v14.4S, v29.8H, v3.8H           // .....................*...........................................
        smlal2 v14.4S, v7.8H, v30.8H           // ......................*..........................................
        smlal2 v14.4S, v10.8H, v12.8H          // .......................*.........................................
        smlal2 v14.4S, v9.8H, v11.8H           // ........................*........................................
        smlal2 v18.4S, v16.8H, v24.8H          // .........................*.......................................
        uzp1 v27.8H, v22.8H, v14.8H            // .........................*.......................................
        smlal2 v18.4S, v29.8H, v20.8H          // ..........................*......................................
        smlal2 v18.4S, v7.8H, v3.8H            // ...........................*.....................................
        mul v26.8H, v27.8H, v2.H[2]            // ............................*....................................
        smlal2 v18.4S, v10.8H, v21.8H          // ..............................*..................................
        smlal v25.4S, v16.4H, v24.4H           // ...............................*.................................
        smlal v25.4S, v29.4H, v20.4H           // ................................*................................
        smlal v25.4S, v7.4H, v3.4H             // .................................*...............................
        smlal v25.4S, v10.4H, v21.4H           // ..................................*..............................
        smlal v25.4S, v9.4H, v12.4H            // ...................................*.............................
        smlal2 v18.4S, v9.8H, v12.8H           // ....................................*............................
        mul v9.8H, v23.8H, v2.H[2]             // .....................................*...........................
        uzp1 v29.8H, v25.8H, v18.8H            // .....................................*...........................
        srshr v23.8H, v19.8H, #11              // ......................................*..........................
        smlal v22.4S, v26.4H, v0.4H            // .......................................*.........................
        mul v29.8H, v29.8H, v2.H[2]            // ........................................*........................
        smlal2 v28.4S, v9.8H, v0.8H            // ..........................................*......................
        smlal2 v14.4S, v26.8H, v0.8H           // ...........................................*.....................
        uzp2 v8.8H, v22.8H, v14.8H             // ............................................*....................
        smlal v4.4S, v9.4H, v0.4H              // ............................................*....................
        smlal v25.4S, v29.4H, v0.4H            // .............................................*...................
        smlal2 v18.4S, v29.8H, v0.8H           // ..............................................*..................
        uzp2 v16.8H, v4.8H, v28.8H             // ..............................................*..................
        sqdmulh v14.8H, v8.8H, v2.H[1]         // ...............................................*.................
        uzp2 v9.8H, v25.8H, v18.8H             // ................................................*................
        sqdmulh v18.8H, v16.8H, v2.H[1]        // .................................................*...............
        sqdmulh v20.8H, v9.8H, v2.H[1]         // ...................................................*.............
        srshr v27.8H, v14.8H, #11              // ....................................................*............
        mls v17.8H, v23.8H, v2.H[0]            // .....................................................*...........
        srshr v18.8H, v18.8H, #11              // ......................................................*..........
        mls v8.8H, v27.8H, v2.H[0]             // .......................................................*.........
        srshr v20.8H, v20.8H, #11              // ........................................................*........
        mls v16.8H, v18.8H, v2.H[0]            // .........................................................*.......
        mls v9.8H, v20.8H, v2.H[0]             // ...........................................................*.....
        st2 {v16.8H, v17.8H}, [x0], #32        // ...............................................................*.
        st2 {v8.8H, v9.8H}, [x0], #32          // ................................................................*

                                               // ----------------------- cycle (expected) ----------------------->
                                               // 0                        25                       50
                                               // |------------------------|------------------------|--------------
        // smlal v4.4S, v6.4H, v27.4H           // *................................................................
        // ldr q1, [x8], #32                    // .*...............................................................
        // smlal v4.4S, v15.4H, v20.4H          // .....*...........................................................
        // ldr q19, [x4, #-16]                  // *................................................................
        // ldr q21, [x2, #16]                   // ..*..............................................................
        // ldr q22, [x7, #16]                   // ...*.............................................................
        // smull2 v16.4S, v28.8H, v5.8H         // .*...............................................................
        // uzp2 v8.8H, v23.8H, v3.8H            // *................................................................
        // smlal2 v16.4S, v14.8H, v10.8H        // ..*..............................................................
        // ldr q7, [x7], #32                    // ...*.............................................................
        // ldr q29, [x2], #32                   // ....*............................................................
        // smlal2 v16.4S, v9.8H, v25.8H         // ...*.............................................................
        // uzp2 v14.8H, v11.8H, v30.8H          // .*...............................................................
        // smlal2 v16.4S, v6.8H, v27.8H         // ....*............................................................
        // uzp2 v6.8H, v12.8H, v19.8H           // ....*............................................................
        // ldr q24, [x5, #16]                   // .....*...........................................................
        // ldr q27, [x5], #32                   // ......*..........................................................
        // smlal2 v16.4S, v15.8H, v20.8H        // ......*..........................................................
        // uzp1 v28.8H, v11.8H, v30.8H          // ..*..............................................................
        // sqdmulh v11.8H, v8.8H, v2.H[1]       // .........*.......................................................
        // uzp1 v15.8H, v7.8H, v22.8H           // ............*....................................................
        // uzp2 v26.8H, v29.8H, v21.8H          // .........*.......................................................
        // uzp1 v5.8H, v29.8H, v21.8H           // ........*........................................................
        // smlal2 v16.4S, v31.8H, v18.8H        // .......*.........................................................
        // uzp1 v25.8H, v27.8H, v24.8H          // ..........*......................................................
        // smlal v4.4S, v31.4H, v18.4H          // ........*........................................................
        // uzp2 v18.8H, v27.8H, v24.8H          // ...........*.....................................................
        // smull v23.4S, v28.4H, v26.4H         // .................*...............................................
        // uzp1 v9.8H, v12.8H, v19.8H           // .....*...........................................................
        // smlal v23.4S, v14.4H, v5.4H          // ...............................*.................................
        // smull2 v3.4S, v28.8H, v26.8H         // ..................*..............................................
        // uzp1 v27.8H, v4.8H, v16.8H           // ..............*..................................................
        // smlal2 v3.4S, v14.8H, v5.8H          // .........................*.......................................
        // uzp1 v20.8H, v1.8H, v13.8H           // ......*..........................................................
        // uzp2 v24.8H, v1.8H, v13.8H           // .......*.........................................................
        // smlal v23.4S, v9.4H, v18.4H          // ................................*................................
        // uzp2 v31.8H, v7.8H, v22.8H           // .............*...................................................
        // ld1 {v10.8H}, [x3], #16              // .......*.........................................................
        // mul v21.8H, v27.8H, v2.H[2]          // .....................................*...........................
        // smlal2 v3.4S, v9.8H, v18.8H          // ..........................*......................................
        // smlal2 v3.4S, v6.8H, v25.8H          // ...........................*.....................................
        // smlal v23.4S, v6.4H, v25.4H          // .................................*...............................
        // smlal v4.4S, v21.4H, v0.4H           // ............................................*....................
        // smlal2 v16.4S, v21.8H, v0.8H         // ..........................................*......................
        // uzp2 v7.8H, v4.8H, v16.8H            // ..............................................*..................
        // smlal2 v3.4S, v15.8H, v24.8H         // ..............................*..................................
        // smlal2 v3.4S, v31.8H, v20.8H         // ....................................*............................
        // srshr v11.8H, v11.8H, #11            // ......................................*..........................
        // smlal v23.4S, v15.4H, v24.4H         // ..................................*..............................
        // sqdmulh v21.8H, v7.8H, v2.H[1]       // .................................................*...............
        // smlal v23.4S, v31.4H, v20.4H         // ...................................*.............................
        // smull v4.4S, v28.4H, v5.4H           // ...........*.....................................................
        // uzp1 v22.8H, v23.8H, v3.8H           // .....................................*...........................
        // mls v8.8H, v11.8H, v2.H[0]           // .....................................................*...........
        // srshr v11.8H, v21.8H, #11            // ......................................................*..........
        // mul v1.8H, v22.8H, v2.H[2]           // ........................................*........................
        // mls v7.8H, v11.8H, v2.H[0]           // .........................................................*.......
        // ld1 {v18.8H}, [x9], #16              // ........*........................................................
        // smlal v4.4S, v14.4H, v10.4H          // ............*....................................................
        // ld1 {v27.8H}, [x6], #16              // .........*.......................................................
        // smlal v4.4S, v9.4H, v25.4H           // .............*...................................................
        // smlal2 v3.4S, v1.8H, v0.8H           // ..............................................*..................
        // smlal v23.4S, v1.4H, v0.4H           // .............................................*...................
        // st2 {v7.8H, v8.8H}, [x0], #32        // ...............................................................*.
        // smlal v4.4S, v6.4H, v27.4H           // ..............*..................................................
        // smlal v4.4S, v15.4H, v20.4H          // ...............*.................................................
        // smull2 v16.4S, v28.8H, v5.8H         // ...................*.............................................
        // uzp2 v8.8H, v23.8H, v3.8H            // ................................................*................
        // smlal2 v16.4S, v14.8H, v10.8H        // ....................*............................................
        // smlal2 v16.4S, v9.8H, v25.8H         // .....................*...........................................
        // smlal2 v16.4S, v6.8H, v27.8H         // ......................*..........................................
        // smlal2 v16.4S, v15.8H, v20.8H        // .......................*.........................................
        // sqdmulh v11.8H, v8.8H, v2.H[1]       // ...................................................*.............
        // smlal2 v16.4S, v31.8H, v18.8H        // ........................*........................................
        // smlal v4.4S, v31.4H, v18.4H          // ................*................................................
        // uzp1 v27.8H, v4.8H, v16.8H           // .........................*.......................................
        // mul v21.8H, v27.8H, v2.H[2]          // ............................*....................................
        // smlal v4.4S, v21.4H, v0.4H           // .......................................*.........................
        // smlal2 v16.4S, v21.8H, v0.8H         // ...........................................*.....................
        // uzp2 v7.8H, v4.8H, v16.8H            // ............................................*....................
        // srshr v11.8H, v11.8H, #11            // ........................................................*........
        // sqdmulh v21.8H, v7.8H, v2.H[1]       // ...............................................*.................
        // mls v8.8H, v11.8H, v2.H[0]           // ...........................................................*.....
        // srshr v11.8H, v21.8H, #11            // ....................................................*............
        // mls v7.8H, v11.8H, v2.H[0]           // .......................................................*.........
        // st2 {v7.8H, v8.8H}, [x0], #32        // ................................................................*


        pop_stack
        ret
#endif /* KYBER_K == 3 */

#if KYBER_K == 4
.global polyvec_basemul_acc_montgomery_cached_asm_k4_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k4_opt

polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)
        add a3_ptr, a0_ptr, #(3 * 512)
        add b3_ptr, b0_ptr, #(3 * 512)
        add b3_cache_ptr, b0_cache_ptr, #(3 * 512/2)

        mov count, #(KYBER_N / 16)
                                             // Instructions:    51
                                             // Expected cycles: 22
                                             // Expected IPC:    2.32
                                             //
                                             // Cycle bound:     22.0
                                             // IPC bound:       2.32
                                             //
                                             // Wall time:     0.43s
                                             // User time:     0.43s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        ldr q23, [x1], #32                   // *.............................
        ldr q3, [x1, #-16]                   // *.............................
        ldr q11, [x2, #16]                   // .*............................
        ldr q30, [x2], #32                   // .*............................
        ldr q10, [x4, #16]                   // ..*...........................
        ldr q25, [x4], #32                   // ..*...........................
        ldr q16, [x5, #16]                   // ...*..........................
        ldr q24, [x5], #32                   // ...*..........................
        uzp1 v8.8H, v30.8H, v11.8H           // .....*........................
        ld1 {v17.8H}, [x3], #16              // .....*........................
        uzp1 v26.8H, v23.8H, v3.8H           // .....*........................
        uzp2 v1.8H, v23.8H, v3.8H            // ......*.......................
        uzp1 v19.8H, v24.8H, v16.8H          // .......*......................
        uzp1 v21.8H, v25.8H, v10.8H          // .......*......................
        smull v29.4S, v26.4H, v8.4H          // ........*.....................
        uzp2 v28.8H, v30.8H, v11.8H          // ........*.....................
        smlal v29.4S, v1.4H, v17.4H          // .........*....................
        ldr q20, [x8], #32                   // .........*....................
        smlal v29.4S, v21.4H, v19.4H         // ..........*...................
        ldr q27, [x8, #-16]                  // ...........*..................
        smull2 v12.4S, v26.8H, v8.8H         // ...........*..................
        smlal2 v12.4S, v1.8H, v17.8H         // ............*.................
        ldr q4, [x7, #16]                    // ............*.................
        ldr q30, [x11, #16]                  // ............*.................
        uzp2 v9.8H, v24.8H, v16.8H           // .............*................
        smull v23.4S, v26.4H, v28.4H         // .............*................
        ldr q11, [x7], #32                   // .............*................
        ld1 {v5.8H}, [x9], #16               // ..............*...............
        smull2 v7.4S, v26.8H, v28.8H         // ..............*...............
        ld1 {v28.8H}, [x6], #16              // ..............*...............
        uzp2 v14.8H, v25.8H, v10.8H          // ...............*..............
        smlal2 v12.4S, v21.8H, v19.8H        // ...............*..............
        ldr q10, [x10, #16]                  // ...............*..............
        smlal2 v7.4S, v1.8H, v8.8H           // ................*.............
        ldr q22, [x11], #32                  // ................*.............
        uzp1 v25.8H, v20.8H, v27.8H          // ................*.............
        smlal v23.4S, v1.4H, v8.4H           // .................*............
        ldr q18, [x10], #32                  // .................*............
        uzp1 v3.8H, v11.8H, v4.8H            // .................*............
        ldr q6, [x8, #16]                    // ..................*...........
        smlal2 v12.4S, v14.8H, v28.8H        // ..................*...........
        uzp2 v16.8H, v11.8H, v4.8H           // ..................*...........
        ldr q26, [x1], #32                   // ...................*..........
        smlal v23.4S, v21.4H, v9.4H          // ...................*..........
        uzp2 v8.8H, v20.8H, v27.8H           // ...................*..........
        uzp2 v13.8H, v22.8H, v30.8H          // ....................*.........
        smlal2 v12.4S, v3.8H, v25.8H         // ....................*.........
        ldr q11, [x4], #32                   // ....................*.........
        uzp1 v31.8H, v18.8H, v10.8H          // .....................*........
        smlal2 v12.4S, v16.8H, v5.8H         // .....................*........
        ldr q17, [x1, #-16]                  // .....................*........

                                              // ------ cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|-----
        // ldr q6, [x8, #16]                  // ...........*...................
        // ldr q17, [x1, #16]                 // *..............................
        // ldr q11, [x4], #32                 // ..*............................
        // ldr q26, [x1], #32                 // *..............................
        // ldr q15, [x5, #16]                 // ...*...........................
        // ldr q28, [x2, #16]                 // .*.............................
        // ldr q20, [x2], #32                 // .*.............................
        // ldr q24, [x5], #32                 // ...*...........................
        // ldr q21, [x4, #-16]                // ..*............................
        // ldr q4, [x7, #16]                  // ............*..................
        // uzp1 v1.8H, v26.8H, v17.8H         // .....*.........................
        // uzp2 v9.8H, v24.8H, v15.8H         // .............*.................
        // uzp1 v19.8H, v24.8H, v15.8H        // .......*.......................
        // ldr q24, [x8], #32                 // .........*.....................
        // uzp2 v15.8H, v26.8H, v17.8H        // ......*........................
        // uzp2 v14.8H, v11.8H, v21.8H        // ...............*...............
        // uzp2 v8.8H, v24.8H, v6.8H          // ...................*...........
        // ldr q13, [x7], #32                 // .............*.................
        // uzp1 v25.8H, v24.8H, v6.8H         // ................*..............
        // uzp2 v16.8H, v13.8H, v4.8H         // ..................*............
        // ld1 {v5.8H}, [x9], #16             // ..............*................
        // ldr q22, [x11], #32                // ................*..............
        // ld1 {v31.8H}, [x3], #16            // .....*.........................
        // uzp2 v17.8H, v20.8H, v28.8H        // ........*......................
        // ldr q30, [x11, #-16]               // ............*..................
        // ldr q18, [x10], #32                // .................*.............
        // uzp1 v3.8H, v13.8H, v4.8H          // .................*.............
        // smull2 v7.4S, v1.8H, v17.8H        // ..............*................
        // uzp1 v4.8H, v20.8H, v28.8H         // .....*.........................
        // uzp2 v13.8H, v22.8H, v30.8H        // ....................*..........
        // smull v23.4S, v1.4H, v17.4H        // .............*.................
        // smlal2 v7.4S, v15.8H, v4.8H        // ................*..............
        // smlal v23.4S, v15.4H, v4.4H        // .................*.............
        // smull v29.4S, v1.4H, v4.4H         // ........*......................
        // smull2 v12.4S, v1.8H, v4.8H        // ...........*...................
        // uzp1 v21.8H, v11.8H, v21.8H        // .......*.......................
        // smlal v29.4S, v15.4H, v31.4H       // .........*.....................
        // smlal2 v12.4S, v15.8H, v31.8H      // ............*..................
        // ldr q6, [x8, #16]                  // ..................*............
        // smlal2 v12.4S, v21.8H, v19.8H      // ...............*...............
        // ldr q10, [x10, #-16]               // ...............*...............
        // ldr q17, [x1, #16]                 // .....................*.........
        // ld1 {v28.8H}, [x6], #16            // ..............*................
        // ldr q11, [x4], #32                 // ....................*..........
        // uzp1 v31.8H, v18.8H, v10.8H        // .....................*.........
        // smlal2 v12.4S, v14.8H, v28.8H      // ..................*............
        // smlal2 v12.4S, v3.8H, v25.8H       // ....................*..........
        // smlal v23.4S, v21.4H, v9.4H        // ...................*...........
        // smlal2 v12.4S, v16.8H, v5.8H       // .....................*.........
        // ldr q26, [x1], #32                 // ...................*...........
        // smlal v29.4S, v21.4H, v19.4H       // ..........*....................

        sub count, count, #2
k4_loop_start:
                                               // Instructions:    85
                                               // Expected cycles: 48
                                               // Expected IPC:    1.77
                                               //
                                               // Cycle bound:     48.0
                                               // IPC bound:       1.77
                                               //
                                               // Wall time:     104.45s
                                               // User time:     104.45s
                                               //
                                               // -------------- cycle (expected) --------------->
                                               // 0                        25
                                               // |------------------------|----------------------
        smlal v29.4S, v14.4H, v28.4H           // l...............................................
        ldr q15, [x5, #16]                     // *...............................................
        ldr q28, [x2, #16]                     // *...............................................
        ldr q20, [x2], #32                     // .*..............................................
        ldr q24, [x5], #32                     // .*..............................................
        smlal2 v7.4S, v21.8H, v9.8H            // .l..............................................
        ldr q21, [x4, #-16]                    // ..*.............................................
        smlal v23.4S, v14.4H, v19.4H           // ..l.............................................
        uzp2 v27.8H, v18.8H, v10.8H            // ..l.............................................
        smlal2 v7.4S, v14.8H, v19.8H           // ...l............................................
        ldr q4, [x7, #16]                      // ...*............................................
        uzp1 v1.8H, v26.8H, v17.8H             // ...*............................................
        uzp1 v22.8H, v22.8H, v30.8H            // ....l...........................................
        ld1 {v10.8H}, [x12], #16               // ....l...........................................
        smlal2 v7.4S, v3.8H, v8.8H             // ....l...........................................
        uzp2 v9.8H, v24.8H, v15.8H             // .....*..........................................
        smlal2 v7.4S, v16.8H, v25.8H           // .....l..........................................
        smlal2 v7.4S, v31.8H, v13.8H           // ......l.........................................
        uzp1 v19.8H, v24.8H, v15.8H            // ......*.........................................
        ldr q24, [x8], #32                     // ......*.........................................
        smlal2 v7.4S, v27.8H, v22.8H           // .......l........................................
        uzp2 v15.8H, v26.8H, v17.8H            // .......*........................................
        uzp2 v14.8H, v11.8H, v21.8H            // ........*.......................................
        smlal v23.4S, v3.4H, v8.4H             // ........l.......................................
        smlal v23.4S, v16.4H, v25.4H           // .........l......................................
        uzp2 v8.8H, v24.8H, v6.8H              // ..........*.....................................
        smlal v23.4S, v31.4H, v13.4H           // ..........l.....................................
        smlal v23.4S, v27.4H, v22.4H           // ...........l....................................
        ldr q13, [x7], #32                     // ...........*....................................
        smlal2 v12.4S, v31.8H, v22.8H          // ............l...................................
        uzp1 v30.8H, v23.8H, v7.8H             // ............l...................................
        smlal v29.4S, v3.4H, v25.4H            // .............l..................................
        uzp1 v25.8H, v24.8H, v6.8H             // .............*..................................
        smlal v29.4S, v16.4H, v5.4H            // ..............l.................................
        uzp2 v16.8H, v13.8H, v4.8H             // ...............*................................
        mul v26.8H, v30.8H, v2.H[2]            // ...............l................................
        ld1 {v5.8H}, [x9], #16                 // ...............*................................
        smlal2 v12.4S, v27.8H, v10.8H          // .................l..............................
        smlal v29.4S, v31.4H, v22.4H           // ..................l.............................
        ldr q22, [x11], #32                    // ..................*.............................
        ld1 {v31.8H}, [x3], #16                // ..................*.............................
        smlal v29.4S, v27.4H, v10.4H           // ...................l............................
        uzp2 v17.8H, v20.8H, v28.8H            // ...................*............................
        ldr q30, [x11, #-16]                   // ...................*............................
        smlal2 v7.4S, v26.8H, v0.8H            // ....................l...........................
        uzp1 v10.8H, v29.8H, v12.8H            // ....................l...........................
        ldr q18, [x10], #32                    // ....................*...........................
        uzp1 v3.8H, v13.8H, v4.8H              // .....................*..........................
        smlal v23.4S, v26.4H, v0.4H            // .....................l..........................
        uzp2 v27.8H, v23.8H, v7.8H             // ......................l.........................
        smull2 v7.4S, v1.8H, v17.8H            // ......................*.........................
        mul v10.8H, v10.8H, v2.H[2]            // .......................l........................
        uzp1 v4.8H, v20.8H, v28.8H             // .......................*........................
        uzp2 v13.8H, v22.8H, v30.8H            // ........................*.......................
        smull v23.4S, v1.4H, v17.4H            // .........................*......................
        smlal2 v7.4S, v15.8H, v4.8H            // ..........................*.....................
        smlal v23.4S, v15.4H, v4.4H            // ...........................*....................
        smlal v29.4S, v10.4H, v0.4H            // ............................l...................
        smlal2 v12.4S, v10.8H, v0.8H           // .............................l..................
        uzp2 v26.8H, v29.8H, v12.8H            // ..............................l.................
        smull v29.4S, v1.4H, v4.4H             // ..............................*.................
        sqdmulh v20.8H, v27.8H, v2.H[1]        // ...............................l................
        sqdmulh v17.8H, v26.8H, v2.H[1]        // .................................l..............
        smull2 v12.4S, v1.8H, v4.8H            // ...................................*............
        uzp1 v21.8H, v11.8H, v21.8H            // ...................................*............
        smlal v29.4S, v15.4H, v31.4H           // ....................................*...........
        srshr v20.8H, v20.8H, #11              // ....................................l...........
        smlal2 v12.4S, v15.8H, v31.8H          // .....................................*..........
        ldr q6, [x8, #16]                      // .....................................e..........
        smlal2 v12.4S, v21.8H, v19.8H          // ......................................*.........
        srshr v24.8H, v17.8H, #11              // ......................................l.........
        ldr q10, [x10, #-16]                   // ......................................*.........
        ldr q17, [x1, #16]                     // .......................................e........
        mls v27.8H, v20.8H, v2.H[0]            // .......................................l........
        ld1 {v28.8H}, [x6], #16                // .......................................*........
        ldr q11, [x4], #32                     // ........................................e.......
        mls v26.8H, v24.8H, v2.H[0]            // .........................................l......
        uzp1 v31.8H, v18.8H, v10.8H            // ..........................................*.....
        smlal2 v12.4S, v14.8H, v28.8H          // ...........................................*....
        smlal2 v12.4S, v3.8H, v25.8H           // ............................................*...
        smlal v23.4S, v21.4H, v9.4H            // .............................................*..
        st2 {v26.8H, v27.8H}, [x0], #32        // ..............................................l.
        smlal2 v12.4S, v16.8H, v5.8H           // ..............................................*.
        ldr q26, [x1], #32                     // ..............................................e.
        smlal v29.4S, v21.4H, v19.4H           // ...............................................*

                                                // ------------------------------------------- cycle (expected) -------------------------------------------->
                                                // 0                        25                       50                       75                       100
                                                // |------------------------|------------------------|------------------------|------------------------|-----
        // ldr q12, [x1], #32                   // .........e.'.............................................~.'..............................................
        // ldr q13, [x1, #-16]                  // ..e........'......................................~........'......................................~.......
        // uzp1 v3.8h, v12.8h, v13.8h           // ...........'..*............................................'..~...........................................
        // uzp2 v4.8h, v12.8h, v13.8h           // ...........'......*........................................'......~.......................................
        // ldr q12, [x2], #32                   // ...........'*..............................................'~.............................................
        // ldr q13, [x2, #-16]                  // ...........*...............................................~..............................................
        // uzp1 v5.8h, v12.8h, v13.8h           // ...........'......................*........................'......................~.......................
        // uzp2 v6.8h, v12.8h, v13.8h           // ...........'..................*............................'..................~...........................
        // ld1 {v7.8h}, [x3], #16               // ...........'.................*.............................'.................~............................
        // smull  v8.4s, v3.4h, v5.4h           // ...........'.............................*.................'.............................~................
        // smull2 v10.4s, v3.8h, v5.8h          // ...........'..................................*............'..................................~...........
        // smlal  v8.4s, v4.4h, v7.4h           // ...........'...................................*...........'...................................~..........
        // smlal2 v10.4s, v4.8h, v7.8h          // ~..........'....................................*..........'....................................~.........
        // smull  v9.4s, v3.4h, v6.4h           // ...........'........................*......................'........................~.....................
        // smull2 v11.4s, v3.8h, v6.8h          // ...........'.....................*.........................'.....................~........................
        // smlal  v9.4s, v4.4h, v5.4h           // ...........'..........................*....................'..........................~...................
        // smlal2 v11.4s, v4.8h, v5.8h          // ...........'.........................*.....................'.........................~....................
        // ldr q12, [x4], #32                   // ...e.......'.......................................~.......'.......................................~......
        // ldr q13, [x4, #-16]                  // ...........'.*.............................................'.~............................................
        // uzp1 v3.8h, v12.8h, v13.8h           // ...........'..................................*............'..................................~...........
        // uzp2 v4.8h, v12.8h, v13.8h           // ...........'.......*.......................................'.......~......................................
        // ldr q12, [x5], #32                   // ...........'*..............................................'~.............................................
        // ldr q13, [x5, #-16]                  // ...........*...............................................~..............................................
        // uzp1 v5.8h, v12.8h, v13.8h           // ...........'.....*.........................................'.....~........................................
        // uzp2 v6.8h, v12.8h, v13.8h           // ...........'....*..........................................'....~.........................................
        // ld1 {v7.8h}, [x6], #16               // ..~........'......................................*........'......................................~.......
        // smlal  v8.4s, v3.4h, v5.4h           // ..........~'..............................................*'..............................................
        // smlal2 v10.4s, v3.8h, v5.8h          // .~.........'.....................................*.........'.....................................~........
        // smlal  v8.4s, v4.4h, v7.4h           // ...........~...............................................l..............................................
        // smlal2 v10.4s, v4.8h, v7.8h          // ......~....'..........................................*....'..........................................~...
        // smlal  v9.4s, v3.4h, v6.4h           // ........~..'............................................*..'............................................~.
        // smlal2 v11.4s, v3.8h, v6.8h          // ...........'~..............................................'l.............................................
        // smlal  v9.4s, v4.4h, v5.4h           // ...........'.~.............................................'.l............................................
        // smlal2 v11.4s, v4.8h, v5.8h          // ...........'..~............................................'..l...........................................
        // ldr q12, [x7], #32                   // ...........'..........*....................................'..........~...................................
        // ldr q13, [x7, #-16]                  // ...........'..*............................................'..~...........................................
        // uzp1 v3.8h, v12.8h, v13.8h           // ...........'....................*..........................'....................~.........................
        // uzp2 v4.8h, v12.8h, v13.8h           // ...........'..............*................................'..............~...............................
        // ldr q12, [x8], #32                   // ...........'.....*.........................................'.....~........................................
        // ldr q13, [x8, #-16]                  // e..........'....................................~..........'....................................~.........
        // uzp1 v5.8h, v12.8h, v13.8h           // ...........'............*..................................'............~.................................
        // uzp2 v6.8h, v12.8h, v13.8h           // ...........'.........*.....................................'.........~....................................
        // ld1 {v7.8h}, [x9], #16               // ...........'..............*................................'..............~...............................
        // smlal  v8.4s, v3.4h, v5.4h           // ...........'............~..................................'............l.................................
        // smlal2 v10.4s, v3.8h, v5.8h          // .......~...'...........................................*...'...........................................~..
        // smlal  v8.4s, v4.4h, v7.4h           // ...........'.............~.................................'.............l................................
        // smlal2 v10.4s, v4.8h, v7.8h          // .........~.'.............................................*.'..............................................
        // smlal  v9.4s, v3.4h, v6.4h           // ...........'.......~.......................................'.......l......................................
        // smlal2 v11.4s, v3.8h, v6.8h          // ...........'...~...........................................'...l..........................................
        // smlal  v9.4s, v4.4h, v5.4h           // ...........'........~......................................'........l.....................................
        // smlal2 v11.4s, v4.8h, v5.8h          // ...........'....~..........................................'....l.........................................
        // ldr q12, [x10], #32                  // ...........'...................*...........................'...................~..........................
        // ldr q13, [x10, #-16]                 // .~.........'.....................................*.........'.....................................~........
        // uzp1 v3.8h, v12.8h, v13.8h           // .....~.....'.........................................*.....'.........................................~....
        // uzp2 v4.8h, v12.8h, v13.8h           // ...........'.~.............................................'.l............................................
        // ldr q12, [x11], #32                  // ...........'.................*.............................'.................~............................
        // ldr q13, [x11, #-16]                 // ...........'..................*............................'..................~...........................
        // uzp1 v5.8h, v12.8h, v13.8h           // ...........'...~...........................................'...l..........................................
        // uzp2 v6.8h, v12.8h, v13.8h           // ...........'.......................*.......................'.......................~......................
        // ld1 {v7.8h}, [x12], #16              // ...........'...~...........................................'...l..........................................
        // smlal  v8.4s, v3.4h, v5.4h           // ...........'.................~.............................'.................l............................
        // smlal2 v10.4s, v3.8h, v5.8h          // ...........'...........~...................................'...........l..................................
        // smlal  v8.4s, v4.4h, v7.4h           // ...........'..................~............................'..................l...........................
        // smlal2 v10.4s, v4.8h, v7.8h          // ...........'................~..............................'................l.............................
        // smlal  v9.4s, v3.4h, v6.4h           // ...........'.........~.....................................'.........l....................................
        // smlal2 v11.4s, v3.8h, v6.8h          // ...........'.....~.........................................'.....l........................................
        // smlal  v9.4s, v4.4h, v5.4h           // ...........'..........~....................................'..........l...................................
        // smlal2 v11.4s, v4.8h, v5.8h          // ...........'......~........................................'......l.......................................
        // uzp1   v28.8h, v8.8h, v10.8h         // ...........'...................~...........................'...................l..........................
        // mul    v28.8h, v28.8h, v2.h[2]       // ...........'......................~........................'......................l.......................
        // smlal  v8.4s, v28.4h, v0.4h          // ...........'...........................~...................'...........................l..................
        // smlal2 v10.4s, v28.8h, v0.8h         // ...........'............................~..................'............................l.................
        // uzp2   v26.8h, v8.8h, v10.8h         // ...........'.............................~.................'.............................l................
        // uzp1   v28.8h, v9.8h, v11.8h         // ...........'...........~...................................'...........l..................................
        // mul    v28.8h, v28.8h, v2.h[2]       // ...........'..............~................................'..............l...............................
        // smlal  v9.4s, v28.4h, v0.4h          // ...........'....................~..........................'....................l.........................
        // smlal2 v11.4s, v28.8h, v0.8h         // ...........'...................~...........................'...................l..........................
        // uzp2   v27.8h, v9.8h, v11.8h         // ...........'.....................~.........................'.....................l........................
        // sqdmulh v28.8h, v26.8h, v2.h[1]      // ...........'................................~..............'................................l.............
        // srshr   v28.8h, v28.8h, #11          // .~.........'.....................................~.........'.....................................l........
        // mls     v26.8h, v28.8h, v2.h[0]      // ....~......'........................................~......'........................................l.....
        // sqdmulh v28.8h, v27.8h, v2.h[1]      // ...........'..............................~................'..............................l...............
        // srshr   v28.8h, v28.8h, #11          // ...........'...................................~...........'...................................l..........
        // mls     v27.8h, v28.8h, v2.h[0]      // ..~........'......................................~........'......................................l.......
        // st2 {v26.8h, v27.8h}, [x0], #32      // .........~.'.............................................~.'.............................................l

        sub count, count, #1
        cbnz count, k4_loop_start
                                               // Instructions:    119
                                               // Expected cycles: 86
                                               // Expected IPC:    1.38
                                               //
                                               // Cycle bound:     86.0
                                               // IPC bound:       1.38
                                               //
                                               // Wall time:     6.73s
                                               // User time:     6.73s
                                               //
                                               // --------------------------------- cycle (expected) ---------------------------------->
                                               // 0                        25                       50                       75
                                               // |------------------------|------------------------|------------------------|----------
        ldr q20, [x5, #16]                     // *.....................................................................................
        smlal2 v7.4S, v21.8H, v9.8H            // *.....................................................................................
        ldr q15, [x5], #32                     // *.....................................................................................
        ldr q21, [x2, #16]                     // .*....................................................................................
        ldr q9, [x7], #32                      // .*....................................................................................
        smlal v29.4S, v14.4H, v28.4H           // .*....................................................................................
        uzp1 v1.8H, v22.8H, v30.8H             // ..*...................................................................................
        ldr q22, [x7, #-16]                    // ..*...................................................................................
        smlal2 v7.4S, v14.8H, v19.8H           // ..*...................................................................................
        uzp2 v30.8H, v18.8H, v10.8H            // ...*..................................................................................
        smlal v29.4S, v3.4H, v25.4H            // ...*..................................................................................
        ldr q4, [x2], #32                      // ...*..................................................................................
        uzp1 v28.8H, v15.8H, v20.8H            // ....*.................................................................................
        smlal v23.4S, v14.4H, v19.4H           // ....*.................................................................................
        ldr q24, [x8], #32                     // ....*.................................................................................
        uzp2 v27.8H, v15.8H, v20.8H            // .....*................................................................................
        smlal v23.4S, v3.4H, v8.4H             // .....*................................................................................
        ldr q18, [x4, #-16]                    // .....*................................................................................
        smlal v23.4S, v16.4H, v25.4H           // ......*...............................................................................
        uzp2 v14.8H, v9.8H, v22.8H             // ......*...............................................................................
        ld1 {v15.8H}, [x9], #16                // ......*...............................................................................
        uzp2 v10.8H, v4.8H, v21.8H             // .......*..............................................................................
        smlal v23.4S, v31.4H, v13.4H           // .......*..............................................................................
        ld1 {v20.8H}, [x12], #16               // .......*..............................................................................
        smlal v23.4S, v30.4H, v1.4H            // ........*.............................................................................
        uzp1 v19.8H, v24.8H, v6.8H             // ........*.............................................................................
        uzp1 v9.8H, v9.8H, v22.8H              // .........*............................................................................
        smlal v29.4S, v16.4H, v5.4H            // .........*............................................................................
        smlal v29.4S, v31.4H, v1.4H            // ..........*...........................................................................
        uzp2 v22.8H, v11.8H, v18.8H            // ..........*...........................................................................
        smlal v29.4S, v30.4H, v20.4H           // ...........*..........................................................................
        uzp1 v18.8H, v11.8H, v18.8H            // ...........*..........................................................................
        uzp1 v4.8H, v4.8H, v21.8H              // ............*.........................................................................
        smlal2 v7.4S, v3.8H, v8.8H             // ............*.........................................................................
        ldr q21, [x11, #16]                    // ............*.........................................................................
        smlal2 v7.4S, v16.8H, v25.8H           // .............*........................................................................
        ldr q8, [x11], #32                     // .............*........................................................................
        uzp1 v3.8H, v26.8H, v17.8H             // .............*........................................................................
        uzp2 v25.8H, v26.8H, v17.8H            // ..............*.......................................................................
        smlal2 v7.4S, v31.8H, v13.8H           // ..............*.......................................................................
        ld1 {v26.8H}, [x3], #16                // ..............*.......................................................................
        uzp2 v24.8H, v24.8H, v6.8H             // ...............*......................................................................
        smlal2 v7.4S, v30.8H, v1.8H            // ...............*......................................................................
        ldr q13, [x10], #32                    // ...............*......................................................................
        smlal2 v12.4S, v31.8H, v1.8H           // ................*.....................................................................
        uzp1 v31.8H, v23.8H, v7.8H             // ................*.....................................................................
        uzp2 v6.8H, v8.8H, v21.8H              // .................*....................................................................
        smull v11.4S, v3.4H, v10.4H            // .................*....................................................................
        uzp1 v17.8H, v8.8H, v21.8H             // ..................*...................................................................
        smull2 v21.4S, v3.8H, v4.8H            // ..................*...................................................................
        ldr q8, [x10, #-16]                    // ..................*...................................................................
        mul v16.8H, v31.8H, v2.H[2]            // ...................*..................................................................
        smlal2 v21.4S, v25.8H, v26.8H          // .....................*................................................................
        smlal2 v21.4S, v18.8H, v28.8H          // ......................*...............................................................
        uzp1 v5.8H, v13.8H, v8.8H              // ......................*...............................................................
        smlal v11.4S, v25.4H, v4.4H            // .......................*..............................................................
        smlal2 v7.4S, v16.8H, v0.8H            // ........................*.............................................................
        smlal v11.4S, v18.4H, v27.4H           // .........................*............................................................
        smlal v11.4S, v22.4H, v28.4H           // ..........................*...........................................................
        smlal v11.4S, v9.4H, v24.4H            // ...........................*..........................................................
        smlal v11.4S, v14.4H, v19.4H           // ............................*.........................................................
        smlal v11.4S, v5.4H, v6.4H             // .............................*........................................................
        smull2 v10.4S, v3.8H, v10.8H           // ..............................*.......................................................
        smlal2 v10.4S, v25.8H, v4.8H           // ...............................*......................................................
        smull v3.4S, v3.4H, v4.4H              // ................................*.....................................................
        uzp2 v4.8H, v13.8H, v8.8H              // ................................*.....................................................
        smlal v3.4S, v25.4H, v26.4H            // .................................*....................................................
        smlal2 v10.4S, v18.8H, v27.8H          // ..................................*...................................................
        smlal2 v10.4S, v22.8H, v28.8H          // ...................................*..................................................
        smlal2 v10.4S, v9.8H, v24.8H           // ....................................*.................................................
        ld1 {v24.8H}, [x6], #16                // ....................................*.................................................
        smlal2 v10.4S, v14.8H, v19.8H          // .....................................*................................................
        smlal2 v10.4S, v5.8H, v6.8H            // ......................................*...............................................
        smlal2 v10.4S, v4.8H, v17.8H           // .......................................*..............................................
        smlal v11.4S, v4.4H, v17.4H            // ........................................*.............................................
        smlal v3.4S, v18.4H, v28.4H            // .........................................*............................................
        uzp1 v8.8H, v11.8H, v10.8H             // .........................................*............................................
        smlal v3.4S, v22.4H, v24.4H            // ..........................................*...........................................
        smlal v3.4S, v9.4H, v19.4H             // ...........................................*..........................................
        mul v8.8H, v8.8H, v2.H[2]              // ............................................*.........................................
        ld1 {v25.8H}, [x12], #16               // ............................................*.........................................
        smlal v3.4S, v14.4H, v15.4H            // ..............................................*.......................................
        smlal v3.4S, v5.4H, v17.4H             // ...............................................*......................................
        smlal v3.4S, v4.4H, v25.4H             // ................................................*.....................................
        smlal2 v10.4S, v8.8H, v0.8H            // .................................................*....................................
        smlal v11.4S, v8.4H, v0.4H             // ..................................................*...................................
        uzp2 v10.8H, v11.8H, v10.8H            // ...................................................*..................................
        smlal2 v21.4S, v22.8H, v24.8H          // ...................................................*..................................
        smlal2 v21.4S, v9.8H, v19.8H           // ....................................................*.................................
        smlal2 v21.4S, v14.8H, v15.8H          // .....................................................*................................
        smlal2 v12.4S, v30.8H, v20.8H          // ......................................................*...............................
        smlal2 v21.4S, v5.8H, v17.8H           // .......................................................*..............................
        uzp1 v11.8H, v29.8H, v12.8H            // .......................................................*..............................
        smlal2 v21.4S, v4.8H, v25.8H           // ........................................................*.............................
        smlal v23.4S, v16.4H, v0.4H            // .........................................................*............................
        uzp1 v8.8H, v3.8H, v21.8H              // .........................................................*............................
        mul v11.8H, v11.8H, v2.H[2]            // ..........................................................*...........................
        uzp2 v20.8H, v23.8H, v7.8H             // ..........................................................*...........................
        mul v8.8H, v8.8H, v2.H[2]              // ............................................................*.........................
        sqdmulh v28.8H, v10.8H, v2.H[1]        // ..............................................................*.......................
        smlal v29.4S, v11.4H, v0.4H            // ................................................................*.....................
        smlal v3.4S, v8.4H, v0.4H              // .................................................................*....................
        smlal2 v21.4S, v8.8H, v0.8H            // ..................................................................*...................
        smlal2 v12.4S, v11.8H, v0.8H           // ...................................................................*..................
        uzp2 v9.8H, v3.8H, v21.8H              // ...................................................................*..................
        uzp2 v19.8H, v29.8H, v12.8H            // ....................................................................*.................
        sqdmulh v17.8H, v20.8H, v2.H[1]        // ....................................................................*.................
        srshr v8.8H, v28.8H, #11               // .....................................................................*................
        sqdmulh v11.8H, v9.8H, v2.H[1]         // ......................................................................*...............
        sqdmulh v31.8H, v19.8H, v2.H[1]        // ........................................................................*.............
        srshr v17.8H, v17.8H, #11              // .........................................................................*............
        mls v10.8H, v8.8H, v2.H[0]             // ..........................................................................*...........
        srshr v8.8H, v11.8H, #11               // ...........................................................................*..........
        mls v20.8H, v17.8H, v2.H[0]            // ............................................................................*.........
        srshr v14.8H, v31.8H, #11              // .............................................................................*........
        mls v9.8H, v8.8H, v2.H[0]              // ..............................................................................*.......
        mls v19.8H, v14.8H, v2.H[0]            // ................................................................................*.....
        st2 {v19.8H, v20.8H}, [x0], #32        // .....................................................................................*
        st2 {v9.8H, v10.8H}, [x0], #32         // .....................................................................................*

                                                // --------------------------------- cycle (expected) ---------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|----------
        // smlal v29.4S, v14.4H, v28.4H         // .*....................................................................................
        // ldr q15, [x5, #16]                   // *.....................................................................................
        // ldr q28, [x2, #16]                   // .*....................................................................................
        // ldr q20, [x2], #32                   // ...*..................................................................................
        // ldr q24, [x5], #32                   // *.....................................................................................
        // smlal2 v7.4S, v21.8H, v9.8H          // *.....................................................................................
        // ldr q21, [x4, #-16]                  // .....*................................................................................
        // smlal v23.4S, v14.4H, v19.4H         // ....*.................................................................................
        // uzp2 v27.8H, v18.8H, v10.8H          // ...*..................................................................................
        // smlal2 v7.4S, v14.8H, v19.8H         // ..*...................................................................................
        // ldr q4, [x7, #16]                    // ..*...................................................................................
        // uzp1 v1.8H, v26.8H, v17.8H           // .............*........................................................................
        // uzp1 v22.8H, v22.8H, v30.8H          // ..*...................................................................................
        // ld1 {v10.8H}, [x12], #16             // .......*..............................................................................
        // smlal2 v7.4S, v3.8H, v8.8H           // ............*.........................................................................
        // uzp2 v9.8H, v24.8H, v15.8H           // .....*................................................................................
        // smlal2 v7.4S, v16.8H, v25.8H         // .............*........................................................................
        // smlal2 v7.4S, v31.8H, v13.8H         // ..............*.......................................................................
        // uzp1 v19.8H, v24.8H, v15.8H          // ....*.................................................................................
        // ldr q24, [x8], #32                   // ....*.................................................................................
        // smlal2 v7.4S, v27.8H, v22.8H         // ...............*......................................................................
        // uzp2 v15.8H, v26.8H, v17.8H          // ..............*.......................................................................
        // uzp2 v14.8H, v11.8H, v21.8H          // ..........*...........................................................................
        // smlal v23.4S, v3.4H, v8.4H           // .....*................................................................................
        // smlal v23.4S, v16.4H, v25.4H         // ......*...............................................................................
        // uzp2 v8.8H, v24.8H, v6.8H            // ...............*......................................................................
        // smlal v23.4S, v31.4H, v13.4H         // .......*..............................................................................
        // smlal v23.4S, v27.4H, v22.4H         // ........*.............................................................................
        // ldr q13, [x7], #32                   // .*....................................................................................
        // smlal2 v12.4S, v31.8H, v22.8H        // ................*.....................................................................
        // uzp1 v30.8H, v23.8H, v7.8H           // ................*.....................................................................
        // smlal v29.4S, v3.4H, v25.4H          // ...*..................................................................................
        // uzp1 v25.8H, v24.8H, v6.8H           // ........*.............................................................................
        // smlal v29.4S, v16.4H, v5.4H          // .........*............................................................................
        // uzp2 v16.8H, v13.8H, v4.8H           // ......*...............................................................................
        // mul v26.8H, v30.8H, v2.H[2]          // ...................*..................................................................
        // ld1 {v5.8H}, [x9], #16               // ......*...............................................................................
        // smlal2 v12.4S, v27.8H, v10.8H        // ......................................................*...............................
        // smlal v29.4S, v31.4H, v22.4H         // ..........*...........................................................................
        // ldr q22, [x11], #32                  // .............*........................................................................
        // ld1 {v31.8H}, [x3], #16              // ..............*.......................................................................
        // smlal v29.4S, v27.4H, v10.4H         // ...........*..........................................................................
        // uzp2 v17.8H, v20.8H, v28.8H          // .......*..............................................................................
        // ldr q30, [x11, #-16]                 // ............*.........................................................................
        // smlal2 v7.4S, v26.8H, v0.8H          // ........................*.............................................................
        // uzp1 v10.8H, v29.8H, v12.8H          // .......................................................*..............................
        // ldr q18, [x10], #32                  // ...............*......................................................................
        // uzp1 v3.8H, v13.8H, v4.8H            // .........*............................................................................
        // smlal v23.4S, v26.4H, v0.4H          // .........................................................*............................
        // uzp2 v27.8H, v23.8H, v7.8H           // ..........................................................*...........................
        // smull2 v7.4S, v1.8H, v17.8H          // ..............................*.......................................................
        // mul v10.8H, v10.8H, v2.H[2]          // ..........................................................*...........................
        // uzp1 v4.8H, v20.8H, v28.8H           // ............*.........................................................................
        // uzp2 v13.8H, v22.8H, v30.8H          // .................*....................................................................
        // smull v23.4S, v1.4H, v17.4H          // .................*....................................................................
        // smlal2 v7.4S, v15.8H, v4.8H          // ...............................*......................................................
        // smlal v23.4S, v15.4H, v4.4H          // .......................*..............................................................
        // smlal v29.4S, v10.4H, v0.4H          // ................................................................*.....................
        // smlal2 v12.4S, v10.8H, v0.8H         // ...................................................................*..................
        // uzp2 v26.8H, v29.8H, v12.8H          // ....................................................................*.................
        // smull v29.4S, v1.4H, v4.4H           // ................................*.....................................................
        // sqdmulh v20.8H, v27.8H, v2.H[1]      // ....................................................................*.................
        // sqdmulh v17.8H, v26.8H, v2.H[1]      // ........................................................................*.............
        // smull2 v12.4S, v1.8H, v4.8H          // ..................*...................................................................
        // uzp1 v21.8H, v11.8H, v21.8H          // ...........*..........................................................................
        // smlal v29.4S, v15.4H, v31.4H         // .................................*....................................................
        // srshr v20.8H, v20.8H, #11            // .........................................................................*............
        // smlal2 v12.4S, v15.8H, v31.8H        // .....................*................................................................
        // smlal2 v12.4S, v21.8H, v19.8H        // ......................*...............................................................
        // srshr v24.8H, v17.8H, #11            // .............................................................................*........
        // ldr q10, [x10, #-16]                 // ..................*...................................................................
        // mls v27.8H, v20.8H, v2.H[0]          // ............................................................................*.........
        // ld1 {v28.8H}, [x6], #16              // ....................................*.................................................
        // mls v26.8H, v24.8H, v2.H[0]          // ................................................................................*.....
        // uzp1 v31.8H, v18.8H, v10.8H          // ......................*...............................................................
        // smlal2 v12.4S, v14.8H, v28.8H        // ...................................................*..................................
        // smlal2 v12.4S, v3.8H, v25.8H         // ....................................................*.................................
        // smlal v23.4S, v21.4H, v9.4H          // .........................*............................................................
        // st2 {v26.8H, v27.8H}, [x0], #32      // .....................................................................................*
        // smlal2 v12.4S, v16.8H, v5.8H         // .....................................................*................................
        // smlal v29.4S, v21.4H, v19.4H         // .........................................*............................................
        // smlal v29.4S, v14.4H, v28.4H         // ..........................................*...........................................
        // smlal2 v7.4S, v21.8H, v9.8H          // ..................................*...................................................
        // smlal v23.4S, v14.4H, v19.4H         // ..........................*...........................................................
        // uzp2 v27.8H, v18.8H, v10.8H          // ................................*.....................................................
        // smlal2 v7.4S, v14.8H, v19.8H         // ...................................*..................................................
        // uzp1 v22.8H, v22.8H, v30.8H          // ..................*...................................................................
        // ld1 {v10.8H}, [x12], #16             // ............................................*.........................................
        // smlal2 v7.4S, v3.8H, v8.8H           // ....................................*.................................................
        // smlal2 v7.4S, v16.8H, v25.8H         // .....................................*................................................
        // smlal2 v7.4S, v31.8H, v13.8H         // ......................................*...............................................
        // smlal2 v7.4S, v27.8H, v22.8H         // .......................................*..............................................
        // smlal v23.4S, v3.4H, v8.4H           // ...........................*..........................................................
        // smlal v23.4S, v16.4H, v25.4H         // ............................*.........................................................
        // smlal v23.4S, v31.4H, v13.4H         // .............................*........................................................
        // smlal v23.4S, v27.4H, v22.4H         // ........................................*.............................................
        // smlal2 v12.4S, v31.8H, v22.8H        // .......................................................*..............................
        // uzp1 v30.8H, v23.8H, v7.8H           // .........................................*............................................
        // smlal v29.4S, v3.4H, v25.4H          // ...........................................*..........................................
        // smlal v29.4S, v16.4H, v5.4H          // ..............................................*.......................................
        // mul v26.8H, v30.8H, v2.H[2]          // ............................................*.........................................
        // smlal2 v12.4S, v27.8H, v10.8H        // ........................................................*.............................
        // smlal v29.4S, v31.4H, v22.4H         // ...............................................*......................................
        // smlal v29.4S, v27.4H, v10.4H         // ................................................*.....................................
        // smlal2 v7.4S, v26.8H, v0.8H          // .................................................*....................................
        // uzp1 v10.8H, v29.8H, v12.8H          // .........................................................*............................
        // smlal v23.4S, v26.4H, v0.4H          // ..................................................*...................................
        // uzp2 v27.8H, v23.8H, v7.8H           // ...................................................*..................................
        // mul v10.8H, v10.8H, v2.H[2]          // ............................................................*.........................
        // smlal v29.4S, v10.4H, v0.4H          // .................................................................*....................
        // smlal2 v12.4S, v10.8H, v0.8H         // ..................................................................*...................
        // uzp2 v26.8H, v29.8H, v12.8H          // ...................................................................*..................
        // sqdmulh v20.8H, v27.8H, v2.H[1]      // ..............................................................*.......................
        // sqdmulh v17.8H, v26.8H, v2.H[1]      // ......................................................................*...............
        // srshr v20.8H, v20.8H, #11            // .....................................................................*................
        // srshr v24.8H, v17.8H, #11            // ...........................................................................*..........
        // mls v27.8H, v20.8H, v2.H[0]          // ..........................................................................*...........
        // mls v26.8H, v24.8H, v2.H[0]          // ..............................................................................*.......
        // st2 {v26.8H, v27.8H}, [x0], #32      // .....................................................................................*


        pop_stack
        ret
#endif /* KYBER_K == 4 */

#endif /* MLKEM_USE_AARCH64_ASM */
