// SPDX-License-Identifier: Apache-2.0

// AArch64 re-implementation of the asymmetric base multiplication from:

// Neon NTT: Faster Dilithium, Kyber, and Saber on Cortex-A72 and Apple M1
// https:   // eprint.iacr.org/2021/986
// https:   // github.com/neon-ntt/neon-ntt

#include "config.h"
#if defined(MLKEM_USE_AARCH64_ASM)

#include "params.h"

// Needed to provide ASM_LOAD directive
#include "common.i"

.macro barrett_reduce a
        sqdmulh t0.8h, \a\().8h, consts.h[1]
        srshr   t0.8h, t0.8h, #11
        mls     \a\().8h, t0.8h, consts.h[0]
.endm

// Input:
// - Vectors al, ah of 32-bit entries
// Output:
// - Montgomery reductions of al || ah, stored in al
.macro montgomery_reduce_long x, a
        uzp1   t0.8h, \a\()l.8h, \a\()h.8h
        mul    t0.8h, t0.8h, consts.h[2]
        smlal  \a\()l.4s, t0.4h, constN.4h
        smlal2 \a\()h.4s, t0.8h, constN.8h
        uzp2   \x\().8h, \a\()l.8h, \a\()h.8h
.endm

// Computes products (a0*b0 + a0*b0t, a0*b1 + a1*b0) in 32-bit.
.macro pmull d, a, b
        smull  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smull2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smull  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smull2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro pmlal d, a, b
        smlal  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smlal2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smlal  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smlal2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro ST2 d0, d1, src
        // This instruction is likely broken down into uOps
        // anyway, so we may achieve better scheduling by
        // breaking manually.
        // st2 {\d0\().8h, \d1\().8h}, [\src], #32
        zip1 tmp0.8h, \d0\().8h, \d1\().8h
        zip2 tmp1.8h, \d0\().8h, \d1\().8h
        str q_tmp0, [\src], #32
        str q_tmp1, [\src, #-16]
.endm

.macro LD2 d0, d1, src
        // This instruction is likely broken down into uOps
        // anyway, so we may achieve better scheduling by
        // breaking manually.
        // ld2 {\d0\().8h, \d1\().8h}, [\src], #32
        ldr q_tmp0, [\src], #32
        ldr q_tmp1, [\src, #-16]
        uzp1 \d0\().8h, tmp0.8h, tmp1.8h
        uzp2 \d1\().8h, tmp0.8h, tmp1.8h
.endm

.macro load_polys a, b, a_ptr, b_ptr, b_cache_ptr
        LD2 \a\()0, \a\()1, \a_ptr
        LD2 \b\()0, \b\()1, \b_ptr
        ld1 {\b\()1t.8h}, [\b_cache_ptr], #16
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

        out          .req x0
        a0_ptr       .req x1
        b0_ptr       .req x2
        b0_cache_ptr .req x3
        a1_ptr       .req x4
        b1_ptr       .req x5
        b1_cache_ptr .req x6
        a2_ptr       .req x7
        b2_ptr       .req x8
        b2_cache_ptr .req x9
        a3_ptr       .req x10
        b3_ptr       .req x11
        b3_cache_ptr .req x12

        count        .req x13
        xtmp         .req x14
        modulus      .req w15

        constN    .req v0
        constX    .req v1
        consts    .req v2

        aa0      .req v3
        aa1      .req v4
        bb0      .req v5
        bb1      .req v6
        bb1t     .req v7

        res0l   .req v8
        res1l   .req v9
        res0h   .req v10
        res1h   .req v11

        tmp0   .req v12
        tmp1   .req v13
        q_tmp0 .req q12
        q_tmp1 .req q13

        out0 .req v26
        out1 .req v27

        t0   .req v28

.p2align 4
const_addr:
        .short 3329
        .short 20159
        .short 3327
        .short 0
        .short 0
        .short 0
        .short 0
        .short 0

#if KYBER_K == 2

.global polyvec_basemul_acc_montgomery_cached_asm_k2_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k2_opt

polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)

        mov count, #(KYBER_N / 16)
                                              // Instructions:    63
                                              // Expected cycles: 37
                                              // Expected IPC:    1.70

                                              // Cycle bound:     37.0
                                              // IPC bound:       1.70

                                              // Wall time:     1.45s
                                              // User time:     1.45s

                                              // --------- cycle (expected) --------->
                                              // 0                        25
                                              // |------------------------|-----------
        ldr q20, [x1], #32                    // *....................................
        ldr q9, [x2], #32                     // *....................................
        ldr q12, [x2, #-16]                   // .*...................................
        ldr q13, [x1, #-16]                   // .*...................................
        ldr q21, [x1, #16]                    // ..*..................................
        ldr q16, [x2, #16]                    // ..*..................................
        ldr q22, [x2], #32                    // ...*.................................
        ldr q10, [x1], #32                    // ...*.................................
        ldr q23, [x5, #16]                    // ....*................................
        ldr q8, [x5], #32                     // ....*................................
        ldr q19, [x4, #16]                    // .....*...............................
        uzp2 v24.8H, v9.8H, v12.8H            // .....*...............................
        uzp1 v3.8H, v20.8H, v13.8H            // .....*...............................
        uzp1 v30.8H, v9.8H, v12.8H            // ......*..............................
        ldr q29, [x4], #32                    // ......*..............................
        uzp2 v15.8H, v20.8H, v13.8H           // .......*.............................
        ld1 {v31.8H}, [x6], #16               // .......*.............................
        uzp2 v1.8H, v22.8H, v16.8H            // .......*.............................
        ldr q7, [x5], #32                     // ........*............................
        smull v28.4S, v3.4H, v24.4H           // ........*............................
        uzp2 v11.8H, v8.8H, v23.8H            // ........*............................
        uzp1 v17.8H, v10.8H, v21.8H           // .........*...........................
        smull2 v24.4S, v3.8H, v24.8H          // .........*...........................
        smlal v28.4S, v15.4H, v30.4H          // ..........*..........................
        uzp1 v12.8H, v29.8H, v19.8H           // ..........*..........................
        uzp1 v27.8H, v22.8H, v16.8H           // ...........*.........................
        smull v4.4S, v3.4H, v30.4H            // ...........*.........................
        ldr q16, [x5, #-16]                   // ...........*.........................
        uzp1 v23.8H, v8.8H, v23.8H            // ............*........................
        smull v18.4S, v17.4H, v1.4H           // ............*........................
        ld1 {v26.8H}, [x3], #16               // .............*.......................
        smlal v28.4S, v12.4H, v11.4H          // .............*.......................
        ldr q22, [x4], #32                    // .............*.......................
        uzp2 v14.8H, v10.8H, v21.8H           // ..............*......................
        smlal2 v24.4S, v15.8H, v30.8H         // ..............*......................
        smlal2 v24.4S, v12.8H, v11.8H         // ...............*.....................
        uzp2 v5.8H, v29.8H, v19.8H            // ...............*.....................
        smull2 v10.4S, v3.8H, v30.8H          // ................*....................
        uzp2 v25.8H, v7.8H, v16.8H            // ................*....................
        smlal2 v10.4S, v15.8H, v26.8H         // .................*...................
        smlal2 v24.4S, v5.8H, v23.8H          // ..................*..................
        smlal v4.4S, v15.4H, v26.4H           // ...................*.................
        smlal2 v10.4S, v12.8H, v23.8H         // ....................*................
        smlal v4.4S, v12.4H, v23.4H           // .....................*...............
        smlal v28.4S, v5.4H, v23.4H           // ......................*..............
        smlal v4.4S, v5.4H, v31.4H            // .......................*.............
        uzp1 v13.8H, v28.8H, v24.8H           // .......................*.............
        smlal2 v10.4S, v5.8H, v31.8H          // ........................*............
        smlal v18.4S, v14.4H, v27.4H          // .........................*...........
        ld1 {v3.8H}, [x3], #16                // .........................*...........
        uzp1 v19.8H, v4.8H, v10.8H            // .........................*...........
        mul v26.8H, v13.8H, v2.H[2]           // ..........................*..........
        ldr q23, [x4, #-16]                   // ............................*........
        mul v13.8H, v19.8H, v2.H[2]           // ............................*........
        smull2 v8.4S, v17.8H, v1.8H           // ..............................*......
        smlal v28.4S, v26.4H, v0.4H           // ...............................*.....
        uzp1 v11.8H, v22.8H, v23.8H           // ................................*....
        smlal2 v24.4S, v26.8H, v0.8H          // ................................*....
        smlal v4.4S, v13.4H, v0.4H            // .................................*...
        uzp2 v9.8H, v28.8H, v24.8H            // .................................*...
        smlal2 v10.4S, v13.8H, v0.8H          // ..................................*..
        smlal v18.4S, v11.4H, v25.4H          // ...................................*.
        sqdmulh v13.8H, v9.8H, v2.H[1]        // ....................................*

                                               // --------- cycle (expected) --------->
                                               // 0                        25
                                               // |------------------------|-----------
        // ldr q6, [x1, #16]                     // .*...................................
        // ldr q22, [x4], #32                    // ......*..............................
        // ldr q16, [x5, #16]                    // ....*................................
        // ldr q12, [x2, #16]                    // .*...................................
        // ldr q23, [x4, #-16]                   // .....*...............................
        // ldr q26, [x1], #32                    // *....................................
        // ldr q5, [x2], #32                     // *....................................
        // uzp2 v15.8H, v5.8H, v12.8H            // .....*...............................
        // uzp1 v17.8H, v26.8H, v6.8H            // .....*...............................
        // uzp1 v27.8H, v5.8H, v12.8H            // ......*..............................
        // ld1 {v3.8H}, [x3], #16                // .............*.......................
        // uzp2 v14.8H, v26.8H, v6.8H            // .......*.............................
        // ldr q7, [x5], #32                     // ....*................................
        // smull v18.4S, v17.4H, v15.4H          // ........*............................
        // smlal v18.4S, v14.4H, v27.4H          // ..........*..........................
        // uzp1 v11.8H, v22.8H, v23.8H           // ..........*..........................
        // smull2 v8.4S, v17.8H, v15.8H          // .........*...........................
        // uzp2 v25.8H, v7.8H, v16.8H            // ........*............................
        // smlal v18.4S, v11.4H, v25.4H          // .............*.......................
        // ld1 {v30.8H}, [x6], #16               // .......*.............................
        // smull2 v10.4S, v17.8H, v27.8H         // ................*....................
        // ldr q6, [x1, #16]                     // ..*..................................
        // uzp2 v1.8H, v22.8H, v23.8H            // ...............*.....................
        // smlal2 v8.4S, v14.8H, v27.8H          // ..............*......................
        // smlal2 v10.4S, v14.8H, v3.8H          // .................*...................
        // ldr q22, [x4], #32                    // .............*.......................
        // uzp1 v29.8H, v7.8H, v16.8H            // ............*........................
        // ldr q16, [x5, #16]                    // ...........*.........................
        // ldr q12, [x2, #16]                    // ..*..................................
        // ldr q23, [x4, #-16]                   // ............................*........
        // smlal2 v8.4S, v11.8H, v25.8H          // ...............*.....................
        // ldr q26, [x1], #32                    // ...*.................................
        // smlal v18.4S, v1.4H, v29.4H           // ......................*..............
        // ldr q5, [x2], #32                     // ...*.................................
        // smlal2 v8.4S, v1.8H, v29.8H           // ..................*..................
        // uzp1 v13.8H, v18.8H, v8.8H            // .......................*.............
        // smlal2 v10.4S, v11.8H, v29.8H         // ....................*................
        // uzp2 v15.8H, v5.8H, v12.8H            // .......*.............................
        // mul v7.8H, v13.8H, v2.H[2]            // ..........................*..........
        // smull v4.4S, v17.4H, v27.4H           // ...........*.........................
        // uzp1 v17.8H, v26.8H, v6.8H            // .........*...........................
        // uzp1 v27.8H, v5.8H, v12.8H            // ...........*.........................
        // smlal v18.4S, v7.4H, v0.4H            // ...............................*.....
        // smlal2 v8.4S, v7.8H, v0.8H            // ................................*....
        // smlal v4.4S, v14.4H, v3.4H            // ...................*.................
        // ld1 {v3.8H}, [x3], #16                // .........................*...........
        // uzp2 v14.8H, v26.8H, v6.8H            // ..............*......................
        // ldr q7, [x5], #32                     // ........*............................
        // smlal v4.4S, v11.4H, v29.4H           // .....................*...............
        // smlal v4.4S, v1.4H, v30.4H            // .......................*.............
        // uzp2 v9.8H, v18.8H, v8.8H             // .................................*...
        // smlal2 v10.4S, v1.8H, v30.8H          // ........................*............
        // smull v18.4S, v17.4H, v15.4H          // ............*........................
        // uzp1 v6.8H, v4.8H, v10.8H             // .........................*...........
        // smlal v18.4S, v14.4H, v27.4H          // .........................*...........
        // uzp1 v11.8H, v22.8H, v23.8H           // ................................*....
        // smull2 v8.4S, v17.8H, v15.8H          // ..............................*......
        // mul v26.8H, v6.8H, v2.H[2]            // ............................*........
        // uzp2 v25.8H, v7.8H, v16.8H            // ................*....................
        // sqdmulh v13.8H, v9.8H, v2.H[1]        // ....................................*
        // smlal v18.4S, v11.4H, v25.4H          // ...................................*.
        // smlal v4.4S, v26.4H, v0.4H            // .................................*...
        // smlal2 v10.4S, v26.8H, v0.8H          // ..................................*..

        sub count, count, #2
k2_loop_start:
                                              // Instructions:    54
                                              // Expected cycles: 32
                                              // Expected IPC:    1.69

                                              // Cycle bound:     32.0
                                              // IPC bound:       1.69

                                              // Wall time:     12.31s
                                              // User time:     12.31s

                                              // ------ cycle (expected) ------->
                                              // 0                        25
                                              // |------------------------|------
        ld1 {v30.8H}, [x6], #16               // *...............................
        uzp2 v20.8H, v4.8H, v10.8H            // l...............................
        smull2 v10.4S, v17.8H, v27.8H         // *...............................
        ldr q6, [x1, #16]                     // .e..............................
        uzp2 v1.8H, v22.8H, v23.8H            // .*..............................
        smlal2 v8.4S, v14.8H, v27.8H          // .*..............................
        smlal2 v10.4S, v14.8H, v3.8H          // ..*.............................
        ldr q22, [x4], #32                    // ..e.............................
        uzp1 v29.8H, v7.8H, v16.8H            // ..*.............................
        ldr q16, [x5, #16]                    // ...e............................
        ldr q12, [x2, #16]                    // ...e............................
        sqdmulh v4.8H, v20.8H, v2.H[1]        // ...l............................
        ldr q23, [x4, #-16]                   // ....e...........................
        smlal2 v8.4S, v11.8H, v25.8H          // .....*..........................
        ldr q26, [x1], #32                    // .....e..........................
        srshr v31.8H, v13.8H, #11             // .....l..........................
        smlal v18.4S, v1.4H, v29.4H           // ......*.........................
        ldr q5, [x2], #32                     // ......e.........................
        smlal2 v8.4S, v1.8H, v29.8H           // .......*........................
        mls v9.8H, v31.8H, v2.H[0]            // ........l.......................
        uzp1 v13.8H, v18.8H, v8.8H            // ........*.......................
        smlal2 v10.4S, v11.8H, v29.8H         // ..........*.....................
        uzp2 v15.8H, v5.8H, v12.8H            // ..........e.....................
        mul v7.8H, v13.8H, v2.H[2]            // ...........*....................
        srshr v21.8H, v4.8H, #11              // ...........l....................
        smull v4.4S, v17.4H, v27.4H           // .............*..................
        uzp1 v17.8H, v26.8H, v6.8H            // .............e..................
        uzp1 v27.8H, v5.8H, v12.8H            // ..............e.................
        mls v20.8H, v21.8H, v2.H[0]           // ..............l.................
        smlal v18.4S, v7.4H, v0.4H            // ................*...............
        smlal2 v8.4S, v7.8H, v0.8H            // .................*..............
        smlal v4.4S, v14.4H, v3.4H            // ..................*.............
        ld1 {v3.8H}, [x3], #16                // ..................e.............
        uzp2 v14.8H, v26.8H, v6.8H            // ..................e.............
        zip2 v28.8H, v20.8H, v9.8H            // ...................l............
        ldr q7, [x5], #32                     // ...................e............
        smlal v4.4S, v11.4H, v29.4H           // ...................*............
        zip1 v12.8H, v20.8H, v9.8H            // ....................l...........
        smlal v4.4S, v1.4H, v30.4H            // ....................*...........
        uzp2 v9.8H, v18.8H, v8.8H             // .....................*..........
        smlal2 v10.4S, v1.8H, v30.8H          // .....................*..........
        smull v18.4S, v17.4H, v15.4H          // ......................e.........
        uzp1 v6.8H, v4.8H, v10.8H             // ......................*.........
        str q12, [x0], #32                    // .......................l........
        smlal v18.4S, v14.4H, v27.4H          // .......................e........
        uzp1 v11.8H, v22.8H, v23.8H           // .......................e........
        smull2 v8.4S, v17.8H, v15.8H          // ........................e.......
        mul v26.8H, v6.8H, v2.H[2]            // .........................*......
        str q28, [x0, #-16]                   // ..........................l.....
        uzp2 v25.8H, v7.8H, v16.8H            // ..........................e.....
        sqdmulh v13.8H, v9.8H, v2.H[1]        // ...........................*....
        smlal v18.4S, v11.4H, v25.4H          // .............................e..
        smlal v4.4S, v26.4H, v0.4H            // ..............................*.
        smlal2 v10.4S, v26.8H, v0.8H          // ...............................*

                                                // ----------------------------------- cycle (expected) ------------------------------------>
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------------
        // ldr q12, [x1], #32                     // ....e..........................'....~..........................'....~.....................
        // ldr q13, [x1, #-16]                    // e..............................'~..............................'~.........................
        // uzp1 v3.8h, v12.8h, v13.8h             // ............e..................'............~..................'............~.............
        // uzp2 v4.8h, v12.8h, v13.8h             // .................e.............'.................~.............'.................~........
        // ldr q12, [x2], #32                     // .....e.........................'.....~.........................'.....~....................
        // ldr q13, [x2, #-16]                    // ..e............................'..~............................'..~.......................
        // uzp1 v5.8h, v12.8h, v13.8h             // .............e.................'.............~.................'.............~............
        // uzp2 v6.8h, v12.8h, v13.8h             // .........e.....................'.........~.....................'.........~................
        // ld1 {v7.8h}, [x3], #16                 // .................e.............'.................~.............'.................~........
        // smull  v8.4s, v3.4h, v5.4h             // ............~..................'............*..................'............~.............
        // smull2 v10.4s, v3.8h, v5.8h            // ...............................*...............................~..........................
        // smlal  v8.4s, v4.4h, v7.4h             // .................~.............'.................*.............'.................~........
        // smlal2 v10.4s, v4.8h, v7.8h            // .~.............................'.*.............................'.~........................
        // smull  v9.4s, v3.4h, v6.4h             // .....................e.........'.....................~.........'.....................~....
        // smull2 v11.4s, v3.8h, v6.8h            // .......................e.......'.......................~.......'.......................~..
        // smlal  v9.4s, v4.4h, v5.4h             // ......................e........'......................~........'......................~...
        // smlal2 v11.4s, v4.8h, v5.8h            // ~..............................'*..............................'~.........................
        // ldr q12, [x4], #32                     // .e.............................'.~.............................'.~........................
        // ldr q13, [x4, #-16]                    // ...e...........................'...~...........................'...~......................
        // uzp1 v3.8h, v12.8h, v13.8h             // ......................e........'......................~........'......................~...
        // uzp2 v4.8h, v12.8h, v13.8h             // ~..............................'*..............................'~.........................
        // ldr q12, [x5], #32                     // ..................e............'..................~............'..................~.......
        // ldr q13, [x5, #-16]                    // ..e............................'..~............................'..~.......................
        // uzp1 v5.8h, v12.8h, v13.8h             // .~.............................'.*.............................'.~........................
        // uzp2 v6.8h, v12.8h, v13.8h             // .........................e.....'.........................~.....'..........................
        // ld1 {v7.8h}, [x6], #16                 // ...............................*...............................~..........................
        // smlal  v8.4s, v3.4h, v5.4h             // ..................~............'..................*............'..................~.......
        // smlal2 v10.4s, v3.8h, v5.8h            // .........~.....................'.........*.....................'.........~................
        // smlal  v8.4s, v4.4h, v7.4h             // ...................~...........'...................*...........'...................~......
        // smlal2 v10.4s, v4.8h, v7.8h            // ....................~..........'....................*..........'....................~.....
        // smlal  v9.4s, v3.4h, v6.4h             // ............................e..'............................~..'..........................
        // smlal2 v11.4s, v3.8h, v6.8h            // ....~..........................'....*..........................'....~.....................
        // smlal  v9.4s, v4.4h, v5.4h             // .....~.........................'.....*.........................'.....~....................
        // smlal2 v11.4s, v4.8h, v5.8h            // ......~........................'......*........................'......~...................
        // uzp1   v28.8h, v8.8h, v10.8h           // .....................~.........'.....................*.........'.....................~....
        // mul    v28.8h, v28.8h, v2.h[2]         // ........................~......'........................*......'........................~.
        // smlal  v8.4s, v28.4h, v0.4h            // .............................~.'.............................*.'..........................
        // smlal2 v10.4s, v28.8h, v0.8h           // ..............................~'..............................*'..........................
        // uzp2   v26.8h, v8.8h, v10.8h           // ...............................~...............................l..........................
        // uzp1   v28.8h, v9.8h, v11.8h           // .......~.......................'.......*.......................'.......~..................
        // mul    v28.8h, v28.8h, v2.h[2]         // ..........~....................'..........*....................'..........~...............
        // smlal  v9.4s, v28.4h, v0.4h            // ...............~...............'...............*...............'...............~..........
        // smlal2 v11.4s, v28.8h, v0.8h           // ................~..............'................*..............'................~.........
        // uzp2   v27.8h, v9.8h, v11.8h           // ....................~..........'....................*..........'....................~.....
        // sqdmulh v28.8h, v26.8h, v2.h[1]        // ..~............................'..~............................'..l.......................
        // srshr   v28.8h, v28.8h, #11            // ..........~....................'..........~....................'..........l...............
        // mls     v26.8h, v28.8h, v2.h[0]        // .............~.................'.............~.................'.............l............
        // sqdmulh v28.8h, v27.8h, v2.h[1]        // ..........................~....'..........................*....'..........................
        // srshr   v28.8h, v28.8h, #11            // ....~..........................'....~..........................'....l.....................
        // mls     v27.8h, v28.8h, v2.h[0]        // .......~.......................'.......~.......................'.......l..................
        // zip1 v12.8h, v26.8h, v27.8h            // ...................~...........'...................~...........'...................l......
        // zip2 v13.8h, v26.8h, v27.8h            // ..................~............'..................~............'..................l.......
        // str q12, [x0], #32                     // ......................~........'......................~........'......................l...
        // str q13, [x0, #-16]                    // .........................~.....'.........................~.....'.........................l

        sub count, count, #1
        cbnz count, k2_loop_start
                                               // Instructions:    45
                                               // Expected cycles: 43
                                               // Expected IPC:    1.05

                                               // Cycle bound:     43.0
                                               // IPC bound:       1.05

                                               // Wall time:     0.90s
                                               // User time:     0.90s

                                               // ------------ cycle (expected) ------------>
                                               // 0                        25
                                               // |------------------------|-----------------
        uzp1 v20.8H, v7.8H, v16.8H             // *..........................................
        smull2 v5.4S, v17.8H, v27.8H           // *..........................................
        smull v21.4S, v17.4H, v27.4H           // .*.........................................
        srshr v15.8H, v13.8H, #11              // .*.........................................
        ld1 {v17.8H}, [x6], #16                // .*.........................................
        smlal2 v8.4S, v14.8H, v27.8H           // ..*........................................
        uzp2 v30.8H, v22.8H, v23.8H            // ..*........................................
        smlal2 v5.4S, v14.8H, v3.8H            // ...*.......................................
        smlal v21.4S, v14.4H, v3.4H            // ....*......................................
        smlal v21.4S, v11.4H, v20.4H           // .....*.....................................
        smlal v21.4S, v30.4H, v17.4H           // ......*....................................
        smlal2 v5.4S, v11.8H, v20.8H           // .......*...................................
        smlal2 v5.4S, v30.8H, v17.8H           // ........*..................................
        smlal2 v8.4S, v11.8H, v25.8H           // .........*.................................
        uzp1 v13.8H, v21.8H, v5.8H             // .........*.................................
        smlal2 v8.4S, v30.8H, v20.8H           // ..........*................................
        smlal v18.4S, v30.4H, v20.4H           // ...........*...............................
        mul v3.8H, v13.8H, v2.H[2]             // ............*..............................
        uzp1 v13.8H, v18.8H, v8.8H             // ............*..............................
        mul v24.8H, v13.8H, v2.H[2]            // ...............*...........................
        smlal v21.4S, v3.4H, v0.4H             // .................*.........................
        smlal2 v5.4S, v3.8H, v0.8H             // ..................*........................
        uzp2 v17.8H, v21.8H, v5.8H             // ...................*.......................
        smlal v18.4S, v24.4H, v0.4H            // ....................*......................
        smlal2 v8.4S, v24.8H, v0.8H            // .....................*.....................
        uzp2 v13.8H, v4.8H, v10.8H             // .....................*.....................
        uzp2 v5.8H, v18.8H, v8.8H              // ......................*....................
        sqdmulh v26.8H, v17.8H, v2.H[1]        // ......................*....................
        sqdmulh v23.8H, v13.8H, v2.H[1]        // ........................*..................
        sqdmulh v1.8H, v5.8H, v2.H[1]          // ..........................*................
        srshr v16.8H, v26.8H, #11              // ...........................*...............
        mls v9.8H, v15.8H, v2.H[0]             // ............................*..............
        srshr v23.8H, v23.8H, #11              // .............................*.............
        mls v17.8H, v16.8H, v2.H[0]            // ..............................*............
        srshr v18.8H, v1.8H, #11               // ...............................*...........
        mls v13.8H, v23.8H, v2.H[0]            // ................................*..........
        mls v5.8H, v18.8H, v2.H[0]             // ..................................*........
        zip2 v24.8H, v13.8H, v9.8H             // .....................................*.....
        zip1 v13.8H, v13.8H, v9.8H             // .....................................*.....
        zip1 v3.8H, v17.8H, v5.8H              // .......................................*...
        zip2 v30.8H, v17.8H, v5.8H             // .......................................*...
        str q13, [x0], #32                     // ........................................*..
        str q24, [x0, #-16]                    // .........................................*.
        str q3, [x0], #32                      // ..........................................*
        str q30, [x0, #-16]                    // ..........................................*

                                               // ------------ cycle (expected) ------------>
                                               // 0                        25
                                               // |------------------------|-----------------
        // ld1 {v30.8H}, [x6], #16               // .*.........................................
        // uzp2 v20.8H, v4.8H, v10.8H            // .....................*.....................
        // smull2 v10.4S, v17.8H, v27.8H         // *..........................................
        // uzp2 v1.8H, v22.8H, v23.8H            // ..*........................................
        // smlal2 v8.4S, v14.8H, v27.8H          // ..*........................................
        // smlal2 v10.4S, v14.8H, v3.8H          // ...*.......................................
        // uzp1 v29.8H, v7.8H, v16.8H            // *..........................................
        // sqdmulh v4.8H, v20.8H, v2.H[1]        // ........................*..................
        // smlal2 v8.4S, v11.8H, v25.8H          // .........*.................................
        // srshr v31.8H, v13.8H, #11             // .*.........................................
        // smlal v18.4S, v1.4H, v29.4H           // ...........*...............................
        // smlal2 v8.4S, v1.8H, v29.8H           // ..........*................................
        // mls v9.8H, v31.8H, v2.H[0]            // ............................*..............
        // uzp1 v13.8H, v18.8H, v8.8H            // ............*..............................
        // smlal2 v10.4S, v11.8H, v29.8H         // .......*...................................
        // mul v7.8H, v13.8H, v2.H[2]            // ...............*...........................
        // srshr v21.8H, v4.8H, #11              // .............................*.............
        // smull v4.4S, v17.4H, v27.4H           // .*.........................................
        // mls v20.8H, v21.8H, v2.H[0]           // ................................*..........
        // smlal v18.4S, v7.4H, v0.4H            // ....................*......................
        // smlal2 v8.4S, v7.8H, v0.8H            // .....................*.....................
        // smlal v4.4S, v14.4H, v3.4H            // ....*......................................
        // zip2 v28.8H, v20.8H, v9.8H            // .....................................*.....
        // smlal v4.4S, v11.4H, v29.4H           // .....*.....................................
        // zip1 v12.8H, v20.8H, v9.8H            // .....................................*.....
        // smlal v4.4S, v1.4H, v30.4H            // ......*....................................
        // uzp2 v9.8H, v18.8H, v8.8H             // ......................*....................
        // smlal2 v10.4S, v1.8H, v30.8H          // ........*..................................
        // uzp1 v6.8H, v4.8H, v10.8H             // .........*.................................
        // str q12, [x0], #32                    // ........................................*..
        // mul v26.8H, v6.8H, v2.H[2]            // ............*..............................
        // str q28, [x0, #-16]                   // .........................................*.
        // sqdmulh v13.8H, v9.8H, v2.H[1]        // ..........................*................
        // smlal v4.4S, v26.4H, v0.4H            // .................*.........................
        // smlal2 v10.4S, v26.8H, v0.8H          // ..................*........................
        // uzp2 v20.8H, v4.8H, v10.8H            // ...................*.......................
        // sqdmulh v4.8H, v20.8H, v2.H[1]        // ......................*....................
        // srshr v31.8H, v13.8H, #11             // ...............................*...........
        // mls v9.8H, v31.8H, v2.H[0]            // ..................................*........
        // srshr v21.8H, v4.8H, #11              // ...........................*...............
        // mls v20.8H, v21.8H, v2.H[0]           // ..............................*............
        // zip2 v28.8H, v20.8H, v9.8H            // .......................................*...
        // zip1 v12.8H, v20.8H, v9.8H            // .......................................*...
        // str q12, [x0], #32                    // ..........................................*
        // str q28, [x0, #-16]                   // ..........................................*


        pop_stack
        ret
#endif /* KYBER_K == 2 */

#if KYBER_K == 3
.global polyvec_basemul_acc_montgomery_cached_asm_k3_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k3_opt

polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)

        mov count, #(KYBER_N / 16)
                                              // Instructions:    117
                                              // Expected cycles: 68
                                              // Expected IPC:    1.72

                                              // Cycle bound:     68.0
                                              // IPC bound:       1.72

                                              // Wall time:     24.68s
                                              // User time:     24.68s

                                              // ------------------------ cycle (expected) ------------------------->
                                              // 0                        25                       50
                                              // |------------------------|------------------------|-----------------
        ldr q6, [x2], #32                     // *...................................................................
        ldr q30, [x2, #-16]                   // *...................................................................
        ldr q15, [x1, #16]                    // .*..................................................................
        ldr q25, [x1], #32                    // .*..................................................................
        ldr q13, [x8, #16]                    // ..*.................................................................
        ldr q5, [x4, #16]                     // ..*.................................................................
        ldr q14, [x4], #32                    // ...*................................................................
        ldr q12, [x2, #16]                    // ...*................................................................
        ldr q21, [x4, #16]                    // ....*...............................................................
        ldr q3, [x8], #32                     // ....*...............................................................
        uzp1 v24.8H, v6.8H, v30.8H            // ....*...............................................................
        ld1 {v31.8H}, [x3], #16               // .....*..............................................................
        ldr q20, [x5, #16]                    // .....*..............................................................
        uzp1 v9.8H, v25.8H, v15.8H            // .....*..............................................................
        ldr q10, [x4], #32                    // ......*.............................................................
        ldr q4, [x5], #32                     // ......*.............................................................
        uzp2 v7.8H, v25.8H, v15.8H            // ......*.............................................................
        uzp2 v30.8H, v6.8H, v30.8H            // .......*............................................................
        uzp1 v22.8H, v14.8H, v5.8H            // .......*............................................................
        ldr q16, [x7], #32                    // .......*............................................................
        uzp1 v15.8H, v3.8H, v13.8H            // ........*...........................................................
        smull v25.4S, v9.4H, v24.4H           // ........*...........................................................
        uzp2 v1.8H, v3.8H, v13.8H             // .........*..........................................................
        smull2 v26.4S, v9.8H, v24.8H          // .........*..........................................................
        uzp2 v28.8H, v10.8H, v21.8H           // ..........*.........................................................
        ld1 {v13.8H}, [x3], #16               // ..........*.........................................................
        smull v3.4S, v9.4H, v30.4H            // ..........*.........................................................
        uzp1 v10.8H, v10.8H, v21.8H           // ...........*........................................................
        ldr q19, [x7, #-16]                   // ...........*........................................................
        smlal2 v26.4S, v7.8H, v31.8H          // ...........*........................................................
        smlal v3.4S, v7.4H, v24.4H            // ............*.......................................................
        uzp2 v5.8H, v14.8H, v5.8H             // ............*.......................................................
        ldr q6, [x2], #32                     // ............*.......................................................
        smull2 v21.4S, v9.8H, v30.8H          // .............*......................................................
        uzp1 v27.8H, v4.8H, v20.8H            // .............*......................................................
        ld1 {v9.8H}, [x6], #16                // .............*......................................................
        uzp2 v20.8H, v4.8H, v20.8H            // ..............*.....................................................
        ldr q30, [x1, #16]                    // ..............*.....................................................
        smlal v25.4S, v7.4H, v31.4H           // ..............*.....................................................
        ldr q31, [x1], #32                    // ...............*....................................................
        smlal2 v21.4S, v7.8H, v24.8H          // ...............*....................................................
        smlal v25.4S, v22.4H, v27.4H          // ................*...................................................
        uzp1 v24.8H, v6.8H, v12.8H            // ................*...................................................
        uzp1 v7.8H, v16.8H, v19.8H            // .................*..................................................
        smlal v25.4S, v5.4H, v9.4H            // .................*..................................................
        uzp2 v16.8H, v16.8H, v19.8H           // ..................*.................................................
        smlal2 v21.4S, v22.8H, v20.8H         // ..................*.................................................
        smlal v3.4S, v22.4H, v20.4H           // ...................*................................................
        uzp2 v18.8H, v6.8H, v12.8H            // ...................*................................................
        smlal2 v26.4S, v22.8H, v27.8H         // ....................*...............................................
        uzp2 v29.8H, v31.8H, v30.8H           // ....................*...............................................
        smlal2 v26.4S, v5.8H, v9.8H           // .....................*..............................................
        smlal2 v26.4S, v7.8H, v15.8H          // ......................*.............................................
        smlal2 v21.4S, v5.8H, v27.8H          // .......................*............................................
        smlal2 v21.4S, v7.8H, v1.8H           // ........................*...........................................
        smlal v3.4S, v5.4H, v27.4H            // .........................*..........................................
        smlal v3.4S, v7.4H, v1.4H             // ..........................*.........................................
        uzp1 v23.8H, v31.8H, v30.8H           // ..........................*.........................................
        ld1 {v22.8H}, [x9], #16               // ...........................*........................................
        smlal v3.4S, v16.4H, v15.4H           // ...........................*........................................
        ldr q9, [x5], #32                     // ............................*.......................................
        ldr q6, [x5, #-16]                    // ............................*.......................................
        smlal2 v21.4S, v16.8H, v15.8H         // ............................*.......................................
        smull v20.4S, v23.4H, v24.4H          // .............................*......................................
        smull2 v4.4S, v23.8H, v24.8H          // ..............................*.....................................
        smlal2 v4.4S, v29.8H, v13.8H          // ...............................*....................................
        smlal2 v26.4S, v16.8H, v22.8H         // ................................*...................................
        uzp1 v19.8H, v9.8H, v6.8H             // ................................*...................................
        ld1 {v5.8H}, [x6], #16                // ................................*...................................
        smlal v25.4S, v7.4H, v15.4H           // .................................*..................................
        smlal v20.4S, v29.4H, v13.4H          // ..................................*.................................
        uzp1 v30.8H, v3.8H, v21.8H            // ..................................*.................................
        smlal v20.4S, v10.4H, v19.4H          // ...................................*................................
        smlal v25.4S, v16.4H, v22.4H          // ....................................*...............................
        uzp1 v13.8H, v25.8H, v26.8H           // .....................................*..............................
        mul v15.8H, v30.8H, v2.H[2]           // .....................................*..............................
        ldr q1, [x7], #32                     // ......................................*.............................
        ldr q31, [x7, #-16]                   // .......................................*............................
        smlal2 v4.4S, v10.8H, v19.8H          // .......................................*............................
        mul v13.8H, v13.8H, v2.H[2]           // ........................................*...........................
        ldr q30, [x8], #32                    // .........................................*..........................
        uzp2 v14.8H, v9.8H, v6.8H             // .........................................*..........................
        ldr q12, [x8, #-16]                   // ..........................................*.........................
        smlal v3.4S, v15.4H, v0.4H            // ..........................................*.........................
        uzp1 v9.8H, v1.8H, v31.8H             // ...........................................*........................
        smlal2 v21.4S, v15.8H, v0.8H          // ...........................................*........................
        uzp2 v22.8H, v3.8H, v21.8H            // ............................................*.......................
        smlal2 v4.4S, v28.8H, v5.8H           // ............................................*.......................
        smlal v25.4S, v13.4H, v0.4H           // .............................................*......................
        uzp2 v6.8H, v1.8H, v31.8H             // .............................................*......................
        smlal2 v26.4S, v13.8H, v0.8H          // ..............................................*.....................
        uzp1 v1.8H, v30.8H, v12.8H            // ..............................................*.....................
        smlal v20.4S, v28.4H, v5.4H           // ...............................................*....................
        uzp2 v27.8H, v25.8H, v26.8H           // ...............................................*....................
        sqdmulh v5.8H, v22.8H, v2.H[1]        // ................................................*...................
        ld1 {v15.8H}, [x9], #16               // ................................................*...................
        sqdmulh v3.8H, v27.8H, v2.H[1]        // ..................................................*.................
        smlal v20.4S, v9.4H, v1.4H            // ....................................................*...............
        smlal v20.4S, v6.4H, v15.4H           // .....................................................*..............
        srshr v17.8H, v5.8H, #11              // .....................................................*..............
        smlal2 v4.4S, v9.8H, v1.8H            // ......................................................*.............
        srshr v21.8H, v3.8H, #11              // .......................................................*............
        smlal2 v4.4S, v6.8H, v15.8H           // .......................................................*............
        uzp1 v7.8H, v20.8H, v4.8H             // ........................................................*...........
        mls v22.8H, v17.8H, v2.H[0]           // ........................................................*...........
        mls v27.8H, v21.8H, v2.H[0]           // ..........................................................*.........
        mul v13.8H, v7.8H, v2.H[2]            // ............................................................*.......
        smull v31.4S, v23.4H, v18.4H          // ..............................................................*.....
        smlal v31.4S, v29.4H, v24.4H          // ...............................................................*....
        zip1 v26.8H, v27.8H, v22.8H           // ................................................................*...
        smull2 v8.4S, v23.8H, v18.8H          // ................................................................*...
        smlal2 v4.4S, v13.8H, v0.8H           // .................................................................*..
        uzp2 v3.8H, v30.8H, v12.8H            // .................................................................*..
        smlal v20.4S, v13.4H, v0.4H           // ..................................................................*.
        zip2 v7.8H, v27.8H, v22.8H            // ..................................................................*.
        smlal2 v8.4S, v29.8H, v24.8H          // ...................................................................*
        uzp2 v23.8H, v20.8H, v4.8H            // ...................................................................*

                                                // ------------------------ cycle (expected) ------------------------->
                                                // 0                        25                       50
                                                // |------------------------|------------------------|-----------------
        // ldr q5, [x7], #32                     // .......*............................................................
        // ldr q4, [x1], #32                     // .*..................................................................
        // ldr q25, [x1, #-16]                   // .*..................................................................
        // ldr q7, [x4], #32                     // ...*................................................................
        // ldr q17, [x4, #-16]                   // ..*.................................................................
        // ldr q24, [x2], #32                    // *...................................................................
        // ldr q18, [x2, #-16]                   // *...................................................................
        // ldr q27, [x8], #32                    // ....*...............................................................
        // uzp1 v21.8H, v4.8H, v25.8H            // .....*..............................................................
        // ldr q14, [x5], #32                    // ......*.............................................................
        // ldr q20, [x5, #-16]                   // .....*..............................................................
        // uzp1 v10.8H, v7.8H, v17.8H            // .......*............................................................
        // ld1 {v16.8H}, [x3], #16               // .....*..............................................................
        // uzp1 v30.8H, v24.8H, v18.8H           // ....*...............................................................
        // uzp2 v4.8H, v4.8H, v25.8H             // ......*.............................................................
        // ldr q11, [x7, #-16]                   // ...........*........................................................
        // ldr q22, [x8, #-16]                   // ..*.................................................................
        // uzp1 v19.8H, v14.8H, v20.8H           // .............*......................................................
        // smull v13.4S, v21.4H, v30.4H          // ........*...........................................................
        // uzp2 v14.8H, v14.8H, v20.8H           // ..............*.....................................................
        // smlal v13.4S, v4.4H, v16.4H           // ..............*.....................................................
        // ld1 {v20.8H}, [x6], #16               // .............*......................................................
        // uzp2 v28.8H, v7.8H, v17.8H            // ............*.......................................................
        // ld1 {v26.8H}, [x9], #16               // ...........................*........................................
        // uzp1 v9.8H, v5.8H, v11.8H             // .................*..................................................
        // uzp2 v6.8H, v5.8H, v11.8H             // ..................*.................................................
        // smlal v13.4S, v10.4H, v19.4H          // ................*...................................................
        // uzp2 v3.8H, v27.8H, v22.8H            // .........*..........................................................
        // smlal v13.4S, v28.4H, v20.4H          // .................*..................................................
        // smull2 v17.4S, v21.8H, v30.8H         // .........*..........................................................
        // uzp1 v1.8H, v27.8H, v22.8H            // ........*...........................................................
        // smlal2 v17.4S, v4.8H, v16.8H          // ...........*........................................................
        // uzp2 v16.8H, v24.8H, v18.8H           // .......*............................................................
        // smlal2 v17.4S, v10.8H, v19.8H         // ....................*...............................................
        // smlal2 v17.4S, v28.8H, v20.8H         // .....................*..............................................
        // smlal v13.4S, v9.4H, v1.4H            // .................................*..................................
        // smlal v13.4S, v6.4H, v26.4H           // ....................................*...............................
        // smlal2 v17.4S, v9.8H, v1.8H           // ......................*.............................................
        // smlal2 v17.4S, v6.8H, v26.8H          // ................................*...................................
        // uzp1 v20.8H, v13.8H, v17.8H           // .....................................*..............................
        // mul v18.8H, v20.8H, v2.H[2]           // ........................................*...........................
        // smull v31.4S, v21.4H, v16.4H          // ..........*.........................................................
        // smlal v31.4S, v4.4H, v30.4H           // ............*.......................................................
        // smull2 v8.4S, v21.8H, v16.8H          // .............*......................................................
        // smlal2 v17.4S, v18.8H, v0.8H          // ..............................................*.....................
        // smlal v13.4S, v18.4H, v0.4H           // .............................................*......................
        // uzp2 v23.8H, v13.8H, v17.8H           // ...............................................*....................
        // smlal2 v8.4S, v4.8H, v30.8H           // ...............*....................................................
        // ldr q5, [x7], #32                     // ......................................*.............................
        // smlal2 v8.4S, v10.8H, v14.8H          // ..................*.................................................
        // ldr q4, [x1], #32                     // ...............*....................................................
        // ldr q25, [x1, #-16]                   // ..............*.....................................................
        // smlal v31.4S, v10.4H, v14.4H          // ...................*................................................
        // smlal2 v8.4S, v28.8H, v19.8H          // .......................*............................................
        // ldr q7, [x4], #32                     // ......*.............................................................
        // ldr q17, [x4, #-16]                   // ....*...............................................................
        // smlal v31.4S, v28.4H, v19.4H          // .........................*..........................................
        // ldr q24, [x2], #32                    // ............*.......................................................
        // ldr q18, [x2, #-16]                   // ...*................................................................
        // ldr q27, [x8], #32                    // .........................................*..........................
        // smlal v31.4S, v9.4H, v3.4H            // ..........................*.........................................
        // uzp1 v21.8H, v4.8H, v25.8H            // ..........................*.........................................
        // ldr q14, [x5], #32                    // ............................*.......................................
        // smlal2 v8.4S, v9.8H, v3.8H            // ........................*...........................................
        // smlal v31.4S, v6.4H, v1.4H            // ...........................*........................................
        // ldr q20, [x5, #-16]                   // ............................*.......................................
        // uzp1 v10.8H, v7.8H, v17.8H            // ...........*........................................................
        // smlal2 v8.4S, v6.8H, v1.8H            // ............................*.......................................
        // ld1 {v16.8H}, [x3], #16               // ..........*.........................................................
        // uzp1 v30.8H, v24.8H, v18.8H           // ................*...................................................
        // uzp2 v4.8H, v4.8H, v25.8H             // ....................*...............................................
        // sqdmulh v15.8H, v23.8H, v2.H[1]       // ..................................................*.................
        // ldr q11, [x7, #-16]                   // .......................................*............................
        // ldr q22, [x8, #-16]                   // ..........................................*.........................
        // uzp1 v26.8H, v31.8H, v8.8H            // ..................................*.................................
        // uzp1 v19.8H, v14.8H, v20.8H           // ................................*...................................
        // smull v13.4S, v21.4H, v30.4H          // .............................*......................................
        // uzp2 v14.8H, v14.8H, v20.8H           // .........................................*..........................
        // smlal v13.4S, v4.4H, v16.4H           // ..................................*.................................
        // ld1 {v20.8H}, [x6], #16               // ................................*...................................
        // uzp2 v28.8H, v7.8H, v17.8H            // ..........*.........................................................
        // mul v1.8H, v26.8H, v2.H[2]            // .....................................*..............................
        // ld1 {v26.8H}, [x9], #16               // ................................................*...................
        // uzp1 v9.8H, v5.8H, v11.8H             // ...........................................*........................
        // uzp2 v6.8H, v5.8H, v11.8H             // .............................................*......................
        // smlal v13.4S, v10.4H, v19.4H          // ...................................*................................
        // uzp2 v3.8H, v27.8H, v22.8H            // .................................................................*..
        // smlal v13.4S, v28.4H, v20.4H          // ...............................................*....................
        // smull2 v17.4S, v21.8H, v30.8H         // ..............................*.....................................
        // smlal v31.4S, v1.4H, v0.4H            // ..........................................*.........................
        // smlal2 v8.4S, v1.8H, v0.8H            // ...........................................*........................
        // uzp1 v1.8H, v27.8H, v22.8H            // ..............................................*.....................
        // smlal2 v17.4S, v4.8H, v16.8H          // ...............................*....................................
        // uzp2 v29.8H, v31.8H, v8.8H            // ............................................*.......................
        // uzp2 v16.8H, v24.8H, v18.8H           // ...................*................................................
        // smlal2 v17.4S, v10.8H, v19.8H         // .......................................*............................
        // srshr v22.8H, v15.8H, #11             // .......................................................*............
        // smlal2 v17.4S, v28.8H, v20.8H         // ............................................*.......................
        // sqdmulh v15.8H, v29.8H, v2.H[1]       // ................................................*...................
        // smlal v13.4S, v9.4H, v1.4H            // ....................................................*...............
        // smlal v13.4S, v6.4H, v26.4H           // .....................................................*..............
        // smlal2 v17.4S, v9.8H, v1.8H           // ......................................................*.............
        // smlal2 v17.4S, v6.8H, v26.8H          // .......................................................*............
        // srshr v24.8H, v15.8H, #11             // .....................................................*..............
        // mls v23.8H, v22.8H, v2.H[0]           // ..........................................................*.........
        // uzp1 v20.8H, v13.8H, v17.8H           // ........................................................*...........
        // mls v29.8H, v24.8H, v2.H[0]           // ........................................................*...........
        // mul v18.8H, v20.8H, v2.H[2]           // ............................................................*.......
        // smull v31.4S, v21.4H, v16.4H          // ..............................................................*.....
        // smlal v31.4S, v4.4H, v30.4H           // ...............................................................*....
        // zip1 v26.8H, v23.8H, v29.8H           // ................................................................*...
        // smull2 v8.4S, v21.8H, v16.8H          // ................................................................*...
        // zip2 v7.8H, v23.8H, v29.8H            // ..................................................................*.
        // smlal2 v17.4S, v18.8H, v0.8H          // .................................................................*..
        // smlal v13.4S, v18.4H, v0.4H           // ..................................................................*.
        // uzp2 v23.8H, v13.8H, v17.8H           // ...................................................................*
        // smlal2 v8.4S, v4.8H, v30.8H           // ...................................................................*

        sub count, count, #2
k3_loop_start:
                                               // Instructions:    71
                                               // Expected cycles: 40
                                               // Expected IPC:    1.77

                                               // Cycle bound:     40.0
                                               // IPC bound:       1.77

                                               // Wall time:     40.75s
                                               // User time:     40.75s

                                               // ---------- cycle (expected) ----------->
                                               // 0                        25
                                               // |------------------------|--------------
        ldr q5, [x7], #32                      // e.......................................
        smlal2 v8.4S, v10.8H, v14.8H           // *.......................................
        str q7, [x0, #16]                      // l.......................................
        ldr q4, [x1], #32                      // .e......................................
        ldr q25, [x1, #-16]                    // .e......................................
        smlal v31.4S, v10.4H, v14.4H           // .*......................................
        smlal2 v8.4S, v28.8H, v19.8H           // ..*.....................................
        ldr q7, [x4], #32                      // ..e.....................................
        ldr q17, [x4, #-16]                    // ..e.....................................
        smlal v31.4S, v28.4H, v19.4H           // ...*....................................
        ldr q24, [x2], #32                     // ...e....................................
        ldr q18, [x2, #-16]                    // ...e....................................
        ldr q27, [x8], #32                     // ....e...................................
        str q26, [x0], #32                     // ....l...................................
        smlal v31.4S, v9.4H, v3.4H             // ....*...................................
        uzp1 v21.8H, v4.8H, v25.8H             // .....e..................................
        ldr q14, [x5], #32                     // .....e..................................
        smlal2 v8.4S, v9.8H, v3.8H             // .....*..................................
        smlal v31.4S, v6.4H, v1.4H             // ......*.................................
        ldr q20, [x5, #-16]                    // ......e.................................
        uzp1 v10.8H, v7.8H, v17.8H             // ......e.................................
        smlal2 v8.4S, v6.8H, v1.8H             // .......*................................
        ld1 {v16.8H}, [x3], #16                // .......e................................
        uzp1 v30.8H, v24.8H, v18.8H            // .......e................................
        uzp2 v4.8H, v4.8H, v25.8H              // ........e...............................
        sqdmulh v15.8H, v23.8H, v2.H[1]        // ........*...............................
        ldr q11, [x7, #-16]                    // ........e...............................
        ldr q22, [x8, #-16]                    // .........e..............................
        uzp1 v26.8H, v31.8H, v8.8H             // .........*..............................
        uzp1 v19.8H, v14.8H, v20.8H            // ..........e.............................
        smull v13.4S, v21.4H, v30.4H           // ..........e.............................
        uzp2 v14.8H, v14.8H, v20.8H            // ...........e............................
        smlal v13.4S, v4.4H, v16.4H            // ...........e............................
        ld1 {v20.8H}, [x6], #16                // ...........e............................
        uzp2 v28.8H, v7.8H, v17.8H             // ............e...........................
        mul v1.8H, v26.8H, v2.H[2]             // ............*...........................
        ld1 {v26.8H}, [x9], #16                // ............e...........................
        uzp1 v9.8H, v5.8H, v11.8H              // .............e..........................
        uzp2 v6.8H, v5.8H, v11.8H              // ..............e.........................
        smlal v13.4S, v10.4H, v19.4H           // ..............e.........................
        uzp2 v3.8H, v27.8H, v22.8H             // ...............e........................
        smlal v13.4S, v28.4H, v20.4H           // ...............e........................
        smull2 v17.4S, v21.8H, v30.8H          // ................e.......................
        smlal v31.4S, v1.4H, v0.4H             // .................*......................
        smlal2 v8.4S, v1.8H, v0.8H             // ..................*.....................
        uzp1 v1.8H, v27.8H, v22.8H             // ..................e.....................
        smlal2 v17.4S, v4.8H, v16.8H           // ...................e....................
        uzp2 v29.8H, v31.8H, v8.8H             // ...................*....................
        uzp2 v16.8H, v24.8H, v18.8H            // ....................e...................
        smlal2 v17.4S, v10.8H, v19.8H          // ....................e...................
        srshr v22.8H, v15.8H, #11              // .....................*..................
        smlal2 v17.4S, v28.8H, v20.8H          // .....................e..................
        sqdmulh v15.8H, v29.8H, v2.H[1]        // ......................*.................
        smlal v13.4S, v9.4H, v1.4H             // ........................e...............
        smlal v13.4S, v6.4H, v26.4H            // .........................e..............
        smlal2 v17.4S, v9.8H, v1.8H            // ..........................e.............
        smlal2 v17.4S, v6.8H, v26.8H           // ...........................e............
        srshr v24.8H, v15.8H, #11              // ...........................*............
        mls v23.8H, v22.8H, v2.H[0]            // ............................*...........
        uzp1 v20.8H, v13.8H, v17.8H            // .............................e..........
        mls v29.8H, v24.8H, v2.H[0]            // ..............................*.........
        mul v18.8H, v20.8H, v2.H[2]            // ................................e.......
        smull v31.4S, v21.4H, v16.4H           // ..................................e.....
        smlal v31.4S, v4.4H, v30.4H            // ...................................e....
        zip1 v26.8H, v23.8H, v29.8H            // ...................................*....
        smull2 v8.4S, v21.8H, v16.8H           // ....................................e...
        zip2 v7.8H, v23.8H, v29.8H             // ....................................*...
        smlal2 v17.4S, v18.8H, v0.8H           // .....................................e..
        smlal v13.4S, v18.4H, v0.4H            // ......................................e.
        uzp2 v23.8H, v13.8H, v17.8H            // .......................................e
        smlal2 v8.4S, v4.8H, v30.8H            // .......................................e

                                                // --------------------------------- cycle (expected) --------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|---------
        // ldr q12, [x1], #32                    // .e......................................'~......................................'~...
        // ldr q13, [x1, #-16]                   // .e......................................'~......................................'~...
        // uzp1 v3.8h, v12.8h, v13.8h            // .....e..................................'....~..................................'....
        // uzp2 v4.8h, v12.8h, v13.8h            // ........e...............................'.......~...............................'....
        // ldr q12, [x2], #32                    // ...e....................................'..~....................................'..~.
        // ldr q13, [x2, #-16]                   // ...e....................................'..~....................................'..~.
        // uzp1 v5.8h, v12.8h, v13.8h            // .......e................................'......~................................'....
        // uzp2 v6.8h, v12.8h, v13.8h            // ....................e...................'...................~...................'....
        // ld1 {v7.8h}, [x3], #16                // .......e................................'......~................................'....
        // smull  v8.4s, v3.4h, v5.4h            // ..........e.............................'.........~.............................'....
        // smull2 v10.4s, v3.8h, v5.8h           // ................e.......................'...............~.......................'....
        // smlal  v8.4s, v4.4h, v7.4h            // ...........e............................'..........~............................'....
        // smlal2 v10.4s, v4.8h, v7.8h           // ...................e....................'..................~....................'....
        // smull  v9.4s, v3.4h, v6.4h            // ..................................e.....'.................................~.....'....
        // smull2 v11.4s, v3.8h, v6.8h           // ....................................e...'...................................~...'....
        // smlal  v9.4s, v4.4h, v5.4h            // ...................................e....'..................................~....'....
        // smlal2 v11.4s, v4.8h, v5.8h           // .......................................e'......................................~'....
        // ldr q12, [x4], #32                    // ..e.....................................'.~.....................................'.~..
        // ldr q13, [x4, #-16]                   // ..e.....................................'.~.....................................'.~..
        // uzp1 v3.8h, v12.8h, v13.8h            // ......e.................................'.....~.................................'....
        // uzp2 v4.8h, v12.8h, v13.8h            // ............e...........................'...........~...........................'....
        // ldr q12, [x5], #32                    // .....e..................................'....~..................................'....
        // ldr q13, [x5, #-16]                   // ......e.................................'.....~.................................'....
        // uzp1 v5.8h, v12.8h, v13.8h            // ..........e.............................'.........~.............................'....
        // uzp2 v6.8h, v12.8h, v13.8h            // ...........e............................'..........~............................'....
        // ld1 {v7.8h}, [x6], #16                // ...........e............................'..........~............................'....
        // smlal  v8.4s, v3.4h, v5.4h            // ..............e.........................'.............~.........................'....
        // smlal2 v10.4s, v3.8h, v5.8h           // ....................e...................'...................~...................'....
        // smlal  v8.4s, v4.4h, v7.4h            // ...............e........................'..............~........................'....
        // smlal2 v10.4s, v4.8h, v7.8h           // .....................e..................'....................~..................'....
        // smlal  v9.4s, v3.4h, v6.4h            // .~......................................'*......................................'~...
        // smlal2 v11.4s, v3.8h, v6.8h           // ~.......................................*.......................................~....
        // smlal  v9.4s, v4.4h, v5.4h            // ...~....................................'..*....................................'..~.
        // smlal2 v11.4s, v4.8h, v5.8h           // ..~.....................................'.*.....................................'.~..
        // ldr q12, [x7], #32                    // e.......................................~.......................................~....
        // ldr q13, [x7, #-16]                   // ........e...............................'.......~...............................'....
        // uzp1 v3.8h, v12.8h, v13.8h            // .............e..........................'............~..........................'....
        // uzp2 v4.8h, v12.8h, v13.8h            // ..............e.........................'.............~.........................'....
        // ldr q12, [x8], #32                    // ....e...................................'...~...................................'....
        // ldr q13, [x8, #-16]                   // .........e..............................'........~..............................'....
        // uzp1 v5.8h, v12.8h, v13.8h            // ..................e.....................'.................~.....................'....
        // uzp2 v6.8h, v12.8h, v13.8h            // ...............e........................'..............~........................'....
        // ld1 {v7.8h}, [x9], #16                // ............e...........................'...........~...........................'....
        // smlal  v8.4s, v3.4h, v5.4h            // ........................e...............'.......................~...............'....
        // smlal2 v10.4s, v3.8h, v5.8h           // ..........................e.............'.........................~.............'....
        // smlal  v8.4s, v4.4h, v7.4h            // .........................e..............'........................~..............'....
        // smlal2 v10.4s, v4.8h, v7.8h           // ...........................e............'..........................~............'....
        // smlal  v9.4s, v3.4h, v6.4h            // ....~...................................'...*...................................'....
        // smlal2 v11.4s, v3.8h, v6.8h           // .....~..................................'....*..................................'....
        // smlal  v9.4s, v4.4h, v5.4h            // ......~.................................'.....*.................................'....
        // smlal2 v11.4s, v4.8h, v5.8h           // .......~................................'......*................................'....
        // uzp1   v28.8h, v8.8h, v10.8h          // .............................e..........'............................~..........'....
        // mul    v28.8h, v28.8h, v2.h[2]        // ................................e.......'...............................~.......'....
        // smlal  v8.4s, v28.4h, v0.4h           // ......................................e.'.....................................~.'....
        // smlal2 v10.4s, v28.8h, v0.8h          // .....................................e..'....................................~..'....
        // uzp2   v26.8h, v8.8h, v10.8h          // .......................................e'......................................~'....
        // uzp1   v28.8h, v9.8h, v11.8h          // .........~..............................'........*..............................'....
        // mul    v28.8h, v28.8h, v2.h[2]        // ............~...........................'...........*...........................'....
        // smlal  v9.4s, v28.4h, v0.4h           // .................~......................'................*......................'....
        // smlal2 v11.4s, v28.8h, v0.8h          // ..................~.....................'.................*.....................'....
        // uzp2   v27.8h, v9.8h, v11.8h          // ...................~....................'..................*....................'....
        // sqdmulh v28.8h, v26.8h, v2.h[1]       // ........~...............................'.......*...............................'....
        // srshr   v28.8h, v28.8h, #11           // .....................~..................'....................*..................'....
        // mls     v26.8h, v28.8h, v2.h[0]       // ............................~...........'...........................*...........'....
        // sqdmulh v28.8h, v27.8h, v2.h[1]       // ......................~.................'.....................*.................'....
        // srshr   v28.8h, v28.8h, #11           // ...........................~............'..........................*............'....
        // mls     v27.8h, v28.8h, v2.h[0]       // ..............................~.........'.............................*.........'....
        // zip1 v12.8h, v26.8h, v27.8h           // ...................................~....'..................................*....'....
        // zip2 v13.8h, v26.8h, v27.8h           // ....................................~...'...................................*...'....
        // str q12, [x0], #32                    // ....~...................................'...~...................................'...l
        // str q13, [x0, #-16]                   // ~.......................................~.......................................l....

        sub count, count, #1
        cbnz count, k3_loop_start
                                              // Instructions:    25
                                              // Expected cycles: 38
                                              // Expected IPC:    0.66

                                              // Cycle bound:     38.0
                                              // IPC bound:       0.66

                                              // Wall time:     0.06s
                                              // User time:     0.06s

                                              // --------- cycle (expected) ---------->
                                              // 0                        25
                                              // |------------------------|------------
        smlal2 v8.4S, v10.8H, v14.8H          // *.....................................
        str q7, [x0, #16]                     // *.....................................
        smlal v31.4S, v10.4H, v14.4H          // .*....................................
        str q26, [x0], #32                    // .*....................................
        smlal2 v8.4S, v28.8H, v19.8H          // ..*...................................
        smlal v31.4S, v28.4H, v19.4H          // ...*..................................
        smlal v31.4S, v9.4H, v3.4H            // ....*.................................
        smlal2 v8.4S, v9.8H, v3.8H            // .....*................................
        smlal v31.4S, v6.4H, v1.4H            // ......*...............................
        smlal2 v8.4S, v6.8H, v1.8H            // .......*..............................
        uzp1 v13.8H, v31.8H, v8.8H            // ........*.............................
        sqdmulh v3.8H, v23.8H, v2.H[1]        // ........*.............................
        mul v15.8H, v13.8H, v2.H[2]           // ...........*..........................
        srshr v13.8H, v3.8H, #11              // .............*........................
        smlal v31.4S, v15.4H, v0.4H           // ................*.....................
        smlal2 v8.4S, v15.8H, v0.8H           // .................*....................
        uzp2 v9.8H, v31.8H, v8.8H             // ..................*...................
        mls v23.8H, v13.8H, v2.H[0]           // ...................*..................
        sqdmulh v13.8H, v9.8H, v2.H[1]        // .....................*................
        srshr v17.8H, v13.8H, #11             // ..........................*...........
        mls v9.8H, v17.8H, v2.H[0]            // .............................*........
        zip1 v30.8H, v23.8H, v9.8H            // ..................................*...
        zip2 v19.8H, v23.8H, v9.8H            // ..................................*...
        str q30, [x0], #32                    // .....................................*
        str q19, [x0, #-16]                   // .....................................*

                                                // --------- cycle (expected) ---------->
                                                // 0                        25
                                                // |------------------------|------------
        // smlal2 v8.4S, v10.8H, v14.8H          // *.....................................
        // str q7, [x0, #16]                     // *.....................................
        // smlal v31.4S, v10.4H, v14.4H          // .*....................................
        // smlal2 v8.4S, v28.8H, v19.8H          // ..*...................................
        // smlal v31.4S, v28.4H, v19.4H          // ...*..................................
        // str q26, [x0], #32                    // .*....................................
        // smlal v31.4S, v9.4H, v3.4H            // ....*.................................
        // smlal2 v8.4S, v9.8H, v3.8H            // .....*................................
        // smlal v31.4S, v6.4H, v1.4H            // ......*...............................
        // smlal2 v8.4S, v6.8H, v1.8H            // .......*..............................
        // sqdmulh v15.8H, v23.8H, v2.H[1]       // ........*.............................
        // uzp1 v26.8H, v31.8H, v8.8H            // ........*.............................
        // mul v1.8H, v26.8H, v2.H[2]            // ...........*..........................
        // smlal v31.4S, v1.4H, v0.4H            // ................*.....................
        // smlal2 v8.4S, v1.8H, v0.8H            // .................*....................
        // uzp2 v29.8H, v31.8H, v8.8H            // ..................*...................
        // srshr v22.8H, v15.8H, #11             // .............*........................
        // sqdmulh v15.8H, v29.8H, v2.H[1]       // .....................*................
        // srshr v24.8H, v15.8H, #11             // ..........................*...........
        // mls v23.8H, v22.8H, v2.H[0]           // ...................*..................
        // mls v29.8H, v24.8H, v2.H[0]           // .............................*........
        // zip1 v26.8H, v23.8H, v29.8H           // ..................................*...
        // zip2 v7.8H, v23.8H, v29.8H            // ..................................*...
        // str q7, [x0, #16]                     // .....................................*
        // str q26, [x0], #32                    // .....................................*


        pop_stack
        ret
#endif /* KYBER_K == 3 */

#if KYBER_K == 4
.global polyvec_basemul_acc_montgomery_cached_asm_k4_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k4_opt

polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)
        add a3_ptr, a0_ptr, #(3 * 512)
        add b3_ptr, b0_ptr, #(3 * 512)
        add b3_cache_ptr, b0_cache_ptr, #(3 * 512/2)

        mov count, #(KYBER_N / 16)
                                             // Instructions:    67
                                             // Expected cycles: 26
                                             // Expected IPC:    2.58
                                             //
                                             // Cycle bound:     26.0
                                             // IPC bound:       2.58
                                             //
                                             // Wall time:     0.97s
                                             // User time:     0.97s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        ldr q12, [x2], #32                   // *.............................
        ldr q6, [x2, #-16]                   // *.............................
        ldr q21, [x1, #16]                   // .*............................
        ldr q17, [x1], #32                   // .*............................
        ldr q23, [x10], #32                  // ..*...........................
        ldr q25, [x5, #16]                   // ..*...........................
        ldr q24, [x11], #32                  // ...*..........................
        ldr q13, [x5], #32                   // ...*..........................
        uzp2 v10.8H, v12.8H, v6.8H           // ....*.........................
        ldr q3, [x4, #16]                    // ....*.........................
        ldr q31, [x4], #32                   // ....*.........................
        uzp1 v28.8H, v17.8H, v21.8H          // .....*........................
        uzp2 v20.8H, v17.8H, v21.8H          // .....*........................
        ldr q26, [x10, #-16]                 // .....*........................
        uzp1 v17.8H, v12.8H, v6.8H           // ......*.......................
        ldr q11, [x8, #48]                   // ......*.......................
        ld1 {v7.8H}, [x12], #16              // ......*.......................
        uzp2 v30.8H, v13.8H, v25.8H          // .......*......................
        ldr q9, [x1, #16]                    // .......*......................
        ld1 {v21.8H}, [x3], #16              // ........*.....................
        smull2 v16.4S, v28.8H, v10.8H        // ........*.....................
        uzp1 v5.8H, v31.8H, v3.8H            // ........*.....................
        ldr q8, [x8], #32                    // .........*....................
        uzp1 v12.8H, v13.8H, v25.8H          // .........*....................
        smlal2 v16.4S, v20.8H, v17.8H        // .........*....................
        smull v4.4S, v28.4H, v17.4H          // ..........*...................
        ldr q13, [x7], #32                   // ..........*...................
        uzp1 v29.8H, v23.8H, v26.8H          // ..........*...................
        smlal2 v16.4S, v5.8H, v30.8H         // ...........*..................
        ldr q18, [x1], #32                   // ...........*..................
        ld1 {v22.8H}, [x6], #16              // ...........*..................
        uzp2 v26.8H, v23.8H, v26.8H          // ............*.................
        smull v23.4S, v28.4H, v10.4H         // ............*.................
        ld1 {v15.8H}, [x9], #16              // ............*.................
        smlal v23.4S, v20.4H, v17.4H         // .............*................
        ldr q1, [x11, #-16]                  // .............*................
        smull2 v17.4S, v28.8H, v17.8H        // ..............*...............
        ldr q6, [x7, #-16]                   // ..............*...............
        ldr q27, [x2, #16]                   // ..............*...............
        smlal2 v17.4S, v20.8H, v21.8H        // ...............*..............
        uzp2 v14.8H, v18.8H, v9.8H           // ...............*..............
        uzp2 v31.8H, v31.8H, v3.8H           // ................*.............
        smlal v4.4S, v20.4H, v21.4H          // ................*.............
        ldr q20, [x8, #-16]                  // ................*.............
        smlal v23.4S, v5.4H, v30.4H          // .................*............
        uzp2 v28.8H, v24.8H, v1.8H           // .................*............
        ldr q3, [x11], #32                   // .................*............
        smlal2 v17.4S, v5.8H, v12.8H         // ..................*...........
        uzp2 v10.8H, v13.8H, v6.8H           // ..................*...........
        uzp1 v21.8H, v13.8H, v6.8H           // ...................*..........
        smlal v23.4S, v31.4H, v12.4H         // ...................*..........
        ldr q6, [x4], #32                    // ...................*..........
        smlal2 v17.4S, v31.8H, v22.8H        // ....................*.........
        ldr q13, [x2], #32                   // ....................*.........
        uzp1 v30.8H, v8.8H, v20.8H           // ....................*.........
        smlal v4.4S, v5.4H, v12.4H           // .....................*........
        uzp2 v5.8H, v8.8H, v20.8H            // .....................*........
        ldr q8, [x8], #32                    // .....................*........
        uzp1 v1.8H, v24.8H, v1.8H            // ......................*.......
        smlal2 v16.4S, v31.8H, v12.8H        // ......................*.......
        ldr q12, [x4, #-16]                  // ......................*.......
        uzp1 v25.8H, v18.8H, v9.8H           // .......................*......
        smlal v4.4S, v31.4H, v22.4H          // .......................*......
        smlal v23.4S, v21.4H, v5.4H          // ........................*.....
        uzp1 v20.8H, v13.8H, v27.8H          // ........................*.....
        smlal v23.4S, v10.4H, v30.4H         // .........................*....
        uzp2 v19.8H, v13.8H, v27.8H          // .........................*....

                                              // ------ cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|-----
        // ldr q9, [x1], #32                  // .*.............................
        // ldr q31, [x1, #-16]                // .*.............................
        // ldr q27, [x2, #16]                 // *..............................
        // ldr q6, [x4], #32                  // ....*..........................
        // ldr q3, [x11], #32                 // ...*...........................
        // ldr q11, [x8, #16]                 // ................*..............
        // ldr q8, [x2], #32                  // *..............................
        // ldr q12, [x4, #-16]                // ....*..........................
        // uzp2 v14.8H, v9.8H, v31.8H         // .....*.........................
        // uzp1 v25.8H, v9.8H, v31.8H         // .....*.........................
        // uzp1 v20.8H, v8.8H, v27.8H         // ......*........................
        // uzp2 v19.8H, v8.8H, v27.8H         // ....*..........................
        // ldr q8, [x8], #32                  // .........*.....................
        // uzp2 v24.8H, v6.8H, v12.8H         // ................*..............
        // ldr q9, [x1], #32                  // ...........*...................
        // ldr q31, [x1, #-16]                // .......*.......................
        // ldr q27, [x2, #16]                 // ..............*................
        // ld1 {v13.8H}, [x3], #16            // ........*......................
        // uzp2 v5.8H, v8.8H, v11.8H          // .....................*.........
        // ld1 {v18.8H}, [x6], #16            // ...........*...................
        // ldr q28, [x7], #32                 // ..........*....................
        // ld1 {v15.8H}, [x9], #16            // ............*..................
        // uzp1 v30.8H, v8.8H, v11.8H         // ....................*..........
        // ldr q7, [x7, #-16]                 // ..............*................
        // smull v23.4S, v25.4H, v19.4H       // ............*..................
        // ldr q11, [x5, #16]                 // ..*............................
        // ldr q26, [x5], #32                 // ...*...........................
        // uzp2 v10.8H, v28.8H, v7.8H         // ..................*............
        // smull2 v16.4S, v25.8H, v19.8H      // ........*......................
        // uzp1 v21.8H, v28.8H, v7.8H         // ...................*...........
        // smlal2 v16.4S, v14.8H, v20.8H      // .........*.....................
        // smlal v23.4S, v14.4H, v20.4H       // .............*.................
        // uzp1 v7.8H, v26.8H, v11.8H         // .........*.....................
        // ldr q22, [x11, #-16]               // .............*.................
        // uzp2 v11.8H, v26.8H, v11.8H        // .......*.......................
        // uzp1 v19.8H, v6.8H, v12.8H         // ........*......................
        // uzp2 v28.8H, v3.8H, v22.8H         // .................*.............
        // smlal v23.4S, v19.4H, v11.4H       // .................*.............
        // smlal v23.4S, v24.4H, v7.4H        // ...................*...........
        // smlal v23.4S, v21.4H, v5.4H        // ........................*......
        // smlal v23.4S, v10.4H, v30.4H       // .........................*.....
        // uzp1 v1.8H, v3.8H, v22.8H          // ......................*........
        // ldr q6, [x4], #32                  // ...................*...........
        // ldr q22, [x10], #32                // ..*............................
        // ldr q3, [x11], #32                 // .................*.............
        // ldr q12, [x10, #-16]               // .....*.........................
        // smull2 v17.4S, v25.8H, v20.8H      // ..............*................
        // smull v4.4S, v25.4H, v20.4H        // ..........*....................
        // smlal2 v17.4S, v14.8H, v13.8H      // ...............*...............
        // uzp2 v26.8H, v22.8H, v12.8H        // ............*..................
        // smlal2 v16.4S, v19.8H, v11.8H      // ...........*...................
        // ldr q11, [x8, #16]                 // ......*........................
        // smlal2 v17.4S, v19.8H, v7.8H       // ..................*............
        // ldr q8, [x2], #32                  // ....................*..........
        // smlal2 v17.4S, v24.8H, v18.8H      // ....................*..........
        // uzp1 v29.8H, v22.8H, v12.8H        // ..........*....................
        // ldr q12, [x4, #-16]                // ......................*........
        // smlal v4.4S, v14.4H, v13.4H        // ................*..............
        // uzp2 v14.8H, v9.8H, v31.8H         // ...............*...............
        // smlal2 v16.4S, v24.8H, v7.8H       // ......................*........
        // uzp1 v25.8H, v9.8H, v31.8H         // .......................*.......
        // smlal v4.4S, v19.4H, v7.4H         // .....................*.........
        // ld1 {v7.8H}, [x12], #16            // ......*........................
        // uzp1 v20.8H, v8.8H, v27.8H         // ........................*......
        // uzp2 v19.8H, v8.8H, v27.8H         // .........................*.....
        // smlal v4.4S, v24.4H, v18.4H        // .......................*.......
        // ldr q8, [x8], #32                  // .....................*.........

        sub count, count, #2
k4_loop_start:
                                              // Instructions:    88
                                              // Expected cycles: 49
                                              // Expected IPC:    1.80
                                              //
                                              // Cycle bound:     48.0
                                              // IPC bound:       1.83
                                              //
                                              // Wall time:     171.84s
                                              // User time:     171.84s
                                              //
                                              // --------------- cycle (expected) --------------->
                                              // 0                        25
                                              // |------------------------|-----------------------
        uzp2 v24.8H, v6.8H, v12.8H            // *................................................
        smlal2 v17.4S, v21.8H, v30.8H         // l................................................
        ldr q9, [x1], #32                     // e................................................
        ldr q31, [x1, #-16]                   // .e...............................................
        ldr q27, [x2, #16]                    // .e...............................................
        smlal v23.4S, v29.4H, v28.4H          // .l...............................................
        ld1 {v13.8H}, [x3], #16               // ..*..............................................
        smlal v23.4S, v26.4H, v1.4H           // ..l..............................................
        smlal2 v16.4S, v21.8H, v5.8H          // ...l.............................................
        uzp2 v5.8H, v8.8H, v11.8H             // ....*............................................
        smlal v4.4S, v21.4H, v30.4H           // ....l............................................
        smlal2 v16.4S, v10.8H, v30.8H         // .....l...........................................
        smlal2 v16.4S, v29.8H, v28.8H         // ......l..........................................
        ld1 {v18.8H}, [x6], #16               // ......*..........................................
        smlal2 v16.4S, v26.8H, v1.8H          // .......l.........................................
        uzp1 v21.8H, v23.8H, v16.8H           // ........l........................................
        smlal2 v17.4S, v10.8H, v15.8H         // ........l........................................
        smlal2 v17.4S, v29.8H, v1.8H          // .........l.......................................
        ldr q28, [x7], #32                    // .........*.......................................
        smlal v4.4S, v10.4H, v15.4H           // ..........l......................................
        ld1 {v15.8H}, [x9], #16               // ..........*......................................
        mul v30.8H, v21.8H, v2.H[2]           // ...........l.....................................
        smlal v4.4S, v29.4H, v1.4H            // .............l...................................
        smlal v4.4S, v26.4H, v7.4H            // ..............l..................................
        smlal2 v17.4S, v26.8H, v7.8H          // ...............l.................................
        uzp1 v29.8H, v4.8H, v17.8H            // ................l................................
        smlal v23.4S, v30.4H, v0.4H           // ................l................................
        smlal2 v16.4S, v30.8H, v0.8H          // .................l...............................
        uzp1 v30.8H, v8.8H, v11.8H            // .................*...............................
        ldr q7, [x7, #-16]                    // .................*...............................
        uzp2 v8.8H, v23.8H, v16.8H            // ..................l..............................
        smull v23.4S, v25.4H, v19.4H          // ..................*..............................
        ldr q11, [x5, #16]                    // ..................*..............................
        mul v1.8H, v29.8H, v2.H[2]            // ...................l.............................
        ldr q26, [x5], #32                    // ...................*.............................
        uzp2 v10.8H, v28.8H, v7.8H            // .....................*...........................
        smull2 v16.4S, v25.8H, v19.8H         // .....................*...........................
        uzp1 v21.8H, v28.8H, v7.8H            // ......................*..........................
        smlal2 v16.4S, v14.8H, v20.8H         // ......................*..........................
        smlal v23.4S, v14.4H, v20.4H          // .......................*.........................
        uzp1 v7.8H, v26.8H, v11.8H            // .......................*.........................
        ldr q22, [x11, #-16]                  // .......................*.........................
        uzp2 v11.8H, v26.8H, v11.8H           // ........................*........................
        smlal v4.4S, v1.4H, v0.4H             // ........................l........................
        smlal2 v17.4S, v1.8H, v0.8H           // .........................l.......................
        uzp1 v19.8H, v6.8H, v12.8H            // .........................*.......................
        uzp2 v29.8H, v4.8H, v17.8H            // ..........................l......................
        sqdmulh v1.8H, v8.8H, v2.H[1]         // ..........................l......................
        uzp2 v28.8H, v3.8H, v22.8H            // ...........................*.....................
        smlal v23.4S, v19.4H, v11.4H          // ............................*....................
        sqdmulh v6.8H, v29.8H, v2.H[1]        // .............................l...................
        smlal v23.4S, v24.4H, v7.4H           // ...............................*.................
        srshr v4.8H, v1.8H, #11               // ...............................l.................
        smlal v23.4S, v21.4H, v5.4H           // ................................*................
        smlal v23.4S, v10.4H, v30.4H          // .................................*...............
        uzp1 v1.8H, v3.8H, v22.8H             // ..................................*..............
        srshr v12.8H, v6.8H, #11              // ..................................l..............
        ldr q6, [x4], #32                     // ..................................e..............
        mls v8.8H, v4.8H, v2.H[0]             // ...................................l.............
        ldr q22, [x10], #32                   // ...................................*.............
        ldr q3, [x11], #32                    // ....................................e............
        mls v29.8H, v12.8H, v2.H[0]           // .....................................l...........
        ldr q12, [x10, #-16]                  // .....................................*...........
        smull2 v17.4S, v25.8H, v20.8H         // .......................................*.........
        smull v4.4S, v25.4H, v20.4H           // ........................................*........
        smlal2 v17.4S, v14.8H, v13.8H         // .........................................*.......
        uzp2 v26.8H, v22.8H, v12.8H           // .........................................*.......
        smlal2 v16.4S, v19.8H, v11.8H         // ..........................................*......
        zip1 v20.8H, v29.8H, v8.8H            // ..........................................l......
        ldr q11, [x8, #16]                    // ..........................................e......
        smlal2 v17.4S, v19.8H, v7.8H          // ...........................................*.....
        zip2 v25.8H, v29.8H, v8.8H            // ...........................................l.....
        ldr q8, [x2], #32                     // ...........................................e.....
        smlal2 v17.4S, v24.8H, v18.8H         // ............................................*....
        uzp1 v29.8H, v22.8H, v12.8H           // ............................................*....
        ldr q12, [x4, #-16]                   // ............................................e....
        smlal v4.4S, v14.4H, v13.4H           // .............................................*...
        uzp2 v14.8H, v9.8H, v31.8H            // .............................................e...
        str q20, [x0], #32                    // .............................................l...
        smlal2 v16.4S, v24.8H, v7.8H          // ..............................................*..
        str q25, [x0, #-16]                   // ..............................................l..
        uzp1 v25.8H, v9.8H, v31.8H            // ..............................................e..
        smlal v4.4S, v19.4H, v7.4H            // ...............................................*.
        ld1 {v7.8H}, [x12], #16               // ...............................................*.
        uzp1 v20.8H, v8.8H, v27.8H            // ...............................................e.
        uzp2 v19.8H, v8.8H, v27.8H            // ................................................e
        smlal v4.4S, v24.4H, v18.4H           // ................................................*
        ldr q8, [x8], #32                     // ................................................e

                                                // --------------------------------------------------------------- cycle (expected) --------------------------------------------------------------->
                                                // 0                        25                       50                       75                       100                      125
                                                // |------------------------|------------------------|------------------------|------------------------|------------------------|-------------------
        // ldr q12, [x1], #32                   // e................................................~................................................~..............................................
        // ldr q13, [x1, #-16]                  // .e...............................................'~...............................................'~.............................................
        // uzp1 v3.8h, v12.8h, v13.8h           // ..............................................e..'.............................................~..'..............................................
        // uzp2 v4.8h, v12.8h, v13.8h           // .............................................e...'............................................~...'............................................~.
        // ldr q12, [x2], #32                   // ...........................................e.....'..........................................~.....'..........................................~...
        // ldr q13, [x2, #-16]                  // .e...............................................'~...............................................'~.............................................
        // uzp1 v5.8h, v12.8h, v13.8h           // ...............................................e.'..............................................~.'..............................................
        // uzp2 v6.8h, v12.8h, v13.8h           // ................................................e'...............................................~'..............................................
        // ld1 {v7.8h}, [x3], #16               // ..~..............................................'.*..............................................'.~............................................
        // smull  v8.4s, v3.4h, v5.4h           // ........................................~........'.......................................*........'.......................................~......
        // smull2 v10.4s, v3.8h, v5.8h          // .......................................~.........'......................................*.........'......................................~.......
        // smlal  v8.4s, v4.4h, v7.4h           // .............................................~...'............................................*...'............................................~.
        // smlal2 v10.4s, v4.8h, v7.8h          // .........................................~.......'........................................*.......'........................................~.....
        // smull  v9.4s, v3.4h, v6.4h           // ..................~..............................'.................*..............................'.................~............................
        // smull2 v11.4s, v3.8h, v6.8h          // .....................~...........................'....................*...........................'....................~.........................
        // smlal  v9.4s, v4.4h, v5.4h           // .......................~.........................'......................*.........................'......................~.......................
        // smlal2 v11.4s, v4.8h, v5.8h          // ......................~..........................'.....................*..........................'.....................~........................
        // ldr q12, [x4], #32                   // ..................................e..............'.................................~..............'.................................~............
        // ldr q13, [x4, #-16]                  // ............................................e....'...........................................~....'...........................................~..
        // uzp1 v3.8h, v12.8h, v13.8h           // .........................~.......................'........................*.......................'........................~.....................
        // uzp2 v4.8h, v12.8h, v13.8h           // ~................................................*................................................~..............................................
        // ldr q12, [x5], #32                   // ...................~.............................'..................*.............................'..................~...........................
        // ldr q13, [x5, #-16]                  // ..................~..............................'.................*..............................'.................~............................
        // uzp1 v5.8h, v12.8h, v13.8h           // .......................~.........................'......................*.........................'......................~.......................
        // uzp2 v6.8h, v12.8h, v13.8h           // ........................~........................'.......................*........................'.......................~......................
        // ld1 {v7.8h}, [x6], #16               // ......~..........................................'.....*..........................................'.....~........................................
        // smlal  v8.4s, v3.4h, v5.4h           // ...............................................~.'..............................................*.'..............................................
        // smlal2 v10.4s, v3.8h, v5.8h          // ...........................................~.....'..........................................*.....'..........................................~...
        // smlal  v8.4s, v4.4h, v7.4h           // ................................................~'...............................................*'..............................................
        // smlal2 v10.4s, v4.8h, v7.8h          // ............................................~....'...........................................*....'...........................................~..
        // smlal  v9.4s, v3.4h, v6.4h           // ............................~....................'...........................*....................'...........................~..................
        // smlal2 v11.4s, v3.8h, v6.8h          // ..........................................~......'.........................................*......'.........................................~....
        // smlal  v9.4s, v4.4h, v5.4h           // ...............................~.................'..............................*.................'..............................~...............
        // smlal2 v11.4s, v4.8h, v5.8h          // ..............................................~..'.............................................*..'..............................................
        // ldr q12, [x7], #32                   // .........~.......................................'........*.......................................'........~.....................................
        // ldr q13, [x7, #-16]                  // .................~...............................'................*...............................'................~.............................
        // uzp1 v3.8h, v12.8h, v13.8h           // ......................~..........................'.....................*..........................'.....................~........................
        // uzp2 v4.8h, v12.8h, v13.8h           // .....................~...........................'....................*...........................'....................~.........................
        // ldr q12, [x8], #32                   // ................................................e'...............................................~'..............................................
        // ldr q13, [x8, #-16]                  // ..........................................e......'.........................................~......'.........................................~....
        // uzp1 v5.8h, v12.8h, v13.8h           // .................~...............................'................*...............................'................~.............................
        // uzp2 v6.8h, v12.8h, v13.8h           // ....~............................................'...*............................................'...~..........................................
        // ld1 {v7.8h}, [x9], #16               // ..........~......................................'.........*......................................'.........~....................................
        // smlal  v8.4s, v3.4h, v5.4h           // ....~............................................'...~............................................'...l..........................................
        // smlal2 v10.4s, v3.8h, v5.8h          // ~................................................~................................................l..............................................
        // smlal  v8.4s, v4.4h, v7.4h           // ..........~......................................'.........~......................................'.........l....................................
        // smlal2 v10.4s, v4.8h, v7.8h          // ........~........................................'.......~........................................'.......l......................................
        // smlal  v9.4s, v3.4h, v6.4h           // ................................~................'...............................*................'...............................~..............
        // smlal2 v11.4s, v3.8h, v6.8h          // ...~.............................................'..~.............................................'..l...........................................
        // smlal  v9.4s, v4.4h, v5.4h           // .................................~...............'................................*...............'................................~.............
        // smlal2 v11.4s, v4.8h, v5.8h          // .....~...........................................'....~...........................................'....l.........................................
        // ldr q12, [x10], #32                  // ...................................~.............'..................................*.............'..................................~...........
        // ldr q13, [x10, #-16]                 // .....................................~...........'....................................*...........'....................................~.........
        // uzp1 v3.8h, v12.8h, v13.8h           // ............................................~....'...........................................*....'...........................................~..
        // uzp2 v4.8h, v12.8h, v13.8h           // .........................................~.......'........................................*.......'........................................~.....
        // ldr q12, [x11], #32                  // ....................................e............'...................................~............'...................................~..........
        // ldr q13, [x11, #-16]                 // .......................~.........................'......................*.........................'......................~.......................
        // uzp1 v5.8h, v12.8h, v13.8h           // ..................................~..............'.................................*..............'.................................~............
        // uzp2 v6.8h, v12.8h, v13.8h           // ...........................~.....................'..........................*.....................'..........................~...................
        // ld1 {v7.8h}, [x12], #16              // ...............................................~.'..............................................*.'..............................................
        // smlal  v8.4s, v3.4h, v5.4h           // .............~...................................'............~...................................'............l.................................
        // smlal2 v10.4s, v3.8h, v5.8h          // .........~.......................................'........~.......................................'........l.....................................
        // smlal  v8.4s, v4.4h, v7.4h           // ..............~..................................'.............~..................................'.............l................................
        // smlal2 v10.4s, v4.8h, v7.8h          // ...............~.................................'..............~.................................'..............l...............................
        // smlal  v9.4s, v3.4h, v6.4h           // .~...............................................'~...............................................'l.............................................
        // smlal2 v11.4s, v3.8h, v6.8h          // ......~..........................................'.....~..........................................'.....l........................................
        // smlal  v9.4s, v4.4h, v5.4h           // ..~..............................................'.~..............................................'.l............................................
        // smlal2 v11.4s, v4.8h, v5.8h          // .......~.........................................'......~.........................................'......l.......................................
        // uzp1   v28.8h, v8.8h, v10.8h         // ................~................................'...............~................................'...............l..............................
        // mul    v28.8h, v28.8h, v2.h[2]       // ...................~.............................'..................~.............................'..................l...........................
        // smlal  v8.4s, v28.4h, v0.4h          // ........................~........................'.......................~........................'.......................l......................
        // smlal2 v10.4s, v28.8h, v0.8h         // .........................~.......................'........................~.......................'........................l.....................
        // uzp2   v26.8h, v8.8h, v10.8h         // ..........................~......................'.........................~......................'.........................l....................
        // uzp1   v28.8h, v9.8h, v11.8h         // ........~........................................'.......~........................................'.......l......................................
        // mul    v28.8h, v28.8h, v2.h[2]       // ...........~.....................................'..........~.....................................'..........l...................................
        // smlal  v9.4s, v28.4h, v0.4h          // ................~................................'...............~................................'...............l..............................
        // smlal2 v11.4s, v28.8h, v0.8h         // .................~...............................'................~...............................'................l.............................
        // uzp2   v27.8h, v9.8h, v11.8h         // ..................~..............................'.................~..............................'.................l............................
        // sqdmulh v28.8h, v26.8h, v2.h[1]      // .............................~...................'............................~...................'............................l.................
        // srshr   v28.8h, v28.8h, #11          // ..................................~..............'.................................~..............'.................................l............
        // mls     v26.8h, v28.8h, v2.h[0]      // .....................................~...........'....................................~...........'....................................l.........
        // sqdmulh v28.8h, v27.8h, v2.h[1]      // ..........................~......................'.........................~......................'.........................l....................
        // srshr   v28.8h, v28.8h, #11          // ...............................~.................'..............................~.................'..............................l...............
        // mls     v27.8h, v28.8h, v2.h[0]      // ...................................~.............'..................................~.............'..................................l...........
        // zip1 v12.8h, v26.8h, v27.8h          // ..........................................~......'.........................................~......'.........................................l....
        // zip2 v13.8h, v26.8h, v27.8h          // ...........................................~.....'..........................................~.....'..........................................l...
        // str q12, [x0], #32                   // .............................................~...'............................................~...'............................................l.
        // str q13, [x0, #-16]                  // ..............................................~..'.............................................~..'.............................................l

        sub count, count, #1
        cbnz count, k4_loop_start
                                               // Instructions:    109
                                               // Expected cycles: 85
                                               // Expected IPC:    1.28
                                               //
                                               // Cycle bound:     85.0
                                               // IPC bound:       1.28
                                               //
                                               // Wall time:     9.71s
                                               // User time:     9.71s
                                               //
                                               // --------------------------------- cycle (expected) --------------------------------->
                                               // 0                        25                       50                       75
                                               // |------------------------|------------------------|------------------------|---------
        uzp1 v22.8H, v6.8H, v12.8H             // *....................................................................................
        smlal2 v16.4S, v21.8H, v5.8H           // *....................................................................................
        ldr q5, [x11, #-16]                    // *....................................................................................
        uzp2 v24.8H, v6.8H, v12.8H             // .*...................................................................................
        ld1 {v12.8H}, [x9], #16                // .*...................................................................................
        smlal2 v16.4S, v10.8H, v30.8H          // .*...................................................................................
        uzp2 v18.8H, v8.8H, v11.8H             // ..*..................................................................................
        smlal v23.4S, v29.4H, v28.4H           // ..*..................................................................................
        ldr q27, [x7], #32                     // ..*..................................................................................
        uzp1 v8.8H, v8.8H, v11.8H              // ...*.................................................................................
        smlal2 v16.4S, v29.8H, v28.8H          // ...*.................................................................................
        ldr q9, [x10], #32                     // ...*.................................................................................
        smlal v23.4S, v26.4H, v1.4H            // ....*................................................................................
        uzp1 v11.8H, v3.8H, v5.8H              // ....*................................................................................
        ldr q6, [x10, #-16]                    // ....*................................................................................
        smlal v4.4S, v21.4H, v30.4H            // .....*...............................................................................
        smlal v4.4S, v10.4H, v15.4H            // ......*..............................................................................
        uzp2 v3.8H, v3.8H, v5.8H               // .......*.............................................................................
        smlal v4.4S, v29.4H, v1.4H             // .......*.............................................................................
        smlal v4.4S, v26.4H, v7.4H             // ........*............................................................................
        uzp1 v13.8H, v9.8H, v6.8H              // ........*............................................................................
        smlal2 v16.4S, v26.8H, v1.8H           // .........*...........................................................................
        uzp2 v9.8H, v9.8H, v6.8H               // .........*...........................................................................
        ldr q6, [x5, #16]                      // .........*...........................................................................
        smlal2 v17.4S, v21.8H, v30.8H          // ..........*..........................................................................
        uzp1 v28.8H, v23.8H, v16.8H            // ..........*..........................................................................
        smlal2 v17.4S, v10.8H, v15.8H          // ...........*.........................................................................
        ldr q15, [x5], #32                     // ...........*.........................................................................
        smlal2 v17.4S, v29.8H, v1.8H           // ............*........................................................................
        mul v5.8H, v28.8H, v2.H[2]             // .............*.......................................................................
        ldr q28, [x7, #-16]                    // .............*.......................................................................
        smlal2 v17.4S, v26.8H, v7.8H           // ...............*.....................................................................
        ld1 {v26.8H}, [x3], #16                // ...............*.....................................................................
        uzp2 v7.8H, v15.8H, v6.8H              // ...............*.....................................................................
        uzp1 v6.8H, v15.8H, v6.8H              // ................*....................................................................
        smull v31.4S, v25.4H, v19.4H           // ................*....................................................................
        uzp2 v1.8H, v27.8H, v28.8H             // .................*...................................................................
        smlal v31.4S, v14.4H, v20.4H           // .................*...................................................................
        uzp1 v21.8H, v27.8H, v28.8H            // ..................*..................................................................
        ld1 {v27.8H}, [x6], #16                // ..................*..................................................................
        smlal v23.4S, v5.4H, v0.4H             // ..................*..................................................................
        smlal2 v16.4S, v5.8H, v0.8H            // ...................*.................................................................
        uzp1 v5.8H, v4.8H, v17.8H              // ...................*.................................................................
        smlal v31.4S, v22.4H, v7.4H            // ....................*................................................................
        uzp2 v23.8H, v23.8H, v16.8H            // ....................*................................................................
        smlal v31.4S, v24.4H, v6.4H            // .....................*...............................................................
        smlal v31.4S, v21.4H, v18.4H           // ......................*..............................................................
        smlal v31.4S, v1.4H, v8.4H             // .......................*.............................................................
        smull2 v15.4S, v25.8H, v20.8H          // ........................*............................................................
        smull2 v19.4S, v25.8H, v19.8H          // .........................*...........................................................
        mul v10.8H, v5.8H, v2.H[2]             // ..........................*..........................................................
        smull v25.4S, v25.4H, v20.4H           // ............................*........................................................
        smlal2 v19.4S, v14.8H, v20.8H          // .............................*.......................................................
        smlal v25.4S, v14.4H, v26.4H           // ..............................*......................................................
        smlal v25.4S, v22.4H, v6.4H            // ...............................*.....................................................
        smlal v25.4S, v24.4H, v27.4H           // ................................*....................................................
        smlal v25.4S, v21.4H, v8.4H            // .................................*...................................................
        smlal v25.4S, v1.4H, v12.4H            // ..................................*..................................................
        smlal2 v15.4S, v14.8H, v26.8H          // ...................................*.................................................
        smlal2 v19.4S, v22.8H, v7.8H           // ....................................*................................................
        smlal2 v15.4S, v22.8H, v6.8H           // .....................................*...............................................
        smlal2 v15.4S, v24.8H, v27.8H          // ......................................*..............................................
        smlal2 v19.4S, v24.8H, v6.8H           // .......................................*.............................................
        smlal2 v19.4S, v21.8H, v18.8H          // ........................................*............................................
        ld1 {v18.8H}, [x12], #16               // ........................................*............................................
        smlal v4.4S, v10.4H, v0.4H             // .........................................*...........................................
        smlal v31.4S, v13.4H, v3.4H            // ..........................................*..........................................
        smlal2 v15.4S, v21.8H, v8.8H           // ...........................................*.........................................
        smlal2 v15.4S, v1.8H, v12.8H           // ............................................*........................................
        smlal2 v19.4S, v1.8H, v8.8H            // .............................................*.......................................
        smlal2 v19.4S, v13.8H, v3.8H           // ..............................................*......................................
        smlal2 v19.4S, v9.8H, v11.8H           // ...............................................*.....................................
        smlal2 v15.4S, v13.8H, v11.8H          // ................................................*....................................
        smlal v31.4S, v9.4H, v11.4H            // .................................................*...................................
        smlal v25.4S, v13.4H, v11.4H           // ..................................................*..................................
        smlal v25.4S, v9.4H, v18.4H            // ...................................................*.................................
        uzp1 v21.8H, v31.8H, v19.8H            // ...................................................*.................................
        smlal2 v15.4S, v9.8H, v18.8H           // ....................................................*................................
        smlal2 v17.4S, v10.8H, v0.8H           // .....................................................*...............................
        uzp1 v10.8H, v25.8H, v15.8H            // .....................................................*...............................
        uzp2 v29.8H, v4.8H, v17.8H             // ......................................................*..............................
        mul v21.8H, v21.8H, v2.H[2]            // ......................................................*..............................
        mul v13.8H, v10.8H, v2.H[2]            // ........................................................*............................
        sqdmulh v4.8H, v29.8H, v2.H[1]         // ..........................................................*..........................
        smlal v31.4S, v21.4H, v0.4H            // ............................................................*........................
        smlal2 v19.4S, v21.8H, v0.8H           // .............................................................*.......................
        smlal v25.4S, v13.4H, v0.4H            // ..............................................................*......................
        uzp2 v19.8H, v31.8H, v19.8H            // ..............................................................*......................
        smlal2 v15.4S, v13.8H, v0.8H           // ...............................................................*.....................
        srshr v17.8H, v4.8H, #11               // ...............................................................*.....................
        uzp2 v3.8H, v25.8H, v15.8H             // ................................................................*....................
        sqdmulh v16.8H, v23.8H, v2.H[1]        // ................................................................*....................
        sqdmulh v10.8H, v19.8H, v2.H[1]        // ..................................................................*..................
        sqdmulh v13.8H, v3.8H, v2.H[1]         // ....................................................................*................
        srshr v4.8H, v16.8H, #11               // .....................................................................*...............
        mls v29.8H, v17.8H, v2.H[0]            // ......................................................................*..............
        srshr v21.8H, v10.8H, #11              // .......................................................................*.............
        mls v23.8H, v4.8H, v2.H[0]             // ........................................................................*............
        srshr v10.8H, v13.8H, #11              // .........................................................................*...........
        mls v19.8H, v21.8H, v2.H[0]            // ..........................................................................*..........
        mls v3.8H, v10.8H, v2.H[0]             // ............................................................................*........
        zip1 v30.8H, v29.8H, v23.8H            // ..............................................................................*......
        zip2 v13.8H, v29.8H, v23.8H            // ...............................................................................*.....
        str q30, [x0], #32                     // .................................................................................*...
        zip1 v10.8H, v3.8H, v19.8H             // .................................................................................*...
        zip2 v31.8H, v3.8H, v19.8H             // .................................................................................*...
        str q13, [x0, #-16]                    // ..................................................................................*..
        str q10, [x0], #32                     // ....................................................................................*
        str q31, [x0, #-16]                    // ....................................................................................*

                                               // --------------------------------- cycle (expected) --------------------------------->
                                               // 0                        25                       50                       75
                                               // |------------------------|------------------------|------------------------|---------
        // uzp2 v24.8H, v6.8H, v12.8H          // .*...................................................................................
        // smlal2 v17.4S, v21.8H, v30.8H       // ..........*..........................................................................
        // smlal v23.4S, v29.4H, v28.4H        // ..*..................................................................................
        // ld1 {v13.8H}, [x3], #16             // ...............*.....................................................................
        // smlal v23.4S, v26.4H, v1.4H         // ....*................................................................................
        // smlal2 v16.4S, v21.8H, v5.8H        // *....................................................................................
        // uzp2 v5.8H, v8.8H, v11.8H           // ..*..................................................................................
        // smlal v4.4S, v21.4H, v30.4H         // .....*...............................................................................
        // smlal2 v16.4S, v10.8H, v30.8H       // .*...................................................................................
        // smlal2 v16.4S, v29.8H, v28.8H       // ...*.................................................................................
        // ld1 {v18.8H}, [x6], #16             // ..................*..................................................................
        // smlal2 v16.4S, v26.8H, v1.8H        // .........*...........................................................................
        // uzp1 v21.8H, v23.8H, v16.8H         // ..........*..........................................................................
        // smlal2 v17.4S, v10.8H, v15.8H       // ...........*.........................................................................
        // smlal2 v17.4S, v29.8H, v1.8H        // ............*........................................................................
        // ldr q28, [x7], #32                  // ..*..................................................................................
        // smlal v4.4S, v10.4H, v15.4H         // ......*..............................................................................
        // ld1 {v15.8H}, [x9], #16             // .*...................................................................................
        // mul v30.8H, v21.8H, v2.H[2]         // .............*.......................................................................
        // smlal v4.4S, v29.4H, v1.4H          // .......*.............................................................................
        // smlal v4.4S, v26.4H, v7.4H          // ........*............................................................................
        // smlal2 v17.4S, v26.8H, v7.8H        // ...............*.....................................................................
        // uzp1 v29.8H, v4.8H, v17.8H          // ...................*.................................................................
        // smlal v23.4S, v30.4H, v0.4H         // ..................*..................................................................
        // smlal2 v16.4S, v30.8H, v0.8H        // ...................*.................................................................
        // uzp1 v30.8H, v8.8H, v11.8H          // ...*.................................................................................
        // ldr q7, [x7, #-16]                  // .............*.......................................................................
        // uzp2 v8.8H, v23.8H, v16.8H          // ....................*................................................................
        // smull v23.4S, v25.4H, v19.4H        // ................*....................................................................
        // ldr q11, [x5, #16]                  // .........*...........................................................................
        // mul v1.8H, v29.8H, v2.H[2]          // ..........................*..........................................................
        // ldr q26, [x5], #32                  // ...........*.........................................................................
        // uzp2 v10.8H, v28.8H, v7.8H          // .................*...................................................................
        // smull2 v16.4S, v25.8H, v19.8H       // .........................*...........................................................
        // uzp1 v21.8H, v28.8H, v7.8H          // ..................*..................................................................
        // smlal2 v16.4S, v14.8H, v20.8H       // .............................*.......................................................
        // smlal v23.4S, v14.4H, v20.4H        // .................*...................................................................
        // uzp1 v7.8H, v26.8H, v11.8H          // ................*....................................................................
        // ldr q22, [x11, #-16]                // *....................................................................................
        // uzp2 v11.8H, v26.8H, v11.8H         // ...............*.....................................................................
        // smlal v4.4S, v1.4H, v0.4H           // .........................................*...........................................
        // smlal2 v17.4S, v1.8H, v0.8H         // .....................................................*...............................
        // uzp1 v19.8H, v6.8H, v12.8H          // *....................................................................................
        // uzp2 v29.8H, v4.8H, v17.8H          // ......................................................*..............................
        // sqdmulh v1.8H, v8.8H, v2.H[1]       // ................................................................*....................
        // uzp2 v28.8H, v3.8H, v22.8H          // .......*.............................................................................
        // smlal v23.4S, v19.4H, v11.4H        // ....................*................................................................
        // sqdmulh v6.8H, v29.8H, v2.H[1]      // ..........................................................*..........................
        // smlal v23.4S, v24.4H, v7.4H         // .....................*...............................................................
        // srshr v4.8H, v1.8H, #11             // .....................................................................*...............
        // smlal v23.4S, v21.4H, v5.4H         // ......................*..............................................................
        // smlal v23.4S, v10.4H, v30.4H        // .......................*.............................................................
        // uzp1 v1.8H, v3.8H, v22.8H           // ....*................................................................................
        // srshr v12.8H, v6.8H, #11            // ...............................................................*.....................
        // mls v8.8H, v4.8H, v2.H[0]           // ........................................................................*............
        // ldr q22, [x10], #32                 // ...*.................................................................................
        // mls v29.8H, v12.8H, v2.H[0]         // ......................................................................*..............
        // ldr q12, [x10, #-16]                // ....*................................................................................
        // smull2 v17.4S, v25.8H, v20.8H       // ........................*............................................................
        // smull v4.4S, v25.4H, v20.4H         // ............................*........................................................
        // smlal2 v17.4S, v14.8H, v13.8H       // ...................................*.................................................
        // uzp2 v26.8H, v22.8H, v12.8H         // .........*...........................................................................
        // smlal2 v16.4S, v19.8H, v11.8H       // ....................................*................................................
        // zip1 v20.8H, v29.8H, v8.8H          // ..............................................................................*......
        // smlal2 v17.4S, v19.8H, v7.8H        // .....................................*...............................................
        // zip2 v25.8H, v29.8H, v8.8H          // ...............................................................................*.....
        // smlal2 v17.4S, v24.8H, v18.8H       // ......................................*..............................................
        // uzp1 v29.8H, v22.8H, v12.8H         // ........*............................................................................
        // smlal v4.4S, v14.4H, v13.4H         // ..............................*......................................................
        // str q20, [x0], #32                  // .................................................................................*...
        // smlal2 v16.4S, v24.8H, v7.8H        // .......................................*.............................................
        // str q25, [x0, #-16]                 // ..................................................................................*..
        // smlal v4.4S, v19.4H, v7.4H          // ...............................*.....................................................
        // ld1 {v7.8H}, [x12], #16             // ........................................*............................................
        // smlal v4.4S, v24.4H, v18.4H         // ................................*....................................................
        // smlal2 v17.4S, v21.8H, v30.8H       // ...........................................*.........................................
        // smlal v23.4S, v29.4H, v28.4H        // ..........................................*..........................................
        // smlal v23.4S, v26.4H, v1.4H         // .................................................*...................................
        // smlal2 v16.4S, v21.8H, v5.8H        // ........................................*............................................
        // smlal v4.4S, v21.4H, v30.4H         // .................................*...................................................
        // smlal2 v16.4S, v10.8H, v30.8H       // .............................................*.......................................
        // smlal2 v16.4S, v29.8H, v28.8H       // ..............................................*......................................
        // smlal2 v16.4S, v26.8H, v1.8H        // ...............................................*.....................................
        // uzp1 v21.8H, v23.8H, v16.8H         // ...................................................*.................................
        // smlal2 v17.4S, v10.8H, v15.8H       // ............................................*........................................
        // smlal2 v17.4S, v29.8H, v1.8H        // ................................................*....................................
        // smlal v4.4S, v10.4H, v15.4H         // ..................................*..................................................
        // mul v30.8H, v21.8H, v2.H[2]         // ......................................................*..............................
        // smlal v4.4S, v29.4H, v1.4H          // ..................................................*..................................
        // smlal v4.4S, v26.4H, v7.4H          // ...................................................*.................................
        // smlal2 v17.4S, v26.8H, v7.8H        // ....................................................*................................
        // uzp1 v29.8H, v4.8H, v17.8H          // .....................................................*...............................
        // smlal v23.4S, v30.4H, v0.4H         // ............................................................*........................
        // smlal2 v16.4S, v30.8H, v0.8H        // .............................................................*.......................
        // uzp2 v8.8H, v23.8H, v16.8H          // ..............................................................*......................
        // mul v1.8H, v29.8H, v2.H[2]          // ........................................................*............................
        // smlal v4.4S, v1.4H, v0.4H           // ..............................................................*......................
        // smlal2 v17.4S, v1.8H, v0.8H         // ...............................................................*.....................
        // uzp2 v29.8H, v4.8H, v17.8H          // ................................................................*....................
        // sqdmulh v1.8H, v8.8H, v2.H[1]       // ..................................................................*..................
        // sqdmulh v6.8H, v29.8H, v2.H[1]      // ....................................................................*................
        // srshr v4.8H, v1.8H, #11             // .......................................................................*.............
        // srshr v12.8H, v6.8H, #11            // .........................................................................*...........
        // mls v8.8H, v4.8H, v2.H[0]           // ..........................................................................*..........
        // mls v29.8H, v12.8H, v2.H[0]         // ............................................................................*........
        // zip1 v20.8H, v29.8H, v8.8H          // .................................................................................*...
        // zip2 v25.8H, v29.8H, v8.8H          // .................................................................................*...
        // str q20, [x0], #32                  // ....................................................................................*
        // str q25, [x0, #-16]                 // ....................................................................................*


        pop_stack
        ret
#endif /* KYBER_K == 4 */

#endif /* MLKEM_USE_AARCH64_ASM */
