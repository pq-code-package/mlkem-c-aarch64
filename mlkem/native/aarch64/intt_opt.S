///
/// Copyright (c) 2022 Arm Limited
/// Copyright (c) 2022 Hanno Becker
/// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
/// SPDX-License-Identifier: MIT
///
/// Permission is hereby granted, free of charge, to any person obtaining a copy
/// of this software and associated documentation files (the "Software"), to deal
/// in the Software without restriction, including without limitation the rights
/// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
/// copies of the Software, and to permit persons to whom the Software is
/// furnished to do so, subject to the following conditions:
///
/// The above copyright notice and this permission notice shall be included in all
/// copies or substantial portions of the Software.
///
/// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
/// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
/// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
/// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
/// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
/// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
/// SOFTWARE.
///

#include "config.h"
#if defined(MLKEM_USE_NATIVE_AARCH64)

// Needed to provide ASM_LOAD directive
#include "common.i"
#include "params.h"

// Bounds:
// If C is chosen so that |src| < q * C, then |dst| < q * (0.0508 * C + 1/2)
//
// See mlken/reduce.c and test/test_bounds.py for more details.
.macro mulmodq dst, src, const, idx0, idx1
        sqrdmulh t2.8h,      \src\().8h, \const\().h[\idx1\()]
        mul      \dst\().8h, \src\().8h, \const\().h[\idx0\()]
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro mulmod dst, src, const, const_twisted
        sqrdmulh t2.8h,      \src\().8h, \const_twisted\().8h
        mul      \dst\().8h, \src\().8h, \const\().8h
        mls      \dst\().8h, t2.8h,      consts.h[0]
.endm

.macro gs_butterfly a, b, root, idx0, idx1
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmodq  \b, tmp, \root, \idx0, \idx1
.endm

.macro gs_butterfly_v a, b, root, root_twisted
        sub tmp.8h,   \a\().8h, \b\().8h
        add \a\().8h, \a\().8h, \b\().8h
        mulmod  \b, tmp, \root, \root_twisted
.endm

.macro mul_ninv dst0, dst1, dst2, dst3, src0, src1, src2, src3
        mulmod \dst0, \src0, ninv, ninv_tw
        mulmod \dst1, \src1, ninv, ninv_tw
        mulmod \dst2, \src2, ninv, ninv_tw
        mulmod \dst3, \src3, ninv, ninv_tw
.endm

.macro barrett_reduce a
        sqdmulh t0.8h,    \a\().8h, consts.h[1]
        srshr   t0.8h,    t0.8h,    #11
        mls     \a\().8h, t0.8h,    consts.h[0]
.endm

.macro load_roots_123
        ldr q_root0, [r_ptr0], #32
        ldr q_root1, [r_ptr0, #-16]
.endm

.macro load_next_roots_45
        ldr q_root0, [r_ptr0], #16
.endm

.macro load_next_roots_67
        ldr q_root0,    [r_ptr1], #(6*16)
        ldr q_root0_tw, [r_ptr1, #(-6*16 + 1*16)]
        ldr q_root1,    [r_ptr1, #(-6*16 + 2*16)]
        ldr q_root1_tw, [r_ptr1, #(-6*16 + 3*16)]
        ldr q_root2,    [r_ptr1, #(-6*16 + 4*16)]
        ldr q_root2_tw, [r_ptr1, #(-6*16 + 5*16)]
.endm

.macro transpose4 data
        trn1 t0.4s, \data\()0.4s, \data\()1.4s
        trn2 t1.4s, \data\()0.4s, \data\()1.4s
        trn1 t2.4s, \data\()2.4s, \data\()3.4s
        trn2 t3.4s, \data\()2.4s, \data\()3.4s

        trn2 \data\()2.2d, t0.2d, t2.2d
        trn2 \data\()3.2d, t1.2d, t3.2d
        trn1 \data\()0.2d, t0.2d, t2.2d
        trn1 \data\()1.2d, t1.2d, t3.2d
.endm

.macro transpose_single data_out, data_in
        trn1 \data_out\()0.4s, \data_in\()0.4s, \data_in\()1.4s
        trn2 \data_out\()1.4s, \data_in\()0.4s, \data_in\()1.4s
        trn1 \data_out\()2.4s, \data_in\()2.4s, \data_in\()3.4s
        trn2 \data_out\()3.4s, \data_in\()2.4s, \data_in\()3.4s
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

// For comparability reasons, the output range for the coefficients of this
// invNTT code is supposed to match the implementation from PQClean on commit
// ee71d2c823982bfcf54686f3cf1d666f396dc9aa. After the invNTT, the coefficients
// are NOT canonically reduced. The ordering of the coefficients is canonical,
// also matching PQClean.

.data
.p2align 4
roots:
#include "intt_123_45_67_twiddles.S"
.text
        .global MLKEM_NAMESPACE(intt_asm_opt)
        .global _MLKEM_NAMESPACE(intt_asm_opt)

.p2align 4
const_addr:       .short 3329
                  .short 20159
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
                  .short 0
ninv_addr:        .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
                  .short 512
ninv_tw_addr:     .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040
                  .short 5040

MLKEM_NAMESPACE(intt_asm_opt):
_MLKEM_NAMESPACE(intt_asm_opt):
        push_stack

        in      .req x0
        inp     .req x1
        count   .req x2
        r_ptr0  .req x3
        r_ptr1  .req x4
        xtmp    .req x5

        data0  .req v8
        data1  .req v9
        data2  .req v10
        data3  .req v11
        data4  .req v12
        data5  .req v13
        data6  .req v14
        data7  .req v15

        q_data0  .req q8
        q_data1  .req q9
        q_data2  .req q10
        q_data3  .req q11
        q_data4  .req q12
        q_data5  .req q13
        q_data6  .req q14
        q_data7  .req q15

        root0    .req v0
        root1    .req v1
        root2    .req v2
        root0_tw .req v4
        root1_tw .req v5
        root2_tw .req v6

        consts     .req v7
        q_consts   .req q7

        q_root0    .req q0
        q_root1    .req q1
        q_root2    .req q2
        q_root0_tw .req q4
        q_root1_tw .req q5
        q_root2_tw .req q6

        tmp .req v24
        t0  .req v25
        t1  .req v26
        t2  .req v27
        t3  .req v28

        ASM_LOAD(r_ptr0, roots_l34)
        ASM_LOAD(r_ptr1, roots_l56)

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]

        ninv             .req v29
        ninv_tw          .req v30

        ASM_LOAD(xtmp, ninv_addr)
        ld1r {ninv.8h}, [xtmp]
        ASM_LOAD(xtmp, ninv_tw_addr)
        ld1r {ninv_tw.8h}, [xtmp]

        mov inp, in
        mov count, #8

                                  // Instructions:    3
                                  // Expected cycles: 5
                                  // Expected IPC:    0.60
                                  //
                                  // Cycle bound:     5.0
                                  // IPC bound:       0.60
                                  //
                                  // Wall time:     0.00s
                                  // User time:     0.00s
                                  //
                                  // ----- cycle (expected) ------>
                                  // 0                        25
                                  // |------------------------|----
        ldr q12, [x1, #16]        // *.............................
        ldr q31, [x1, #32]        // ..*...........................
        ldr q6, [x1, #48]         // ....*.........................

                                   // ------ cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|-----
        // ldr q12, [x1, #16]      // *..............................
        // ldr q31, [x1, #32]      // ..*............................
        // ldr q6, [x1, #48]       // ....*..........................

        sub count, count, #1
scale_start:
                                               // Instructions:    20
                                               // Expected cycles: 24
                                               // Expected IPC:    0.83
                                               //
                                               // Cycle bound:     24.0
                                               // IPC bound:       0.83
                                               //
                                               // Wall time:     0.51s
                                               // User time:     0.51s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        ldr q10, [x1, #0]                      // *.............................
        sqrdmulh v13.8H, v12.8H, v30.8H        // ..*...........................
        mul v21.8H, v12.8H, v29.8H             // ...*..........................
        sqrdmulh v3.8H, v10.8H, v30.8H         // ....*.........................
        mul v10.8H, v10.8H, v29.8H             // .....*........................
        sqrdmulh v12.8H, v31.8H, v30.8H        // ......*.......................
        mls v21.8H, v13.8H, v7.H[0]            // .......*......................
        mul v13.8H, v31.8H, v29.8H             // ........*.....................
        mls v10.8H, v3.8H, v7.H[0]             // .........*....................
        sqrdmulh v3.8H, v6.8H, v30.8H          // ..........*...................
        mul v6.8H, v6.8H, v29.8H               // ...........*..................
        mls v13.8H, v12.8H, v7.H[0]            // ............*.................
        str q10, [x1], #64                     // .............*................
        ldr q12, [x1, #16]                     // ..............e...............
        str q21, [x1, #-48]                    // ................*.............
        mls v6.8H, v3.8H, v7.H[0]              // .................*............
        str q13, [x1, #-32]                    // ..................*...........
        ldr q31, [x1, #32]                     // ...................e..........
        str q6, [x1, #-16]                     // .....................*........
        ldr q6, [x1, #48]                      // ......................e.......

                                                      // ------ cycle (expected) ------->
                                                      // 0                        25
                                                      // |------------------------|------
        // ldr q8, [x1, #(16*0)]                      // ..........*.....................
        // ldr q9, [x1, #(16*1)]                      // e.........'.............~.......
        // ldr q10, [x1, #(16*2)]                     // .....e....'..................~..
        // ldr q11, [x1, #(16*3)]                     // ........e.'.....................
        // sqrdmulh v27.8h,      v8.8h, v30.8h        // ..........'...*.................
        // mul      v8.8h, v8.8h, v29.8h              // ..........'....*................
        // mls      v8.8h, v27.8h,      v7.h[0]       // ..........'........*............
        // sqrdmulh v27.8h,      v9.8h, v30.8h        // ..........'.*...................
        // mul      v9.8h, v9.8h, v29.8h              // ..........'..*..................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ..........'......*..............
        // sqrdmulh v27.8h,      v10.8h, v30.8h       // ..........'.....*...............
        // mul      v10.8h, v10.8h, v29.8h            // ..........'.......*.............
        // mls      v10.8h, v27.8h,      v7.h[0]      // ..........'...........*.........
        // sqrdmulh v27.8h,      v11.8h, v30.8h       // ..........'.........*...........
        // mul      v11.8h, v11.8h, v29.8h            // ..........'..........*..........
        // mls      v11.8h, v27.8h,      v7.h[0]      // ...~......'................*....
        // str q8, [x1], #64                          // ..........'............*........
        // str q9, [x1, #(-64 + 16*1)]                // ..~.......'...............*.....
        // str q10, [x1, #(-64 + 16*2)]               // ....~.....'.................*...
        // str q11, [x1, #(-64 + 16*3)]               // .......~..'....................*

        sub count, count, #1
        cbnz count, scale_start
                                               // Instructions:    17
                                               // Expected cycles: 20
                                               // Expected IPC:    0.85
                                               //
                                               // Cycle bound:     20.0
                                               // IPC bound:       0.85
                                               //
                                               // Wall time:     0.16s
                                               // User time:     0.16s
                                               //
                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        sqrdmulh v0.8H, v6.8H, v30.8H          // *.............................
        mul v13.8H, v6.8H, v29.8H              // .*............................
        ldr q10, [x1, #0]                      // ..*...........................
        mul v23.8H, v31.8H, v29.8H             // ....*.........................
        mls v13.8H, v0.8H, v7.H[0]             // .....*........................
        sqrdmulh v4.8H, v10.8H, v30.8H         // ......*.......................
        mul v18.8H, v10.8H, v29.8H             // .......*......................
        sqrdmulh v10.8H, v12.8H, v30.8H        // ........*.....................
        mul v21.8H, v12.8H, v29.8H             // .........*....................
        sqrdmulh v0.8H, v31.8H, v30.8H         // ..........*...................
        mls v18.8H, v4.8H, v7.H[0]             // ...........*..................
        str q13, [x1, #48]                     // ............*.................
        mls v21.8H, v10.8H, v7.H[0]            // .............*................
        mls v23.8H, v0.8H, v7.H[0]             // ..............*...............
        str q18, [x1], #64                     // ...............*..............
        str q21, [x1, #-48]                    // .................*............
        str q23, [x1, #-32]                    // ...................*..........

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ldr q10, [x1, #0]                    // ..*............................
        // sqrdmulh v13.8H, v12.8H, v30.8H      // ........*......................
        // mul v21.8H, v12.8H, v29.8H           // .........*.....................
        // sqrdmulh v3.8H, v10.8H, v30.8H       // ......*........................
        // mul v10.8H, v10.8H, v29.8H           // .......*.......................
        // sqrdmulh v12.8H, v31.8H, v30.8H      // ..........*....................
        // mls v21.8H, v13.8H, v7.H[0]          // .............*.................
        // mul v13.8H, v31.8H, v29.8H           // ....*..........................
        // mls v10.8H, v3.8H, v7.H[0]           // ...........*...................
        // sqrdmulh v3.8H, v6.8H, v30.8H        // *..............................
        // mul v6.8H, v6.8H, v29.8H             // .*.............................
        // mls v13.8H, v12.8H, v7.H[0]          // ..............*................
        // str q10, [x1], #64                   // ...............*...............
        // str q21, [x1, #-48]                  // .................*.............
        // mls v6.8H, v3.8H, v7.H[0]            // .....*.........................
        // str q13, [x1, #-32]                  // ...................*...........
        // str q6, [x1, #-16]                   // ............*..................


        mov inp, in
        mov count, #8

        .p2align 2
                                           // Instructions:    11
                                           // Expected cycles: 20
                                           // Expected IPC:    0.55
                                           //
                                           // Cycle bound:     20.0
                                           // IPC bound:       0.55
                                           //
                                           // Wall time:     0.01s
                                           // User time:     0.01s
                                           //
                                           // ----- cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|----
        ldr q10, [x1, #0]                  // *.............................
        ldr q21, [x1, #16]                 // ..*...........................
        ldr q31, [x1, #32]                 // ....*.........................
        ldr q12, [x1, #48]                 // ......*.......................
        ldr q5, [x4], #(6*16)              // ........*.....................
        trn1 v30.4S, v31.4S, v12.4S        // ..........*...................
        ldr q9, [x4, #-80]                 // ...........*..................
        ldr q15, [x4, #-64]                // .............*................
        ldr q6, [x4, #-48]                 // ...............*..............
        ldr q25, [x4, #-32]                // .................*............
        ldr q20, [x4, #-16]                // ...................*..........

                                            // ------ cycle (expected) ------>
                                            // 0                        25
                                            // |------------------------|-----
        // ldr q10, [x1, #0]                // *..............................
        // ldr q21, [x1, #16]               // ..*............................
        // ldr q31, [x1, #32]               // ....*..........................
        // ldr q12, [x1, #48]               // ......*........................
        // trn1 v30.4S, v31.4S, v12.4S      // ..........*....................
        // ldr q5, [x4], #(6*16)            // ........*......................
        // ldr q9, [x4, #-80]               // ...........*...................
        // ldr q15, [x4, #-64]              // .............*.................
        // ldr q6, [x4, #-48]               // ...............*...............
        // ldr q25, [x4, #-32]              // .................*.............
        // ldr q20, [x4, #-16]              // ...................*...........

        sub count, count, #1
layer4567_start:
                                                // Instructions:    83
                                                // Expected cycles: 94
                                                // Expected IPC:    0.88
                                                //
                                                // Cycle bound:     94.0
                                                // IPC bound:       0.88
                                                //
                                                // Wall time:     3.34s
                                                // User time:     3.34s
                                                //
                                                // ------------------------------------- cycle (expected) -------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|------------------
        trn1 v13.4S, v10.4S, v21.4S             // *.............................................................................................
        trn2 v10.4S, v10.4S, v21.4S             // .*............................................................................................
        trn2 v21.4S, v31.4S, v12.4S             // ..*...........................................................................................
        trn2 v3.2D, v13.2D, v30.2D              // ...*..........................................................................................
        trn1 v13.2D, v13.2D, v30.2D             // ....*.........................................................................................
        trn2 v12.2D, v10.2D, v21.2D             // .....*........................................................................................
        trn1 v10.2D, v10.2D, v21.2D             // ......*.......................................................................................
        sub v21.8H, v3.8H, v12.8H               // .......*......................................................................................
        add v3.8H, v3.8H, v12.8H                // ........*.....................................................................................
        sub v12.8H, v13.8H, v10.8H              // .........*....................................................................................
        add v13.8H, v13.8H, v10.8H              // ..........*...................................................................................
        sqrdmulh v10.8H, v21.8H, v20.8H         // ...........*..................................................................................
        sqrdmulh v6.8H, v12.8H, v6.8H           // ............*.................................................................................
        mul v12.8H, v12.8H, v15.8H              // .............*................................................................................
        mul v21.8H, v21.8H, v25.8H              // ..............*...............................................................................
        sub v30.8H, v13.8H, v3.8H               // ...............*..............................................................................
        add v13.8H, v13.8H, v3.8H               // ................*.............................................................................
        mls v12.8H, v6.8H, v7.H[0]              // .................*............................................................................
        mls v21.8H, v10.8H, v7.H[0]             // ..................*...........................................................................
        sqrdmulh v10.8H, v30.8H, v9.8H          // ...................*..........................................................................
        mul v3.8H, v30.8H, v5.8H                // ....................*.........................................................................
        ldr q6, [x3], #16                       // .....................*........................................................................
        sub v30.8H, v12.8H, v21.8H              // .......................*......................................................................
        mls v3.8H, v10.8H, v7.H[0]              // ........................*.....................................................................
        add v10.8H, v12.8H, v21.8H              // .........................*....................................................................
        sqrdmulh v21.8H, v30.8H, v9.8H          // ..........................*...................................................................
        mul v12.8H, v30.8H, v5.8H               // ...........................*..................................................................
        trn1 v30.4S, v13.4S, v10.4S             // ............................*.................................................................
        trn2 v13.4S, v13.4S, v10.4S             // .............................*................................................................
        ldr q10, [x1, #64]                      // ..............................e...............................................................
        mls v12.8H, v21.8H, v7.H[0]             // ................................*.............................................................
        ldr q21, [x1, #80]                      // .................................e............................................................
        ldr q31, [x1, #96]                      // ...................................e..........................................................
        trn1 v5.4S, v3.4S, v12.4S               // .....................................*........................................................
        trn2 v3.4S, v3.4S, v12.4S               // ......................................*.......................................................
        ldr q12, [x1, #112]                     // .......................................e......................................................
        trn2 v9.2D, v30.2D, v5.2D               // .........................................*....................................................
        trn2 v15.2D, v13.2D, v3.2D              // ..........................................*...................................................
        trn1 v30.2D, v30.2D, v5.2D              // ...........................................*..................................................
        trn1 v13.2D, v13.2D, v3.2D              // ............................................*.................................................
        sub v3.8H, v9.8H, v15.8H                // .............................................*................................................
        sub v5.8H, v30.8H, v13.8H               // ..............................................*...............................................
        add v13.8H, v30.8H, v13.8H              // ...............................................*..............................................
        sqrdmulh v30.8H, v3.8H, v6.H[5]         // ................................................*.............................................
        sqrdmulh v25.8H, v5.8H, v6.H[3]         // .................................................*............................................
        mul v5.8H, v5.8H, v6.H[2]               // ..................................................*...........................................
        mul v3.8H, v3.8H, v6.H[4]               // ...................................................*..........................................
        add v9.8H, v9.8H, v15.8H                // ....................................................*.........................................
        sqdmulh v15.8H, v13.8H, v7.H[1]         // .....................................................*........................................
        mls v5.8H, v25.8H, v7.H[0]              // ......................................................*.......................................
        mls v3.8H, v30.8H, v7.H[0]              // .......................................................*......................................
        sqdmulh v30.8H, v9.8H, v7.H[1]          // ........................................................*.....................................
        srshr v15.8H, v15.8H, #11               // .........................................................*....................................
        sqdmulh v25.8H, v5.8H, v7.H[1]          // ..........................................................*...................................
        sqdmulh v20.8H, v3.8H, v7.H[1]          // ...........................................................*..................................
        mls v13.8H, v15.8H, v7.H[0]             // ............................................................*.................................
        srshr v30.8H, v30.8H, #11               // .............................................................*................................
        srshr v15.8H, v25.8H, #11               // ..............................................................*...............................
        srshr v25.8H, v20.8H, #11               // ...............................................................*..............................
        mls v9.8H, v30.8H, v7.H[0]              // ................................................................*.............................
        mls v5.8H, v15.8H, v7.H[0]              // .................................................................*............................
        mls v3.8H, v25.8H, v7.H[0]              // ..................................................................*...........................
        trn1 v30.4S, v31.4S, v12.4S             // ...................................................................e..........................
        sub v15.8H, v13.8H, v9.8H               // ....................................................................*.........................
        add v13.8H, v13.8H, v9.8H               // .....................................................................*........................
        sub v9.8H, v5.8H, v3.8H                 // ......................................................................*.......................
        sqrdmulh v25.8H, v15.8H, v6.H[1]        // .......................................................................*......................
        mul v15.8H, v15.8H, v6.H[0]             // ........................................................................*.....................
        sqrdmulh v20.8H, v9.8H, v6.H[1]         // .........................................................................*....................
        mul v6.8H, v9.8H, v6.H[0]               // ..........................................................................*...................
        add v3.8H, v5.8H, v3.8H                 // ...........................................................................*..................
        mls v15.8H, v25.8H, v7.H[0]             // ............................................................................*.................
        str q13, [x1], #(64)                    // .............................................................................*................
        mls v6.8H, v20.8H, v7.H[0]              // ..............................................................................*...............
        str q3, [x1, #-48]                      // ...............................................................................*..............
        ldr q5, [x4], #(6*16)                   // ................................................................................e.............
        str q15, [x1, #-32]                     // ..................................................................................*...........
        ldr q9, [x4, #-80]                      // ...................................................................................e..........
        str q6, [x1, #-16]                      // .....................................................................................*........
        ldr q15, [x4, #-64]                     // ......................................................................................e.......
        ldr q6, [x4, #-48]                      // ........................................................................................e.....
        ldr q25, [x4, #-32]                     // ..........................................................................................e...
        ldr q20, [x4, #-16]                     // ............................................................................................e.

                                                      // ----------------------------------------------------------------- cycle (expected) ------------------------------------------------------------------>
                                                      // 0                        25                       50                       75                       100                      125
                                                      // |------------------------|------------------------|------------------------|------------------------|------------------------|------------------------
        // ldr q8, [x1, #(16*0)]                      // e...............................................................'.............................~.......................................................
        // ldr q9, [x1, #(16*1)]                      // ...e............................................................'................................~....................................................
        // ldr q10, [x1, #(16*2)]                     // .....e..........................................................'..................................~..................................................
        // ldr q11, [x1, #(16*3)]                     // .........e......................................................'......................................~..............................................
        // trn1 v25.4s, v8.4s, v9.4s                  // ................................................................*.....................................................................................
        // trn2 v26.4s, v8.4s, v9.4s                  // ................................................................'*....................................................................................
        // trn1 v27.4s, v10.4s, v11.4s                // .....................................e..........................'..................................................................~..................
        // trn2 v28.4s, v10.4s, v11.4s                // ................................................................'.*...................................................................................
        // trn2 v10.2d, v25.2d, v27.2d                // ................................................................'..*..................................................................................
        // trn2 v11.2d, v26.2d, v28.2d                // ................................................................'....*................................................................................
        // trn1 v8.2d, v25.2d, v27.2d                 // ................................................................'...*.................................................................................
        // trn1 v9.2d, v26.2d, v28.2d                 // ................................................................'.....*...............................................................................
        // ldr q0,    [x4], #(6*16)                   // ..................................................e.............'...............................................................................~.....
        // ldr q4, [x4, #(-6*16 + 1*16)]              // .....................................................e..........'..................................................................................~..
        // ldr q1,    [x4, #(-6*16 + 2*16)]           // ........................................................e.......'.....................................................................................
        // ldr q5, [x4, #(-6*16 + 3*16)]              // ..........................................................e.....'.....................................................................................
        // ldr q2,    [x4, #(-6*16 + 4*16)]           // ............................................................e...'.....................................................................................
        // ldr q6, [x4, #(-6*16 + 5*16)]              // ..............................................................e.'.....................................................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ................................................................'........*............................................................................
        // add v8.8h, v8.8h, v9.8h                    // ................................................................'.........*...........................................................................
        // sqrdmulh v27.8h,      v24.8h, v5.8h        // ................................................................'...........*.........................................................................
        // mul      v9.8h, v24.8h, v1.8h              // ................................................................'............*........................................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ................................................................'................*....................................................................
        // sub v24.8h,   v10.8h, v11.8h               // ................................................................'......*..............................................................................
        // add v10.8h, v10.8h, v11.8h                 // ................................................................'.......*.............................................................................
        // sqrdmulh v27.8h,      v24.8h, v6.8h        // ................................................................'..........*..........................................................................
        // mul      v11.8h, v24.8h, v2.8h             // ................................................................'.............*.......................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ................................................................'.................*...................................................................
        // sub v24.8h,   v8.8h, v10.8h                // ................................................................'..............*......................................................................
        // add v8.8h, v8.8h, v10.8h                   // ................................................................'...............*.....................................................................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // ................................................................'..................*..................................................................
        // mul      v10.8h, v24.8h, v0.8h             // ................................................................'...................*.................................................................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ................................................................'.......................*.............................................................
        // sub v24.8h,   v9.8h, v11.8h                // ................................................................'......................*..............................................................
        // add v9.8h, v9.8h, v11.8h                   // ................................................................'........................*............................................................
        // sqrdmulh v27.8h,      v24.8h, v4.8h        // ................................................................'.........................*...........................................................
        // mul      v11.8h, v24.8h, v0.8h             // ................................................................'..........................*..........................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ..~.............................................................'...............................*.....................................................
        // trn1 v25.4s, v8.4s, v9.4s                  // ................................................................'...........................*.........................................................
        // trn2 v26.4s, v8.4s, v9.4s                  // ................................................................'............................*........................................................
        // trn1 v27.4s, v10.4s, v11.4s                // .......~........................................................'....................................*................................................
        // trn2 v28.4s, v10.4s, v11.4s                // ........~.......................................................'.....................................*...............................................
        // trn2 v10.2d, v25.2d, v27.2d                // ...........~....................................................'........................................*............................................
        // trn2 v11.2d, v26.2d, v28.2d                // ............~...................................................'.........................................*...........................................
        // trn1 v8.2d, v25.2d, v27.2d                 // .............~..................................................'..........................................*..........................................
        // trn1 v9.2d, v26.2d, v28.2d                 // ..............~.................................................'...........................................*.........................................
        // ldr q0, [x3], #16                          // ................................................................'....................*................................................................
        // sub v24.8h,   v8.8h, v9.8h                 // ................~...............................................'.............................................*.......................................
        // add v8.8h, v8.8h, v9.8h                    // .................~..............................................'..............................................*......................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ...................~............................................'................................................*....................................
        // mul      v9.8h, v24.8h, v0.h[2]            // ....................~...........................................'.................................................*...................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ........................~.......................................'.....................................................*...............................
        // sub v24.8h,   v10.8h, v11.8h               // ...............~................................................'............................................*........................................
        // add v10.8h, v10.8h, v11.8h                 // ......................~.........................................'...................................................*.................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ..................~.............................................'...............................................*.....................................
        // mul      v11.8h, v24.8h, v0.h[4]           // .....................~..........................................'..................................................*..................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // .........................~......................................'......................................................*..............................
        // sqdmulh v25.8h,    v8.8h, v7.h[1]          // .......................~........................................'....................................................*................................
        // srshr   v25.8h,    v25.8h,    #11          // ...........................~....................................'........................................................*............................
        // mls     v8.8h, v25.8h,    v7.h[0]          // ..............................~.................................'...........................................................*.........................
        // sqdmulh v25.8h,    v10.8h, v7.h[1]         // ..........................~.....................................'.......................................................*.............................
        // srshr   v25.8h,    v25.8h,    #11          // ...............................~................................'............................................................*........................
        // mls     v10.8h, v25.8h,    v7.h[0]         // ..................................~.............................'...............................................................*.....................
        // sqdmulh v25.8h,    v9.8h, v7.h[1]          // ............................~...................................'.........................................................*...........................
        // srshr   v25.8h,    v25.8h,    #11          // ................................~...............................'.............................................................*.......................
        // mls     v9.8h, v25.8h,    v7.h[0]          // ...................................~............................'................................................................*....................
        // sqdmulh v25.8h,    v11.8h, v7.h[1]         // .............................~..................................'..........................................................*..........................
        // srshr   v25.8h,    v25.8h,    #11          // .................................~..............................'..............................................................*......................
        // mls     v11.8h, v25.8h,    v7.h[0]         // ....................................~...........................'.................................................................*...................
        // sub v24.8h,   v8.8h, v10.8h                // ......................................~.........................'...................................................................*.................
        // add v8.8h, v8.8h, v10.8h                   // .......................................~........................'....................................................................*................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // .........................................~......................'......................................................................*..............
        // mul      v10.8h, v24.8h, v0.h[0]           // ..........................................~.....................'.......................................................................*.............
        // mls      v10.8h, v27.8h,      v7.h[0]      // ..............................................~.................'...........................................................................*.........
        // sub v24.8h,   v9.8h, v11.8h                // ........................................~.......................'.....................................................................*...............
        // add v9.8h, v9.8h, v11.8h                   // .............................................~..................'..........................................................................*..........
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................................~....................'........................................................................*............
        // mul      v11.8h, v24.8h, v0.h[0]           // ............................................~...................'.........................................................................*...........
        // mls      v11.8h, v27.8h,      v7.h[0]      // ................................................~...............'.............................................................................*.......
        // str q8, [x1], #(64)                        // ...............................................~................'............................................................................*........
        // str q9, [x1, #(-64 + 16*1)]                // .................................................~..............'..............................................................................*......
        // str q10, [x1, #(-64 + 16*2)]               // ....................................................~...........'.................................................................................*...
        // str q11, [x1, #(-64 + 16*3)]               // .......................................................~........'....................................................................................*

        sub count, count, #1
        cbnz count, layer4567_start
                                                 // Instructions:    72
                                                 // Expected cycles: 79
                                                 // Expected IPC:    0.91
                                                 //
                                                 // Cycle bound:     79.0
                                                 // IPC bound:       0.91
                                                 //
                                                 // Wall time:     9.38s
                                                 // User time:     9.38s
                                                 //
                                                 // ------------------------------ cycle (expected) ------------------------------>
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|---
        trn1 v3.4S, v10.4S, v21.4S               // *..............................................................................
        trn2 v12.4S, v31.4S, v12.4S              // .*.............................................................................
        trn2 v13.4S, v10.4S, v21.4S              // ..*............................................................................
        trn1 v28.2D, v3.2D, v30.2D               // ...*...........................................................................
        trn2 v1.2D, v3.2D, v30.2D                // ....*..........................................................................
        trn2 v31.2D, v13.2D, v12.2D              // .....*.........................................................................
        trn1 v12.2D, v13.2D, v12.2D              // ......*........................................................................
        sub v10.8H, v1.8H, v31.8H                // .......*.......................................................................
        sub v13.8H, v28.8H, v12.8H               // ........*......................................................................
        add v30.8H, v28.8H, v12.8H               // .........*.....................................................................
        mul v21.8H, v10.8H, v25.8H               // ..........*....................................................................
        mul v3.8H, v13.8H, v15.8H                // ...........*...................................................................
        sqrdmulh v13.8H, v13.8H, v6.8H           // ............*..................................................................
        sqrdmulh v10.8H, v10.8H, v20.8H          // .............*.................................................................
        add v31.8H, v1.8H, v31.8H                // ..............*................................................................
        mls v3.8H, v13.8H, v7.H[0]               // ................*..............................................................
        mls v21.8H, v10.8H, v7.H[0]              // .................*.............................................................
        sub v10.8H, v30.8H, v31.8H               // ..................*............................................................
        ldr q15, [x3], #16                       // ...................*...........................................................
        sub v13.8H, v3.8H, v21.8H                // .....................*.........................................................
        sqrdmulh v6.8H, v10.8H, v9.8H            // ......................*........................................................
        mul v12.8H, v10.8H, v5.8H                // .......................*.......................................................
        mul v10.8H, v13.8H, v5.8H                // ........................*......................................................
        sqrdmulh v13.8H, v13.8H, v9.8H           // .........................*.....................................................
        add v3.8H, v3.8H, v21.8H                 // ..........................*....................................................
        add v31.8H, v30.8H, v31.8H               // ...........................*...................................................
        mls v12.8H, v6.8H, v7.H[0]               // ............................*..................................................
        mls v10.8H, v13.8H, v7.H[0]              // .............................*.................................................
        trn1 v30.4S, v31.4S, v3.4S               // ..............................*................................................
        trn2 v21.4S, v31.4S, v3.4S               // ...............................*...............................................
        trn2 v13.4S, v12.4S, v10.4S              // .................................*.............................................
        trn1 v10.4S, v12.4S, v10.4S              // ..................................*............................................
        trn1 v6.2D, v21.2D, v13.2D               // ....................................*..........................................
        trn2 v12.2D, v21.2D, v13.2D              // .....................................*.........................................
        trn1 v31.2D, v30.2D, v10.2D              // ......................................*........................................
        trn2 v30.2D, v30.2D, v10.2D              // .......................................*.......................................
        sub v13.8H, v31.8H, v6.8H                // ........................................*......................................
        add v31.8H, v31.8H, v6.8H                // .........................................*.....................................
        sub v21.8H, v30.8H, v12.8H               // ..........................................*....................................
        sqrdmulh v26.8H, v13.8H, v15.H[3]        // ...........................................*...................................
        mul v2.8H, v13.8H, v15.H[2]              // ............................................*..................................
        mul v9.8H, v21.8H, v15.H[4]              // .............................................*.................................
        sqrdmulh v10.8H, v21.8H, v15.H[5]        // ..............................................*................................
        sqdmulh v3.8H, v31.8H, v7.H[1]           // ...............................................*...............................
        mls v2.8H, v26.8H, v7.H[0]               // ................................................*..............................
        add v12.8H, v30.8H, v12.8H               // .................................................*.............................
        mls v9.8H, v10.8H, v7.H[0]               // ..................................................*............................
        srshr v3.8H, v3.8H, #11                  // ...................................................*...........................
        sqdmulh v10.8H, v12.8H, v7.H[1]          // ....................................................*..........................
        sqdmulh v21.8H, v2.8H, v7.H[1]           // .....................................................*.........................
        sqdmulh v13.8H, v9.8H, v7.H[1]           // ......................................................*........................
        mls v31.8H, v3.8H, v7.H[0]               // .......................................................*.......................
        srshr v10.8H, v10.8H, #11                // ........................................................*......................
        srshr v16.8H, v21.8H, #11                // .........................................................*.....................
        srshr v13.8H, v13.8H, #11                // ..........................................................*....................
        mls v12.8H, v10.8H, v7.H[0]              // ...........................................................*...................
        mls v2.8H, v16.8H, v7.H[0]               // ............................................................*..................
        mls v9.8H, v13.8H, v7.H[0]               // .............................................................*.................
        sub v10.8H, v31.8H, v12.8H               // ...............................................................*...............
        add v6.8H, v31.8H, v12.8H                // ................................................................*..............
        sub v13.8H, v2.8H, v9.8H                 // .................................................................*.............
        mul v3.8H, v10.8H, v15.H[0]              // ..................................................................*............
        sqrdmulh v12.8H, v10.8H, v15.H[1]        // ...................................................................*...........
        mul v10.8H, v13.8H, v15.H[0]             // ....................................................................*..........
        sqrdmulh v21.8H, v13.8H, v15.H[1]        // .....................................................................*.........
        add v13.8H, v2.8H, v9.8H                 // ......................................................................*........
        mls v3.8H, v12.8H, v7.H[0]               // .......................................................................*.......
        str q6, [x1], #(64)                      // ........................................................................*......
        mls v10.8H, v21.8H, v7.H[0]              // .........................................................................*.....
        str q13, [x1, #-48]                      // ..........................................................................*....
        str q3, [x1, #-32]                       // ............................................................................*..
        str q10, [x1, #-16]                      // ..............................................................................*

                                                 // ------------------------------ cycle (expected) ------------------------------>
                                                 // 0                        25                       50                       75
                                                 // |------------------------|------------------------|------------------------|---
        // trn1 v13.4S, v10.4S, v21.4S           // *..............................................................................
        // trn2 v10.4S, v10.4S, v21.4S           // ..*............................................................................
        // trn2 v21.4S, v31.4S, v12.4S           // .*.............................................................................
        // trn2 v3.2D, v13.2D, v30.2D            // ....*..........................................................................
        // trn1 v13.2D, v13.2D, v30.2D           // ...*...........................................................................
        // trn2 v12.2D, v10.2D, v21.2D           // .....*.........................................................................
        // trn1 v10.2D, v10.2D, v21.2D           // ......*........................................................................
        // sub v21.8H, v3.8H, v12.8H             // .......*.......................................................................
        // add v3.8H, v3.8H, v12.8H              // ..............*................................................................
        // sub v12.8H, v13.8H, v10.8H            // ........*......................................................................
        // add v13.8H, v13.8H, v10.8H            // .........*.....................................................................
        // sqrdmulh v10.8H, v21.8H, v20.8H       // .............*.................................................................
        // sqrdmulh v6.8H, v12.8H, v6.8H         // ............*..................................................................
        // mul v12.8H, v12.8H, v15.8H            // ...........*...................................................................
        // mul v21.8H, v21.8H, v25.8H            // ..........*....................................................................
        // sub v30.8H, v13.8H, v3.8H             // ..................*............................................................
        // add v13.8H, v13.8H, v3.8H             // ...........................*...................................................
        // mls v12.8H, v6.8H, v7.H[0]            // ................*..............................................................
        // mls v21.8H, v10.8H, v7.H[0]           // .................*.............................................................
        // sqrdmulh v10.8H, v30.8H, v9.8H        // ......................*........................................................
        // mul v3.8H, v30.8H, v5.8H              // .......................*.......................................................
        // ldr q6, [x3], #16                     // ...................*...........................................................
        // sub v30.8H, v12.8H, v21.8H            // .....................*.........................................................
        // mls v3.8H, v10.8H, v7.H[0]            // ............................*..................................................
        // add v10.8H, v12.8H, v21.8H            // ..........................*....................................................
        // sqrdmulh v21.8H, v30.8H, v9.8H        // .........................*.....................................................
        // mul v12.8H, v30.8H, v5.8H             // ........................*......................................................
        // trn1 v30.4S, v13.4S, v10.4S           // ..............................*................................................
        // trn2 v13.4S, v13.4S, v10.4S           // ...............................*...............................................
        // mls v12.8H, v21.8H, v7.H[0]           // .............................*.................................................
        // trn1 v5.4S, v3.4S, v12.4S             // ..................................*............................................
        // trn2 v3.4S, v3.4S, v12.4S             // .................................*.............................................
        // trn2 v9.2D, v30.2D, v5.2D             // .......................................*.......................................
        // trn2 v15.2D, v13.2D, v3.2D            // .....................................*.........................................
        // trn1 v30.2D, v30.2D, v5.2D            // ......................................*........................................
        // trn1 v13.2D, v13.2D, v3.2D            // ....................................*..........................................
        // sub v3.8H, v9.8H, v15.8H              // ..........................................*....................................
        // sub v5.8H, v30.8H, v13.8H             // ........................................*......................................
        // add v13.8H, v30.8H, v13.8H            // .........................................*.....................................
        // sqrdmulh v30.8H, v3.8H, v6.H[5]       // ..............................................*................................
        // sqrdmulh v25.8H, v5.8H, v6.H[3]       // ...........................................*...................................
        // mul v5.8H, v5.8H, v6.H[2]             // ............................................*..................................
        // mul v3.8H, v3.8H, v6.H[4]             // .............................................*.................................
        // add v9.8H, v9.8H, v15.8H              // .................................................*.............................
        // sqdmulh v15.8H, v13.8H, v7.H[1]       // ...............................................*...............................
        // mls v5.8H, v25.8H, v7.H[0]            // ................................................*..............................
        // mls v3.8H, v30.8H, v7.H[0]            // ..................................................*............................
        // sqdmulh v30.8H, v9.8H, v7.H[1]        // ....................................................*..........................
        // srshr v15.8H, v15.8H, #11             // ...................................................*...........................
        // sqdmulh v25.8H, v5.8H, v7.H[1]        // .....................................................*.........................
        // sqdmulh v20.8H, v3.8H, v7.H[1]        // ......................................................*........................
        // mls v13.8H, v15.8H, v7.H[0]           // .......................................................*.......................
        // srshr v30.8H, v30.8H, #11             // ........................................................*......................
        // srshr v15.8H, v25.8H, #11             // .........................................................*.....................
        // srshr v25.8H, v20.8H, #11             // ..........................................................*....................
        // mls v9.8H, v30.8H, v7.H[0]            // ...........................................................*...................
        // mls v5.8H, v15.8H, v7.H[0]            // ............................................................*..................
        // mls v3.8H, v25.8H, v7.H[0]            // .............................................................*.................
        // sub v15.8H, v13.8H, v9.8H             // ...............................................................*...............
        // add v13.8H, v13.8H, v9.8H             // ................................................................*..............
        // sub v9.8H, v5.8H, v3.8H               // .................................................................*.............
        // sqrdmulh v25.8H, v15.8H, v6.H[1]      // ...................................................................*...........
        // mul v15.8H, v15.8H, v6.H[0]           // ..................................................................*............
        // sqrdmulh v20.8H, v9.8H, v6.H[1]       // .....................................................................*.........
        // mul v6.8H, v9.8H, v6.H[0]             // ....................................................................*..........
        // add v3.8H, v5.8H, v3.8H               // ......................................................................*........
        // mls v15.8H, v25.8H, v7.H[0]           // .......................................................................*.......
        // str q13, [x1], #(64)                  // ........................................................................*......
        // mls v6.8H, v20.8H, v7.H[0]            // .........................................................................*.....
        // str q3, [x1, #-48]                    // ..........................................................................*....
        // str q15, [x1, #-32]                   // ............................................................................*..
        // str q6, [x1, #-16]                    // ..............................................................................*


        // ---------------------------------------------------------------------

        mov count, #4
        ASM_LOAD(r_ptr0, roots_l012)
        load_roots_123

        .p2align 2

                                          // Instructions:    12
                                          // Expected cycles: 19
                                          // Expected IPC:    0.63
                                          //
                                          // Cycle bound:     19.0
                                          // IPC bound:       0.63
                                          //
                                          // Wall time:     0.01s
                                          // User time:     0.01s
                                          //
                                          // ----- cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|----
        ldr q31, [x0, #256]               // *.............................
        ldr q5, [x0, #320]                // ..*...........................
        ldr q30, [x0, #128]               // ....*.........................
        add v25.8H, v31.8H, v5.8H         // ......*.......................
        ldr q9, [x0, #384]                // .......*......................
        ldr q15, [x0, #448]               // .........*....................
        ldr q12, [x0, #192]               // ...........*..................
        add v20.8H, v9.8H, v15.8H         // .............*................
        ldr q3, [x0, #0]                  // ..............*...............
        add v27.8H, v30.8H, v12.8H        // ................*.............
        add v24.8H, v25.8H, v20.8H        // .................*............
        ldr q6, [x0, #64]                 // ..................*...........

                                           // ------ cycle (expected) ------>
                                           // 0                        25
                                           // |------------------------|-----
        // ldr q3, [x0, #0]                // ..............*................
        // ldr q6, [x0, #64]               // ..................*............
        // ldr q30, [x0, #128]             // ....*..........................
        // ldr q12, [x0, #192]             // ...........*...................
        // ldr q31, [x0, #256]             // *..............................
        // ldr q5, [x0, #320]              // ..*............................
        // ldr q9, [x0, #384]              // .......*.......................
        // ldr q15, [x0, #448]             // .........*.....................
        // add v25.8H, v31.8H, v5.8H       // ......*........................
        // add v20.8H, v9.8H, v15.8H       // .............*.................
        // add v27.8H, v30.8H, v12.8H      // ................*..............
        // add v24.8H, v25.8H, v20.8H      // .................*.............

        sub count, count, #1
layer123_start:
                                                // Instructions:    76
                                                // Expected cycles: 84
                                                // Expected IPC:    0.90
                                                //
                                                // Cycle bound:     84.0
                                                // IPC bound:       0.90
                                                //
                                                // Wall time:     2.64s
                                                // User time:     2.64s
                                                //
                                                // -------------------------------- cycle (expected) --------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------
        sub v13.8H, v3.8H, v6.8H                // *...................................................................................
        add v10.8H, v3.8H, v6.8H                // .*..................................................................................
        sub v21.8H, v30.8H, v12.8H              // ..*.................................................................................
        sqrdmulh v3.8H, v13.8H, v0.H[7]         // ...*................................................................................
        mul v13.8H, v13.8H, v0.H[6]             // ....*...............................................................................
        sub v12.8H, v10.8H, v27.8H              // .....*..............................................................................
        add v10.8H, v10.8H, v27.8H              // ......*.............................................................................
        sqrdmulh v6.8H, v21.8H, v1.H[1]         // .......*............................................................................
        mul v21.8H, v21.8H, v1.H[0]             // ........*...........................................................................
        mls v13.8H, v3.8H, v7.H[0]              // .........*..........................................................................
        sub v3.8H, v31.8H, v5.8H                // ..........*.........................................................................
        sqrdmulh v30.8H, v12.8H, v0.H[3]        // ...........*........................................................................
        mul v12.8H, v12.8H, v0.H[2]             // ............*.......................................................................
        sub v31.8H, v10.8H, v24.8H              // .............*......................................................................
        add v10.8H, v10.8H, v24.8H              // ..............*.....................................................................
        mls v21.8H, v6.8H, v7.H[0]              // ...............*....................................................................
        sqrdmulh v6.8H, v3.8H, v1.H[3]          // ................*...................................................................
        mul v3.8H, v3.8H, v1.H[2]               // .................*..................................................................
        sub v5.8H, v9.8H, v15.8H                // ..................*.................................................................
        sub v9.8H, v13.8H, v21.8H               // ...................*................................................................
        add v13.8H, v13.8H, v21.8H              // ....................*...............................................................
        mls v3.8H, v6.8H, v7.H[0]               // .....................*..............................................................
        sqrdmulh v21.8H, v5.8H, v1.H[5]         // ......................*.............................................................
        mls v12.8H, v30.8H, v7.H[0]             // .......................*............................................................
        mul v6.8H, v5.8H, v1.H[4]               // ........................*...........................................................
        sqrdmulh v30.8H, v9.8H, v0.H[3]         // .........................*..........................................................
        mul v5.8H, v9.8H, v0.H[2]               // ..........................*.........................................................
        sqrdmulh v9.8H, v31.8H, v0.H[1]         // ...........................*........................................................
        mul v31.8H, v31.8H, v0.H[0]             // ............................*.......................................................
        str q10, [x0], #(16)                    // .............................*......................................................
        mls v6.8H, v21.8H, v7.H[0]              // ..............................*.....................................................
        mls v5.8H, v30.8H, v7.H[0]              // ...............................*....................................................
        sub v10.8H, v25.8H, v20.8H              // ................................*...................................................
        mls v31.8H, v9.8H, v7.H[0]              // .................................*..................................................
        sub v21.8H, v3.8H, v6.8H                // ..................................*.................................................
        sqrdmulh v30.8H, v10.8H, v0.H[5]        // ...................................*................................................
        mul v10.8H, v10.8H, v0.H[4]             // ....................................*...............................................
        add v3.8H, v3.8H, v6.8H                 // .....................................*..............................................
        sqrdmulh v6.8H, v21.8H, v0.H[5]         // ......................................*.............................................
        mul v21.8H, v21.8H, v0.H[4]             // .......................................*............................................
        mls v10.8H, v30.8H, v7.H[0]             // ........................................*...........................................
        sub v30.8H, v13.8H, v3.8H               // .........................................*..........................................
        add v13.8H, v13.8H, v3.8H               // ..........................................*.........................................
        mls v21.8H, v6.8H, v7.H[0]              // ...........................................*........................................
        sqrdmulh v3.8H, v30.8H, v0.H[1]         // ............................................*.......................................
        mul v6.8H, v30.8H, v0.H[0]              // .............................................*......................................
        sub v30.8H, v12.8H, v10.8H              // ..............................................*.....................................
        add v10.8H, v12.8H, v10.8H              // ...............................................*....................................
        sub v12.8H, v5.8H, v21.8H               // ................................................*...................................
        mls v6.8H, v3.8H, v7.H[0]               // .................................................*..................................
        sqrdmulh v3.8H, v30.8H, v0.H[1]         // ..................................................*.................................
        mul v30.8H, v30.8H, v0.H[0]             // ...................................................*................................
        add v21.8H, v5.8H, v21.8H               // ....................................................*...............................
        sqrdmulh v5.8H, v12.8H, v0.H[1]         // .....................................................*..............................
        mul v12.8H, v12.8H, v0.H[0]             // ......................................................*.............................
        mls v30.8H, v3.8H, v7.H[0]              // .......................................................*............................
        str q31, [x0, #240]                     // ........................................................*...........................
        ldr q3, [x0, #0]                        // .........................................................e..........................
        mls v12.8H, v5.8H, v7.H[0]              // ...........................................................*........................
        str q6, [x0, #304]                      // ............................................................*.......................
        ldr q6, [x0, #64]                       // .............................................................e......................
        str q30, [x0, #368]                     // ...............................................................*....................
        ldr q30, [x0, #128]                     // ................................................................e...................
        str q12, [x0, #432]                     // ..................................................................*.................
        ldr q12, [x0, #192]                     // ...................................................................e................
        str q13, [x0, #48]                      // .....................................................................*..............
        ldr q31, [x0, #256]                     // ......................................................................e.............
        ldr q5, [x0, #320]                      // ........................................................................e...........
        ldr q9, [x0, #384]                      // ..........................................................................e.........
        ldr q15, [x0, #448]                     // ............................................................................e.......
        str q10, [x0, #112]                     // ..............................................................................*.....
        add v25.8H, v31.8H, v5.8H               // ...............................................................................e....
        add v20.8H, v9.8H, v15.8H               // ................................................................................e...
        str q21, [x0, #176]                     // .................................................................................*..
        add v27.8H, v30.8H, v12.8H              // ..................................................................................e.
        add v24.8H, v25.8H, v20.8H              // ...................................................................................e

                                                      // --------------------------------------------- cycle (expected) --------------------------------------------->
                                                      // 0                        25                       50                       75                       100
                                                      // |------------------------|------------------------|------------------------|------------------------|--------
        // ldr q8, [x0, #0]                           // e..........................'........................................................~........................
        // ldr q9, [x0, #(1*(512/8))]                 // ....e......................'............................................................~....................
        // ldr q10, [x0, #(2*(512/8))]                // .......e...................'...............................................................~.................
        // ldr q11, [x0, #(3*(512/8))]                // ..........e................'..................................................................~..............
        // ldr q12, [x0, #(4*(512/8))]                // .............e.............'.....................................................................~...........
        // ldr q13, [x0, #(5*(512/8))]                // ...............e...........'.......................................................................~.........
        // ldr q14, [x0, #(6*(512/8))]                // .................e.........'.........................................................................~.......
        // ldr q15, [x0, #(7*(512/8))]                // ...................e.......'...........................................................................~.....
        // sub v24.8h,   v8.8h, v9.8h                 // ...........................*.................................................................................
        // add v8.8h, v8.8h, v9.8h                    // ...........................'*................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[7]      // ...........................'..*..............................................................................
        // mul      v9.8h, v24.8h, v0.h[6]            // ...........................'...*.............................................................................
        // mls      v9.8h, v27.8h,      v7.h[0]       // ...........................'........*........................................................................
        // sub v24.8h,   v10.8h, v11.8h               // ...........................'.*...............................................................................
        // add v10.8h, v10.8h, v11.8h                 // .........................e.'.................................................................................
        // sqrdmulh v27.8h,      v24.8h, v1.h[1]      // ...........................'......*..........................................................................
        // mul      v11.8h, v24.8h, v1.h[0]           // ...........................'.......*.........................................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ...........................'..............*..................................................................
        // sub v24.8h,   v12.8h, v13.8h               // ...........................'.........*.......................................................................
        // add v12.8h, v12.8h, v13.8h                 // ......................e....'..............................................................................~..
        // sqrdmulh v27.8h,      v24.8h, v1.h[3]      // ...........................'...............*.................................................................
        // mul      v13.8h, v24.8h, v1.h[2]           // ...........................'................*................................................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ...........................'....................*............................................................
        // sub v24.8h,   v14.8h, v15.8h               // ...........................'.................*...............................................................
        // add v14.8h, v14.8h, v15.8h                 // .......................e...'...............................................................................~.
        // sqrdmulh v27.8h,      v24.8h, v1.h[5]      // ...........................'.....................*...........................................................
        // mul      v15.8h, v24.8h, v1.h[4]           // ...........................'.......................*.........................................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ...........................'.............................*...................................................
        // sub v24.8h,   v8.8h, v10.8h                // ...........................'....*............................................................................
        // add v8.8h, v8.8h, v10.8h                   // ...........................'.....*...........................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ...........................'..........*......................................................................
        // mul      v10.8h, v24.8h, v0.h[2]           // ...........................'...........*.....................................................................
        // mls      v10.8h, v27.8h,      v7.h[0]      // ...........................'......................*..........................................................
        // sub v24.8h,   v9.8h, v11.8h                // ...........................'..................*..............................................................
        // add v9.8h, v9.8h, v11.8h                   // ...........................'...................*.............................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[3]      // ...........................'........................*........................................................
        // mul      v11.8h, v24.8h, v0.h[2]           // ...........................'.........................*.......................................................
        // mls      v11.8h, v27.8h,      v7.h[0]      // ...........................'..............................*..................................................
        // sub v24.8h,   v12.8h, v14.8h               // ...........................'...............................*.................................................
        // add v12.8h, v12.8h, v14.8h                 // ..........................e'.................................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ...........................'..................................*..............................................
        // mul      v14.8h, v24.8h, v0.h[4]           // ...........................'...................................*.............................................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ...........................'.......................................*.........................................
        // sub v24.8h,   v13.8h, v15.8h               // ...........................'.................................*...............................................
        // add v13.8h, v13.8h, v15.8h                 // ...........................'....................................*............................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[5]      // ...........................'.....................................*...........................................
        // mul      v15.8h, v24.8h, v0.h[4]           // ...........................'......................................*..........................................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ...........................'..........................................*......................................
        // sub v24.8h,   v8.8h, v12.8h                // ...........................'............*....................................................................
        // add v8.8h, v8.8h, v12.8h                   // ...........................'.............*...................................................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................'..........................*......................................................
        // mul      v12.8h, v24.8h, v0.h[0]           // ...........................'...........................*.....................................................
        // mls      v12.8h, v27.8h,      v7.h[0]      // ...........................'................................*................................................
        // sub v24.8h,   v9.8h, v13.8h                // ...........................'........................................*........................................
        // add v9.8h, v9.8h, v13.8h                   // ...........................'.........................................*.......................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................'...........................................*.....................................
        // mul      v13.8h, v24.8h, v0.h[0]           // ...........................'............................................*....................................
        // mls      v13.8h, v27.8h,      v7.h[0]      // ...........................'................................................*................................
        // sub v24.8h,   v10.8h, v14.8h               // ...........................'.............................................*...................................
        // add v10.8h, v10.8h, v14.8h                 // ...........................'..............................................*..................................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................'.................................................*...............................
        // mul      v14.8h, v24.8h, v0.h[0]           // ...........................'..................................................*..............................
        // mls      v14.8h, v27.8h,      v7.h[0]      // ...........................'......................................................*..........................
        // sub v24.8h,   v11.8h, v15.8h               // ...........................'...............................................*.................................
        // add v11.8h, v11.8h, v15.8h                 // ...........................'...................................................*.............................
        // sqrdmulh v27.8h,      v24.8h, v0.h[1]      // ...........................'....................................................*............................
        // mul      v15.8h, v24.8h, v0.h[0]           // ...........................'.....................................................*...........................
        // mls      v15.8h, v27.8h,      v7.h[0]      // ..~........................'..........................................................*......................
        // str q12, [x0, #(4*(512/8))]                // ...........................'.......................................................*.........................
        // str q13, [x0, #(5*(512/8))]                // ...~.......................'...........................................................*.....................
        // str q14, [x0, #(6*(512/8))]                // ......~....................'..............................................................*..................
        // str q15, [x0, #(7*(512/8))]                // .........~.................'.................................................................*...............
        // str q8, [x0], #(16)                        // ...........................'............................*....................................................
        // str q9, [x0, #(-16 + 1*(512/8))]           // ............~..............'....................................................................*............
        // str q10, [x0, #(-16 + 2*(512/8))]          // .....................~.....'.............................................................................*...
        // str q11, [x0, #(-16 + 3*(512/8))]          // ........................~..'................................................................................*

        sub count, count, #1
        cbnz count, layer123_start
                                                // Instructions:    64
                                                // Expected cycles: 66
                                                // Expected IPC:    0.97
                                                //
                                                // Cycle bound:     66.0
                                                // IPC bound:       0.97
                                                //
                                                // Wall time:     8.20s
                                                // User time:     8.20s
                                                //
                                                // ----------------------- cycle (expected) ------------------------>
                                                // 0                        25                       50
                                                // |------------------------|------------------------|---------------
        add v14.8H, v3.8H, v6.8H                // *.................................................................
        sub v13.8H, v25.8H, v20.8H              // .*................................................................
        sub v3.8H, v3.8H, v6.8H                 // ..*...............................................................
        sub v29.8H, v14.8H, v27.8H              // ...*..............................................................
        mul v28.8H, v13.8H, v0.H[4]             // ....*.............................................................
        sqrdmulh v10.8H, v13.8H, v0.H[5]        // .....*............................................................
        sqrdmulh v13.8H, v29.8H, v0.H[3]        // ......*...........................................................
        mul v20.8H, v29.8H, v0.H[2]             // .......*..........................................................
        sub v19.8H, v30.8H, v12.8H              // ........*.........................................................
        sqrdmulh v29.8H, v3.8H, v0.H[7]         // .........*........................................................
        mls v28.8H, v10.8H, v7.H[0]             // ..........*.......................................................
        mls v20.8H, v13.8H, v7.H[0]             // ...........*......................................................
        sqrdmulh v22.8H, v19.8H, v1.H[1]        // ............*.....................................................
        mul v23.8H, v19.8H, v1.H[0]             // .............*....................................................
        mul v6.8H, v3.8H, v0.H[6]               // ..............*...................................................
        sub v13.8H, v20.8H, v28.8H              // ...............*..................................................
        sub v15.8H, v9.8H, v15.8H               // ................*.................................................
        mls v23.8H, v22.8H, v7.H[0]             // .................*................................................
        sqrdmulh v10.8H, v13.8H, v0.H[1]        // ..................*...............................................
        mul v13.8H, v13.8H, v0.H[0]             // ...................*..............................................
        mls v6.8H, v29.8H, v7.H[0]              // ....................*.............................................
        sqrdmulh v21.8H, v15.8H, v1.H[5]        // .....................*............................................
        mul v15.8H, v15.8H, v1.H[4]             // ......................*...........................................
        mls v13.8H, v10.8H, v7.H[0]             // .......................*..........................................
        sub v16.8H, v6.8H, v23.8H               // ........................*.........................................
        sub v25.8H, v31.8H, v5.8H               // .........................*........................................
        mls v15.8H, v21.8H, v7.H[0]             // ..........................*.......................................
        mul v30.8H, v16.8H, v0.H[2]             // ...........................*......................................
        sqrdmulh v21.8H, v16.8H, v0.H[3]        // ............................*.....................................
        sqrdmulh v5.8H, v25.8H, v1.H[3]         // .............................*....................................
        add v27.8H, v14.8H, v27.8H              // ..............................*...................................
        mul v25.8H, v25.8H, v1.H[2]             // ...............................*..................................
        mls v30.8H, v21.8H, v7.H[0]             // ................................*.................................
        sub v3.8H, v27.8H, v24.8H               // .................................*................................
        str q13, [x0, #384]                     // ..................................*...............................
        mls v25.8H, v5.8H, v7.H[0]              // ...................................*..............................
        sqrdmulh v12.8H, v3.8H, v0.H[1]         // ....................................*.............................
        mul v31.8H, v3.8H, v0.H[0]              // .....................................*............................
        add v5.8H, v6.8H, v23.8H                // ......................................*...........................
        add v10.8H, v25.8H, v15.8H              // .......................................*..........................
        sub v6.8H, v25.8H, v15.8H               // ........................................*.........................
        mls v31.8H, v12.8H, v7.H[0]             // .........................................*........................
        add v9.8H, v5.8H, v10.8H                // ..........................................*.......................
        mul v21.8H, v6.8H, v0.H[4]              // ...........................................*......................
        sqrdmulh v6.8H, v6.8H, v0.H[5]          // ............................................*.....................
        str q31, [x0, #256]                     // .............................................*....................
        sub v22.8H, v5.8H, v10.8H               // ..............................................*...................
        str q9, [x0, #64]                       // ...............................................*..................
        mls v21.8H, v6.8H, v7.H[0]              // ................................................*.................
        sqrdmulh v6.8H, v22.8H, v0.H[1]         // .................................................*................
        mul v3.8H, v22.8H, v0.H[0]              // ..................................................*...............
        add v12.8H, v20.8H, v28.8H              // ...................................................*..............
        sub v13.8H, v30.8H, v21.8H              // ....................................................*.............
        add v21.8H, v30.8H, v21.8H              // .....................................................*............
        mls v3.8H, v6.8H, v7.H[0]               // ......................................................*...........
        sqrdmulh v10.8H, v13.8H, v0.H[1]        // .......................................................*..........
        mul v13.8H, v13.8H, v0.H[0]             // ........................................................*.........
        str q21, [x0, #192]                     // .........................................................*........
        add v6.8H, v27.8H, v24.8H               // ..........................................................*.......
        str q3, [x0, #320]                      // ...........................................................*......
        mls v13.8H, v10.8H, v7.H[0]             // ............................................................*.....
        str q6, [x0], #(16)                     // .............................................................*....
        str q12, [x0, #112]                     // ...............................................................*..
        str q13, [x0, #432]                     // .................................................................*

                                                 // ----------------------- cycle (expected) ------------------------>
                                                 // 0                        25                       50
                                                 // |------------------------|------------------------|---------------
        // sub v13.8H, v3.8H, v6.8H              // ..*...............................................................
        // add v10.8H, v3.8H, v6.8H              // *.................................................................
        // sub v21.8H, v30.8H, v12.8H            // ........*.........................................................
        // sqrdmulh v3.8H, v13.8H, v0.H[7]       // .........*........................................................
        // mul v13.8H, v13.8H, v0.H[6]           // ..............*...................................................
        // sub v12.8H, v10.8H, v27.8H            // ...*..............................................................
        // add v10.8H, v10.8H, v27.8H            // ..............................*...................................
        // sqrdmulh v6.8H, v21.8H, v1.H[1]       // ............*.....................................................
        // mul v21.8H, v21.8H, v1.H[0]           // .............*....................................................
        // mls v13.8H, v3.8H, v7.H[0]            // ....................*.............................................
        // sub v3.8H, v31.8H, v5.8H              // .........................*........................................
        // sqrdmulh v30.8H, v12.8H, v0.H[3]      // ......*...........................................................
        // mul v12.8H, v12.8H, v0.H[2]           // .......*..........................................................
        // sub v31.8H, v10.8H, v24.8H            // .................................*................................
        // add v10.8H, v10.8H, v24.8H            // ..........................................................*.......
        // mls v21.8H, v6.8H, v7.H[0]            // .................*................................................
        // sqrdmulh v6.8H, v3.8H, v1.H[3]        // .............................*....................................
        // mul v3.8H, v3.8H, v1.H[2]             // ...............................*..................................
        // sub v5.8H, v9.8H, v15.8H              // ................*.................................................
        // sub v9.8H, v13.8H, v21.8H             // ........................*.........................................
        // add v13.8H, v13.8H, v21.8H            // ......................................*...........................
        // mls v3.8H, v6.8H, v7.H[0]             // ...................................*..............................
        // sqrdmulh v21.8H, v5.8H, v1.H[5]       // .....................*............................................
        // mls v12.8H, v30.8H, v7.H[0]           // ...........*......................................................
        // mul v6.8H, v5.8H, v1.H[4]             // ......................*...........................................
        // sqrdmulh v30.8H, v9.8H, v0.H[3]       // ............................*.....................................
        // mul v5.8H, v9.8H, v0.H[2]             // ...........................*......................................
        // sqrdmulh v9.8H, v31.8H, v0.H[1]       // ....................................*.............................
        // mul v31.8H, v31.8H, v0.H[0]           // .....................................*............................
        // str q10, [x0], #(16)                  // .............................................................*....
        // mls v6.8H, v21.8H, v7.H[0]            // ..........................*.......................................
        // mls v5.8H, v30.8H, v7.H[0]            // ................................*.................................
        // sub v10.8H, v25.8H, v20.8H            // .*................................................................
        // mls v31.8H, v9.8H, v7.H[0]            // .........................................*........................
        // sub v21.8H, v3.8H, v6.8H              // ........................................*.........................
        // sqrdmulh v30.8H, v10.8H, v0.H[5]      // .....*............................................................
        // mul v10.8H, v10.8H, v0.H[4]           // ....*.............................................................
        // add v3.8H, v3.8H, v6.8H               // .......................................*..........................
        // sqrdmulh v6.8H, v21.8H, v0.H[5]       // ............................................*.....................
        // mul v21.8H, v21.8H, v0.H[4]           // ...........................................*......................
        // mls v10.8H, v30.8H, v7.H[0]           // ..........*.......................................................
        // sub v30.8H, v13.8H, v3.8H             // ..............................................*...................
        // add v13.8H, v13.8H, v3.8H             // ..........................................*.......................
        // mls v21.8H, v6.8H, v7.H[0]            // ................................................*.................
        // sqrdmulh v3.8H, v30.8H, v0.H[1]       // .................................................*................
        // mul v6.8H, v30.8H, v0.H[0]            // ..................................................*...............
        // sub v30.8H, v12.8H, v10.8H            // ...............*..................................................
        // add v10.8H, v12.8H, v10.8H            // ...................................................*..............
        // sub v12.8H, v5.8H, v21.8H             // ....................................................*.............
        // mls v6.8H, v3.8H, v7.H[0]             // ......................................................*...........
        // sqrdmulh v3.8H, v30.8H, v0.H[1]       // ..................*...............................................
        // mul v30.8H, v30.8H, v0.H[0]           // ...................*..............................................
        // add v21.8H, v5.8H, v21.8H             // .....................................................*............
        // sqrdmulh v5.8H, v12.8H, v0.H[1]       // .......................................................*..........
        // mul v12.8H, v12.8H, v0.H[0]           // ........................................................*.........
        // mls v30.8H, v3.8H, v7.H[0]            // .......................*..........................................
        // str q31, [x0, #240]                   // .............................................*....................
        // mls v12.8H, v5.8H, v7.H[0]            // ............................................................*.....
        // str q6, [x0, #304]                    // ...........................................................*......
        // str q30, [x0, #368]                   // ..................................*...............................
        // str q12, [x0, #432]                   // .................................................................*
        // str q13, [x0, #48]                    // ...............................................*..................
        // str q10, [x0, #112]                   // ...............................................................*..
        // str q21, [x0, #176]                   // .........................................................*........


        pop_stack
        ret

#endif /* MLKEM_USE_NATIVE_AARCH64 */
