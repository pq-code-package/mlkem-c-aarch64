// SPDX-License-Identifier: Apache-2.0

// AArch64 re-implementation of the asymmetric base multiplication from:

// Neon NTT: Faster Dilithium, Kyber, and Saber on Cortex-A72 and Apple M1
// https:   // eprint.iacr.org/2021/986
// https:   // github.com/neon-ntt/neon-ntt

#include "config.h"
#if defined(MLKEM_USE_NATIVE_AARCH64)

#include "params.h"

// Needed to provide ASM_LOAD directive
#include "common.i"

// Input:
// - Vectors al, ah of 32-bit entries
// Output:
// - Montgomery reductions of al || ah, stored in al
.macro montgomery_reduce_long x, a
        uzp1   t0.8h, \a\()l.8h, \a\()h.8h
        mul    t0.8h, t0.8h, consts.h[2]
        smlal  \a\()l.4s, t0.4h, constN.4h
        smlal2 \a\()h.4s, t0.8h, constN.8h
        uzp2   \x\().8h, \a\()l.8h, \a\()h.8h
.endm

// Computes products (a0*b0 + a0*b0t, a0*b1 + a1*b0) in 32-bit.
.macro pmull d, a, b
        smull  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smull2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smull  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smull2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro pmlal d, a, b
        smlal  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smlal2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smlal  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smlal2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro load_polys a, b, a_ptr, b_ptr, b_cache_ptr
        ld2 {\a\()0.8h, \a\()1.8h}, [\a_ptr],       #32
        ld2 {\b\()0.8h, \b\()1.8h}, [\b_ptr],       #32
        ld1 {\b\()1t.8h},           [\b_cache_ptr], #16
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

        out          .req x0
        a0_ptr       .req x1
        b0_ptr       .req x2
        b0_cache_ptr .req x3
        a1_ptr       .req x4
        b1_ptr       .req x5
        b1_cache_ptr .req x6
        a2_ptr       .req x7
        b2_ptr       .req x8
        b2_cache_ptr .req x9
        a3_ptr       .req x10
        b3_ptr       .req x11
        b3_cache_ptr .req x12

        count        .req x13
        xtmp         .req x14
        modulus      .req w15

        constN    .req v0
        constX    .req v1
        consts    .req v2

        aa0      .req v3
        aa1      .req v4
        bb0      .req v5
        bb1      .req v6
        bb1t     .req v7

        res0l   .req v8
        res1l   .req v9
        res0h   .req v10
        res1h   .req v11

        tmp0 .req v12
        tmp1 .req v13
        q_tmp0 .req q12
        q_tmp1 .req q13

        out0 .req v26
        out1 .req v27

        t0   .req v28

.p2align 4
const_addr:
        .short 3329
        .short 20159
        .short 3327
        .short 0
        .short 0
        .short 0
        .short 0
        .short 0

#if KYBER_K == 2

.global polyvec_basemul_acc_montgomery_cached_asm_k2_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k2_opt

polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)

        mov count, #(KYBER_N / 16)
                                               // Instructions:    6
                                               // Expected cycles: 11
                                               // Expected IPC:    0.55

                                               // Cycle bound:     11.0
                                               // IPC bound:       0.55

                                               // Wall time:     0.01s
                                               // User time:     0.01s

                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        ld2 {v6.8H, v7.8H}, [x1], #32          // *.............................
        ld2 {v4.8H, v5.8H}, [x2], #32          // ..*...........................
        ld1 {v12.8H}, [x3], #16                // ....*.........................
        ld2 {v15.8H, v16.8H}, [x4], #32        // ......*.......................
        ld2 {v29.8H, v30.8H}, [x5], #32        // ........*.....................
        ld1 {v31.8H}, [x6], #16                // ..........*...................

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ld2 {v6.8H, v7.8H}, [x1], #32          // *..............................
        // ld2 {v4.8H, v5.8H}, [x2], #32          // ..*............................
        // ld1 {v12.8H}, [x3], #16                // ....*..........................
        // ld2 {v15.8H, v16.8H}, [x4], #32        // ......*........................
        // ld2 {v29.8H, v30.8H}, [x5], #32        // ........*......................
        // ld1 {v31.8H}, [x6], #16                // ..........*....................

        sub count, count, #1
k2_loop_start:
                                               // Instructions:    33
                                               // Expected cycles: 40
                                               // Expected IPC:    0.82

                                               // Cycle bound:     40.0
                                               // IPC bound:       0.82

                                               // Wall time:     1.67s
                                               // User time:     1.67s

                                               // ---------- cycle (expected) ----------->
                                               // 0                        25
                                               // |------------------------|--------------
        smull v13.4S, v6.4H, v4.4H             // *.......................................
        smull2 v10.4S, v6.8H, v4.8H            // .*......................................
        smull v21.4S, v6.4H, v5.4H             // ..*.....................................
        smull2 v3.4S, v6.8H, v5.8H             // ...*....................................
        smlal v13.4S, v7.4H, v12.4H            // ....*...................................
        smlal2 v10.4S, v7.8H, v12.8H           // .....*..................................
        smlal v21.4S, v7.4H, v4.4H             // ......*.................................
        smlal2 v3.4S, v7.8H, v4.8H             // .......*................................
        smlal v13.4S, v15.4H, v29.4H           // ........*...............................
        smlal2 v10.4S, v15.8H, v29.8H          // .........*..............................
        smlal v21.4S, v15.4H, v30.4H           // ..........*.............................
        smlal2 v3.4S, v15.8H, v30.8H           // ...........*............................
        smlal v13.4S, v16.4H, v31.4H           // ............*...........................
        smlal2 v10.4S, v16.8H, v31.8H          // .............*..........................
        smlal v21.4S, v16.4H, v29.4H           // ..............*.........................
        smlal2 v3.4S, v16.8H, v29.8H           // ...............*........................
        ld2 {v6.8H, v7.8H}, [x1], #32          // ................e.......................
        uzp1 v12.8H, v13.8H, v10.8H            // ..................*.....................
        uzp1 v30.8H, v21.8H, v3.8H             // ...................*....................
        mul v12.8H, v12.8H, v2.H[2]            // ....................*...................
        mul v30.8H, v30.8H, v2.H[2]            // .....................*..................
        ld2 {v4.8H, v5.8H}, [x2], #32          // ......................e.................
        smlal v13.4S, v12.4H, v0.4H            // ........................*...............
        smlal2 v10.4S, v12.8H, v0.8H           // .........................*..............
        smlal v21.4S, v30.4H, v0.4H            // ..........................*.............
        smlal2 v3.4S, v30.8H, v0.8H            // ...........................*............
        ld1 {v12.8H}, [x3], #16                // ............................e...........
        uzp2 v13.8H, v13.8H, v10.8H            // ..............................*.........
        uzp2 v14.8H, v21.8H, v3.8H             // ...............................*........
        ld2 {v15.8H, v16.8H}, [x4], #32        // ................................e.......
        st2 {v13.8H, v14.8H}, [x0], #32        // ..................................*.....
        ld2 {v29.8H, v30.8H}, [x5], #32        // ....................................e...
        ld1 {v31.8H}, [x6], #16                // ......................................e.

                                                    // -------------------- cycle (expected) -------------------->
                                                    // 0                        25                       50
                                                    // |------------------------|------------------------|--------
        // ld2 {v3.8h, v4.8h}, [x1],       #32        // e.......................'...............~..................
        // ld2 {v5.8h, v6.8h}, [x2],       #32        // ......e.................'.....................~............
        // ld1 {v7.8h},           [x3], #16           // ............e...........'...........................~......
        // smull  v8.4s, v3.4h, v5.4h                 // ........................*..................................
        // smull2 v10.4s, v3.8h, v5.8h                // ........................'*.................................
        // smlal  v8.4s, v4.4h, v7.4h                 // ........................'...*..............................
        // smlal2 v10.4s, v4.8h, v7.8h                // ........................'....*.............................
        // smull  v9.4s, v3.4h, v6.4h                 // ........................'.*................................
        // smull2 v11.4s, v3.8h, v6.8h                // ........................'..*...............................
        // smlal  v9.4s, v4.4h, v5.4h                 // ........................'.....*............................
        // smlal2 v11.4s, v4.8h, v5.8h                // ........................'......*...........................
        // ld2 {v3.8h, v4.8h}, [x4],       #32        // ................e.......'...............................~..
        // ld2 {v5.8h, v6.8h}, [x5],       #32        // ....................e...'..................................
        // ld1 {v7.8h},           [x6], #16           // ......................e.'..................................
        // smlal  v8.4s, v3.4h, v5.4h                 // ........................'.......*..........................
        // smlal2 v10.4s, v3.8h, v5.8h                // ........................'........*.........................
        // smlal  v8.4s, v4.4h, v7.4h                 // ........................'...........*......................
        // smlal2 v10.4s, v4.8h, v7.8h                // ........................'............*.....................
        // smlal  v9.4s, v3.4h, v6.4h                 // ........................'.........*........................
        // smlal2 v11.4s, v3.8h, v6.8h                // ........................'..........*.......................
        // smlal  v9.4s, v4.4h, v5.4h                 // ........................'.............*....................
        // smlal2 v11.4s, v4.8h, v5.8h                // ........................'..............*...................
        // uzp1   v28.8h, v8.8h, v10.8h               // ..~.....................'.................*................
        // mul    v28.8h, v28.8h, v2.h[2]             // ....~...................'...................*..............
        // smlal  v8.4s, v28.4h, v0.4h                // ........~...............'.......................*..........
        // smlal2 v10.4s, v28.8h, v0.8h               // .........~..............'........................*.........
        // uzp2   v26.8h, v8.8h, v10.8h               // ..............~.........'.............................*....
        // uzp1   v28.8h, v9.8h, v11.8h               // ...~....................'..................*...............
        // mul    v28.8h, v28.8h, v2.h[2]             // .....~..................'....................*.............
        // smlal  v9.4s, v28.4h, v0.4h                // ..........~.............'.........................*........
        // smlal2 v11.4s, v28.8h, v0.8h               // ...........~............'..........................*.......
        // uzp2   v27.8h, v9.8h, v11.8h               // ...............~........'..............................*...
        // st2 {v26.8h, v27.8h}, [x0], #32            // ..................~.....'.................................*

        sub count, count, #1
        cbnz count, k2_loop_start
                                               // Instructions:    27
                                               // Expected cycles: 34
                                               // Expected IPC:    0.79

                                               // Cycle bound:     34.0
                                               // IPC bound:       0.79

                                               // Wall time:     0.25s
                                               // User time:     0.25s

                                               // ------- cycle (expected) -------->
                                               // 0                        25
                                               // |------------------------|--------
        smull v13.4S, v6.4H, v5.4H             // *.................................
        smull2 v10.4S, v6.8H, v5.8H            // .*................................
        smull v21.4S, v6.4H, v4.4H             // ..*...............................
        smull2 v3.4S, v6.8H, v4.8H             // ...*..............................
        smlal v13.4S, v7.4H, v4.4H             // ....*.............................
        smlal2 v10.4S, v7.8H, v4.8H            // .....*............................
        smlal v21.4S, v7.4H, v12.4H            // ......*...........................
        smlal2 v3.4S, v7.8H, v12.8H            // .......*..........................
        smlal v13.4S, v15.4H, v30.4H           // ........*.........................
        smlal2 v10.4S, v15.8H, v30.8H          // .........*........................
        smlal v21.4S, v15.4H, v29.4H           // ..........*.......................
        smlal2 v3.4S, v15.8H, v29.8H           // ...........*......................
        smlal v13.4S, v16.4H, v29.4H           // ............*.....................
        smlal2 v10.4S, v16.8H, v29.8H          // .............*....................
        smlal v21.4S, v16.4H, v31.4H           // ..............*...................
        smlal2 v3.4S, v16.8H, v31.8H           // ...............*..................
        uzp1 v12.8H, v13.8H, v10.8H            // .................*................
        uzp1 v6.8H, v21.8H, v3.8H              // ...................*..............
        mul v12.8H, v12.8H, v2.H[2]            // ....................*.............
        mul v6.8H, v6.8H, v2.H[2]              // .....................*............
        smlal v13.4S, v12.4H, v0.4H            // ........................*.........
        smlal v21.4S, v6.4H, v0.4H             // .........................*........
        smlal2 v3.4S, v6.8H, v0.8H             // ..........................*.......
        smlal2 v10.4S, v12.8H, v0.8H           // ...........................*......
        uzp2 v21.8H, v21.8H, v3.8H             // ..............................*...
        uzp2 v22.8H, v13.8H, v10.8H            // ...............................*..
        st2 {v21.8H, v22.8H}, [x0], #32        // .................................*

                                                // ------- cycle (expected) -------->
                                                // 0                        25
                                                // |------------------------|--------
        // smull v13.4S, v6.4H, v4.4H             // ..*...............................
        // smull2 v10.4S, v6.8H, v4.8H            // ...*..............................
        // smull v21.4S, v6.4H, v5.4H             // *.................................
        // smull2 v3.4S, v6.8H, v5.8H             // .*................................
        // smlal v13.4S, v7.4H, v12.4H            // ......*...........................
        // smlal2 v10.4S, v7.8H, v12.8H           // .......*..........................
        // smlal v21.4S, v7.4H, v4.4H             // ....*.............................
        // smlal2 v3.4S, v7.8H, v4.8H             // .....*............................
        // smlal v13.4S, v15.4H, v29.4H           // ..........*.......................
        // smlal2 v10.4S, v15.8H, v29.8H          // ...........*......................
        // smlal v21.4S, v15.4H, v30.4H           // ........*.........................
        // smlal2 v3.4S, v15.8H, v30.8H           // .........*........................
        // smlal v13.4S, v16.4H, v31.4H           // ..............*...................
        // smlal2 v10.4S, v16.8H, v31.8H          // ...............*..................
        // smlal v21.4S, v16.4H, v29.4H           // ............*.....................
        // smlal2 v3.4S, v16.8H, v29.8H           // .............*....................
        // uzp1 v12.8H, v13.8H, v10.8H            // ...................*..............
        // uzp1 v30.8H, v21.8H, v3.8H             // .................*................
        // mul v12.8H, v12.8H, v2.H[2]            // .....................*............
        // mul v30.8H, v30.8H, v2.H[2]            // ....................*.............
        // smlal v13.4S, v12.4H, v0.4H            // .........................*........
        // smlal2 v10.4S, v12.8H, v0.8H           // ..........................*.......
        // smlal v21.4S, v30.4H, v0.4H            // ........................*.........
        // smlal2 v3.4S, v30.8H, v0.8H            // ...........................*......
        // uzp2 v13.8H, v13.8H, v10.8H            // ..............................*...
        // uzp2 v14.8H, v21.8H, v3.8H             // ...............................*..
        // st2 {v13.8H, v14.8H}, [x0], #32        // .................................*


        pop_stack
        ret
#endif /* KYBER_K == 2 */

#if KYBER_K == 3
.global polyvec_basemul_acc_montgomery_cached_asm_k3_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k3_opt

polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)

        mov count, #(KYBER_N / 16)
                                               // Instructions:    52
                                               // Expected cycles: 66
                                               // Expected IPC:    0.79

                                               // Cycle bound:     66.0
                                               // IPC bound:       0.79

                                               // Wall time:     8.09s
                                               // User time:     8.09s

                                               // ----------------------- cycle (expected) ------------------------>
                                               // 0                        25                       50
                                               // |------------------------|------------------------|---------------
        ld2 {v7.8H, v8.8H}, [x2], #32          // *.................................................................
        ld2 {v28.8H, v29.8H}, [x1], #32        // ..*...............................................................
        ld1 {v10.8H}, [x3], #16                // ....*.............................................................
        smull2 v15.4S, v28.8H, v8.8H           // ......*...........................................................
        smull v9.4S, v28.4H, v8.4H             // .......*..........................................................
        ld1 {v31.8H}, [x3], #16                // ........*.........................................................
        smlal2 v15.4S, v29.8H, v7.8H           // ..........*.......................................................
        ld2 {v19.8H, v20.8H}, [x5], #32        // ...........*......................................................
        smlal v9.4S, v29.4H, v7.4H             // .............*....................................................
        ld2 {v16.8H, v17.8H}, [x4], #32        // ..............*...................................................
        ld2 {v3.8H, v4.8H}, [x7], #32          // ................*.................................................
        smlal v9.4S, v16.4H, v20.4H            // ..................*...............................................
        smlal2 v15.4S, v16.8H, v20.8H          // ...................*..............................................
        smull v1.4S, v28.4H, v7.4H             // ....................*.............................................
        smull2 v22.4S, v28.8H, v7.8H           // .....................*............................................
        smlal v9.4S, v17.4H, v19.4H            // ......................*...........................................
        smlal2 v15.4S, v17.8H, v19.8H          // .......................*..........................................
        ld2 {v6.8H, v7.8H}, [x8], #32          // ........................*.........................................
        smlal v1.4S, v29.4H, v10.4H            // ..........................*.......................................
        smlal2 v22.4S, v29.8H, v10.8H          // ...........................*......................................
        smlal2 v15.4S, v3.8H, v7.8H            // ............................*.....................................
        smlal v9.4S, v3.4H, v7.4H              // .............................*....................................
        smlal v1.4S, v16.4H, v19.4H            // ..............................*...................................
        smlal2 v22.4S, v16.8H, v19.8H          // ...............................*..................................
        ld1 {v5.8H}, [x6], #16                 // ................................*.................................
        smlal v9.4S, v4.4H, v6.4H              // ..................................*...............................
        smlal2 v15.4S, v4.8H, v6.8H            // ...................................*..............................
        smlal v1.4S, v17.4H, v5.4H             // ....................................*.............................
        smlal2 v22.4S, v17.8H, v5.8H           // .....................................*............................
        ld1 {v30.8H}, [x9], #16                // ......................................*...........................
        smlal v1.4S, v3.4H, v6.4H              // ........................................*.........................
        smlal2 v22.4S, v3.8H, v6.8H            // .........................................*........................
        ld2 {v11.8H, v12.8H}, [x1], #32        // ..........................................*.......................
        smlal v1.4S, v4.4H, v30.4H             // ............................................*.....................
        smlal2 v22.4S, v4.8H, v30.8H           // .............................................*....................
        uzp1 v21.8H, v9.8H, v15.8H             // ..............................................*...................
        ld1 {v14.8H}, [x6], #16                // ...............................................*..................
        uzp1 v13.8H, v1.8H, v22.8H             // .................................................*................
        mul v10.8H, v21.8H, v2.H[2]            // ..................................................*...............
        mul v21.8H, v13.8H, v2.H[2]            // ...................................................*..............
        ld2 {v23.8H, v24.8H}, [x2], #32        // ....................................................*.............
        smlal2 v15.4S, v10.8H, v0.8H           // ......................................................*...........
        smlal2 v22.4S, v21.8H, v0.8H           // .......................................................*..........
        smlal v1.4S, v21.4H, v0.4H             // ........................................................*.........
        smull2 v13.4S, v11.8H, v23.8H          // .........................................................*........
        ld2 {v25.8H, v26.8H}, [x5], #32        // ..........................................................*.......
        smlal v9.4S, v10.4H, v0.4H             // ............................................................*.....
        smlal2 v13.4S, v12.8H, v31.8H          // .............................................................*....
        smull2 v27.4S, v11.8H, v24.8H          // ..............................................................*...
        uzp2 v16.8H, v1.8H, v22.8H             // ...............................................................*..
        uzp2 v17.8H, v9.8H, v15.8H             // ................................................................*.
        ld2 {v6.8H, v7.8H}, [x4], #32          // .................................................................*

                                                // ----------------------- cycle (expected) ------------------------>
                                                // 0                        25                       50
                                                // |------------------------|------------------------|---------------
        // ld2 {v23.8H, v24.8H}, [x2], #32       // *.................................................................
        // ld2 {v11.8H, v12.8H}, [x1], #32       // ..*...............................................................
        // ld2 {v6.8H, v7.8H}, [x4], #32         // ..............*...................................................
        // ld1 {v31.8H}, [x3], #16               // ....*.............................................................
        // ld2 {v25.8H, v26.8H}, [x5], #32       // ...........*......................................................
        // smull2 v13.4S, v11.8H, v23.8H         // .....................*............................................
        // ld1 {v14.8H}, [x6], #16               // ................................*.................................
        // smlal2 v13.4S, v12.8H, v31.8H         // ...........................*......................................
        // smull2 v27.4S, v11.8H, v24.8H         // ......*...........................................................
        // smlal2 v13.4S, v6.8H, v25.8H          // ...............................*..................................
        // smull v20.4S, v11.4H, v24.4H          // .......*..........................................................
        // smull v17.4S, v11.4H, v23.4H          // ....................*.............................................
        // smlal2 v27.4S, v12.8H, v23.8H         // ..........*.......................................................
        // smlal2 v13.4S, v7.8H, v14.8H          // .....................................*............................
        // smlal v20.4S, v12.4H, v23.4H          // .............*....................................................
        // smlal v17.4S, v12.4H, v31.4H          // ..........................*.......................................
        // smlal2 v27.4S, v6.8H, v26.8H          // ...................*..............................................
        // ld1 {v5.8H}, [x9], #16                // ......................................*...........................
        // smlal v17.4S, v6.4H, v25.4H           // ..............................*...................................
        // smlal v20.4S, v6.4H, v26.4H           // ..................*...............................................
        // ld2 {v23.8H, v24.8H}, [x2], #32       // ....................................................*.............
        // ld2 {v15.8H, v16.8H}, [x8], #32       // ........................*.........................................
        // smlal v17.4S, v7.4H, v14.4H           // ....................................*.............................
        // ld2 {v8.8H, v9.8H}, [x7], #32         // ................*.................................................
        // smlal v20.4S, v7.4H, v25.4H           // ......................*...........................................
        // smlal2 v27.4S, v7.8H, v25.8H          // .......................*..........................................
        // smlal2 v13.4S, v8.8H, v15.8H          // .........................................*........................
        // smlal v17.4S, v8.4H, v15.4H           // ........................................*.........................
        // smlal v20.4S, v8.4H, v16.4H           // .............................*....................................
        // smlal2 v27.4S, v8.8H, v16.8H          // ............................*.....................................
        // smlal2 v13.4S, v9.8H, v5.8H           // .............................................*....................
        // smlal v17.4S, v9.4H, v5.4H            // ............................................*.....................
        // smlal v20.4S, v9.4H, v15.4H           // ..................................*...............................
        // smlal2 v27.4S, v9.8H, v15.8H          // ...................................*..............................
        // ld2 {v11.8H, v12.8H}, [x1], #32       // ..........................................*.......................
        // uzp1 v31.8H, v17.8H, v13.8H           // .................................................*................
        // uzp1 v8.8H, v20.8H, v27.8H            // ..............................................*...................
        // ld2 {v6.8H, v7.8H}, [x4], #32         // .................................................................*
        // mul v18.8H, v31.8H, v2.H[2]           // ...................................................*..............
        // mul v14.8H, v8.8H, v2.H[2]            // ..................................................*...............
        // ld1 {v31.8H}, [x3], #16               // ........*.........................................................
        // smlal v17.4S, v18.4H, v0.4H           // ........................................................*.........
        // smlal2 v27.4S, v14.8H, v0.8H          // ......................................................*...........
        // smlal2 v13.4S, v18.8H, v0.8H          // .......................................................*..........
        // smlal v20.4S, v14.4H, v0.4H           // ............................................................*.....
        // ld2 {v25.8H, v26.8H}, [x5], #32       // ..........................................................*.......
        // uzp2 v16.8H, v17.8H, v13.8H           // ...............................................................*..
        // smull2 v13.4S, v11.8H, v23.8H         // .........................................................*........
        // uzp2 v17.8H, v20.8H, v27.8H           // ................................................................*.
        // ld1 {v14.8H}, [x6], #16               // ...............................................*..................
        // smlal2 v13.4S, v12.8H, v31.8H         // .............................................................*....
        // smull2 v27.4S, v11.8H, v24.8H         // ..............................................................*...

        sub count, count, #2
k3_loop_start:
                                               // Instructions:    44
                                               // Expected cycles: 54
                                               // Expected IPC:    0.81

                                               // Cycle bound:     54.0
                                               // IPC bound:       0.81

                                               // Wall time:     4.51s
                                               // User time:     4.51s

                                               // ----------------- cycle (expected) ------------------>
                                               // 0                        25                       50
                                               // |------------------------|------------------------|---
        st2 {v16.8H, v17.8H}, [x0], #32        // l.....................................................
        smlal2 v13.4S, v6.8H, v25.8H           // ..*...................................................
        smull v20.4S, v11.4H, v24.4H           // ...*..................................................
        smull v17.4S, v11.4H, v23.4H           // ....*.................................................
        smlal2 v27.4S, v12.8H, v23.8H          // .....*................................................
        smlal2 v13.4S, v7.8H, v14.8H           // ......*...............................................
        smlal v20.4S, v12.4H, v23.4H           // .......*..............................................
        smlal v17.4S, v12.4H, v31.4H           // ........*.............................................
        smlal2 v27.4S, v6.8H, v26.8H           // .........*............................................
        ld1 {v5.8H}, [x9], #16                 // ..........*...........................................
        smlal v17.4S, v6.4H, v25.4H            // ............*.........................................
        smlal v20.4S, v6.4H, v26.4H            // .............*........................................
        ld2 {v23.8H, v24.8H}, [x2], #32        // ..............e.......................................
        ld2 {v15.8H, v16.8H}, [x8], #32        // ................*.....................................
        smlal v17.4S, v7.4H, v14.4H            // ..................*...................................
        ld2 {v8.8H, v9.8H}, [x7], #32          // ...................*..................................
        smlal v20.4S, v7.4H, v25.4H            // .....................*................................
        smlal2 v27.4S, v7.8H, v25.8H           // ......................*...............................
        smlal2 v13.4S, v8.8H, v15.8H           // .......................*..............................
        smlal v17.4S, v8.4H, v15.4H            // ........................*.............................
        smlal v20.4S, v8.4H, v16.4H            // .........................*............................
        smlal2 v27.4S, v8.8H, v16.8H           // ..........................*...........................
        smlal2 v13.4S, v9.8H, v5.8H            // ...........................*..........................
        smlal v17.4S, v9.4H, v5.4H             // ............................*.........................
        smlal v20.4S, v9.4H, v15.4H            // .............................*........................
        smlal2 v27.4S, v9.8H, v15.8H           // ..............................*.......................
        ld2 {v11.8H, v12.8H}, [x1], #32        // ...............................e......................
        uzp1 v31.8H, v17.8H, v13.8H            // .................................*....................
        uzp1 v8.8H, v20.8H, v27.8H             // ..................................*...................
        ld2 {v6.8H, v7.8H}, [x4], #32          // ...................................e..................
        mul v18.8H, v31.8H, v2.H[2]            // .....................................*................
        mul v14.8H, v8.8H, v2.H[2]             // ......................................*...............
        ld1 {v31.8H}, [x3], #16                // .......................................e..............
        smlal v17.4S, v18.4H, v0.4H            // .........................................*............
        smlal2 v27.4S, v14.8H, v0.8H           // ..........................................*...........
        smlal2 v13.4S, v18.8H, v0.8H           // ...........................................*..........
        smlal v20.4S, v14.4H, v0.4H            // ............................................*.........
        ld2 {v25.8H, v26.8H}, [x5], #32        // .............................................e........
        uzp2 v16.8H, v17.8H, v13.8H            // ...............................................*......
        smull2 v13.4S, v11.8H, v23.8H          // ................................................e.....
        uzp2 v17.8H, v20.8H, v27.8H            // .................................................*....
        ld1 {v14.8H}, [x6], #16                // ..................................................e...
        smlal2 v13.4S, v12.8H, v31.8H          // ....................................................e.
        smull2 v27.4S, v11.8H, v24.8H          // .....................................................e

                                                    // -------------------------------------- cycle (expected) -------------------------------------->
                                                    // 0                        25                       50                       75
                                                    // |------------------------|------------------------|------------------------|-------------------
        // ld2 {v3.8h, v4.8h}, [x1],       #32       // .................e......................'..............................~.......................
        // ld2 {v5.8h, v6.8h}, [x2],       #32       // e.......................................'.............~........................................
        // ld1 {v7.8h},           [x3], #16          // .........................e..............'......................................~...............
        // smull  v8.4s, v3.4h, v5.4h                // ........................................'...*..................................................
        // smull2 v10.4s, v3.8h, v5.8h               // ..................................e.....'...............................................~......
        // smlal  v8.4s, v4.4h, v7.4h                // ........................................'.......*..............................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......................................e.'...................................................~..
        // smull  v9.4s, v3.4h, v6.4h                // ........................................'..*...................................................
        // smull2 v11.4s, v3.8h, v6.8h               // .......................................e'....................................................~.
        // smlal  v9.4s, v4.4h, v5.4h                // ........................................'......*...............................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ........................................'....*.................................................
        // ld2 {v3.8h, v4.8h}, [x4],       #32       // .....................e..................'..................................~...................
        // ld2 {v5.8h, v6.8h}, [x5],       #32       // ...............................e........'............................................~.........
        // ld1 {v7.8h},           [x6], #16          // ....................................e...'.................................................~....
        // smlal  v8.4s, v3.4h, v5.4h                // ........................................'...........*..........................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ........................................'.*....................................................
        // smlal  v8.4s, v4.4h, v7.4h                // ....~...................................'.................*....................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ........................................'.....*................................................
        // smlal  v9.4s, v3.4h, v6.4h                // ........................................'............*.........................................
        // smlal2 v11.4s, v3.8h, v6.8h               // ........................................'........*.............................................
        // smlal  v9.4s, v4.4h, v5.4h                // .......~................................'....................*.................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ........~...............................'.....................*................................
        // ld2 {v3.8h, v4.8h}, [x7],       #32       // .....~..................................'..................*...................................
        // ld2 {v5.8h, v6.8h}, [x8],       #32       // ..~.....................................'...............*......................................
        // ld1 {v7.8h},           [x9], #16          // ........................................'.........*............................................
        // smlal  v8.4s, v3.4h, v5.4h                // ..........~.............................'.......................*..............................
        // smlal2 v10.4s, v3.8h, v5.8h               // .........~..............................'......................*...............................
        // smlal  v8.4s, v4.4h, v7.4h                // ..............~.........................'...........................*..........................
        // smlal2 v10.4s, v4.8h, v7.8h               // .............~..........................'..........................*...........................
        // smlal  v9.4s, v3.4h, v6.4h                // ...........~............................'........................*.............................
        // smlal2 v11.4s, v3.8h, v6.8h               // ............~...........................'.........................*............................
        // smlal  v9.4s, v4.4h, v5.4h                // ...............~........................'............................*.........................
        // smlal2 v11.4s, v4.8h, v5.8h               // ................~.......................'.............................*........................
        // uzp1   v28.8h, v8.8h, v10.8h              // ...................~....................'................................*.....................
        // mul    v28.8h, v28.8h, v2.h[2]            // .......................~................'....................................*.................
        // smlal  v8.4s, v28.4h, v0.4h               // ...........................~............'........................................*.............
        // smlal2 v10.4s, v28.8h, v0.8h              // .............................~..........'..........................................*...........
        // uzp2   v26.8h, v8.8h, v10.8h              // .................................~......'..............................................*.......
        // uzp1   v28.8h, v9.8h, v11.8h              // ....................~...................'.................................*....................
        // mul    v28.8h, v28.8h, v2.h[2]            // ........................~...............'.....................................*................
        // smlal  v9.4s, v28.4h, v0.4h               // ..............................~.........'...........................................*..........
        // smlal2 v11.4s, v28.8h, v0.8h              // ............................~...........'.........................................*............
        // uzp2   v27.8h, v9.8h, v11.8h              // ...................................~....'................................................*.....
        // st2 {v26.8h, v27.8h}, [x0], #32           // ........................................~.....................................................l

        sub count, count, #1
        cbnz count, k3_loop_start
                                               // Instructions:    36
                                               // Expected cycles: 45
                                               // Expected IPC:    0.80

                                               // Cycle bound:     45.0
                                               // IPC bound:       0.80

                                               // Wall time:     0.30s
                                               // User time:     0.30s

                                               // ------------- cycle (expected) ------------->
                                               // 0                        25
                                               // |------------------------|-------------------
        ld2 {v21.8H, v22.8H}, [x8], #32        // *............................................
        smull v10.4S, v11.4H, v24.4H           // ..*..........................................
        smlal2 v13.4S, v6.8H, v25.8H           // ...*.........................................
        smlal2 v27.4S, v12.8H, v23.8H          // ....*........................................
        smull v18.4S, v11.4H, v23.4H           // .....*.......................................
        smlal v10.4S, v12.4H, v23.4H           // ......*......................................
        ld2 {v29.8H, v30.8H}, [x7], #32        // .......*.....................................
        smlal2 v27.4S, v6.8H, v26.8H           // .........*...................................
        smlal v10.4S, v6.4H, v26.4H            // ..........*..................................
        smlal v18.4S, v12.4H, v31.4H           // ...........*.................................
        smlal2 v13.4S, v7.8H, v14.8H           // ............*................................
        smlal2 v27.4S, v7.8H, v25.8H           // .............*...............................
        smlal v10.4S, v7.4H, v25.4H            // ..............*..............................
        smlal v18.4S, v6.4H, v25.4H            // ...............*.............................
        smlal2 v13.4S, v29.8H, v21.8H          // ................*............................
        smlal2 v27.4S, v29.8H, v22.8H          // .................*...........................
        smlal v10.4S, v29.4H, v22.4H           // ..................*..........................
        smlal v18.4S, v7.4H, v14.4H            // ...................*.........................
        ld1 {v3.8H}, [x9], #16                 // ....................*........................
        smlal v10.4S, v30.4H, v21.4H           // ......................*......................
        smlal v18.4S, v29.4H, v21.4H           // .......................*.....................
        smlal2 v27.4S, v30.8H, v21.8H          // ........................*....................
        smlal2 v13.4S, v30.8H, v3.8H           // .........................*...................
        smlal v18.4S, v30.4H, v3.4H            // ...........................*.................
        uzp1 v8.8H, v10.8H, v27.8H             // ............................*................
        mul v23.8H, v8.8H, v2.H[2]             // ..............................*..............
        uzp1 v30.8H, v18.8H, v13.8H            // ...............................*.............
        mul v19.8H, v30.8H, v2.H[2]            // .................................*...........
        smlal2 v27.4S, v23.8H, v0.8H           // ..................................*..........
        smlal v10.4S, v23.4H, v0.4H            // ...................................*.........
        smlal v18.4S, v19.4H, v0.4H            // .....................................*.......
        smlal2 v13.4S, v19.8H, v0.8H           // ......................................*......
        st2 {v16.8H, v17.8H}, [x0], #32        // .......................................*.....
        uzp2 v12.8H, v10.8H, v27.8H            // .........................................*...
        uzp2 v11.8H, v18.8H, v13.8H            // ..........................................*..
        st2 {v11.8H, v12.8H}, [x0], #32        // ............................................*

                                                // ------------- cycle (expected) ------------->
                                                // 0                        25
                                                // |------------------------|-------------------
        // st2 {v16.8H, v17.8H}, [x0], #32       // .......................................*.....
        // smlal2 v13.4S, v6.8H, v25.8H          // ...*.........................................
        // smull v20.4S, v11.4H, v24.4H          // ..*..........................................
        // smull v17.4S, v11.4H, v23.4H          // .....*.......................................
        // smlal2 v27.4S, v12.8H, v23.8H         // ....*........................................
        // smlal2 v13.4S, v7.8H, v14.8H          // ............*................................
        // smlal v20.4S, v12.4H, v23.4H          // ......*......................................
        // smlal v17.4S, v12.4H, v31.4H          // ...........*.................................
        // smlal2 v27.4S, v6.8H, v26.8H          // .........*...................................
        // ld1 {v5.8H}, [x9], #16                // ....................*........................
        // smlal v17.4S, v6.4H, v25.4H           // ...............*.............................
        // smlal v20.4S, v6.4H, v26.4H           // ..........*..................................
        // ld2 {v15.8H, v16.8H}, [x8], #32       // *............................................
        // smlal v17.4S, v7.4H, v14.4H           // ...................*.........................
        // ld2 {v8.8H, v9.8H}, [x7], #32         // .......*.....................................
        // smlal v20.4S, v7.4H, v25.4H           // ..............*..............................
        // smlal2 v27.4S, v7.8H, v25.8H          // .............*...............................
        // smlal2 v13.4S, v8.8H, v15.8H          // ................*............................
        // smlal v17.4S, v8.4H, v15.4H           // .......................*.....................
        // smlal v20.4S, v8.4H, v16.4H           // ..................*..........................
        // smlal2 v27.4S, v8.8H, v16.8H          // .................*...........................
        // smlal2 v13.4S, v9.8H, v5.8H           // .........................*...................
        // smlal v17.4S, v9.4H, v5.4H            // ...........................*.................
        // smlal v20.4S, v9.4H, v15.4H           // ......................*......................
        // smlal2 v27.4S, v9.8H, v15.8H          // ........................*....................
        // uzp1 v31.8H, v17.8H, v13.8H           // ...............................*.............
        // uzp1 v8.8H, v20.8H, v27.8H            // ............................*................
        // mul v18.8H, v31.8H, v2.H[2]           // .................................*...........
        // mul v14.8H, v8.8H, v2.H[2]            // ..............................*..............
        // smlal v17.4S, v18.4H, v0.4H           // .....................................*.......
        // smlal2 v27.4S, v14.8H, v0.8H          // ..................................*..........
        // smlal2 v13.4S, v18.8H, v0.8H          // ......................................*......
        // smlal v20.4S, v14.4H, v0.4H           // ...................................*.........
        // uzp2 v16.8H, v17.8H, v13.8H           // ..........................................*..
        // uzp2 v17.8H, v20.8H, v27.8H           // .........................................*...
        // st2 {v16.8H, v17.8H}, [x0], #32       // ............................................*


        pop_stack
        ret
#endif /* KYBER_K == 3 */

#if KYBER_K == 4
.global polyvec_basemul_acc_montgomery_cached_asm_k4_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k4_opt

polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)
        add a3_ptr, a0_ptr, #(3 * 512)
        add b3_ptr, b0_ptr, #(3 * 512)
        add b3_cache_ptr, b0_cache_ptr, #(3 * 512/2)

        mov count, #(KYBER_N / 16)
                                                // Instructions:    18
                                                // Expected cycles: 27
                                                // Expected IPC:    0.67
                                                //
                                                // Cycle bound:     27.0
                                                // IPC bound:       0.67
                                                //
                                                // Wall time:     0.03s
                                                // User time:     0.03s
                                                //
                                                // ----- cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|----
        ld2 {v3.8H, v4.8H}, [x1], #32           // *.............................
        ld2 {v13.8H, v14.8H}, [x2], #32         // ..*...........................
        ld1 {v31.8H}, [x3], #16                 // ....*.........................
        smull v9.4S, v3.4H, v14.4H              // ......*.......................
        smull2 v6.4S, v3.8H, v14.8H             // .......*......................
        smull2 v29.4S, v3.8H, v13.8H            // ........*.....................
        smull v11.4S, v3.4H, v13.4H             // .........*....................
        smlal v9.4S, v4.4H, v13.4H              // ..........*...................
        smlal2 v6.4S, v4.8H, v13.8H             // ...........*..................
        smlal2 v29.4S, v4.8H, v31.8H            // ............*.................
        smlal v11.4S, v4.4H, v31.4H             // .............*................
        ld2 {v27.8H, v28.8H}, [x7], #32         // ..............*...............
        ld2 {v18.8H, v19.8H}, [x10], #32        // ................*.............
        ld2 {v20.8H, v21.8H}, [x8], #32         // ..................*...........
        ld2 {v25.8H, v26.8H}, [x11], #32        // ....................*.........
        ld2 {v16.8H, v17.8H}, [x5], #32         // ......................*.......
        ld2 {v7.8H, v8.8H}, [x1], #32           // ........................*.....
        ld1 {v3.8H}, [x3], #16                  // ..........................*...

                                                 // ------ cycle (expected) ------>
                                                 // 0                        25
                                                 // |------------------------|-----
        // ld2 {v7.8H, v8.8H}, [x1], #32         // *..............................
        // ld1 {v3.8H}, [x3], #16                // ....*..........................
        // ld2 {v4.8H, v5.8H}, [x2], #32         // ..*............................
        // ld2 {v27.8H, v28.8H}, [x7], #32       // ..............*................
        // ld2 {v18.8H, v19.8H}, [x10], #32      // ................*..............
        // smull v9.4S, v7.4H, v5.4H             // ......*........................
        // ld2 {v20.8H, v21.8H}, [x8], #32       // ..................*............
        // smlal v9.4S, v8.4H, v4.4H             // ..........*....................
        // smull2 v29.4S, v7.8H, v4.8H           // ........*......................
        // smull2 v6.4S, v7.8H, v5.8H            // .......*.......................
        // ld2 {v25.8H, v26.8H}, [x11], #32      // ....................*..........
        // smull v11.4S, v7.4H, v4.4H            // .........*.....................
        // smlal2 v6.4S, v8.8H, v4.8H            // ...........*...................
        // smlal2 v29.4S, v8.8H, v3.8H           // ............*..................
        // ld2 {v16.8H, v17.8H}, [x5], #32       // ......................*........
        // smlal v11.4S, v8.4H, v3.4H            // .............*.................
        // ld2 {v7.8H, v8.8H}, [x1], #32         // ........................*......
        // ld1 {v3.8H}, [x3], #16                // ..........................*....

        sub count, count, #2
k4_loop_start:
                                                // Instructions:    55
                                                // Expected cycles: 68
                                                // Expected IPC:    0.81
                                                //
                                                // Cycle bound:     68.0
                                                // IPC bound:       0.81
                                                //
                                                // Wall time:     13.63s
                                                // User time:     13.63s
                                                //
                                                // ------------------------ cycle (expected) ------------------------->
                                                // 0                        25                       50
                                                // |------------------------|------------------------|-----------------
        ld2 {v13.8H, v14.8H}, [x4], #32         // l...................................................................
        ld1 {v15.8H}, [x6], #16                 // ..l.................................................................
        smlal2 v29.4S, v13.8H, v16.8H           // ....l...............................................................
        smlal v9.4S, v13.4H, v17.4H             // .....l..............................................................
        smlal2 v6.4S, v13.8H, v17.8H            // ......l.............................................................
        smlal v11.4S, v13.4H, v16.4H            // .......l............................................................
        smlal2 v29.4S, v14.8H, v15.8H           // ........l...........................................................
        smlal v9.4S, v14.4H, v16.4H             // .........l..........................................................
        smlal2 v6.4S, v14.8H, v16.8H            // ..........l.........................................................
        ld1 {v30.8H}, [x9], #16                 // ...........l........................................................
        smlal v9.4S, v27.4H, v21.4H             // .............l......................................................
        smlal2 v6.4S, v27.8H, v21.8H            // ..............l.....................................................
        smlal v11.4S, v14.4H, v15.4H            // ...............l....................................................
        smlal2 v29.4S, v27.8H, v20.8H           // ................l...................................................
        smlal v9.4S, v28.4H, v20.4H             // .................l..................................................
        smlal2 v6.4S, v28.8H, v20.8H            // ..................l.................................................
        smlal v11.4S, v27.4H, v20.4H            // ...................l................................................
        smlal2 v29.4S, v28.8H, v30.8H           // ....................l...............................................
        smlal v9.4S, v18.4H, v26.4H             // .....................l..............................................
        smlal2 v6.4S, v18.8H, v26.8H            // ......................l.............................................
        smlal v11.4S, v28.4H, v30.4H            // .......................l............................................
        smlal2 v29.4S, v18.8H, v25.8H           // ........................l...........................................
        smlal v9.4S, v19.4H, v25.4H             // .........................l..........................................
        smlal2 v6.4S, v19.8H, v25.8H            // ..........................l.........................................
        ld1 {v23.8H}, [x12], #16                // ...........................l........................................
        smlal v11.4S, v18.4H, v25.4H            // .............................l......................................
        uzp1 v14.8H, v9.8H, v6.8H               // ..............................l.....................................
        smlal2 v29.4S, v19.8H, v23.8H           // ...............................l....................................
        mul v27.8H, v14.8H, v2.H[2]             // ................................l...................................
        smlal v11.4S, v19.4H, v23.4H            // .................................l..................................
        ld2 {v4.8H, v5.8H}, [x2], #32           // ..................................*.................................
        smlal v9.4S, v27.4H, v0.4H              // ....................................l...............................
        smlal2 v6.4S, v27.8H, v0.8H             // .....................................l..............................
        ld2 {v27.8H, v28.8H}, [x7], #32         // ......................................*.............................
        uzp1 v13.8H, v11.8H, v29.8H             // ........................................l...........................
        uzp2 v15.8H, v9.8H, v6.8H               // .........................................l..........................
        mul v13.8H, v13.8H, v2.H[2]             // ..........................................l.........................
        ld2 {v18.8H, v19.8H}, [x10], #32        // ...........................................*........................
        smull v9.4S, v7.4H, v5.4H               // .............................................*......................
        smlal v11.4S, v13.4H, v0.4H             // ..............................................l.....................
        smlal2 v29.4S, v13.8H, v0.8H            // ...............................................l....................
        ld2 {v20.8H, v21.8H}, [x8], #32         // ................................................*...................
        smlal v9.4S, v8.4H, v4.4H               // ..................................................*.................
        uzp2 v14.8H, v11.8H, v29.8H             // ...................................................l................
        smull2 v29.4S, v7.8H, v4.8H             // ....................................................*...............
        smull2 v6.4S, v7.8H, v5.8H              // .....................................................*..............
        ld2 {v25.8H, v26.8H}, [x11], #32        // ......................................................*.............
        smull v11.4S, v7.4H, v4.4H              // ........................................................*...........
        smlal2 v6.4S, v8.8H, v4.8H              // .........................................................*..........
        smlal2 v29.4S, v8.8H, v3.8H             // ..........................................................*.........
        ld2 {v16.8H, v17.8H}, [x5], #32         // ...........................................................*........
        smlal v11.4S, v8.4H, v3.4H              // .............................................................*......
        ld2 {v7.8H, v8.8H}, [x1], #32           // ..............................................................e.....
        ld1 {v3.8H}, [x3], #16                  // ................................................................e...
        st2 {v14.8H, v15.8H}, [x0], #32         // ..................................................................l.

                                                     // ------------------------------------------------------------- cycle (expected) ------------------------------------------------------------->
                                                     // 0                        25                       50                       75                       100                      125
                                                     // |------------------------|------------------------|------------------------|------------------------|------------------------|---------------
        // ld2 {v3.8h, v4.8h}, [x1],       #32       // e.....'.............................................................~.....'.............................................................~....
        // ld2 {v5.8h, v6.8h}, [x2],       #32       // ......'.................................*.................................'.................................~................................
        // ld1 {v7.8h},           [x3], #16          // ..e...'...............................................................~...'...............................................................~..
        // smull  v8.4s, v3.4h, v5.4h                // ......'.......................................................*...........'.......................................................~..........
        // smull2 v10.4s, v3.8h, v5.8h               // ......'...................................................*...............'...................................................~..............
        // smlal  v8.4s, v4.4h, v7.4h                // ......'............................................................*......'............................................................~.....
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.........................................................*.........'.........................................................~........
        // smull  v9.4s, v3.4h, v6.4h                // ......'............................................*......................'............................................~.....................
        // smull2 v11.4s, v3.8h, v6.8h               // ......'....................................................*..............'....................................................~.............
        // smlal  v9.4s, v4.4h, v5.4h                // ......'.................................................*.................'.................................................~................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'........................................................*..........'........................................................~.........
        // ld2 {v3.8h, v4.8h}, [x4],       #32       // ......~...................................................................l..................................................................
        // ld2 {v5.8h, v6.8h}, [x5],       #32       // ......'..........................................................*........'..........................................................~.......
        // ld1 {v7.8h},           [x6], #16          // ......'.~.................................................................'.l................................................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'......~............................................................'......l...........................................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'...~...............................................................'...l..............................................................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'..............~....................................................'..............l...................................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.......~...........................................................'.......l..........................................................
        // smlal  v9.4s, v3.4h, v6.4h                // ......'....~..............................................................'....l.............................................................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'.....~.............................................................'.....l............................................................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'........~..........................................................'........l.........................................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'.........~.........................................................'.........l........................................................
        // ld2 {v3.8h, v4.8h}, [x7],       #32       // ......'.....................................*.............................'.....................................~............................
        // ld2 {v5.8h, v6.8h}, [x8],       #32       // ......'...............................................*...................'...............................................~..................
        // ld1 {v7.8h},           [x9], #16          // ......'..........~........................................................'..........l.......................................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'..................~................................................'..................l...............................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'...............~...................................................'...............l..................................................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'......................~............................................'......................l...........................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'...................~...............................................'...................l..............................................
        // smlal  v9.4s, v3.4h, v6.4h                // ......'............~......................................................'............l.....................................................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'.............~.....................................................'.............l....................................................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'................~..................................................'................l.................................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'.................~.................................................'.................l................................................
        // ld2 {v3.8h, v4.8h}, [x10],       #32      // ......'..........................................*........................'..........................................~.......................
        // ld2 {v5.8h, v6.8h}, [x11],       #32      // ......'.....................................................*.............'.....................................................~............
        // ld1 {v7.8h},           [x12], #16         // ......'..........................~........................................'..........................l.......................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'............................~......................................'............................l.....................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'.......................~...........................................'.......................l..........................................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'................................~..................................'................................l.................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'..............................~....................................'..............................l...................................
        // smlal  v9.4s, v3.4h, v6.4h                // ......'....................~..............................................'....................l.............................................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'.....................~.............................................'.....................l............................................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'........................~..........................................'........................l.........................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'.........................~.........................................'.........................l........................................
        // uzp1   v28.8h, v8.8h, v10.8h              // ......'.......................................~...........................'.......................................l..........................
        // mul    v28.8h, v28.8h, v2.h[2]            // ......'.........................................~.........................'.........................................l........................
        // smlal  v8.4s, v28.4h, v0.4h               // ......'.............................................~.....................'.............................................l....................
        // smlal2 v10.4s, v28.8h, v0.8h              // ......'..............................................~....................'..............................................l...................
        // uzp2   v26.8h, v8.8h, v10.8h              // ......'..................................................~................'..................................................l...............
        // uzp1   v28.8h, v9.8h, v11.8h              // ......'.............................~.....................................'.............................l....................................
        // mul    v28.8h, v28.8h, v2.h[2]            // ......'...............................~...................................'...............................l..................................
        // smlal  v9.4s, v28.4h, v0.4h               // ......'...................................~...............................'...................................l..............................
        // smlal2 v11.4s, v28.8h, v0.8h              // ......'....................................~..............................'....................................l.............................
        // uzp2   v27.8h, v9.8h, v11.8h              // ......'........................................~..........................'........................................l.........................
        // st2 {v26.8h, v27.8h}, [x0], #32           // ....~.'.................................................................~.'.................................................................l

        sub count, count, #1
        cbnz count, k4_loop_start
                                                // Instructions:    92
                                                // Expected cycles: 107
                                                // Expected IPC:    0.86
                                                //
                                                // Cycle bound:     107.0
                                                // IPC bound:       0.86
                                                //
                                                // Wall time:     15.26s
                                                // User time:     15.26s
                                                //
                                                // -------------------------------------------- cycle (expected) -------------------------------------------->
                                                // 0                        25                       50                       75                       100
                                                // |------------------------|------------------------|------------------------|------------------------|------
        ld2 {v14.8H, v15.8H}, [x4], #32         // *..........................................................................................................
        ld1 {v1.8H}, [x6], #16                  // ..*........................................................................................................
        smlal2 v29.4S, v14.8H, v16.8H           // ....*......................................................................................................
        smlal v11.4S, v14.4H, v16.4H            // .....*.....................................................................................................
        ld2 {v12.8H, v13.8H}, [x5], #32         // ......*....................................................................................................
        smlal2 v29.4S, v15.8H, v1.8H            // ........*..................................................................................................
        smlal v11.4S, v15.4H, v1.4H             // .........*.................................................................................................
        ld1 {v10.8H}, [x9], #16                 // ..........*................................................................................................
        smlal2 v29.4S, v27.8H, v20.8H           // ............*..............................................................................................
        smlal v11.4S, v27.4H, v20.4H            // .............*.............................................................................................
        ld2 {v22.8H, v23.8H}, [x2], #32         // ..............*............................................................................................
        smlal2 v29.4S, v28.8H, v10.8H           // ................*..........................................................................................
        smlal v11.4S, v28.4H, v10.4H            // .................*.........................................................................................
        ld1 {v31.8H}, [x12], #16                // ..................*........................................................................................
        smlal2 v29.4S, v18.8H, v25.8H           // ....................*......................................................................................
        smlal v11.4S, v18.4H, v25.4H            // .....................*.....................................................................................
        smull2 v1.4S, v7.8H, v23.8H             // ......................*....................................................................................
        smlal v9.4S, v14.4H, v17.4H             // .......................*...................................................................................
        smlal2 v29.4S, v19.8H, v31.8H           // ........................*..................................................................................
        smlal v11.4S, v19.4H, v31.4H            // .........................*.................................................................................
        smull v31.4S, v7.4H, v23.4H             // ..........................*................................................................................
        smlal v9.4S, v15.4H, v16.4H             // ...........................*...............................................................................
        smull v10.4S, v7.4H, v22.4H             // ............................*..............................................................................
        smlal2 v1.4S, v8.8H, v22.8H             // .............................*.............................................................................
        smlal v31.4S, v8.4H, v22.4H             // ..............................*............................................................................
        ld2 {v4.8H, v5.8H}, [x4], #32           // ...............................*...........................................................................
        ld2 {v23.8H, v24.8H}, [x11], #32        // .................................*.........................................................................
        smlal2 v1.4S, v4.8H, v13.8H             // ...................................*.......................................................................
        smlal v31.4S, v4.4H, v13.4H             // ....................................*......................................................................
        ld1 {v30.8H}, [x6], #16                 // .....................................*.....................................................................
        smlal2 v1.4S, v5.8H, v12.8H             // .......................................*...................................................................
        smlal v10.4S, v8.4H, v3.4H              // ........................................*..................................................................
        smull2 v7.4S, v7.8H, v22.8H             // .........................................*.................................................................
        uzp1 v22.8H, v11.8H, v29.8H             // ..........................................*................................................................
        smlal2 v6.4S, v14.8H, v17.8H            // ...........................................*...............................................................
        smlal v10.4S, v4.4H, v12.4H             // ............................................*..............................................................
        smlal2 v7.4S, v8.8H, v3.8H              // .............................................*.............................................................
        ld2 {v13.8H, v14.8H}, [x7], #32         // ..............................................*............................................................
        mul v17.8H, v22.8H, v2.H[2]             // ................................................*..........................................................
        smlal2 v7.4S, v4.8H, v12.8H             // .................................................*.........................................................
        smlal v10.4S, v5.4H, v30.4H             // ..................................................*........................................................
        smlal2 v6.4S, v15.8H, v16.8H            // ...................................................*.......................................................
        smlal v11.4S, v17.4H, v0.4H             // ....................................................*......................................................
        ld2 {v3.8H, v4.8H}, [x8], #32           // .....................................................*.....................................................
        smlal2 v7.4S, v5.8H, v30.8H             // .......................................................*...................................................
        ld1 {v30.8H}, [x9], #16                 // ........................................................*..................................................
        smlal v10.4S, v13.4H, v3.4H             // ..........................................................*................................................
        smlal2 v7.4S, v13.8H, v3.8H             // ...........................................................*...............................................
        ld2 {v15.8H, v16.8H}, [x10], #32        // ............................................................*..............................................
        smlal v10.4S, v14.4H, v30.4H            // ..............................................................*............................................
        smlal v9.4S, v27.4H, v21.4H             // ...............................................................*...........................................
        smlal2 v7.4S, v14.8H, v30.8H            // ................................................................*..........................................
        smlal2 v6.4S, v27.8H, v21.8H            // .................................................................*.........................................
        smlal v10.4S, v15.4H, v23.4H            // ..................................................................*........................................
        ld1 {v27.8H}, [x12], #16                // ...................................................................*.......................................
        smlal2 v7.4S, v15.8H, v23.8H            // .....................................................................*.....................................
        smlal v31.4S, v5.4H, v12.4H             // ......................................................................*....................................
        smlal2 v6.4S, v28.8H, v20.8H            // .......................................................................*...................................
        smlal v10.4S, v16.4H, v27.4H            // ........................................................................*..................................
        smlal2 v7.4S, v16.8H, v27.8H            // .........................................................................*.................................
        smlal v31.4S, v13.4H, v4.4H             // ..........................................................................*................................
        smlal2 v6.4S, v18.8H, v26.8H            // ...........................................................................*...............................
        smlal2 v1.4S, v13.8H, v4.8H             // ............................................................................*..............................
        smlal v9.4S, v28.4H, v20.4H             // .............................................................................*.............................
        smlal v31.4S, v14.4H, v3.4H             // ..............................................................................*............................
        uzp1 v13.8H, v10.8H, v7.8H              // ...............................................................................*...........................
        smlal2 v1.4S, v14.8H, v3.8H             // ................................................................................*..........................
        smlal v9.4S, v18.4H, v26.4H             // .................................................................................*.........................
        smlal v31.4S, v15.4H, v24.4H            // ..................................................................................*........................
        smlal2 v6.4S, v19.8H, v25.8H            // ...................................................................................*.......................
        smlal2 v1.4S, v15.8H, v24.8H            // ....................................................................................*......................
        smlal v9.4S, v19.4H, v25.4H             // .....................................................................................*.....................
        smlal v31.4S, v16.4H, v23.4H            // ......................................................................................*....................
        mul v13.8H, v13.8H, v2.H[2]             // .......................................................................................*...................
        smlal2 v1.4S, v16.8H, v23.8H            // ........................................................................................*..................
        uzp1 v23.8H, v9.8H, v6.8H               // .........................................................................................*.................
        smlal2 v29.4S, v17.8H, v0.8H            // ..........................................................................................*................
        mul v12.8H, v23.8H, v2.H[2]             // ...........................................................................................*...............
        uzp1 v4.8H, v31.8H, v1.8H               // ............................................................................................*..............
        smlal v10.4S, v13.4H, v0.4H             // .............................................................................................*.............
        mul v23.8H, v4.8H, v2.H[2]              // ..............................................................................................*............
        smlal v9.4S, v12.4H, v0.4H              // ...............................................................................................*...........
        smlal2 v7.4S, v13.8H, v0.8H             // ................................................................................................*..........
        smlal2 v6.4S, v12.8H, v0.8H             // .................................................................................................*.........
        smlal v31.4S, v23.4H, v0.4H             // ..................................................................................................*........
        smlal2 v1.4S, v23.8H, v0.8H             // ...................................................................................................*.......
        uzp2 v12.8H, v10.8H, v7.8H              // ....................................................................................................*......
        uzp2 v25.8H, v9.8H, v6.8H               // .....................................................................................................*.....
        uzp2 v24.8H, v11.8H, v29.8H             // ......................................................................................................*....
        uzp2 v13.8H, v31.8H, v1.8H              // .......................................................................................................*...
        st2 {v24.8H, v25.8H}, [x0], #32         // ........................................................................................................*..
        st2 {v12.8H, v13.8H}, [x0], #32         // ..........................................................................................................*

                                                 // -------------------------------------------- cycle (expected) -------------------------------------------->
                                                 // 0                        25                       50                       75                       100
                                                 // |------------------------|------------------------|------------------------|------------------------|------
        // ld2 {v13.8H, v14.8H}, [x4], #32       // *..........................................................................................................
        // ld1 {v15.8H}, [x6], #16               // ..*........................................................................................................
        // smlal2 v29.4S, v13.8H, v16.8H         // ....*......................................................................................................
        // smlal v9.4S, v13.4H, v17.4H           // .......................*...................................................................................
        // smlal2 v6.4S, v13.8H, v17.8H          // ...........................................*...............................................................
        // smlal v11.4S, v13.4H, v16.4H          // .....*.....................................................................................................
        // smlal2 v29.4S, v14.8H, v15.8H         // ........*..................................................................................................
        // smlal v9.4S, v14.4H, v16.4H           // ...........................*...............................................................................
        // smlal2 v6.4S, v14.8H, v16.8H          // ...................................................*.......................................................
        // ld1 {v30.8H}, [x9], #16               // ..........*................................................................................................
        // smlal v9.4S, v27.4H, v21.4H           // ...............................................................*...........................................
        // smlal2 v6.4S, v27.8H, v21.8H          // .................................................................*.........................................
        // smlal v11.4S, v14.4H, v15.4H          // .........*.................................................................................................
        // smlal2 v29.4S, v27.8H, v20.8H         // ............*..............................................................................................
        // smlal v9.4S, v28.4H, v20.4H           // .............................................................................*.............................
        // smlal2 v6.4S, v28.8H, v20.8H          // .......................................................................*...................................
        // smlal v11.4S, v27.4H, v20.4H          // .............*.............................................................................................
        // smlal2 v29.4S, v28.8H, v30.8H         // ................*..........................................................................................
        // smlal v9.4S, v18.4H, v26.4H           // .................................................................................*.........................
        // smlal2 v6.4S, v18.8H, v26.8H          // ...........................................................................*...............................
        // smlal v11.4S, v28.4H, v30.4H          // .................*.........................................................................................
        // smlal2 v29.4S, v18.8H, v25.8H         // ....................*......................................................................................
        // smlal v9.4S, v19.4H, v25.4H           // .....................................................................................*.....................
        // smlal2 v6.4S, v19.8H, v25.8H          // ...................................................................................*.......................
        // ld1 {v23.8H}, [x12], #16              // ..................*........................................................................................
        // smlal v11.4S, v18.4H, v25.4H          // .....................*.....................................................................................
        // uzp1 v14.8H, v9.8H, v6.8H             // .........................................................................................*.................
        // smlal2 v29.4S, v19.8H, v23.8H         // ........................*..................................................................................
        // mul v27.8H, v14.8H, v2.H[2]           // ...........................................................................................*...............
        // smlal v11.4S, v19.4H, v23.4H          // .........................*.................................................................................
        // ld2 {v4.8H, v5.8H}, [x2], #32         // ..............*............................................................................................
        // smlal v9.4S, v27.4H, v0.4H            // ...............................................................................................*...........
        // smlal2 v6.4S, v27.8H, v0.8H           // .................................................................................................*.........
        // ld2 {v27.8H, v28.8H}, [x7], #32       // ..............................................*............................................................
        // uzp1 v13.8H, v11.8H, v29.8H           // ..........................................*................................................................
        // uzp2 v15.8H, v9.8H, v6.8H             // .....................................................................................................*.....
        // mul v13.8H, v13.8H, v2.H[2]           // ................................................*..........................................................
        // ld2 {v18.8H, v19.8H}, [x10], #32      // ............................................................*..............................................
        // smull v9.4S, v7.4H, v5.4H             // ..........................*................................................................................
        // smlal v11.4S, v13.4H, v0.4H           // ....................................................*......................................................
        // smlal2 v29.4S, v13.8H, v0.8H          // ..........................................................................................*................
        // ld2 {v20.8H, v21.8H}, [x8], #32       // .....................................................*.....................................................
        // smlal v9.4S, v8.4H, v4.4H             // ..............................*............................................................................
        // uzp2 v14.8H, v11.8H, v29.8H           // ......................................................................................................*....
        // smull2 v29.4S, v7.8H, v4.8H           // .........................................*.................................................................
        // smull2 v6.4S, v7.8H, v5.8H            // ......................*....................................................................................
        // ld2 {v25.8H, v26.8H}, [x11], #32      // .................................*.........................................................................
        // smull v11.4S, v7.4H, v4.4H            // ............................*..............................................................................
        // smlal2 v6.4S, v8.8H, v4.8H            // .............................*.............................................................................
        // smlal2 v29.4S, v8.8H, v3.8H           // .............................................*.............................................................
        // ld2 {v16.8H, v17.8H}, [x5], #32       // ......*....................................................................................................
        // smlal v11.4S, v8.4H, v3.4H            // ........................................*..................................................................
        // st2 {v14.8H, v15.8H}, [x0], #32       // ........................................................................................................*..
        // ld2 {v13.8H, v14.8H}, [x4], #32       // ...............................*...........................................................................
        // ld1 {v15.8H}, [x6], #16               // .....................................*.....................................................................
        // smlal2 v29.4S, v13.8H, v16.8H         // .................................................*.........................................................
        // smlal v9.4S, v13.4H, v17.4H           // ....................................*......................................................................
        // smlal2 v6.4S, v13.8H, v17.8H          // ...................................*.......................................................................
        // smlal v11.4S, v13.4H, v16.4H          // ............................................*..............................................................
        // smlal2 v29.4S, v14.8H, v15.8H         // .......................................................*...................................................
        // smlal v9.4S, v14.4H, v16.4H           // ......................................................................*....................................
        // smlal2 v6.4S, v14.8H, v16.8H          // .......................................*...................................................................
        // ld1 {v30.8H}, [x9], #16               // ........................................................*..................................................
        // smlal v9.4S, v27.4H, v21.4H           // ..........................................................................*................................
        // smlal2 v6.4S, v27.8H, v21.8H          // ............................................................................*..............................
        // smlal v11.4S, v14.4H, v15.4H          // ..................................................*........................................................
        // smlal2 v29.4S, v27.8H, v20.8H         // ...........................................................*...............................................
        // smlal v9.4S, v28.4H, v20.4H           // ..............................................................................*............................
        // smlal2 v6.4S, v28.8H, v20.8H          // ................................................................................*..........................
        // smlal v11.4S, v27.4H, v20.4H          // ..........................................................*................................................
        // smlal2 v29.4S, v28.8H, v30.8H         // ................................................................*..........................................
        // smlal v9.4S, v18.4H, v26.4H           // ..................................................................................*........................
        // smlal2 v6.4S, v18.8H, v26.8H          // ....................................................................................*......................
        // smlal v11.4S, v28.4H, v30.4H          // ..............................................................*............................................
        // smlal2 v29.4S, v18.8H, v25.8H         // .....................................................................*.....................................
        // smlal v9.4S, v19.4H, v25.4H           // ......................................................................................*....................
        // smlal2 v6.4S, v19.8H, v25.8H          // ........................................................................................*..................
        // ld1 {v23.8H}, [x12], #16              // ...................................................................*.......................................
        // smlal v11.4S, v18.4H, v25.4H          // ..................................................................*........................................
        // uzp1 v14.8H, v9.8H, v6.8H             // ............................................................................................*..............
        // smlal2 v29.4S, v19.8H, v23.8H         // .........................................................................*.................................
        // mul v27.8H, v14.8H, v2.H[2]           // ..............................................................................................*............
        // smlal v11.4S, v19.4H, v23.4H          // ........................................................................*..................................
        // smlal v9.4S, v27.4H, v0.4H            // ..................................................................................................*........
        // smlal2 v6.4S, v27.8H, v0.8H           // ...................................................................................................*.......
        // uzp1 v13.8H, v11.8H, v29.8H           // ...............................................................................*...........................
        // uzp2 v15.8H, v9.8H, v6.8H             // .......................................................................................................*...
        // mul v13.8H, v13.8H, v2.H[2]           // .......................................................................................*...................
        // smlal v11.4S, v13.4H, v0.4H           // .............................................................................................*.............
        // smlal2 v29.4S, v13.8H, v0.8H          // ................................................................................................*..........
        // uzp2 v14.8H, v11.8H, v29.8H           // ....................................................................................................*......
        // st2 {v14.8H, v15.8H}, [x0], #32       // ..........................................................................................................*


        pop_stack
        ret
#endif /* KYBER_K == 4 */

#endif /* MLKEM_USE_NATIVE_AARCH64 */
