// SPDX-License-Identifier: Apache-2.0
//
// AArch64 re-implementation of the asymmetric base multiplication from:
//
// Neon NTT: Faster Dilithium, Kyber, and Saber on Cortex-A72 and Apple M1
// https://eprint.iacr.org/2021/986
// https://github.com/neon-ntt/neon-ntt

#include "config.h"
#if defined(MLKEM_USE_NATIVE_AARCH64)

#include "params.h"

// Needed to provide ASM_LOAD directive
#include "common.i"

.macro barrett_reduce a
        sqdmulh t0.8h, \a\().8h, consts.h[1]
        srshr   t0.8h, t0.8h, #11
        mls     \a\().8h, t0.8h, consts.h[0]
.endm

// Input:
// - Vectors al, ah of 32-bit entries
// Output:
// - Montgomery reductions of al || ah, stored in al
.macro montgomery_reduce_long x, a
        uzp1   t0.8h, \a\()l.8h, \a\()h.8h
        mul    t0.8h, t0.8h, consts.h[2]
        smlal  \a\()l.4s, t0.4h, constN.4h
        smlal2 \a\()h.4s, t0.8h, constN.8h
        uzp2   \x\().8h, \a\()l.8h, \a\()h.8h
.endm

// Computes products (a0*b0 + a0*b0t, a0*b1 + a1*b0) in 32-bit.
.macro pmull d, a, b
        smull  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smull2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smull  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smull2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro pmlal d, a, b
        smlal  \d\()0l.4s, \a\()0.4h, \b\()0.4h
        smlal2 \d\()0h.4s, \a\()0.8h, \b\()0.8h
        smlal  \d\()0l.4s, \a\()1.4h, \b\()1t.4h
        smlal2 \d\()0h.4s, \a\()1.8h, \b\()1t.8h

        smlal  \d\()1l.4s, \a\()0.4h, \b\()1.4h
        smlal2 \d\()1h.4s, \a\()0.8h, \b\()1.8h
        smlal  \d\()1l.4s, \a\()1.4h, \b\()0.4h
        smlal2 \d\()1h.4s, \a\()1.8h, \b\()0.8h
.endm

.macro load_polys a, b, a_ptr, b_ptr, b_cache_ptr
        ld2 {\a\()0.8h, \a\()1.8h}, [\a_ptr],       #32
        ld2 {\b\()0.8h, \b\()1.8h}, [\b_ptr],       #32
        ld1 {\b\()1t.8h},           [\b_cache_ptr], #16
.endm

.macro save_vregs
        sub sp, sp, #(16*4)
        stp  d8,  d9, [sp, #16*0]
        stp d10, d11, [sp, #16*1]
        stp d12, d13, [sp, #16*2]
        stp d14, d15, [sp, #16*3]
.endm

.macro restore_vregs
        ldp  d8,  d9, [sp, #16*0]
        ldp d10, d11, [sp, #16*1]
        ldp d12, d13, [sp, #16*2]
        ldp d14, d15, [sp, #16*3]
        add sp, sp, #(16*4)
.endm

.macro push_stack
        save_vregs
.endm

.macro pop_stack
        restore_vregs
.endm

        out          .req x0
        a0_ptr       .req x1
        b0_ptr       .req x2
        b0_cache_ptr .req x3
        a1_ptr       .req x4
        b1_ptr       .req x5
        b1_cache_ptr .req x6
        a2_ptr       .req x7
        b2_ptr       .req x8
        b2_cache_ptr .req x9
        a3_ptr       .req x10
        b3_ptr       .req x11
        b3_cache_ptr .req x12

        count        .req x13
        xtmp         .req x14
        modulus      .req w15

        constN    .req v0
        constX    .req v1
        consts    .req v2

        aa0      .req v3
        aa1      .req v4
        bb0      .req v5
        bb1      .req v6
        bb1t     .req v7

        res0l   .req v8
        res1l   .req v9
        res0h   .req v10
        res1h   .req v11

        out0 .req v26
        out1 .req v27

        t0   .req v28

.p2align 4
const_addr:
        .short 3329
        .short 20159
        .short 3327
        .short 0
        .short 0
        .short 0
        .short 0
        .short 0

#if KYBER_K == 2

.global polyvec_basemul_acc_montgomery_cached_asm_k2_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k2_opt

polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k2_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)

        mov count, #(KYBER_N / 16)
                                               // Instructions:    15
                                               // Expected cycles: 30
                                               // Expected IPC:    0.50

                                               // Cycle bound:     30.0
                                               // IPC bound:       0.50

                                               // Wall time:     0.02s
                                               // User time:     0.02s

                                               // ----- cycle (expected) ------>
                                               // 0                        25
                                               // |------------------------|----
        ld1 {v29.8H}, [x3], #16                // *.............................
        ld2 {v15.8H, v16.8H}, [x1], #32        // ..*...........................
        ld2 {v17.8H, v18.8H}, [x2], #32        // ......*.......................
        ld2 {v7.8H, v8.8H}, [x4], #32          // ..........*...................
        smull v1.4S, v15.4H, v17.4H            // ..............*...............
        smull2 v30.4S, v15.8H, v17.8H          // ...............*..............
        ld2 {v11.8H, v12.8H}, [x5], #32        // ................*.............
        smlal2 v30.4S, v16.8H, v29.8H          // ....................*.........
        smlal v1.4S, v16.4H, v29.4H            // .....................*........
        ld1 {v6.8H}, [x6], #16                 // ......................*.......
        smlal2 v30.4S, v7.8H, v11.8H           // ........................*.....
        smlal v1.4S, v7.4H, v11.4H             // .........................*....
        smull2 v14.4S, v15.8H, v18.8H          // ..........................*...
        smlal2 v30.4S, v8.8H, v6.8H            // ............................*.
        smlal v1.4S, v8.4H, v6.4H              // .............................*

                                                // ------ cycle (expected) ------>
                                                // 0                        25
                                                // |------------------------|-----
        // ld1 {v9.8H}, [x3], #16                 // *..............................
        // ld1 {v20.8H}, [x6], #16                // ......................*........
        // ld2 {v15.8H, v16.8H}, [x1], #32        // ..*............................
        // ld2 {v17.8H, v18.8H}, [x2], #32        // ......*........................
        // smull v1.4S, v15.4H, v17.4H            // ..............*................
        // smull2 v30.4S, v15.8H, v17.8H          // ...............*...............
        // ld2 {v7.8H, v8.8H}, [x4], #32          // ..........*....................
        // ld2 {v11.8H, v12.8H}, [x5], #32        // ................*..............
        // smlal v1.4S, v16.4H, v9.4H             // .....................*.........
        // smlal2 v30.4S, v16.8H, v9.8H           // ....................*..........
        // smlal v1.4S, v7.4H, v11.4H             // .........................*.....
        // smlal2 v30.4S, v7.8H, v11.8H           // ........................*......
        // smull2 v14.4S, v15.8H, v18.8H          // ..........................*....
        // smlal v1.4S, v8.4H, v20.4H             // .............................*.
        // smlal2 v30.4S, v8.8H, v20.8H           // ............................*..

        sub count, count, #1
k2_loop_start:
                                               // Instructions:    39
                                               // Expected cycles: 54
                                               // Expected IPC:    0.72

                                               // Cycle bound:     53.0
                                               // IPC bound:       0.74

                                               // Wall time:     31.04s
                                               // User time:     31.04s

                                               // ----------------- cycle (expected) ------------------>
                                               // 0                        25                       50
                                               // |------------------------|------------------------|---
        ld1 {v9.8H}, [x3], #16                 // e.....................................................
        ld1 {v20.8H}, [x6], #16                // ..e...................................................
        smull v25.4S, v15.4H, v18.4H           // ....*.................................................
        uzp1 v10.8H, v1.8H, v30.8H             // .....*................................................
        smlal2 v14.4S, v16.8H, v17.8H          // ......*...............................................
        mul v19.8H, v10.8H, v2.H[2]            // .......*..............................................
        smlal v25.4S, v16.4H, v17.4H           // ........*.............................................
        ld2 {v15.8H, v16.8H}, [x1], #32        // .........e............................................
        smlal v1.4S, v19.4H, v0.4H             // .............*........................................
        smlal2 v30.4S, v19.8H, v0.8H           // ..............*.......................................
        smlal v25.4S, v7.4H, v12.4H            // ...............*......................................
        smlal2 v14.4S, v7.8H, v12.8H           // ................*.....................................
        ld2 {v17.8H, v18.8H}, [x2], #32        // .................e....................................
        smlal2 v14.4S, v8.8H, v11.8H           // .....................*................................
        smlal v25.4S, v8.4H, v11.4H            // ......................*...............................
        uzp2 v4.8H, v1.8H, v30.8H              // .......................*..............................
        smull v1.4S, v15.4H, v17.4H            // ........................e.............................
        smull2 v30.4S, v15.8H, v17.8H          // .........................e............................
        uzp1 v27.8H, v25.8H, v14.8H            // ..........................*...........................
        sqdmulh v22.8H, v4.8H, v2.H[1]         // ...........................*..........................
        mul v28.8H, v27.8H, v2.H[2]            // ............................*.........................
        ld2 {v7.8H, v8.8H}, [x4], #32          // .............................e........................
        smlal v25.4S, v28.4H, v0.4H            // .................................*....................
        smlal2 v14.4S, v28.8H, v0.8H           // ..................................*...................
        ld2 {v11.8H, v12.8H}, [x5], #32        // ...................................e..................
        uzp2 v5.8H, v25.8H, v14.8H             // .......................................*..............
        srshr v21.8H, v22.8H, #11              // ........................................*.............
        sqdmulh v22.8H, v5.8H, v2.H[1]         // .........................................*............
        smlal v1.4S, v16.4H, v9.4H             // ..........................................e...........
        smlal2 v30.4S, v16.8H, v9.8H           // ...........................................e..........
        mls v4.8H, v21.8H, v2.H[0]             // ............................................*.........
        srshr v10.8H, v22.8H, #11              // .............................................*........
        smlal v1.4S, v7.4H, v11.4H             // ..............................................e.......
        smlal2 v30.4S, v7.8H, v11.8H           // ...............................................e......
        mls v5.8H, v10.8H, v2.H[0]             // ................................................*.....
        smull2 v14.4S, v15.8H, v18.8H          // .................................................e....
        smlal v1.4S, v8.4H, v20.4H             // ..................................................e...
        smlal2 v30.4S, v8.8H, v20.8H           // ...................................................e..
        st2 {v4.8H, v5.8H}, [x0], #32          // ....................................................*.

                                                    // -------------------------------------------- cycle (expected) -------------------------------------------->
                                                    // 0                        25                       50                       75                       100
                                                    // |------------------------|------------------------|------------------------|------------------------|------
        // ld2 {v3.8h, v4.8h}, [x1],       #32        // .........e............................................'........~...........................................
        // ld2 {v5.8h, v6.8h}, [x2],       #32        // .................e....................................'................~...................................
        // ld1 {v7.8h},           [x3], #16           // e.....................................................~....................................................
        // smull  v8.4s, v3.4h, v5.4h                 // ........................e.............................'.......................~............................
        // smull2 v10.4s, v3.8h, v5.8h                // .........................e............................'........................~...........................
        // smlal  v8.4s, v4.4h, v7.4h                 // ..........................................e...........'.........................................~..........
        // smlal2 v10.4s, v4.8h, v7.8h                // ...........................................e..........'..........................................~.........
        // smull  v9.4s, v3.4h, v6.4h                 // ....~.................................................'...*................................................
        // smull2 v11.4s, v3.8h, v6.8h                // .................................................e....'................................................~...
        // smlal  v9.4s, v4.4h, v5.4h                 // ........~.............................................'.......*............................................
        // smlal2 v11.4s, v4.8h, v5.8h                // ......~...............................................'.....*..............................................
        // ld2 {v3.8h, v4.8h}, [x4],       #32        // .............................e........................'............................~.......................
        // ld2 {v5.8h, v6.8h}, [x5],       #32        // ...................................e..................'..................................~.................
        // ld1 {v7.8h},           [x6], #16           // ..e...................................................'.~..................................................
        // smlal  v8.4s, v3.4h, v5.4h                 // ..............................................e.......'.............................................~......
        // smlal2 v10.4s, v3.8h, v5.8h                // ...............................................e......'..............................................~.....
        // smlal  v8.4s, v4.4h, v7.4h                 // ..................................................e...'.................................................~..
        // smlal2 v10.4s, v4.8h, v7.8h                // ...................................................e..'..................................................~.
        // smlal  v9.4s, v3.4h, v6.4h                 // ...............~......................................'..............*.....................................
        // smlal2 v11.4s, v3.8h, v6.8h                // ................~.....................................'...............*....................................
        // smlal  v9.4s, v4.4h, v5.4h                 // ......................~...............................'.....................*..............................
        // smlal2 v11.4s, v4.8h, v5.8h                // .....................~................................'....................*...............................
        // uzp1   v28.8h, v8.8h, v10.8h               // .....~................................................'....*...............................................
        // mul    v28.8h, v28.8h, v2.h[2]             // .......~..............................................'......*.............................................
        // smlal  v8.4s, v28.4h, v0.4h                // .............~........................................'............*.......................................
        // smlal2 v10.4s, v28.8h, v0.8h               // ..............~.......................................'.............*......................................
        // uzp2   v26.8h, v8.8h, v10.8h               // .......................~..............................'......................*.............................
        // uzp1   v28.8h, v9.8h, v11.8h               // ..........................~...........................'.........................*..........................
        // mul    v28.8h, v28.8h, v2.h[2]             // ............................~.........................'...........................*........................
        // smlal  v9.4s, v28.4h, v0.4h                // .................................~....................'................................*...................
        // smlal2 v11.4s, v28.8h, v0.8h               // ..................................~...................'.................................*..................
        // uzp2   v27.8h, v9.8h, v11.8h               // .......................................~..............'......................................*.............
        // sqdmulh v28.8h, v26.8h, v2.h[1]            // ...........................~..........................'..........................*.........................
        // srshr   v28.8h, v28.8h, #11                // ........................................~.............'.......................................*............
        // mls     v26.8h, v28.8h, v2.h[0]            // ............................................~.........'...........................................*........
        // sqdmulh v28.8h, v27.8h, v2.h[1]            // .........................................~............'........................................*...........
        // srshr   v28.8h, v28.8h, #11                // .............................................~........'............................................*.......
        // mls     v27.8h, v28.8h, v2.h[0]            // ................................................~.....'...............................................*....
        // st2 {v26.8h, v27.8h}, [x0], #32            // ....................................................~.'...................................................*

        sub count, count, #1
        cbnz count, k2_loop_start
                                               // Instructions:    24
                                               // Expected cycles: 41
                                               // Expected IPC:    0.59

                                               // Cycle bound:     41.0
                                               // IPC bound:       0.59

                                               // Wall time:     0.14s
                                               // User time:     0.14s

                                               // ----------- cycle (expected) ----------->
                                               // 0                        25
                                               // |------------------------|---------------
        smull v28.4S, v15.4H, v18.4H           // *........................................
        smlal2 v14.4S, v16.8H, v17.8H          // .*.......................................
        uzp1 v6.8H, v1.8H, v30.8H              // ..*......................................
        smlal v28.4S, v16.4H, v17.4H           // ....*....................................
        mul v4.8H, v6.8H, v2.H[2]              // .....*...................................
        smlal2 v14.4S, v7.8H, v12.8H           // ......*..................................
        smlal v28.4S, v7.4H, v12.4H            // ........*................................
        smlal v1.4S, v4.4H, v0.4H              // .........*...............................
        smlal2 v30.4S, v4.8H, v0.8H            // ..........*..............................
        smlal2 v14.4S, v8.8H, v11.8H           // ...........*.............................
        smlal v28.4S, v8.4H, v11.4H            // ............*............................
        uzp2 v22.8H, v1.8H, v30.8H             // ..............*..........................
        uzp1 v4.8H, v28.8H, v14.8H             // ................*........................
        sqdmulh v8.8H, v22.8H, v2.H[1]         // .................*.......................
        mul v19.8H, v4.8H, v2.H[2]             // ..................*......................
        srshr v20.8H, v8.8H, #11               // .....................*...................
        smlal v28.4S, v19.4H, v0.4H            // ......................*..................
        smlal2 v14.4S, v19.8H, v0.8H           // .......................*.................
        mls v22.8H, v20.8H, v2.H[0]            // ........................*................
        uzp2 v23.8H, v28.8H, v14.8H            // ...........................*.............
        sqdmulh v19.8H, v23.8H, v2.H[1]        // .............................*...........
        srshr v30.8H, v19.8H, #11              // .................................*.......
        mls v23.8H, v30.8H, v2.H[0]            // ....................................*....
        st2 {v22.8H, v23.8H}, [x0], #32        // ........................................*

                                               // ----------- cycle (expected) ----------->
                                               // 0                        25
                                               // |------------------------|---------------
        // smull v25.4S, v15.4H, v18.4H          // *........................................
        // uzp1 v10.8H, v1.8H, v30.8H            // ..*......................................
        // smlal2 v14.4S, v16.8H, v17.8H         // .*.......................................
        // mul v19.8H, v10.8H, v2.H[2]           // .....*...................................
        // smlal v25.4S, v16.4H, v17.4H          // ....*....................................
        // smlal v1.4S, v19.4H, v0.4H            // .........*...............................
        // smlal2 v30.4S, v19.8H, v0.8H          // ..........*..............................
        // smlal v25.4S, v7.4H, v12.4H           // ........*................................
        // smlal2 v14.4S, v7.8H, v12.8H          // ......*..................................
        // smlal2 v14.4S, v8.8H, v11.8H          // ...........*.............................
        // smlal v25.4S, v8.4H, v11.4H           // ............*............................
        // uzp2 v4.8H, v1.8H, v30.8H             // ..............*..........................
        // uzp1 v27.8H, v25.8H, v14.8H           // ................*........................
        // sqdmulh v22.8H, v4.8H, v2.H[1]        // .................*.......................
        // mul v28.8H, v27.8H, v2.H[2]           // ..................*......................
        // smlal v25.4S, v28.4H, v0.4H           // ......................*..................
        // smlal2 v14.4S, v28.8H, v0.8H          // .......................*.................
        // uzp2 v5.8H, v25.8H, v14.8H            // ...........................*.............
        // srshr v21.8H, v22.8H, #11             // .....................*...................
        // sqdmulh v22.8H, v5.8H, v2.H[1]        // .............................*...........
        // mls v4.8H, v21.8H, v2.H[0]            // ........................*................
        // srshr v10.8H, v22.8H, #11             // .................................*.......
        // mls v5.8H, v10.8H, v2.H[0]            // ....................................*....
        // st2 {v4.8H, v5.8H}, [x0], #32         // ........................................*


        pop_stack
        ret
#endif /* KYBER_K == 2 */

#if KYBER_K == 3
.global polyvec_basemul_acc_montgomery_cached_asm_k3_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k3_opt

polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k3_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)

        mov count, #(KYBER_N / 16)
                                               // Instructions:    66
                                               // Expected cycles: 101
                                               // Expected IPC:    0.65

                                               // Cycle bound:     101.0
                                               // IPC bound:       0.65

                                               // Wall time:     1.16s
                                               // User time:     1.16s

                                               // ----------------------------------------- cycle (expected) ----------------------------------------->
                                               // 0                        25                       50                       75                       100
                                               // |------------------------|------------------------|------------------------|------------------------|
        ld1 {v3.8H}, [x3], #16                 // *....................................................................................................
        ld2 {v10.8H, v11.8H}, [x1], #32        // ..*..................................................................................................
        ld2 {v24.8H, v25.8H}, [x2], #32        // ......*..............................................................................................
        ld1 {v8.8H}, [x6], #16                 // ..........*..........................................................................................
        smull2 v28.4S, v10.8H, v24.8H          // ............*........................................................................................
        smull v21.4S, v10.4H, v24.4H           // .............*.......................................................................................
        smull2 v19.4S, v10.8H, v25.8H          // ..............*......................................................................................
        smull v10.4S, v10.4H, v25.4H           // ...............*.....................................................................................
        smlal2 v28.4S, v11.8H, v3.8H           // ................*....................................................................................
        smlal v21.4S, v11.4H, v3.4H            // .................*...................................................................................
        smlal2 v19.4S, v11.8H, v24.8H          // ..................*..................................................................................
        smlal v10.4S, v11.4H, v24.4H           // ...................*.................................................................................
        ld1 {v3.8H}, [x9], #16                 // ....................*................................................................................
        ld2 {v25.8H, v26.8H}, [x4], #32        // ......................*..............................................................................
        ld2 {v22.8H, v23.8H}, [x5], #32        // ..........................*..........................................................................
        ld1 {v12.8H}, [x3], #16                // ..............................*......................................................................
        smlal v21.4S, v25.4H, v22.4H           // ................................*....................................................................
        smlal2 v28.4S, v25.8H, v22.8H          // .................................*...................................................................
        smlal2 v19.4S, v25.8H, v23.8H          // ..................................*..................................................................
        smlal v10.4S, v25.4H, v23.4H           // ...................................*.................................................................
        smlal v21.4S, v26.4H, v8.4H            // ....................................*................................................................
        smlal2 v28.4S, v26.8H, v8.8H           // .....................................*...............................................................
        smlal2 v19.4S, v26.8H, v22.8H          // ......................................*..............................................................
        smlal v10.4S, v26.4H, v22.4H           // .......................................*.............................................................
        ld1 {v8.8H}, [x6], #16                 // ........................................*............................................................
        ld2 {v23.8H, v24.8H}, [x7], #32        // ..........................................*..........................................................
        ld2 {v17.8H, v18.8H}, [x8], #32        // ..............................................*......................................................
        ld2 {v25.8H, v26.8H}, [x4], #32        // ..................................................*..................................................
        smlal v21.4S, v23.4H, v17.4H           // ......................................................*..............................................
        smlal2 v28.4S, v23.8H, v17.8H          // .......................................................*.............................................
        smlal2 v19.4S, v23.8H, v18.8H          // ........................................................*............................................
        smlal v10.4S, v23.4H, v18.4H           // .........................................................*...........................................
        smlal v21.4S, v24.4H, v3.4H            // ..........................................................*..........................................
        smlal2 v28.4S, v24.8H, v3.8H           // ...........................................................*.........................................
        smlal2 v19.4S, v24.8H, v17.8H          // ............................................................*........................................
        ld2 {v13.8H, v14.8H}, [x1], #32        // .............................................................*.......................................
        uzp1 v3.8H, v21.8H, v28.8H             // .................................................................*...................................
        smlal v10.4S, v24.4H, v17.4H           // ..................................................................*..................................
        ld2 {v22.8H, v23.8H}, [x2], #32        // ...................................................................*.................................
        uzp1 v18.8H, v10.8H, v19.8H            // .......................................................................*.............................
        mul v3.8H, v3.8H, v2.H[2]              // ........................................................................*............................
        mul v18.8H, v18.8H, v2.H[2]            // .........................................................................*...........................
        smull v4.4S, v13.4H, v22.4H            // ..........................................................................*..........................
        smull v17.4S, v13.4H, v23.4H           // ...........................................................................*.........................
        smlal v21.4S, v3.4H, v0.4H             // ............................................................................*........................
        smlal2 v19.4S, v18.8H, v0.8H           // .............................................................................*.......................
        smlal v10.4S, v18.4H, v0.4H            // ..............................................................................*......................
        smlal2 v28.4S, v3.8H, v0.8H            // ...............................................................................*.....................
        smlal v4.4S, v14.4H, v12.4H            // ................................................................................*....................
        smlal v17.4S, v14.4H, v22.4H           // .................................................................................*...................
        uzp2 v6.8H, v10.8H, v19.8H             // ..................................................................................*..................
        smull2 v10.4S, v13.8H, v22.8H          // ...................................................................................*.................
        uzp2 v5.8H, v21.8H, v28.8H             // ....................................................................................*................
        smull2 v19.4S, v13.8H, v23.8H          // .....................................................................................*...............
        sqdmulh v3.8H, v5.8H, v2.H[1]          // ......................................................................................*..............
        smlal2 v10.4S, v14.8H, v12.8H          // .......................................................................................*.............
        ld2 {v15.8H, v16.8H}, [x5], #32        // ........................................................................................*............
        smlal2 v19.4S, v14.8H, v22.8H          // ............................................................................................*........
        srshr v3.8H, v3.8H, #11                // .............................................................................................*.......
        smlal v4.4S, v25.4H, v15.4H            // ..............................................................................................*......
        smlal2 v10.4S, v25.8H, v15.8H          // ...............................................................................................*.....
        sqdmulh v7.8H, v6.8H, v2.H[1]          // ................................................................................................*....
        mls v5.8H, v3.8H, v2.H[0]              // .................................................................................................*...
        smlal v4.4S, v26.4H, v8.4H             // ..................................................................................................*..
        smlal2 v10.4S, v26.8H, v8.8H           // ...................................................................................................*.
        ld2 {v12.8H, v13.8H}, [x7], #32        // ....................................................................................................*

                                                // ----------------------------------------- cycle (expected) ----------------------------------------->
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|-------------------------
        // ld2 {v25.8H, v26.8H}, [x4], #32       // ......................*..............................................................................
        // ld2 {v28.8H, v29.8H}, [x1], #32       // ..*..................................................................................................
        // ld2 {v22.8H, v23.8H}, [x2], #32       // ......*..............................................................................................
        // smull2 v10.4S, v28.8H, v22.8H         // ............*........................................................................................
        // smull2 v19.4S, v28.8H, v23.8H         // ..............*......................................................................................
        // smull v4.4S, v28.4H, v22.4H           // .............*.......................................................................................
        // ld1 {v1.8H}, [x3], #16                // *....................................................................................................
        // smlal2 v19.4S, v29.8H, v22.8H         // ..................*..................................................................................
        // smull v17.4S, v28.4H, v23.4H          // ...............*.....................................................................................
        // smlal v4.4S, v29.4H, v1.4H            // .................*...................................................................................
        // ld2 {v15.8H, v16.8H}, [x5], #32       // ..........................*..........................................................................
        // smlal2 v10.4S, v29.8H, v1.8H          // ................*....................................................................................
        // smlal v17.4S, v29.4H, v22.4H          // ...................*.................................................................................
        // smlal v4.4S, v25.4H, v15.4H           // ................................*....................................................................
        // smlal2 v10.4S, v25.8H, v15.8H         // .................................*...................................................................
        // ld1 {v29.8H}, [x6], #16               // ..........*..........................................................................................
        // smlal2 v10.4S, v26.8H, v29.8H         // .....................................*...............................................................
        // ld2 {v12.8H, v13.8H}, [x7], #32       // ..........................................*..........................................................
        // smlal v4.4S, v26.4H, v29.4H           // ....................................*................................................................
        // smlal2 v19.4S, v25.8H, v16.8H         // ..................................*..................................................................
        // smlal v17.4S, v25.4H, v16.4H          // ...................................*.................................................................
        // ld2 {v20.8H, v21.8H}, [x8], #32       // ..............................................*......................................................
        // smlal2 v19.4S, v26.8H, v15.8H         // ......................................*..............................................................
        // smlal v17.4S, v26.4H, v15.4H          // .......................................*.............................................................
        // smlal v4.4S, v12.4H, v20.4H           // ......................................................*..............................................
        // smlal2 v10.4S, v12.8H, v20.8H         // .......................................................*.............................................
        // smlal2 v19.4S, v12.8H, v21.8H         // ........................................................*............................................
        // smlal v17.4S, v12.4H, v21.4H          // .........................................................*...........................................
        // ld1 {v29.8H}, [x9], #16               // ....................*................................................................................
        // smlal2 v19.4S, v13.8H, v20.8H         // ............................................................*........................................
        // smlal v17.4S, v13.4H, v20.4H          // ..................................................................*..................................
        // smlal v4.4S, v13.4H, v29.4H           // ..........................................................*..........................................
        // smlal2 v10.4S, v13.8H, v29.8H         // ...........................................................*.........................................
        // uzp1 v6.8H, v17.8H, v19.8H            // .......................................................................*.............................
        // uzp1 v14.8H, v4.8H, v10.8H            // .................................................................*...................................
        // mul v7.8H, v6.8H, v2.H[2]             // .........................................................................*...........................
        // mul v1.8H, v14.8H, v2.H[2]            // ........................................................................*............................
        // ld2 {v25.8H, v26.8H}, [x4], #32       // ..................................................*..................................................
        // smlal v4.4S, v1.4H, v0.4H             // ............................................................................*........................
        // smlal2 v19.4S, v7.8H, v0.8H           // .............................................................................*.......................
        // smlal v17.4S, v7.4H, v0.4H            // ..............................................................................*......................
        // smlal2 v10.4S, v1.8H, v0.8H           // ...............................................................................*.....................
        // ld2 {v28.8H, v29.8H}, [x1], #32       // .............................................................*.......................................
        // ld2 {v22.8H, v23.8H}, [x2], #32       // ...................................................................*.................................
        // uzp2 v6.8H, v17.8H, v19.8H            // ..................................................................................*..................
        // uzp2 v5.8H, v4.8H, v10.8H             // ....................................................................................*................
        // smull2 v10.4S, v28.8H, v22.8H         // ...................................................................................*.................
        // smull2 v19.4S, v28.8H, v23.8H         // .....................................................................................*...............
        // smull v4.4S, v28.4H, v22.4H           // ..........................................................................*..........................
        // ld1 {v1.8H}, [x3], #16                // ..............................*......................................................................
        // smlal2 v19.4S, v29.8H, v22.8H         // ............................................................................................*........
        // smull v17.4S, v28.4H, v23.4H          // ...........................................................................*.........................
        // smlal v4.4S, v29.4H, v1.4H            // ................................................................................*....................
        // ld2 {v15.8H, v16.8H}, [x5], #32       // ........................................................................................*............
        // smlal2 v10.4S, v29.8H, v1.8H          // .......................................................................................*.............
        // smlal v17.4S, v29.4H, v22.4H          // .................................................................................*...................
        // smlal v4.4S, v25.4H, v15.4H           // ..............................................................................................*......
        // sqdmulh v27.8H, v5.8H, v2.H[1]        // ......................................................................................*..............
        // smlal2 v10.4S, v25.8H, v15.8H         // ...............................................................................................*.....
        // ld1 {v29.8H}, [x6], #16               // ........................................*............................................................
        // srshr v3.8H, v27.8H, #11              // .............................................................................................*.......
        // sqdmulh v7.8H, v6.8H, v2.H[1]         // ................................................................................................*....
        // smlal2 v10.4S, v26.8H, v29.8H         // ...................................................................................................*.
        // mls v5.8H, v3.8H, v2.H[0]             // .................................................................................................*...
        // ld2 {v12.8H, v13.8H}, [x7], #32       // ....................................................................................................*
        // smlal v4.4S, v26.4H, v29.4H           // ..................................................................................................*..

        sub count, count, #2
k3_loop_start:
                                               // Instructions:    50
                                               // Expected cycles: 72
                                               // Expected IPC:    0.69

                                               // Cycle bound:     71.0
                                               // IPC bound:       0.70

                                               // Wall time:     28.72s
                                               // User time:     28.72s

                                               // -------------------------- cycle (expected) --------------------------->
                                               // 0                        25                       50
                                               // |------------------------|------------------------|---------------------
        srshr v28.8H, v7.8H, #11               // l.......................................................................
        smlal2 v19.4S, v25.8H, v16.8H          // .*......................................................................
        smlal v17.4S, v25.4H, v16.4H           // ..*.....................................................................
        mls v6.8H, v28.8H, v2.H[0]             // ...l....................................................................
        ld2 {v20.8H, v21.8H}, [x8], #32        // ....*...................................................................
        smlal2 v19.4S, v26.8H, v15.8H          // ........*...............................................................
        smlal v17.4S, v26.4H, v15.4H           // .........*..............................................................
        smlal v4.4S, v12.4H, v20.4H            // ..........*.............................................................
        smlal2 v10.4S, v12.8H, v20.8H          // ...........*............................................................
        smlal2 v19.4S, v12.8H, v21.8H          // ............*...........................................................
        smlal v17.4S, v12.4H, v21.4H           // .............*..........................................................
        ld1 {v29.8H}, [x9], #16                // ..............*.........................................................
        smlal2 v19.4S, v13.8H, v20.8H          // ................*.......................................................
        smlal v17.4S, v13.4H, v20.4H           // .................*......................................................
        smlal v4.4S, v13.4H, v29.4H            // ..................*.....................................................
        smlal2 v10.4S, v13.8H, v29.8H          // ...................*....................................................
        st2 {v5.8H, v6.8H}, [x0], #32          // ....................l...................................................
        uzp1 v6.8H, v17.8H, v19.8H             // ......................*.................................................
        uzp1 v14.8H, v4.8H, v10.8H             // .......................*................................................
        mul v7.8H, v6.8H, v2.H[2]              // ........................*...............................................
        mul v1.8H, v14.8H, v2.H[2]             // .........................*..............................................
        ld2 {v25.8H, v26.8H}, [x4], #32        // ..........................e.............................................
        smlal v4.4S, v1.4H, v0.4H              // ..............................*.........................................
        smlal2 v19.4S, v7.8H, v0.8H            // ...............................*........................................
        smlal v17.4S, v7.4H, v0.4H             // ................................*.......................................
        smlal2 v10.4S, v1.8H, v0.8H            // .................................*......................................
        ld2 {v28.8H, v29.8H}, [x1], #32        // ..................................e.....................................
        ld2 {v22.8H, v23.8H}, [x2], #32        // ......................................e.................................
        uzp2 v6.8H, v17.8H, v19.8H             // ..........................................*.............................
        uzp2 v5.8H, v4.8H, v10.8H              // ...........................................*............................
        smull2 v10.4S, v28.8H, v22.8H          // ............................................e...........................
        smull2 v19.4S, v28.8H, v23.8H          // .............................................e..........................
        smull v4.4S, v28.4H, v22.4H            // ..............................................e.........................
        ld1 {v1.8H}, [x3], #16                 // ...............................................e........................
        smlal2 v19.4S, v29.8H, v22.8H          // .................................................e......................
        smull v17.4S, v28.4H, v23.4H           // ..................................................e.....................
        smlal v4.4S, v29.4H, v1.4H             // ...................................................e....................
        ld2 {v15.8H, v16.8H}, [x5], #32        // ....................................................e...................
        smlal2 v10.4S, v29.8H, v1.8H           // ........................................................e...............
        smlal v17.4S, v29.4H, v22.4H           // .........................................................e..............
        smlal v4.4S, v25.4H, v15.4H            // ..........................................................e.............
        sqdmulh v27.8H, v5.8H, v2.H[1]         // ...........................................................*............
        smlal2 v10.4S, v25.8H, v15.8H          // ............................................................e...........
        ld1 {v29.8H}, [x6], #16                // .............................................................e..........
        srshr v3.8H, v27.8H, #11               // ...............................................................*........
        sqdmulh v7.8H, v6.8H, v2.H[1]          // ................................................................*.......
        smlal2 v10.4S, v26.8H, v29.8H          // .................................................................e......
        mls v5.8H, v3.8H, v2.H[0]              // ..................................................................*.....
        ld2 {v12.8H, v13.8H}, [x7], #32        // ...................................................................e....
        smlal v4.4S, v26.4H, v29.4H            // .......................................................................e

                                                    // ------------------------------------------------------------ cycle (expected) ------------------------------------------------------------>
                                                    // 0                        25                       50                       75                       100                      125
                                                    // |------------------------|------------------------|------------------------|------------------------|------------------------|-------------
        // ld2 {v3.8h, v4.8h}, [x1],       #32       // ........e.....................................'.................................~.....................................'....................
        // ld2 {v5.8h, v6.8h}, [x2],       #32       // ............e.................................'.....................................~.................................'....................
        // ld1 {v7.8h},           [x3], #16          // .....................e........................'..............................................~........................'....................
        // smull  v8.4s, v3.4h, v5.4h                // ....................e.........................'.............................................~.........................'....................
        // smull2 v10.4s, v3.8h, v5.8h               // ..................e...........................'...........................................~...........................'....................
        // smlal  v8.4s, v4.4h, v7.4h                // .........................e....................'..................................................~....................'....................
        // smlal2 v10.4s, v4.8h, v7.8h               // ..............................e...............'.......................................................~...............'....................
        // smull  v9.4s, v3.4h, v6.4h                // ........................e.....................'.................................................~.....................'....................
        // smull2 v11.4s, v3.8h, v6.8h               // ...................e..........................'............................................~..........................'....................
        // smlal  v9.4s, v4.4h, v5.4h                // ...............................e..............'........................................................~..............'....................
        // smlal2 v11.4s, v4.8h, v5.8h               // .......................e......................'................................................~......................'....................
        // ld2 {v3.8h, v4.8h}, [x4],       #32       // e.............................................'.........................~.............................................'....................
        // ld2 {v5.8h, v6.8h}, [x5],       #32       // ..........................e...................'...................................................~...................'....................
        // ld1 {v7.8h},           [x6], #16          // ...................................e..........'............................................................~..........'....................
        // smlal  v8.4s, v3.4h, v5.4h                // ................................e.............'.........................................................~.............'....................
        // smlal2 v10.4s, v3.8h, v5.8h               // ..................................e...........'...........................................................~...........'....................
        // smlal  v8.4s, v4.4h, v7.4h                // .............................................e'......................................................................~'....................
        // smlal2 v10.4s, v4.8h, v7.8h               // .......................................e......'................................................................~......'....................
        // smlal  v9.4s, v3.4h, v6.4h                // ..............................................'.*.....................................................................'.~..................
        // smlal2 v11.4s, v3.8h, v6.8h               // ..............................................'*......................................................................'~...................
        // smlal  v9.4s, v4.4h, v5.4h                // ..............................................'........*..............................................................'........~...........
        // smlal2 v11.4s, v4.8h, v5.8h               // ..............................................'.......*...............................................................'.......~............
        // ld2 {v3.8h, v4.8h}, [x7],       #32       // .........................................e....'..................................................................~....'....................
        // ld2 {v5.8h, v6.8h}, [x8],       #32       // ..............................................'...*...................................................................'...~................
        // ld1 {v7.8h},           [x9], #16          // ..............................................'.............*.........................................................'.............~......
        // smlal  v8.4s, v3.4h, v5.4h                // ..............................................'.........*.............................................................'.........~..........
        // smlal2 v10.4s, v3.8h, v5.8h               // ..............................................'..........*............................................................'..........~.........
        // smlal  v8.4s, v4.4h, v7.4h                // ..............................................'.................*.....................................................'.................~..
        // smlal2 v10.4s, v4.8h, v7.8h               // ..............................................'..................*....................................................'..................~.
        // smlal  v9.4s, v3.4h, v6.4h                // ..............................................'............*..........................................................'............~.......
        // smlal2 v11.4s, v3.8h, v6.8h               // ..............................................'...........*...........................................................'...........~........
        // smlal  v9.4s, v4.4h, v5.4h                // ..............................................'................*......................................................'................~...
        // smlal2 v11.4s, v4.8h, v5.8h               // ..............................................'...............*.......................................................'...............~....
        // uzp1   v28.8h, v8.8h, v10.8h              // ..............................................'......................*................................................'....................
        // mul    v28.8h, v28.8h, v2.h[2]            // ..............................................'........................*..............................................'....................
        // smlal  v8.4s, v28.4h, v0.4h               // ....~.........................................'.............................*.........................................'....................
        // smlal2 v10.4s, v28.8h, v0.8h              // .......~......................................'................................*......................................'....................
        // uzp2   v26.8h, v8.8h, v10.8h              // .................~............................'..........................................*............................'....................
        // uzp1   v28.8h, v9.8h, v11.8h              // ..............................................'.....................*.................................................'....................
        // mul    v28.8h, v28.8h, v2.h[2]            // ..............................................'.......................*...............................................'....................
        // smlal  v9.4s, v28.4h, v0.4h               // ......~.......................................'...............................*.......................................'....................
        // smlal2 v11.4s, v28.8h, v0.8h              // .....~........................................'..............................*........................................'....................
        // uzp2   v27.8h, v9.8h, v11.8h              // ................~.............................'.........................................*.............................'....................
        // sqdmulh v28.8h, v26.8h, v2.h[1]           // .................................~............'..........................................................*............'....................
        // srshr   v28.8h, v28.8h, #11               // .....................................~........'..............................................................*........'....................
        // mls     v26.8h, v28.8h, v2.h[0]           // ........................................~.....'.................................................................*.....'....................
        // sqdmulh v28.8h, v27.8h, v2.h[1]           // ......................................~.......'...............................................................*.......'....................
        // srshr   v28.8h, v28.8h, #11               // ..............................................~.......................................................................l....................
        // mls     v27.8h, v28.8h, v2.h[0]           // ..............................................'..~....................................................................'..l.................
        // st2 {v26.8h, v27.8h}, [x0], #32           // ..............................................'...................~...................................................'...................l

        sub count, count, #1
        cbnz count, k3_loop_start
                                               // Instructions:    34
                                               // Expected cycles: 47
                                               // Expected IPC:    0.72

                                               // Cycle bound:     47.0
                                               // IPC bound:       0.72

                                               // Wall time:     0.16s
                                               // User time:     0.16s

                                               // -------------- cycle (expected) -------------->
                                               // 0                        25
                                               // |------------------------|---------------------
        smlal v17.4S, v25.4H, v16.4H           // *..............................................
        smlal2 v19.4S, v25.8H, v16.8H          // .*.............................................
        ld2 {v27.8H, v28.8H}, [x8], #32        // ..*............................................
        smlal2 v19.4S, v26.8H, v15.8H          // ......*........................................
        ld1 {v31.8H}, [x9], #16                // .......*.......................................
        smlal v17.4S, v26.4H, v15.4H           // .........*.....................................
        smlal2 v19.4S, v12.8H, v28.8H          // ..........*....................................
        smlal v4.4S, v12.4H, v27.4H            // ...........*...................................
        smlal2 v10.4S, v12.8H, v27.8H          // ............*..................................
        smlal v17.4S, v12.4H, v28.4H           // .............*.................................
        smlal2 v19.4S, v13.8H, v27.8H          // ..............*................................
        smlal v4.4S, v13.4H, v31.4H            // ...............*...............................
        smlal2 v10.4S, v13.8H, v31.8H          // ................*..............................
        smlal v17.4S, v13.4H, v27.4H           // .................*.............................
        srshr v3.8H, v7.8H, #11                // ..................*............................
        uzp1 v1.8H, v4.8H, v10.8H              // ....................*..........................
        uzp1 v24.8H, v17.8H, v19.8H            // .....................*.........................
        mul v7.8H, v1.8H, v2.H[2]              // ......................*........................
        mul v27.8H, v24.8H, v2.H[2]            // .......................*.......................
        mls v6.8H, v3.8H, v2.H[0]              // ........................*......................
        smlal2 v10.4S, v7.8H, v0.8H            // ..........................*....................
        smlal v17.4S, v27.4H, v0.4H            // ...........................*...................
        smlal2 v19.4S, v27.8H, v0.8H           // ............................*..................
        smlal v4.4S, v7.4H, v0.4H              // .............................*.................
        st2 {v5.8H, v6.8H}, [x0], #32          // ..............................*................
        uzp2 v24.8H, v17.8H, v19.8H            // ................................*..............
        uzp2 v23.8H, v4.8H, v10.8H             // .................................*.............
        sqdmulh v7.8H, v24.8H, v2.H[1]         // ..................................*............
        sqdmulh v30.8H, v23.8H, v2.H[1]        // ...................................*...........
        srshr v4.8H, v7.8H, #11                // ......................................*........
        srshr v7.8H, v30.8H, #11               // .......................................*.......
        mls v24.8H, v4.8H, v2.H[0]             // .........................................*.....
        mls v23.8H, v7.8H, v2.H[0]             // ..........................................*....
        st2 {v23.8H, v24.8H}, [x0], #32        // ..............................................*

                                                // -------------- cycle (expected) -------------->
                                                // 0                        25
                                                // |------------------------|---------------------
        // srshr v28.8H, v7.8H, #11              // ..................*............................
        // smlal2 v19.4S, v25.8H, v16.8H         // .*.............................................
        // smlal v17.4S, v25.4H, v16.4H          // *..............................................
        // mls v6.8H, v28.8H, v2.H[0]            // ........................*......................
        // ld2 {v20.8H, v21.8H}, [x8], #32       // ..*............................................
        // smlal2 v19.4S, v26.8H, v15.8H         // ......*........................................
        // smlal v17.4S, v26.4H, v15.4H          // .........*.....................................
        // smlal v4.4S, v12.4H, v20.4H           // ...........*...................................
        // smlal2 v10.4S, v12.8H, v20.8H         // ............*..................................
        // smlal2 v19.4S, v12.8H, v21.8H         // ..........*....................................
        // smlal v17.4S, v12.4H, v21.4H          // .............*.................................
        // ld1 {v29.8H}, [x9], #16               // .......*.......................................
        // smlal2 v19.4S, v13.8H, v20.8H         // ..............*................................
        // smlal v17.4S, v13.4H, v20.4H          // .................*.............................
        // smlal v4.4S, v13.4H, v29.4H           // ...............*...............................
        // smlal2 v10.4S, v13.8H, v29.8H         // ................*..............................
        // st2 {v5.8H, v6.8H}, [x0], #32         // ..............................*................
        // uzp1 v6.8H, v17.8H, v19.8H            // .....................*.........................
        // uzp1 v14.8H, v4.8H, v10.8H            // ....................*..........................
        // mul v7.8H, v6.8H, v2.H[2]             // .......................*.......................
        // mul v1.8H, v14.8H, v2.H[2]            // ......................*........................
        // smlal v4.4S, v1.4H, v0.4H             // .............................*.................
        // smlal2 v19.4S, v7.8H, v0.8H           // ............................*..................
        // smlal v17.4S, v7.4H, v0.4H            // ...........................*...................
        // smlal2 v10.4S, v1.8H, v0.8H           // ..........................*....................
        // uzp2 v6.8H, v17.8H, v19.8H            // ................................*..............
        // uzp2 v5.8H, v4.8H, v10.8H             // .................................*.............
        // sqdmulh v27.8H, v5.8H, v2.H[1]        // ...................................*...........
        // srshr v3.8H, v27.8H, #11              // .......................................*.......
        // sqdmulh v7.8H, v6.8H, v2.H[1]         // ..................................*............
        // mls v5.8H, v3.8H, v2.H[0]             // ..........................................*....
        // srshr v28.8H, v7.8H, #11              // ......................................*........
        // mls v6.8H, v28.8H, v2.H[0]            // .........................................*.....
        // st2 {v5.8H, v6.8H}, [x0], #32         // ..............................................*


        pop_stack
        ret
#endif /* KYBER_K == 3 */

#if KYBER_K == 4
.global polyvec_basemul_acc_montgomery_cached_asm_k4_opt
.global _polyvec_basemul_acc_montgomery_cached_asm_k4_opt

polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
_polyvec_basemul_acc_montgomery_cached_asm_k4_opt:
        push_stack

        ASM_LOAD(xtmp, const_addr)
        ld1 {consts.8h}, [xtmp]
        ldrsh modulus, [xtmp]
        dup constN.8h, modulus

        // Computed bases of vector entries

        add a1_ptr, a0_ptr, #(1 * 512)
        add b1_ptr, b0_ptr, #(1 * 512)
        add b1_cache_ptr, b0_cache_ptr, #(1 * 512/2)
        add a2_ptr, a0_ptr, #(2 * 512)
        add b2_ptr, b0_ptr, #(2 * 512)
        add b2_cache_ptr, b0_cache_ptr, #(2 * 512/2)
        add a3_ptr, a0_ptr, #(3 * 512)
        add b3_ptr, b0_ptr, #(3 * 512)
        add b3_cache_ptr, b0_cache_ptr, #(3 * 512/2)

        mov count, #(KYBER_N / 16)
                                                // Instructions:    45
                                                // Expected cycles: 74
                                                // Expected IPC:    0.61
                                                //
                                                // Cycle bound:     74.0
                                                // IPC bound:       0.61
                                                //
                                                // Wall time:     3.04s
                                                // User time:     3.04s
                                                //
                                                // --------------------------- cycle (expected) ---------------------------->
                                                // 0                        25                       50
                                                // |------------------------|------------------------|-----------------------
        ld2 {v12.8H, v13.8H}, [x2], #32         // *.........................................................................
        ld2 {v10.8H, v11.8H}, [x1], #32         // ....*.....................................................................
        ld1 {v29.8H}, [x3], #16                 // ........*.................................................................
        smull v1.4S, v10.4H, v12.4H             // ..........*...............................................................
        ld1 {v31.8H}, [x9], #16                 // ...........*..............................................................
        smull2 v28.4S, v10.8H, v12.8H           // .............*............................................................
        smlal v1.4S, v11.4H, v29.4H             // ..............*...........................................................
        smull v5.4S, v10.4H, v13.4H             // ...............*..........................................................
        smull2 v21.4S, v10.8H, v13.8H           // ................*.........................................................
        smlal2 v28.4S, v11.8H, v29.8H           // .................*........................................................
        ld2 {v14.8H, v15.8H}, [x8], #32         // ..................*.......................................................
        ld2 {v25.8H, v26.8H}, [x5], #32         // ......................*...................................................
        ld2 {v29.8H, v30.8H}, [x4], #32         // ..........................*...............................................
        smlal v5.4S, v11.4H, v12.4H             // ..............................*...........................................
        smlal2 v21.4S, v11.8H, v12.8H           // ...............................*..........................................
        smlal2 v28.4S, v29.8H, v25.8H           // ................................*.........................................
        ld2 {v9.8H, v10.8H}, [x11], #32         // .................................*........................................
        smlal v5.4S, v29.4H, v26.4H             // .....................................*....................................
        smlal2 v21.4S, v29.8H, v26.8H           // ......................................*...................................
        ld2 {v22.8H, v23.8H}, [x7], #32         // .......................................*..................................
        smlal v5.4S, v30.4H, v25.4H             // ...........................................*..............................
        smlal2 v21.4S, v30.8H, v25.8H           // ............................................*.............................
        ld2 {v19.8H, v20.8H}, [x10], #32        // .............................................*............................
        smlal v5.4S, v22.4H, v15.4H             // .................................................*........................
        smlal2 v21.4S, v22.8H, v15.8H           // ..................................................*.......................
        ld1 {v12.8H}, [x6], #16                 // ...................................................*......................
        smlal v5.4S, v23.4H, v14.4H             // .....................................................*....................
        smlal2 v21.4S, v23.8H, v14.8H           // ......................................................*...................
        smlal2 v28.4S, v30.8H, v12.8H           // .......................................................*..................
        smlal v1.4S, v29.4H, v25.4H             // ........................................................*.................
        smlal v5.4S, v19.4H, v10.4H             // .........................................................*................
        smlal2 v21.4S, v19.8H, v10.8H           // ..........................................................*...............
        smlal2 v28.4S, v22.8H, v14.8H           // ...........................................................*..............
        smlal v1.4S, v30.4H, v12.4H             // ............................................................*.............
        smlal v5.4S, v20.4H, v9.4H              // .............................................................*............
        smlal2 v21.4S, v20.8H, v9.8H            // ..............................................................*...........
        smlal2 v28.4S, v23.8H, v31.8H           // ...............................................................*..........
        ld1 {v24.8H}, [x12], #16                // ................................................................*.........
        uzp1 v12.8H, v5.8H, v21.8H              // ..................................................................*.......
        smlal2 v28.4S, v19.8H, v9.8H            // ...................................................................*......
        mul v6.8H, v12.8H, v2.H[2]              // ....................................................................*.....
        smlal v1.4S, v22.4H, v14.4H             // .....................................................................*....
        smlal2 v28.4S, v20.8H, v24.8H           // .......................................................................*..
        smlal2 v21.4S, v6.8H, v0.8H             // ........................................................................*.
        ld2 {v7.8H, v8.8H}, [x5], #32           // .........................................................................*

                                                 // --------------------------- cycle (expected) ---------------------------->
                                                 // 0                        25                       50
                                                 // |------------------------|------------------------|-----------------------
        // ld2 {v7.8H, v8.8H}, [x5], #32         // ......................*...................................................
        // ld1 {v27.8H}, [x3], #16               // ........*.................................................................
        // ld1 {v16.8H}, [x6], #16               // ...................................................*......................
        // ld1 {v31.8H}, [x9], #16               // ...........*..............................................................
        // ld2 {v3.8H, v4.8H}, [x1], #32         // ....*.....................................................................
        // ld2 {v9.8H, v10.8H}, [x2], #32        // *.........................................................................
        // ld1 {v24.8H}, [x12], #16              // ................................................................*.........
        // smull2 v21.4S, v3.8H, v10.8H          // ................*.........................................................
        // smull v5.4S, v3.4H, v10.4H            // ...............*..........................................................
        // smlal2 v21.4S, v4.8H, v9.8H           // ...............................*..........................................
        // ld2 {v29.8H, v30.8H}, [x4], #32       // ..........................*...............................................
        // ld2 {v22.8H, v23.8H}, [x7], #32       // .......................................*..................................
        // smull v1.4S, v3.4H, v9.4H             // ..........*...............................................................
        // smull2 v28.4S, v3.8H, v9.8H           // .............*............................................................
        // smlal v5.4S, v4.4H, v9.4H             // ..............................*...........................................
        // smlal2 v21.4S, v29.8H, v8.8H          // ......................................*...................................
        // smlal v1.4S, v4.4H, v27.4H            // ..............*...........................................................
        // smlal2 v28.4S, v4.8H, v27.8H          // .................*........................................................
        // smlal v5.4S, v29.4H, v8.4H            // .....................................*....................................
        // smlal2 v21.4S, v30.8H, v7.8H          // ............................................*.............................
        // smlal v1.4S, v29.4H, v7.4H            // ........................................................*.................
        // smlal2 v28.4S, v29.8H, v7.8H          // ................................*.........................................
        // ld2 {v12.8H, v13.8H}, [x8], #32       // ..................*.......................................................
        // smlal v1.4S, v30.4H, v16.4H           // ............................................................*.............
        // smlal2 v28.4S, v30.8H, v16.8H         // .......................................................*..................
        // smlal v5.4S, v30.4H, v7.4H            // ...........................................*..............................
        // smlal2 v21.4S, v22.8H, v13.8H         // ..................................................*.......................
        // ld2 {v9.8H, v10.8H}, [x11], #32       // .................................*........................................
        // smlal2 v21.4S, v23.8H, v12.8H         // ......................................................*...................
        // smlal v5.4S, v22.4H, v13.4H           // .................................................*........................
        // ld2 {v19.8H, v20.8H}, [x10], #32      // .............................................*............................
        // smlal v5.4S, v23.4H, v12.4H           // .....................................................*....................
        // smlal2 v28.4S, v22.8H, v12.8H         // ...........................................................*..............
        // smlal2 v21.4S, v19.8H, v10.8H         // ..........................................................*...............
        // smlal v5.4S, v19.4H, v10.4H           // .........................................................*................
        // smlal2 v28.4S, v23.8H, v31.8H         // ...............................................................*..........
        // smlal2 v21.4S, v20.8H, v9.8H          // ..............................................................*...........
        // smlal v5.4S, v20.4H, v9.4H            // .............................................................*............
        // smlal2 v28.4S, v19.8H, v9.8H          // ...................................................................*......
        // smlal v1.4S, v22.4H, v12.4H           // .....................................................................*....
        // uzp1 v12.8H, v5.8H, v21.8H            // ..................................................................*.......
        // smlal2 v28.4S, v20.8H, v24.8H         // .......................................................................*..
        // mul v6.8H, v12.8H, v2.H[2]            // ....................................................................*.....
        // ld2 {v7.8H, v8.8H}, [x5], #32         // .........................................................................*
        // smlal2 v21.4S, v6.8H, v0.8H           // ........................................................................*.

        sub count, count, #2
k4_loop_start:
                                                // Instructions:    61
                                                // Expected cycles: 90
                                                // Expected IPC:    0.68
                                                //
                                                // Cycle bound:     89.0
                                                // IPC bound:       0.69
                                                //
                                                // Wall time:     63.34s
                                                // User time:     63.34s
                                                //
                                                // ----------------------------------- cycle (expected) ------------------------------------>
                                                // 0                        25                       50                       75
                                                // |------------------------|------------------------|------------------------|--------------
        smlal v5.4S, v6.4H, v0.4H               // .l........................................................................................
        smlal v1.4S, v23.4H, v31.4H             // ..l.......................................................................................
        ld1 {v27.8H}, [x3], #16                 // ...*......................................................................................
        uzp2 v18.8H, v5.8H, v21.8H              // .....l....................................................................................
        smlal v1.4S, v19.4H, v9.4H              // ......l...................................................................................
        sqdmulh v21.8H, v18.8H, v2.H[1]         // .......l..................................................................................
        ld1 {v16.8H}, [x6], #16                 // ........*.................................................................................
        smlal v1.4S, v20.4H, v24.4H             // ..........l...............................................................................
        srshr v15.8H, v21.8H, #11               // ...........l..............................................................................
        ld1 {v31.8H}, [x9], #16                 // ............*.............................................................................
        mls v18.8H, v15.8H, v2.H[0]             // ..............l...........................................................................
        ld2 {v3.8H, v4.8H}, [x1], #32           // ...............*..........................................................................
        ld2 {v9.8H, v10.8H}, [x2], #32          // ...................*......................................................................
        ld1 {v24.8H}, [x12], #16                // .......................*..................................................................
        smull2 v21.4S, v3.8H, v10.8H            // .........................*................................................................
        uzp1 v15.8H, v1.8H, v28.8H              // ..........................l...............................................................
        smull v5.4S, v3.4H, v10.4H              // ...........................*..............................................................
        mul v12.8H, v15.8H, v2.H[2]             // ............................l.............................................................
        smlal2 v21.4S, v4.8H, v9.8H             // .............................*............................................................
        ld2 {v29.8H, v30.8H}, [x4], #32         // ..............................*...........................................................
        smlal v1.4S, v12.4H, v0.4H              // ..................................l.......................................................
        smlal2 v28.4S, v12.8H, v0.8H            // ...................................l......................................................
        ld2 {v22.8H, v23.8H}, [x7], #32         // ....................................*.....................................................
        uzp2 v17.8H, v1.8H, v28.8H              // ........................................l.................................................
        smull v1.4S, v3.4H, v9.4H               // .........................................*................................................
        smull2 v28.4S, v3.8H, v9.8H             // ..........................................*...............................................
        smlal v5.4S, v4.4H, v9.4H               // ...........................................*..............................................
        smlal2 v21.4S, v29.8H, v8.8H            // ............................................*.............................................
        smlal v1.4S, v4.4H, v27.4H              // .............................................*............................................
        smlal2 v28.4S, v4.8H, v27.8H            // ..............................................*...........................................
        smlal v5.4S, v29.4H, v8.4H              // ...............................................*..........................................
        smlal2 v21.4S, v30.8H, v7.8H            // ................................................*.........................................
        smlal v1.4S, v29.4H, v7.4H              // .................................................*........................................
        smlal2 v28.4S, v29.8H, v7.8H            // ..................................................*.......................................
        ld2 {v12.8H, v13.8H}, [x8], #32         // ...................................................*......................................
        smlal v1.4S, v30.4H, v16.4H             // .......................................................*..................................
        smlal2 v28.4S, v30.8H, v16.8H           // ........................................................*.................................
        smlal v5.4S, v30.4H, v7.4H              // .........................................................*................................
        smlal2 v21.4S, v22.8H, v13.8H           // ..........................................................*...............................
        ld2 {v9.8H, v10.8H}, [x11], #32         // ...........................................................*..............................
        smlal2 v21.4S, v23.8H, v12.8H           // ...............................................................*..........................
        smlal v5.4S, v22.4H, v13.4H             // ................................................................*.........................
        ld2 {v19.8H, v20.8H}, [x10], #32        // .................................................................*........................
        smlal v5.4S, v23.4H, v12.4H             // .....................................................................*....................
        smlal2 v28.4S, v22.8H, v12.8H           // ......................................................................*...................
        smlal2 v21.4S, v19.8H, v10.8H           // .......................................................................*..................
        sqdmulh v14.8H, v17.8H, v2.H[1]         // ........................................................................l.................
        smlal v5.4S, v19.4H, v10.4H             // .........................................................................*................
        smlal2 v28.4S, v23.8H, v31.8H           // ..........................................................................*...............
        smlal2 v21.4S, v20.8H, v9.8H            // ...........................................................................*..............
        srshr v6.8H, v14.8H, #11                // ............................................................................l.............
        smlal v5.4S, v20.4H, v9.4H              // .............................................................................*............
        smlal2 v28.4S, v19.8H, v9.8H            // ..............................................................................*...........
        smlal v1.4S, v22.4H, v12.4H             // ...............................................................................*..........
        mls v17.8H, v6.8H, v2.H[0]              // ................................................................................l.........
        uzp1 v12.8H, v5.8H, v21.8H              // .................................................................................*........
        smlal2 v28.4S, v20.8H, v24.8H           // ..................................................................................*.......
        mul v6.8H, v12.8H, v2.H[2]              // ...................................................................................*......
        ld2 {v7.8H, v8.8H}, [x5], #32           // ....................................................................................e.....
        smlal2 v21.4S, v6.8H, v0.8H             // ........................................................................................*.
        st2 {v17.8H, v18.8H}, [x0], #32         // .........................................................................................l

                                                     // ----------------------------------------------------------------------------------- cycle (expected) ------------------------------------------------------------------------------------>
                                                     // 0                        25                       50                       75                       100                      125                      150                      175
                                                     // |------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|----------
        // ld2 {v3.8h, v4.8h}, [x1],       #32       // ......'..............*..........................................................................'..............~..........................................................................
        // ld2 {v5.8h, v6.8h}, [x2],       #32       // ......'..................*......................................................................'..................~......................................................................
        // ld1 {v7.8h},           [x3], #16          // ......'..*......................................................................................'..~......................................................................................
        // smull  v8.4s, v3.4h, v5.4h                // ......'........................................*................................................'........................................~................................................
        // smull2 v10.4s, v3.8h, v5.8h               // ......'.........................................*...............................................'.........................................~...............................................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'............................................*............................................'............................................~............................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.............................................*...........................................'.............................................~...........................................
        // smull  v9.4s, v3.4h, v6.4h                // ......'..........................*..............................................................'..........................~..............................................................
        // smull2 v11.4s, v3.8h, v6.8h               // ......'........................*................................................................'........................~................................................................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'..........................................*..............................................'..........................................~..............................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'............................*............................................................'............................~............................................................
        // ld2 {v3.8h, v4.8h}, [x4],       #32       // ......'.............................*...........................................................'.............................~...........................................................
        // ld2 {v5.8h, v6.8h}, [x5],       #32       // e.....'...................................................................................~.....'...................................................................................~.....
        // ld1 {v7.8h},           [x6], #16          // ......'.......*.................................................................................'.......~.................................................................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'................................................*........................................'................................................~........................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'.................................................*.......................................'.................................................~.......................................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'......................................................*..................................'......................................................~..................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.......................................................*.................................'.......................................................~.................................
        // smlal  v9.4s, v3.4h, v6.4h                // ......'..............................................*..........................................'..............................................~..........................................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'...........................................*.............................................'...........................................~.............................................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'........................................................*................................'........................................................~................................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'...............................................*.........................................'...............................................~.........................................
        // ld2 {v3.8h, v4.8h}, [x7],       #32       // ......'...................................*.....................................................'...................................~.....................................................
        // ld2 {v5.8h, v6.8h}, [x8],       #32       // ......'..................................................*......................................'..................................................~......................................
        // ld1 {v7.8h},           [x9], #16          // ......'...........*.............................................................................'...........~.............................................................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'..............................................................................*..........'..............................................................................~..........
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'.....................................................................*...................'.....................................................................~...................
        // smlal  v8.4s, v4.4h, v7.4h                // ......'.~.......................................................................................'.l.......................................................................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.........................................................................*...............'.........................................................................~...............
        // smlal  v9.4s, v3.4h, v6.4h                // ......'...............................................................*.........................'...............................................................~.........................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'.........................................................*...............................'.........................................................~...............................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'....................................................................*....................'....................................................................~....................
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'..............................................................*..........................'..............................................................~..........................
        // ld2 {v3.8h, v4.8h}, [x10],       #32      // ......'................................................................*........................'................................................................~........................
        // ld2 {v5.8h, v6.8h}, [x11],       #32      // ......'..........................................................*..............................'..........................................................~..............................
        // ld1 {v7.8h},           [x12], #16         // ......'......................*..................................................................'......................~..................................................................
        // smlal  v8.4s, v3.4h, v5.4h                // ......'.....~...................................................................................'.....l...................................................................................
        // smlal2 v10.4s, v3.8h, v5.8h               // ......'.............................................................................*...........'.............................................................................~...........
        // smlal  v8.4s, v4.4h, v7.4h                // ......'.........~...............................................................................'.........l...............................................................................
        // smlal2 v10.4s, v4.8h, v7.8h               // ......'.................................................................................*.......'.................................................................................~.......
        // smlal  v9.4s, v3.4h, v6.4h                // ......'........................................................................*................'........................................................................~................
        // smlal2 v11.4s, v3.8h, v6.8h               // ......'......................................................................*..................'......................................................................~..................
        // smlal  v9.4s, v4.4h, v5.4h                // ......'............................................................................*............'............................................................................~............
        // smlal2 v11.4s, v4.8h, v5.8h               // ......'..........................................................................*..............'..........................................................................~..............
        // uzp1   v28.8h, v8.8h, v10.8h              // ......'.........................~...............................................................'.........................l...............................................................
        // mul    v28.8h, v28.8h, v2.h[2]            // ......'...........................~.............................................................'...........................l.............................................................
        // smlal  v8.4s, v28.4h, v0.4h               // ......'.................................~.......................................................'.................................l.......................................................
        // smlal2 v10.4s, v28.8h, v0.8h              // ......'..................................~......................................................'..................................l......................................................
        // uzp2   v26.8h, v8.8h, v10.8h              // ......'.......................................~.................................................'.......................................l.................................................
        // uzp1   v28.8h, v9.8h, v11.8h              // ......'................................................................................*........'................................................................................~........
        // mul    v28.8h, v28.8h, v2.h[2]            // ......'..................................................................................*......'..................................................................................~......
        // smlal  v9.4s, v28.4h, v0.4h               // ......'~........................................................................................'l........................................................................................
        // smlal2 v11.4s, v28.8h, v0.8h              // ....~.'.......................................................................................*.'.......................................................................................~.
        // uzp2   v27.8h, v9.8h, v11.8h              // ......'....~....................................................................................'....l....................................................................................
        // sqdmulh v28.8h, v26.8h, v2.h[1]           // ......'.......................................................................~.................'.......................................................................l.................
        // srshr   v28.8h, v28.8h, #11               // ......'...........................................................................~.............'...........................................................................l.............
        // mls     v26.8h, v28.8h, v2.h[0]           // ......'...............................................................................~.........'...............................................................................l.........
        // sqdmulh v28.8h, v27.8h, v2.h[1]           // ......'......~..................................................................................'......l..................................................................................
        // srshr   v28.8h, v28.8h, #11               // ......'..........~..............................................................................'..........l..............................................................................
        // mls     v27.8h, v28.8h, v2.h[0]           // ......'.............~...........................................................................'.............l...........................................................................
        // st2 {v26.8h, v27.8h}, [x0], #32           // .....~'........................................................................................~'........................................................................................l

        sub count, count, #1
        cbnz count, k4_loop_start
                                                // Instructions:    77
                                                // Expected cycles: 104
                                                // Expected IPC:    0.74
                                                //
                                                // Cycle bound:     104.0
                                                // IPC bound:       0.74
                                                //
                                                // Wall time:     1.67s
                                                // User time:     1.67s
                                                //
                                                // ------------------------------------------ cycle (expected) ------------------------------------------->
                                                // 0                        25                       50                       75                       100
                                                // |------------------------|------------------------|------------------------|------------------------|---
        smlal v5.4S, v6.4H, v0.4H               // *.......................................................................................................
        smlal v1.4S, v23.4H, v31.4H             // .*......................................................................................................
        ld2 {v14.8H, v15.8H}, [x8], #32         // ..*.....................................................................................................
        uzp2 v6.8H, v5.8H, v21.8H               // ......*.................................................................................................
        smlal v1.4S, v19.4H, v9.4H              // .......*................................................................................................
        ld1 {v26.8H}, [x9], #16                 // ........*...............................................................................................
        sqdmulh v4.8H, v6.8H, v2.H[1]           // ..........*.............................................................................................
        smlal v1.4S, v20.4H, v24.4H             // ...........*............................................................................................
        ld2 {v12.8H, v13.8H}, [x4], #32         // ............*...........................................................................................
        ld2 {v10.8H, v11.8H}, [x2], #32         // ................*.......................................................................................
        ld2 {v29.8H, v30.8H}, [x1], #32         // ....................*...................................................................................
        ld1 {v18.8H}, [x3], #16                 // ........................*...............................................................................
        smull2 v17.4S, v29.8H, v10.8H           // ..........................*.............................................................................
        smull v9.4S, v29.4H, v10.4H             // ...........................*............................................................................
        ld1 {v25.8H}, [x6], #16                 // ............................*...........................................................................
        smlal2 v17.4S, v30.8H, v18.8H           // ..............................*.........................................................................
        smull2 v27.4S, v29.8H, v11.8H           // ...............................*........................................................................
        smull v21.4S, v29.4H, v11.4H            // ................................*.......................................................................
        smlal v9.4S, v30.4H, v18.4H             // .................................*......................................................................
        smlal2 v17.4S, v12.8H, v7.8H            // ..................................*.....................................................................
        smlal2 v27.4S, v30.8H, v10.8H           // ...................................*....................................................................
        smlal v21.4S, v30.4H, v10.4H            // ....................................*...................................................................
        ld2 {v10.8H, v11.8H}, [x11], #32        // .....................................*..................................................................
        smlal v21.4S, v12.4H, v8.4H             // .........................................*..............................................................
        smlal2 v17.4S, v13.8H, v25.8H           // ..........................................*.............................................................
        ld2 {v29.8H, v30.8H}, [x10], #32        // ...........................................*............................................................
        smlal v21.4S, v13.4H, v7.4H             // ...............................................*........................................................
        smlal v9.4S, v12.4H, v7.4H              // ................................................*.......................................................
        uzp1 v18.8H, v1.8H, v28.8H              // .................................................*......................................................
        ld2 {v19.8H, v20.8H}, [x7], #32         // ..................................................*.....................................................
        smlal2 v27.4S, v12.8H, v8.8H            // ......................................................*.................................................
        smlal v9.4S, v13.4H, v25.4H             // .......................................................*................................................
        ld1 {v16.8H}, [x12], #16                // ........................................................*...............................................
        smlal2 v27.4S, v13.8H, v7.8H            // ..........................................................*.............................................
        smlal v9.4S, v19.4H, v14.4H             // ...........................................................*............................................
        smlal2 v17.4S, v19.8H, v14.8H           // ............................................................*...........................................
        smlal v21.4S, v19.4H, v15.4H            // .............................................................*..........................................
        smlal2 v27.4S, v19.8H, v15.8H           // ..............................................................*.........................................
        smlal v9.4S, v20.4H, v26.4H             // ...............................................................*........................................
        smlal2 v17.4S, v20.8H, v26.8H           // ................................................................*.......................................
        smlal v21.4S, v20.4H, v14.4H            // .................................................................*......................................
        smlal2 v27.4S, v20.8H, v14.8H           // ..................................................................*.....................................
        smlal v9.4S, v29.4H, v10.4H             // ...................................................................*....................................
        smlal2 v17.4S, v29.8H, v10.8H           // ....................................................................*...................................
        smlal v21.4S, v29.4H, v11.4H            // .....................................................................*..................................
        smlal2 v27.4S, v29.8H, v11.8H           // ......................................................................*.................................
        smlal v9.4S, v30.4H, v16.4H             // .......................................................................*................................
        smlal2 v17.4S, v30.8H, v16.8H           // ........................................................................*...............................
        smlal v21.4S, v30.4H, v10.4H            // .........................................................................*..............................
        smlal2 v27.4S, v30.8H, v10.8H           // ..........................................................................*.............................
        srshr v26.8H, v4.8H, #11                // ...........................................................................*............................
        uzp1 v12.8H, v9.8H, v17.8H              // ............................................................................*...........................
        mul v14.8H, v18.8H, v2.H[2]             // .............................................................................*..........................
        uzp1 v29.8H, v21.8H, v27.8H             // ..............................................................................*.........................
        mul v12.8H, v12.8H, v2.H[2]             // ...............................................................................*........................
        mul v29.8H, v29.8H, v2.H[2]             // ................................................................................*.......................
        smlal v1.4S, v14.4H, v0.4H              // .................................................................................*......................
        smlal2 v28.4S, v14.8H, v0.8H            // ..................................................................................*.....................
        smlal2 v17.4S, v12.8H, v0.8H            // ...................................................................................*....................
        smlal v9.4S, v12.4H, v0.4H              // ....................................................................................*...................
        smlal v21.4S, v29.4H, v0.4H             // .....................................................................................*..................
        smlal2 v27.4S, v29.8H, v0.8H            // ......................................................................................*.................
        uzp2 v5.8H, v1.8H, v28.8H               // .......................................................................................*................
        uzp2 v3.8H, v9.8H, v17.8H               // ........................................................................................*...............
        sqdmulh v14.8H, v5.8H, v2.H[1]          // .........................................................................................*..............
        uzp2 v4.8H, v21.8H, v27.8H              // ..........................................................................................*.............
        sqdmulh v12.8H, v3.8H, v2.H[1]          // ...........................................................................................*............
        sqdmulh v29.8H, v4.8H, v2.H[1]          // ............................................................................................*...........
        mls v6.8H, v26.8H, v2.H[0]              // .............................................................................................*..........
        srshr v14.8H, v14.8H, #11               // ..............................................................................................*.........
        srshr v12.8H, v12.8H, #11               // ...............................................................................................*........
        srshr v29.8H, v29.8H, #11               // ................................................................................................*.......
        mls v5.8H, v14.8H, v2.H[0]              // .................................................................................................*......
        mls v3.8H, v12.8H, v2.H[0]              // ..................................................................................................*.....
        mls v4.8H, v29.8H, v2.H[0]              // ...................................................................................................*....
        st2 {v5.8H, v6.8H}, [x0], #32           // .....................................................................................................*..
        st2 {v3.8H, v4.8H}, [x0], #32           // .......................................................................................................*

                                                 // ------------------------------------------ cycle (expected) ------------------------------------------->
                                                 // 0                        25                       50                       75                       100
                                                 // |------------------------|------------------------|------------------------|------------------------|---
        // smlal v5.4S, v6.4H, v0.4H             // *.......................................................................................................
        // smlal v1.4S, v23.4H, v31.4H           // .*......................................................................................................
        // ld1 {v27.8H}, [x3], #16               // ........................*...............................................................................
        // uzp2 v18.8H, v5.8H, v21.8H            // ......*.................................................................................................
        // smlal v1.4S, v19.4H, v9.4H            // .......*................................................................................................
        // sqdmulh v21.8H, v18.8H, v2.H[1]       // ..........*.............................................................................................
        // ld1 {v16.8H}, [x6], #16               // ............................*...........................................................................
        // smlal v1.4S, v20.4H, v24.4H           // ...........*............................................................................................
        // srshr v15.8H, v21.8H, #11             // ...........................................................................*............................
        // ld1 {v31.8H}, [x9], #16               // ........*...............................................................................................
        // mls v18.8H, v15.8H, v2.H[0]           // .............................................................................................*..........
        // ld2 {v3.8H, v4.8H}, [x1], #32         // ....................*...................................................................................
        // ld2 {v9.8H, v10.8H}, [x2], #32        // ................*.......................................................................................
        // ld1 {v24.8H}, [x12], #16              // ........................................................*...............................................
        // smull2 v21.4S, v3.8H, v10.8H          // ...............................*........................................................................
        // uzp1 v15.8H, v1.8H, v28.8H            // .................................................*......................................................
        // smull v5.4S, v3.4H, v10.4H            // ................................*.......................................................................
        // mul v12.8H, v15.8H, v2.H[2]           // .............................................................................*..........................
        // smlal2 v21.4S, v4.8H, v9.8H           // ...................................*....................................................................
        // ld2 {v29.8H, v30.8H}, [x4], #32       // ............*...........................................................................................
        // smlal v1.4S, v12.4H, v0.4H            // .................................................................................*......................
        // smlal2 v28.4S, v12.8H, v0.8H          // ..................................................................................*.....................
        // ld2 {v22.8H, v23.8H}, [x7], #32       // ..................................................*.....................................................
        // uzp2 v17.8H, v1.8H, v28.8H            // .......................................................................................*................
        // smull v1.4S, v3.4H, v9.4H             // ...........................*............................................................................
        // smull2 v28.4S, v3.8H, v9.8H           // ..........................*.............................................................................
        // smlal v5.4S, v4.4H, v9.4H             // ....................................*...................................................................
        // smlal2 v21.4S, v29.8H, v8.8H          // ......................................................*.................................................
        // smlal v1.4S, v4.4H, v27.4H            // .................................*......................................................................
        // smlal2 v28.4S, v4.8H, v27.8H          // ..............................*.........................................................................
        // smlal v5.4S, v29.4H, v8.4H            // .........................................*..............................................................
        // smlal2 v21.4S, v30.8H, v7.8H          // ..........................................................*.............................................
        // smlal v1.4S, v29.4H, v7.4H            // ................................................*.......................................................
        // smlal2 v28.4S, v29.8H, v7.8H          // ..................................*.....................................................................
        // ld2 {v12.8H, v13.8H}, [x8], #32       // ..*.....................................................................................................
        // smlal v1.4S, v30.4H, v16.4H           // .......................................................*................................................
        // smlal2 v28.4S, v30.8H, v16.8H         // ..........................................*.............................................................
        // smlal v5.4S, v30.4H, v7.4H            // ...............................................*........................................................
        // smlal2 v21.4S, v22.8H, v13.8H         // ..............................................................*.........................................
        // ld2 {v9.8H, v10.8H}, [x11], #32       // .....................................*..................................................................
        // smlal2 v21.4S, v23.8H, v12.8H         // ..................................................................*.....................................
        // smlal v5.4S, v22.4H, v13.4H           // .............................................................*..........................................
        // ld2 {v19.8H, v20.8H}, [x10], #32      // ...........................................*............................................................
        // smlal v5.4S, v23.4H, v12.4H           // .................................................................*......................................
        // smlal2 v28.4S, v22.8H, v12.8H         // ............................................................*...........................................
        // smlal2 v21.4S, v19.8H, v10.8H         // ......................................................................*.................................
        // sqdmulh v14.8H, v17.8H, v2.H[1]       // .........................................................................................*..............
        // smlal v5.4S, v19.4H, v10.4H           // .....................................................................*..................................
        // smlal2 v28.4S, v23.8H, v31.8H         // ................................................................*.......................................
        // smlal2 v21.4S, v20.8H, v9.8H          // ..........................................................................*.............................
        // srshr v6.8H, v14.8H, #11              // ..............................................................................................*.........
        // smlal v5.4S, v20.4H, v9.4H            // .........................................................................*..............................
        // smlal2 v28.4S, v19.8H, v9.8H          // ....................................................................*...................................
        // smlal v1.4S, v22.4H, v12.4H           // ...........................................................*............................................
        // mls v17.8H, v6.8H, v2.H[0]            // .................................................................................................*......
        // uzp1 v12.8H, v5.8H, v21.8H            // ..............................................................................*.........................
        // smlal2 v28.4S, v20.8H, v24.8H         // ........................................................................*...............................
        // mul v6.8H, v12.8H, v2.H[2]            // ................................................................................*.......................
        // smlal2 v21.4S, v6.8H, v0.8H           // ......................................................................................*.................
        // st2 {v17.8H, v18.8H}, [x0], #32       // .....................................................................................................*..
        // smlal v5.4S, v6.4H, v0.4H             // .....................................................................................*..................
        // smlal v1.4S, v23.4H, v31.4H           // ...............................................................*........................................
        // uzp2 v18.8H, v5.8H, v21.8H            // ..........................................................................................*.............
        // smlal v1.4S, v19.4H, v9.4H            // ...................................................................*....................................
        // sqdmulh v21.8H, v18.8H, v2.H[1]       // ............................................................................................*...........
        // smlal v1.4S, v20.4H, v24.4H           // .......................................................................*................................
        // srshr v15.8H, v21.8H, #11             // ................................................................................................*.......
        // mls v18.8H, v15.8H, v2.H[0]           // ...................................................................................................*....
        // uzp1 v15.8H, v1.8H, v28.8H            // ............................................................................*...........................
        // mul v12.8H, v15.8H, v2.H[2]           // ...............................................................................*........................
        // smlal v1.4S, v12.4H, v0.4H            // ....................................................................................*...................
        // smlal2 v28.4S, v12.8H, v0.8H          // ...................................................................................*....................
        // uzp2 v17.8H, v1.8H, v28.8H            // ........................................................................................*...............
        // sqdmulh v14.8H, v17.8H, v2.H[1]       // ...........................................................................................*............
        // srshr v6.8H, v14.8H, #11              // ...............................................................................................*........
        // mls v17.8H, v6.8H, v2.H[0]            // ..................................................................................................*.....
        // st2 {v17.8H, v18.8H}, [x0], #32       // .......................................................................................................*


        pop_stack
        ret
#endif /* KYBER_K == 4 */

#endif /* MLKEM_USE_NATIVE_AARCH64 */
